<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Death Number - Multiplayer_games</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f0f0f0;
            margin: 0;
            text-align: center;
        }
        .container {
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 500px;
            box-sizing: border-box;
        }
        h1 {
            color: #333;
        }
        input, button {
            width: calc(100% - 20px);
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: #fff;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0056b3;
        }
        .section {
            margin-top: 20px;
            display: none;
        }
        .section.active {
            display: block;
        }
        .game-info {
            background-color: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin-bottom: 20px;
            text-align: left;
        }
        .game-info p {
            margin: 5px 0;
        }
        .number-display {
            font-size: 3em;
            font-weight: bold;
            color: #28a745;
            margin: 20px 0;
        }
        .turn-info {
            font-size: 1.2em;
            color: #555;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .action-buttons button {
            width: calc(33.33% - 10px);
            margin: 5px;
            background-color: #28a745;
        }
        .action-buttons button:hover {
            background-color: #218838;
        }
        .hidden {
            display: none;
        }
        .status-message {
            font-weight: bold;
            color: #dc3545;
            margin-top: 15px;
        }
    </style>
</head>
<body>

<div class="container">
    <div id="setup-section" class="section active">
        <h1>Death Number</h1>
        <p>สร้างห้องหรือเข้าร่วมห้อง</p>
        <button id="show-create-form-btn">สร้างห้อง</button>
        <button id="show-join-form-btn">เข้าร่วมห้อง</button>

        <div id="create-room-form" class="hidden">
            <h2>สร้างห้องใหม่</h2>
            <input type="text" id="player-name-create" placeholder="ใส่ชื่อเล่นของคุณ" required>
            <input type="number" id="lose-number-input" placeholder="เลขที่จะนับแล้วแพ้ (เช่น 20)" value="20" required>
            <input type="number" id="max-count-input" placeholder="นับได้สูงสุดไม่เกิน (เช่น 3)" value="3" required>
            <button id="submit-create-room">ตั้งห้อง</button>
        </div>

        <div id="join-room-form" class="hidden">
            <h2>เข้าร่วมห้อง</h2>
            <input type="text" id="player-name-join" placeholder="ใส่ชื่อเล่นของคุณ" required>
            <input type="text" id="room-id-input" placeholder="ใส่โค้ดห้อง" required>
            <button id="submit-join-room">เข้าร่วม</button>
        </div>
    </div>

    <div id="lobby-section" class="section">
        <h2 id="lobby-title"></h2>
        <p><strong>ชื่อผู้เล่น:</strong> <span id="my-name-display"></span></p>
        <p id="peer-status">กำลังสร้าง Peer ID...</p>
        <div id="room-info" class="hidden">
            <p><strong>โค้ดห้องของคุณ:</strong> <span id="room-id-display"></span></p>
            <button id="copy-link-btn">คัดลอกลิงก์</button>
            <p id="connection-status">กำลังรอเพื่อนเข้าร่วม...</p>
            <div id="opponent-name-display" class="hidden">
                <p><strong>เพื่อนของคุณ:</strong> <span id="opponent-name"></span></p>
            </div>
        </div>
        <div id="game-waiting-start" class="hidden">
            <p>เมื่อเพื่อนเข้ามาแล้ว กดปุ่มเพื่อเริ่มเกม</p>
            <button id="start-game-btn">เริ่มเกม</button>
        </div>
    </div>

    <div id="game-section" class="section">
        <div class="game-info">
            <p><strong>กฎ:</strong> แพ้เมื่อนับถึง <span id="lose-number-display"></span>, นับได้ไม่เกิน <span id="max-count-display"></span> ตัว</p>
            <p><strong>ผู้เล่น 1:</strong> <span id="player1-name"></span></p>
            <p><strong>ผู้เล่น 2:</strong> <span id="player2-name"></span></p>
        </div>
        <div class="number-display" id="current-number-display">0</div>
        <p class="turn-info" id="turn-info"></p>
        <div class="action-buttons" id="action-buttons"></div>
        <p class="status-message" id="game-status"></p>
    </div>
</div>

<script>
    const setupSection = document.getElementById('setup-section');
    const lobbySection = document.getElementById('lobby-section');
    const gameSection = document.getElementById('game-section');

    const showCreateFormBtn = document.getElementById('show-create-form-btn');
    const showJoinFormBtn = document.getElementById('show-join-form-btn');
    const createRoomForm = document.getElementById('create-room-form');
    const joinRoomForm = document.getElementById('join-room-form');

    const submitCreateRoom = document.getElementById('submit-create-room');
    const submitJoinRoom = document.getElementById('submit-join-room');

    const playerNameCreateInput = document.getElementById('player-name-create');
    const loseNumberInput = document.getElementById('lose-number-input');
    const maxCountInput = document.getElementById('max-count-input');

    const playerNameJoinInput = document.getElementById('player-name-join');
    const roomIdInput = document.getElementById('room-id-input');

    const myNameDisplay = document.getElementById('my-name-display');
    const peerStatus = document.getElementById('peer-status');
    const roomInfo = document.getElementById('room-info');
    const roomIdDisplay = document.getElementById('room-id-display');
    const copyLinkBtn = document.getElementById('copy-link-btn');
    const connectionStatus = document.getElementById('connection-status');
    const opponentNameDisplay = document.getElementById('opponent-name-display');
    const opponentNameSpan = document.getElementById('opponent-name');
    const gameWaitingStart = document.getElementById('game-waiting-start');
    const startGameBtn = document.getElementById('start-game-btn');

    const loseNumberDisplay = document.getElementById('lose-number-display');
    const maxCountDisplay = document.getElementById('max-count-display');
    const player1Name = document.getElementById('player1-name');
    const player2Name = document.getElementById('player2-name');
    const currentNumberDisplay = document.getElementById('current-number-display');
    const turnInfo = document.getElementById('turn-info');
    const actionButtons = document.getElementById('action-buttons');
    const gameStatus = document.getElementById('game-status');

    let myName = '';
    let myPeerId;
    let peer;
    let conn;
    let loseNumber;
    let maxCount;
    let currentNumber;
    let isHost = false;
    let myTurn = false;
    let opponentName = '';
    let gameStarted = false;

    // Function to show/hide sections
    function showSection(sectionId) {
        document.querySelectorAll('.section').forEach(section => {
            section.classList.remove('active');
        });
        document.getElementById(sectionId).classList.add('active');
    }

    // Initial state: show setup section and main buttons
    showSection('setup-section');
    createRoomForm.classList.add('hidden');
    joinRoomForm.classList.add('hidden');

    // Event listeners for the main buttons
    showCreateFormBtn.addEventListener('click', () => {
        createRoomForm.classList.remove('hidden');
        joinRoomForm.classList.add('hidden');
    });
    showJoinFormBtn.addEventListener('click', () => {
        joinRoomForm.classList.remove('hidden');
        createRoomForm.classList.add('hidden');
    });

    // Handle URL parameters for joining a room
    const urlParams = new URLSearchParams(window.location.search);
    const roomFromUrl = urlParams.get('room');
    if (roomFromUrl) {
        showSection('setup-section');
        joinRoomForm.classList.remove('hidden');
        showCreateFormBtn.classList.add('hidden');
        showJoinFormBtn.classList.add('hidden');
        roomIdInput.value = roomFromUrl;
        // User must fill in their name and press 'เข้าร่วม'
    }

    // Create Room
    submitCreateRoom.addEventListener('click', () => {
        if (!playerNameCreateInput.value || !loseNumberInput.value || !maxCountInput.value) {
            alert('กรุณากรอกข้อมูลให้ครบถ้วน');
            return;
        }
        myName = playerNameCreateInput.value;
        loseNumber = parseInt(loseNumberInput.value);
        maxCount = parseInt(maxCountInput.value);
        isHost = true;
        
        showSection('lobby-section');
        document.getElementById('lobby-title').textContent = 'สร้างห้องใหม่';
        myNameDisplay.textContent = myName;

        peer = new Peer();
        setupPeerEvents();
    });

    // Join Room
    submitJoinRoom.addEventListener('click', () => {
        if (!playerNameJoinInput.value || !roomIdInput.value) {
            alert('กรุณากรอกข้อมูลให้ครบถ้วน');
            return;
        }
        myName = playerNameJoinInput.value;
        const roomId = roomIdInput.value;
        isHost = false;
        
        showSection('lobby-section');
        document.getElementById('lobby-title').textContent = 'เข้าร่วมห้อง';
        myNameDisplay.textContent = myName;

        peer = new Peer();
        setupPeerEvents();
        
        peer.on('open', (id) => {
            myPeerId = id;
            peerStatus.textContent = `กำลังเชื่อมต่อ...`;
            conn = peer.connect(roomId);
            setupConnectionEvents(conn);
        });
    });

    function setupPeerEvents() {
        peer.on('open', (id) => {
            myPeerId = id;
            if (isHost) {
                peerStatus.textContent = `Peer ID ของคุณ: ${myPeerId}`;
                roomInfo.classList.remove('hidden');
                roomIdDisplay.textContent = myPeerId;
                const roomLink = `${window.location.href.split('?')[0]}?room=${myPeerId}`;
                copyLinkBtn.addEventListener('click', () => {
                    navigator.clipboard.writeText(roomLink).then(() => {
                        alert('คัดลอกลิงก์แล้ว!');
                    });
                });
            }
        });

        peer.on('connection', (connection) => {
            conn = connection;
            setupConnectionEvents(conn);
            connectionStatus.textContent = 'เพื่อนเข้าร่วมแล้ว!';
            gameWaitingStart.classList.remove('hidden');
        });
        
        peer.on('error', (err) => {
            console.error(err);
            alert('เกิดข้อผิดพลาดในการเชื่อมต่อ: ' + err.message);
        });
    }

    function setupConnectionEvents(connection) {
        connection.on('open', () => {
            console.log('Connection established with opponent!');
            if (isHost) {
                conn.send({ type: 'player-data', name: myName, loseNumber: loseNumber, maxCount: maxCount });
            } else {
                conn.send({ type: 'player-data', name: myName });
            }
        });

        connection.on('data', (data) => {
            if (data.type === 'player-data') {
                opponentName = data.name;
                opponentNameDisplay.classList.remove('hidden');
                opponentNameSpan.textContent = opponentName;
                if (!isHost) {
                    loseNumber = data.loseNumber;
                    maxCount = data.maxCount;
                    gameWaitingStart.classList.remove('hidden');
                }
            } else if (data.type === 'start-game') {
                if (!gameStarted) {
                    startGame(isHost ? myName : opponentName, isHost ? opponentName : myName);
                }
            } else if (data.type === 'move') {
                currentNumber += data.count;
                updateGameDisplay();
                if (currentNumber >= loseNumber) {
                    endGame(false); // Opponent loses
                } else {
                    myTurn = true;
                    turnInfo.textContent = 'ถึงตาคุณแล้ว!';
                    createCountButtons();
                }
            }
        });

        connection.on('close', () => {
            gameStatus.textContent = 'คู่ต่อสู้ตัดการเชื่อมต่อ! เกมจบลงแล้ว';
            actionButtons.innerHTML = '';
        });
    }

    // Add event listener for the start game button (only for the host)
    startGameBtn.addEventListener('click', () => {
        if (isHost) {
            conn.send({ type: 'start-game' });
            startGame(myName, opponentName);
        }
    });

    function startGame(player1, player2) {
        gameStarted = true;
        showSection('game-section');

        player1Name.textContent = player1;
        player2Name.textContent = player2;
        loseNumberDisplay.textContent = loseNumber;
        maxCountDisplay.textContent = maxCount;
        currentNumber = 0;
        currentNumberDisplay.textContent = currentNumber;

        if (isHost) {
            myTurn = true;
            turnInfo.textContent = 'ถึงตาคุณแล้ว!';
            createCountButtons();
        } else {
            myTurn = false;
            turnInfo.textContent = 'กำลังรอตาของ ' + player1 + '...';
        }
    }

    function updateGameDisplay() {
        currentNumberDisplay.textContent = currentNumber;
    }

    function createCountButtons() {
        actionButtons.innerHTML = '';
        for (let i = 1; i <= maxCount; i++) {
            const nextNumber = currentNumber + i;
            if (nextNumber <= loseNumber) {
                const button = document.createElement('button');
                button.textContent = `+${i}`;
                button.onclick = () => {
                    myTurn = false;
                    conn.send({ type: 'move', count: i });
                    currentNumber = nextNumber;
                    updateGameDisplay();
                    turnInfo.textContent = 'กำลังรอตาของ ' + opponentName + '...';
                    actionButtons.innerHTML = '';
                    if (nextNumber === loseNumber) {
                        endGame(true);
                    }
                };
                actionButtons.appendChild(button);
            }
        }
    }

    function endGame(isLoser) {
        if (isLoser) {
            gameStatus.textContent = `คุณนับได้ ${loseNumber}... คุณแพ้!`;
        } else {
            gameStatus.textContent = `คู่ต่อสู้ของคุณนับได้ ${loseNumber}... คุณชนะ!`;
        }
        actionButtons.innerHTML = '';
        turnInfo.textContent = 'เกมจบแล้ว';
    }
</script>

</body>
</html>