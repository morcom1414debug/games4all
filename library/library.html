<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>ทายไหมพี่ เล่มนี้ใครแต่ง? - 1414Plus</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body {
    font-family: "Segoe UI", sans-serif;
    background: #fafafa;
    text-align: center;
    padding: 20px;
    margin: 0;
  }
  #game, #lobby, #room, #quiz, #result { display: none; }
  button {
    background: #4CAF50; color: white; border: none;
    padding: 10px 20px; margin: 5px; border-radius: 6px; cursor: pointer;
    font-size: 16px;
  }
  button:hover { background: #45a049; }
   
  button:disabled {
    background: #cccccc;
    color: #666666;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }
   
  input { padding: 8px; border-radius: 4px; border: 1px solid #ccc; width: 200px; }
  h1, h2, h3 { color: #333; }
  ul { list-style: none; padding: 0; }
  li { margin: 8px 0; background:#fff; padding:12px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }

  #backToMenuBtn {
    position: fixed;
    top: 15px;
    left: 15px;
    z-index: 9999;
    /* ไม่ซ่อนตั้งแต่เริ่มต้นอีกต่อไป */
  }
  #backToMenuBtn button {
    background: #f44336;
    padding: 12px 26px;
    font-weight: bold;
    border-radius: 50px;
    box-shadow: 0 4px 12px rgba(244,67,54,0.4);
    transition: all 0.3s;
  }
  #backToMenuBtn button:hover {
    background: #d32f2f;
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(244,67,54,0.5);
  }
</style>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
</head>
<body>
<h1 id="mainTitle" tabindex="0">ทายไหมพี่ เล่มนี้ใครแต่ง? - 1414Plus</h1>

<!-- ปุ่มกลับเมนูหลัก แสดงตั้งแต่เริ่มต้น -->
<div id="backToMenuBtn">
  <button onclick="window.location.href='../index.html'">กลับเมนูหลัก</button>
</div>

<div id="game">
  <div id="nameInput">
    <p>ขอท้าทายเพื่อนสมาชิกทุกคน ใครมั่นใจว่ารอบรู้หนังสือในระบบบริการของห้องสมุด<br>ตอบคำถามเกี่ยวกับหนังสือที่ทางห้องสมุดมีให้บริการ เพียงตั้งชื่อแล้ว<br>จะสร้างห้องใหม่หรือเข้าร่วมห้องที่มีเพื่อนสร้างไว้ก็ดี แต่ละรอบจะมีทั้งหมด 7 ข้อ<br>เล่นร่วมกันกับเพื่อนได้สูงสุด 20 คนหรือเล่นคนเดียวก็สร้างห้องและกดเริ่มเกมได้เลย</p>
    <input id="playerName" placeholder="ชื่อของคุณ" autofocus><br><br>
    <button onclick="confirmName()">ยืนยัน</button>
  </div>

  <div id="lobby">
    <h2 id="lobbyTitle" tabindex="0">ล็อบบี้</h2>
    <button onclick="showCreateRoom()">สร้างห้องใหม่</button>
    <h3>ห้องที่เปิดอยู่</h3>
    <ul id="roomList"></ul>
  </div>

  <div id="room">
    <h2 id="roomName" tabindex="0"></h2>
    <p>* คนที่สร้างห้อง กดเริ่มเกมได้คนเดียวเท่านั้น แต่ละข้อมีเวลา 15 วินาทีตายตัว<br>ครบ 15 วินาทีจะไปข้อถัดไปอัตโนมัติ ไม่ต้องรอให้ทุกคนตอบครบ<br>ถ้าตอบไม่ทันในข้อนั้น จะไม่ได้คะแนนในข้อนั้น<br>ตอนนี้มีผู้เล่นในห้องดังนี้:</p>
    <ul id="playerList"></ul>
    <button id="startBtn" onclick="startGame()">เริ่มเกม</button>
  </div>

  <div id="quiz">
    <h2 id="questionText" tabindex="0"></h2>
    <div id="options"></div>
    <p id="timer" style="font-size:18px; font-weight:bold; margin-top:20px; visibility:hidden; height:0; overflow:hidden;"></p>
  </div>

  <div id="result">
    <h2 id="resultHeading" tabindex="0">สรุปผล</h2>
    <ul id="scoreList"></ul>
    <button onclick="requestBackToLobby()">กลับไปเลือกห้องใหม่</button>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBIPeN4YUIrwM4MmFtDvT2DJ-v4toxc7tY",
  authDomain: "xo-game-134ec.firebaseapp.com",
  databaseURL: "https://xo-game-134ec-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "xo-game-134ec",
  storageBucket: "xo-game-134ec.firebasestorage.app",
  messagingSenderId: "318375224157",
  appId: "1:318375224157:web:144534f30a5c2f7cb77eb4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// === เพิ่มตามที่กำหนดเพื่อแยกเกม ===
const GAME_ID = "library01";                  // <--- เปลี่ยนเป็นชื่อเฉพาะของเกมนี้ (เช่น capital, flag, animal ฯลฯ)
const ROOMS_PATH = `games/${GAME_ID}/rooms`;
// ======================================

let playerName="", roomId="", playerId="", isHost=false;
let questionIndex=0, timerInterval, timeLeft=11, localAnswered=false;
let currentRoomListener=null, soundListener=null, lastSoundTime=0;
let lastQuestionText = "";
let waitLoopSource = null;
let isProcessingNext = false;

// ============== Web Audio API Setup ==============
let audioCtx = null;
const soundBuffers = {};

async function initAudioContext() {
  if (audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  
  const soundFiles = ["pop", "start", "friend", "door", "next", "new4", "wait"];
  
  await Promise.all(soundFiles.map(async (name) => {
    try {
      const response = await fetch(`audio/${name}.mp3`);
      const arrayBuffer = await response.arrayBuffer();
      const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
      soundBuffers[name] = audioBuffer;
    } catch (e) {
      console.warn(`Failed to load sound: ${name}.mp3`, e);
    }
  }));
}

function resumeAudioContext() {
  if (audioCtx && audioCtx.state !== 'running') {
    audioCtx.resume();
  }
}

function playSound(name) {
  if (!audioCtx || !soundBuffers[name]) return;
  resumeAudioContext();
  
  const source = audioCtx.createBufferSource();
  source.buffer = soundBuffers[name];
  source.connect(audioCtx.destination);
  source.start(0);
}

function startWaitLoop() {
  stopWaitLoop();
  if (!audioCtx || !soundBuffers["wait"]) return;
  resumeAudioContext();
  
  const source = audioCtx.createBufferSource();
  source.buffer = soundBuffers["wait"];
  source.loop = true;
  source.connect(audioCtx.destination);
  source.start(0);
  waitLoopSource = source;
}

function stopWaitLoop() {
  if (waitLoopSource) {
    waitLoopSource.stop();
    waitLoopSource = null;
  }
}

// ============== END Web Audio API ==============

const questions = [ /* คำถามทั้งหมดเหมือนเดิม ไม่เปลี่ยน */ 
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง แฮร์รี่ พอตเตอร์ กับ ศิลาอาถรรพ์ ?", options:["J.R. Ward","J. K. Rowling","J. R. R. Tolkien"], answer:1 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง บุพเพสันนิวาส ?", options:["รอมแพง","ทมยันตี","คาลิ"], answer:0 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง ปรมาจารย์ลัทธิมาร ?", options:["โม่เซียงถงซิ่ว","โก้วเล้ง","ต้าลี่จินกังจ่าง"], answer:0 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง เจาะเวลาหาโจโฉ ?", options:["โก้วเล้ง","โม่เหริน","เกิงซิน"], answer:2 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง Apsara สาปอัปสรา ?", options:["ภาคินัย","ชลาลัย","ทมยันตี"], answer:0 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง ฆาตกรรมบนรถด่วนโอเรียนท์เอกซ์เพรส ?", options:["Stephen King","Agatha Christie","Julia Quinn"], answer:1 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง กลับจากป่าช้า Pet Sematary ?", options:["Julia Quinn","Jack London","Stephen King"], answer:2 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง เสียงเพรียกจากพงไพร The Call of the Wild ?", options:["Julia Quinn","Jack London","J.R. Ward"], answer:1 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง H.A.C.K เจาะระบบ ไขรหัสมรณะ ?", options:["PDI.Lori","Enigma","MAME"], answer:1 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง รักนี้บังเอิญคือคุณ ?", options:["MAME","MTRD.s","PDI.Lori"], answer:0 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง โต๊ะโตะจัง เด็กหญิงข้างหน้าต่าง ?", options:["อายาสึจิ ยูกิโตะ","นากามุระ ซัตสึกิ","คุโรยานางิ เท็ตสึโกะ"], answer:2 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง KIRAKIRA เป็นประกาย ?", options:["ฟุคามิ เรอิจิโร","เอคุนิ คาโอริ","นากามุระ ซัตสึกิ"], answer:1 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง เด็กชายในชุดนอนลายทาง The Boy in the Striped Pyjamas ?", options:["Agatha Christie","Louis Sachar","John Boyne"], answer:2 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง ยอดพธูโจรสลัด ?", options:["เชียนซานฉาเค่อ","ต้าลี่จินกังจ่าง","เย่ว์ชูอวิ๋น"], answer:2 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง พิษสวาท ?", options:["ทมยันตี","ส. ศิวรักษ์","กิ่งฉัตร"], answer:0 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง ใบไม้ที่ปลิดปลิว ?", options:["ทมยันตี","ตรี อภิรุม","ดวงตะวัน"], answer:0 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง บริดเจอร์ตันนิรันดร The Bridgerton Happily Ever After ?", options:["Enid Blyton","Julia Quinn","Kass Morgan"], answer:1 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง มหากาพย์แห่งเหมาซาน ?", options:["ขวงซั่งจยาขวง","ต้าลี่จินกังจ่าง","ปู้จื่อซื่อเคอไช่"], answer:1 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง คุณชายพุฒิภัทร ?", options:["ร่มแก้ว","ซ่อนกลิ่น","เก้าแต้ม"], answer:2 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง ต้นส้มแสนรัก ?", options:["ส.โสมนิจ","José Vasconcelos","ฮิงาชิโนะ เคโงะ"], answer:1 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง ความสุขของกะทิ ?", options:["งามพรรณ เวชชาชีวะ","ชมัยภร แสงกระจ่าง","ประภัสสร เสวิกุล"], answer:0 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง พ่อมดมหัศจรรย์แห่งออซ ?", options:["Enid Blyton","L. Frank Baum","Pearl S. Buck"], answer:1 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง ลินลาน่ารัก ?", options:["ส. พลายน้อย","ก. สุรางคนางค์","ว. วินิจฉัยกุล"], answer:2 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง ชาร์ล็อตต์ แมงมุมเพื่อนรัก ?", options:["E. B. White","Pearl S. Buck","J. R. R. Tolkien"], answer:0 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง ย้อนเวลาขึ้นเป็นอ๋อง ?", options:["เยี่ยกวน","หวงอี้","เอ่อร์เกิน"], answer:0 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง สุดแค้นแสนรัก ?", options:["จุฬามณี","ฌาปนินทร์","เฟื่องณรี"], answer:0 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง วังเดียวดาย ?", options:["กิมย้ง","หมี่หลันเลดี้","มนต์มิถุนา"], answer:1 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง สิบคราวิวาห์วอน ?", options:["คุณชายรีวิวหนังสือ","ปากกาแดงดำ","@moment"], answer:0 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง ยุทธภพออนไลน์ ?", options:["ปากกาแดงดำ","คุณชายรีวิวหนังสือ","@moment"], answer:0 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง Alice's Adventures in Wonderland ?", options:["Rupert Kingfisher","Agatha Christie","Lewis Carroll"], answer:2 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง มหากาพย์เทพมรณะ ?", options:["โม่เหริน","ซ็อลบง","อุเก็ตสึ"], answer:1 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง ยอดยุทธ์พิทักษ์พิภพ ?", options:["หวงอี้","เฟิ่งเกอ","โม่เหริน"], answer:2 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง The Great Gatsby ?", options:["F. Scott Fitzgerald","J.D. Salinger","H. Rider Haggard"], answer:0 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง เดอะ ก๊อดฟาเธอร์ The Godfather ?", options:["James Patterson","Mario Puzo","Patrick Nobes"], answer:1 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง เพชรพระอุมา ?", options:["กรรัมภา","ดวงตะวัน","พนมเทียน"], answer:2 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง โรงงานช็อกโกแลตมหัศจรรย์ ?", options:["Enid Blyton","Roald Dahl","J. K. Rowling"], answer:1 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง Jays Day ?", options:["วีรันดา","เปเปอร์มิ้นท์","กัลฐิดา"], answer:2 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง สาวน้อยในตะเกียงแก้ว ?", options:["กฤษณา อโศกสิน","โสภี พรรณราย","ชมัยภร แสงกระจ่าง"], answer:1 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง สวรรค์ประทานพร ?", options:["โม่เซียงถงซิ่ว","ต้าลี่จินกังจ่าง","เชียนซานฉาเค่อ"], answer:0 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง กุ้ยเฟยขี้นินทา ?", options:["หม่าหย่งเฉิง","เฉียนลู่","ฮัวริเฟย"], answer:2 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง แดจังกึม จอมนางแห่งวังหลวง ?", options:["ยูมินจู","พัคโซยอง","โชนัมจู"], answer:0 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง เพอร์ซีย์ แจ็กสัน กับอาถรรพ์ทะเลปีศาจ ?", options:["Agatha Christie","L. Frank Baum","Rick Riordan"], answer:2 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง แรงเงา ?", options:["อุษณา เพลิงธรรม","วลัย นวาระ","นันทนา วีระชน"], answer:2 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง มองอย่าให้เห็น Bird Box ?", options:["Stephen King","Josh Malerman","Chris Carter"], answer:1 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง แก้วจอมแก่น ?", options:["เก็น กวี","กระทรวงศึกษาธิการ","แว่นแก้ว"], answer:2 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง ต้อยติ่งเด็กหญิงช่างฝัน ?", options:["เก็น กวี","ปราบดา หยุ่น","วิเชียร เกษประทุม"], answer:0 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง กระวานน้อยแรกรัก ?", options:["ปู้จื่อซื่อเคอไช่","จำลอง พิศนาคะ","อีเหมยถงเฉียน"], answer:0 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง คุนหนิง ?", options:["โก้วเล้ง","เฉียนลู่","ชิจิง"], answer:2 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง ตำนานแห่งพรีเดน ?", options:["Lloyd Alexander","Michael Crichton","John Steinbeck"], answer:0 },
  { q:"ใครเป็นผู้แต่งนิยายเรื่อง หงส์ฟ้าประกาศิต ?", options:["จิ่วลู่เฟยเซียง","อ้อเล้งเซ็ง","เตี่ยนซิน"], answer:1 }
];

// แสดงปุ่มกลับเมนูหลักตั้งแต่เริ่ม (ไม่ซ่อนอีกต่อไป)
document.getElementById("game").style.display="block";
document.getElementById("backToMenuBtn").style.display="block";

function triggerSound(name) {
  if (!roomId) return;
  const now = Date.now();
  if (now - lastSoundTime < 200) return;
  lastSoundTime = now;
  db.ref(`${ROOMS_PATH}/${roomId}/soundTrigger`).set({name, time: now});
  db.ref(`${ROOMS_PATH}/${roomId}/lastActivity`).set(now);
}

function startSoundListener() {
  if (soundListener) soundListener.off();
  if (!roomId) return;
  soundListener = db.ref(`${ROOMS_PATH}/${roomId}/soundTrigger`);
  soundListener.on("value", s => { 
    const d = s.val(); 
    if (d?.name) playSound(d.name); 
  });
}

function focusHeading(id) {
  requestAnimationFrame(() => setTimeout(() => {
    const el = document.getElementById(id);
    if (el) { el.setAttribute('tabindex', '-1'); el.focus(); }
  }, 150));
}

function focusQuestionIfChanged(newText) {
  if (newText !== lastQuestionText) {
    lastQuestionText = newText;
    document.getElementById("questionText").textContent = newText;
    focusHeading("questionText");
  }
}

function shuffleArray(arr) {
  for (let i = arr.length-1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

async function confirmName() {
  playerName = document.getElementById("playerName").value.trim();
  if (!playerName) { alert("กรุณาใส่ชื่อ"); return; }
  playerId = Math.random().toString(36).substr(2,9);
  document.getElementById("nameInput").style.display = "none";
  document.getElementById("lobby").style.display = "block";
  focusHeading("lobbyTitle");
   
  await initAudioContext();
   
  loadRooms();
}

function loadRooms() {
  const list = document.getElementById("roomList");
  db.ref(ROOMS_PATH).on("value", snap => {
    list.innerHTML = "";
    const now = Date.now();

    snap.forEach(r => {
      const room = r.val();
      const roomKey = r.key;
      const playerCount = room.players ? Object.keys(room.players).length : 0;

      const lastActivity = room.lastActivity || room.created || 0;
      if (now - lastActivity > 600000) {
        db.ref(`${ROOMS_PATH}/${roomKey}`).remove();
        return;
      }

      if (playerCount === 0 && room.created && (now - room.created > 3000)) {
        db.ref(`${ROOMS_PATH}/${roomKey}`).remove();
        return;
      }

      if (room.status === "waiting" && playerCount > 0) {
        const li = document.createElement("li");
        li.innerHTML = `${room.name} (${playerCount} คน)`;
        const btn = document.createElement("button");
        btn.textContent = "เข้าร่วม";
        btn.onclick = () => joinRoom(roomKey);
        li.appendChild(btn);
        list.appendChild(li);
      }
    });
  });
}

function showCreateRoom() {
  const name = prompt("ตั้งชื่อห้อง:");
  if (!name) return;
  const ref = db.ref(ROOMS_PATH).push();
  roomId = ref.key; isHost = true;
  ref.set({
    name, 
    status:"waiting", 
    host:playerId, 
    created:Date.now(),
    lastActivity: Date.now(),
    players:{}
  });
  joinRoom(roomId);
}

function joinRoom(id) {
  db.ref(`${ROOMS_PATH}/${id}`).once("value").then(snap => {
    const room = snap.val();
    const playerCount = room.players ? Object.keys(room.players).length : 0;
    if (playerCount >= 20) {
      alert("ห้องนี้มีผู้เล่นครบ 20 คนแล้ว ไม่สามารถเข้าร่วมได้");
      return;
    }
    roomId = id;
    const ref = db.ref(`${ROOMS_PATH}/${roomId}/players/${playerId}`);
    ref.set({name:playerName, score:0, answered:false});
    ref.onDisconnect().remove();
    db.ref(`${ROOMS_PATH}/${roomId}/lastJoin`).set(Date.now());
    db.ref(`${ROOMS_PATH}/${roomId}/lastActivity`).set(Date.now());
    showRoom();
  });
}

function showRoom() {
  document.getElementById("lobby").style.display = "none";
  document.getElementById("room").style.display = "block";
  document.getElementById("backToMenuBtn").style.display = "block"; // แสดงปุ่มเมื่อเข้าห้อง
  focusHeading("roomName");
  startSoundListener();

  if (currentRoomListener) currentRoomListener.off();
  currentRoomListener = db.ref(`${ROOMS_PATH}/${roomId}`);
  currentRoomListener.on("value", snap => {
    const room = snap.val();
    if (!room) { alert("ห้องถูกลบแล้ว"); backToLobby(); return; }

    document.getElementById("roomName").textContent = `ห้อง: ${room.name}`;
    const list = document.getElementById("playerList"); list.innerHTML = "";
    if (room.players) {
      for (let id in room.players) {
        const li = document.createElement("li");
        li.textContent = `${room.players[id].name} (${room.players[id].score||0} คะแนน)`;
        list.appendChild(li);
      }
    }
    document.getElementById("startBtn").style.display = (room.host === playerId) ? "inline" : "none";

    if (room.lastJoin && room.lastJoin !== window._lastJoinTime) {
      window._lastJoinTime = room.lastJoin;
      playSound("friend"); 
    }
    if (room.lastBackToLobby && room.lastBackToLobby !== window._lastBackTime) {
      window._lastBackTime = room.lastBackToLobby;
      triggerSound("door");
    }

    if (room.status === "playing") {
        const incomingIndex = room.current ?? 0;

        if (room.questions && room.questions[incomingIndex]) {
          questionIndex = incomingIndex;

          document.getElementById("lobby").style.display = "none";
          document.getElementById("room").style.display = "none";
          document.getElementById("quiz").style.display = "block";
          document.getElementById("mainTitle").style.display = "none";
          document.getElementById("backToMenuBtn").style.display = "block"; // แสดงตอนเล่น

          showQuestion(room.questions[questionIndex]);
        }

        if (room.players && room.players[playerId] && room.players[playerId].answered === true) {
             localAnswered = true;
             const allBtns = document.querySelectorAll("#options button");
             allBtns.forEach(btn => btn.disabled = true);
        } else if (room.players && room.players[playerId]) {
             localAnswered = false;
        }
    }
    else if (room.status === "finished" && room.phase === "finished") {
      stopWaitLoop();
      showResult(room);
      document.getElementById("backToMenuBtn").style.display = "block"; // แสดงตอนสรุปผล
    }
  });
}

function startGame() {
  triggerSound("start");
  const randomQs = getRandomQuestions(7);
  db.ref(`${ROOMS_PATH}/${roomId}`).update({
    status: "playing",
    current: 0,
    questions: randomQs,
    lastActivity: Date.now(),
    phase: "playing"
  }).then(() => {
    questionIndex = 0;
    document.getElementById("lobby").style.display = "none";
    document.getElementById("room").style.display = "none";
    document.getElementById("quiz").style.display = "block";
    document.getElementById("mainTitle").style.display = "none";
    document.getElementById("backToMenuBtn").style.display = "block";
    showQuestion(randomQs[0]);
  }).catch(err => {
    console.error("Error starting game:", err);
    alert("เกิดข้อผิดพลาดในการเริ่มเกม กรุณาลองใหม่");
  });
}

function getRandomQuestions(n) {
  const copy = questions.map(q => ({...q, options: [...q.options]}));
  const res = [];
  for (let i = 0; i < n; i++) {
    const idx = Math.floor(Math.random() * copy.length);
    let q = copy.splice(idx, 1)[0];
    const opts = [...q.options];
    const correctText = opts[q.answer];
    shuffleArray(opts);
    q.answer = opts.indexOf(correctText);
    q.options = opts;
    res.push(q);
  }
  return res;
}

function showQuestion(q) {
  if (!q) return;

  localAnswered = false;
  timeLeft = 11;

  const newText = `ข้อที่ ${questionIndex + 1}: ${q.q}`;
  const delay = (questionIndex === 0) ? 600 : 200;
  setTimeout(() => {
    focusQuestionIfChanged(newText);
  }, delay);

  const container = document.getElementById("options");
  container.innerHTML = "";
  const correctText = q.options[q.answer];

  q.options.forEach((opt, i) => {
    const btn = document.createElement("button");
    btn.textContent = opt;
    btn.onclick = () => submitAnswer(opt === correctText);
    container.appendChild(btn);
  });

  document.getElementById("timer").textContent = `เวลา: ${timeLeft} วินาที`; 
  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    timeLeft--;
    document.getElementById("timer").textContent = `เวลา: ${timeLeft} วินาที`; 
    
    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      if (isHost && !isProcessingNext) {
        isProcessingNext = true;
        prepareNextQuestion();
      }
    }
  }, 1000);
}

function submitAnswer(isCorrect) {
  if (localAnswered) return;
  localAnswered = true;

  const allBtns = document.querySelectorAll("#options button");
  allBtns.forEach(btn => btn.disabled = true);

  playSound("pop");

  const roomRef = db.ref(`${ROOMS_PATH}/${roomId}/players/${playerId}`);
  roomRef.transaction(p => {
    if (!p || p.answered) return p;
    p.answered = true;
    if (isCorrect) {
      p.score = (p.score || 0) + 1;
    }
    return p;
  });
}

function prepareNextQuestion() {
  clearInterval(timerInterval);
  
  const isLastQuestion = questionIndex >= 6;
  
  if (isLastQuestion) {
    triggerSound("new4");
    startWaitLoop();
    db.ref(`${ROOMS_PATH}/${roomId}`).update({ phase: "endingSound" });
    setTimeout(advanceToNextQuestion, 2500);
  } else {
    triggerSound("next");
    setTimeout(advanceToNextQuestion, 1200);
  }
}

function advanceToNextQuestion() {
  const roomRef = db.ref(`${ROOMS_PATH}/${roomId}`);
  roomRef.transaction(room => {
    if (!room || room.status !== "playing") return room;

    const totalQ = (room.questions || []).length;
    const nextIndex = (room.current || 0) + 1;

    if (nextIndex >= totalQ) {
      room.status = "finished";
      room.phase = "finished";
      let playersArr = [];
      if (room.players) {
        playersArr = Object.values(room.players);
        playersArr.sort((a,b) => (b.score||0) - (a.score||0));
      }
      const max = playersArr.length > 0 ? (playersArr[0].score || 0) : 0;
      const winners = playersArr.filter(p => (p.score||0) === max).map(p => p.name);
      room.result = { winners, players: playersArr };
    } else {
      room.current = nextIndex;
      if (room.players) {
        Object.keys(room.players).forEach(k => {
          room.players[k].answered = false;
        });
      }
    }

    room.lastActivity = Date.now();
    return room;
  }, () => {
    isProcessingNext = false;
  });
}

function showResult(roomData) {
  clearInterval(timerInterval);
  stopWaitLoop(); 
  document.getElementById("quiz").style.display = "none";
  document.getElementById("result").style.display = "block";
  document.getElementById("mainTitle").style.display = "none";
  document.getElementById("backToMenuBtn").style.display = "block";

  const list = document.getElementById("scoreList");
  list.innerHTML = "";
  const players = roomData.result?.players || [];
  const winners = roomData.result?.winners || [];
  document.getElementById("resultHeading").textContent = `สรุปผล ผู้ชนะคือ ${winners.join(", ")}`;

  players.forEach(p => {
    const li = document.createElement("li");
    li.textContent = `${p.name}: ${p.score} คะแนน`;
    list.appendChild(li);
  });
  focusHeading("resultHeading");
}

function requestBackToLobby() {
  triggerSound("door");
  db.ref(`${ROOMS_PATH}/${roomId}/lastBackToLobby`).set(Date.now());
  backToLobby();
}

function backToLobby() {
  if (currentRoomListener) { currentRoomListener.off(); currentRoomListener = null; }
  if (soundListener) { soundListener.off(); soundListener = null; }
  stopWaitLoop(); 
  if (roomId && playerId) {
    db.ref(`${ROOMS_PATH}/${roomId}/players/${playerId}`).remove();
  }
  roomId = ""; questionIndex = 0; lastQuestionText = "";
  document.getElementById("result").style.display = "none";
  document.getElementById("room").style.display = "none";
  document.getElementById("quiz").style.display = "none";
  document.getElementById("mainTitle").style.display = "block";
  document.getElementById("lobby").style.display = "block";
  document.getElementById("backToMenuBtn").style.display = "block"; // แสดงปุ่มเมื่อกลับมาล็อบบี้
  focusHeading("lobbyTitle");
  loadRooms();
}
</script>
</body>
</html>