<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏Å‡∏° X-O ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; color: #2d3748; }
        .container { background-color: #ffffff; border-radius: 1.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); padding: 2.5rem; max-width: 500px; width: 100%; text-align: center; display: flex; flex-direction: column; gap: 1.5rem;}
        .title { font-size: 2.5rem; font-weight: 700; color: #4a5568; margin-bottom: 1.5rem;}
        .mode-selection button { background-color: #4299e1; color: white; padding: 1rem 2rem; border-radius: 0.75rem; font-weight: 600; transition: background-color 0.3s ease; cursor: pointer; border: none; width: 100%; margin-bottom: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);}
        .mode-selection button:hover { background-color: #3182ce;}
        .game-info { font-size: 1.25rem; font-weight: 600; color: #2b6cb0; min-height: 2rem;}
        .board { display: grid; grid-template-columns: repeat(3, 1fr); grid-gap: 0.75rem; width: 100%; max-width: 350px; margin: 0 auto;}
        .board button { background-color: #edf2f7; border: 2px solid #cbd5e0; border-radius: 0.75rem; width: 100px; height: 100px; display: flex; justify-content: center; align-items: center; font-size: 2.5rem; font-weight: 700; cursor: pointer; transition: background-color 0.3s ease, transform 0.1s ease; color: #2d3748; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);}
        .board button:not([data-player]):hover { background-color: #e2e8f0; transform: scale(1.02);}
        .board button[data-player="X"] { color: #e53e3e;}
        .board button[data-player="O"] { color: #38b2ac;}
        .game-control button { background-color: #ecc94b; color: #333; padding: 1rem 2rem; border-radius: 0.75rem; font-weight: 600; transition: background-color 0.3s ease; cursor: pointer; border: none; margin-top: 1.5rem; width: 100%; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);}
        .game-control button:hover { background-color: #d69e2e;}
        .hidden { display: none;}
        #roomList .room-item { display:flex; align-items:center; justify-content:space-between; padding:2px 0;}
        #roomList .joinRoomListBtn { margin-left:1rem;}
        .room-action { margin-left: 0.5rem;}
        .exit-room-btn { background: #e53e3e; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; border: none; cursor:pointer; transition: background 0.2s;}
        .exit-room-btn:hover { background: #c53030;}
        @media (max-width: 600px) {
            .container { padding: 1.5rem;}
            .title { font-size: 2rem;}
            .mode-selection button, .game-control button { padding: 0.75rem 1.5rem;}
            .board button { width: 90px; height: 90px; font-size: 2rem;}
            .board { max-width: 300px;}
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">‡πÄ‡∏Å‡∏° X-O</h1>

        <div id="modeSelectionScreen" class="mode-selection">
            <button id="singlePlayerBtn">‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡πÅ‡∏Ç‡πà‡∏á‡∏Å‡∏±‡∏ö‡∏ö‡∏≠‡∏ó)</button>
            <button id="twoPlayersBtn">‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</button>
            <button id="onlineBtn">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</button>
        </div>

        <!-- Online lobby (only room list and create room input) -->
        <div id="onlineLobby" class="hidden flex flex-col gap-4 items-center">
            <div class="flex flex-col w-full gap-2">
                <div class="flex gap-2 items-center mb-2">
                    <input type="text" id="createRoomInput" placeholder="‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á/‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á (a-z, 0-9)" class="border p-2 rounded flex-1 text-center">
                    <button id="createOnlineGameBtn" class="bg-green-500 hover:bg-green-600 text-white py-2 px-3 rounded">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>
                </div>
            </div>
            <div id="roomList" class="mt-4 mb-1 flex flex-col gap-1"></div>
            <button class="text-gray-600 text-xs underline mt-2" onclick="showMainMenu()">‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
            <div id="lobbyStatus" class="text-yellow-600 mt-1"></div>
        </div>

        <div id="gameScreen" class="hidden">
            <div id="gameInfo" class="game-info"></div>
            <div id="scoreDisplay" class="game-info mt-4"></div>
            <div class="board" id="gameBoard"></div>
            <div class="game-control flex flex-col gap-2">
                <button id="newGameBtn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà</button>
                <button id="exitRoomBtn" class="exit-room-btn hidden">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ</button>
				<button id="backToMenuBtn" class="text-gray-600 text-xs underline mt-2 hidden">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà</button>
            </div>
        </div>
    </div>
    <script>
// ----------------- Config & State -----------------
const firebaseConfig = {
    apiKey: "AIzaSyDcSVVxhzYOgo-pnJaFv_yYLkUZKEw02W8",
    authDomain: "joe-xo.firebaseapp.com",
    databaseURL: "https://joe-xo-default-rtdb.asia-southeast1.firebasedatabase.app/",
    projectId: "joe-xo",
    storageBucket: "joe-xo.firebasestorage.app",
    messagingSenderId: "101765403300",
    appId: "1:101765403300:web:47a44ac0ceb281f5228c31"
};
firebase.initializeApp(firebaseConfig);
const rtdb = firebase.database();

let board = ['', '', '', '', '', '', '', '', ''];
let currentPlayer = 'X';
let gameActive = false;
let gameMode = null;
let firstPlayerForNextRound = 'X';
let xScore = 0, oScore = 0, round = 0;
const maxRounds = 3;
let onlineRoomId = null;
let onlineUnsub = null;
let onlinePlayer = null;

// UI elements
const modeSelectionScreen = document.getElementById('modeSelectionScreen');
const gameScreen = document.getElementById('gameScreen');
const gameInfo = document.getElementById('gameInfo');
const scoreDisplay = document.getElementById('scoreDisplay');
const gameBoard = document.getElementById('gameBoard');
const singlePlayerBtn = document.getElementById('singlePlayerBtn');
const twoPlayersBtn = document.getElementById('twoPlayersBtn');
const onlineBtn = document.getElementById('onlineBtn');
const newGameBtn = document.getElementById('newGameBtn');
const onlineLobby = document.getElementById('onlineLobby');
const createOnlineGameBtn = document.getElementById('createOnlineGameBtn');
const createRoomInput = document.getElementById('createRoomInput');
const lobbyStatus = document.getElementById('lobbyStatus');
const roomListDiv = document.getElementById('roomList');
const exitRoomBtn = document.getElementById('exitRoomBtn');
const backToMenuBtn = document.getElementById('backToMenuBtn');
// handler ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ
backToMenuBtn.addEventListener('click', showMainMenu);

// ----------------- Sound -----------------
const audioQueue = [];
let isAudioPlaying = false;
function playAudio(soundFile) {
    audioQueue.push(soundFile); processAudioQueue();
}
function processAudioQueue() {
    if (audioQueue.length === 0 || isAudioPlaying) return;
    isAudioPlaying = true;
    const soundFile = audioQueue.shift();
    const audio = new Audio(soundFile);
    audio.addEventListener('ended', () => {
        isAudioPlaying = false;
        processAudioQueue();
    });
    const audioPromise = audio.play();
    if (audioPromise !== undefined) audioPromise.catch(() => {
        isAudioPlaying = false; processAudioQueue();
    });
}
function playMoveSound(player, idx) { playAudio(`${player.toLowerCase()}${idx + 1}.ogg`); }
function playRoundResultSound(result) { playAudio(`${result}.ogg`); }
function playFinalResultSound(result) { playAudio(`${result}.ogg`); }

// ----------------- Board Rendering -----------------
function initializeBoard() {
    gameBoard.innerHTML = '';
    for (let i = 0; i < 9; i++) {
        const button = document.createElement('button');
        button.dataset.index = i;
        button.textContent = `‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà${i + 1}`;
        button.classList.add('transition', 'duration-300');
        button.addEventListener('click', handleCellClick);
        gameBoard.appendChild(button);
        board[i] = '';
    }
}
function renderOnlineBoard() {
    for (let i = 0; i < 9; i++) {
        const btn = gameBoard.children[i];
        if (!btn) continue;
        btn.textContent = board[i] ? board[i] : `‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà${i + 1}`;
        btn.dataset.player = board[i] ? board[i] : '';
    }
}

// ----------------- Lobby Room List -----------------
let roomListDBListener = null;
function startRoomListListener() {
    stopRoomListListener();
    roomListDiv.innerHTML = "<div class='font-bold text-gray-900 mb-2'>‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</div>";
    const ref = rtdb.ref('xomultiplayer');
    roomListDBListener = ref.on('value', snapshot => {
        roomListDiv.innerHTML = "<div class='font-bold text-gray-900 mb-2'>‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</div>";
        const rooms = snapshot.val() || {};
        let anyRoom = false;
        const now = Date.now();
        Object.keys(rooms).forEach(roomCode => {
            const room = rooms[roomCode];
            // ‡∏ñ‡πâ‡∏≤ lastActive ‡πÑ‡∏°‡πà‡∏°‡∏µ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô 5 ‡∏ô‡∏≤‡∏ó‡∏µ ‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á
            if (!room.lastActive || (now - room.lastActive > 5 * 60 * 1000)) {
                rtdb.ref('xomultiplayer/' + roomCode).remove();
                return;
            }
            if (room.players && room.players.X === true && room.players.O !== true) {
                anyRoom = true;
                roomListDiv.innerHTML += `
                <div class="room-item border-b">
                    <span class="mr-2 font-mono">${roomCode}</span>
                    <button class="px-4 py-1.5 bg-sky-500 text-white rounded hover:bg-sky-600 joinRoomListBtn" data-room="${roomCode}">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</button>
                </div>`;
            }
        });
        if (!anyRoom) roomListDiv.innerHTML += `<div class="text-gray-400 text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á</div>`;
        document.querySelectorAll('.joinRoomListBtn').forEach(btn => {
            btn.onclick = async () => {
                const code = btn.dataset.room;
                joinOnlineGameBtnFromList(code);
            };
        });
    });
}
function stopRoomListListener() {
    if (roomListDBListener) {
        rtdb.ref('xomultiplayer').off('value', roomListDBListener);
        roomListDBListener = null;
    }
}

// --------- Leave room logic ----------
async function leaveRoomCleanup(removeRoom = false) {
    if (!onlineRoomId || !onlinePlayer) return;
    try {
        const playersRef = rtdb.ref('xomultiplayer/' + onlineRoomId + '/players');
        await rtdb.ref('xomultiplayer/' + onlineRoomId + '/players/' + onlinePlayer).set(null);
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤
        await rtdb.ref('xomultiplayer/' + onlineRoomId).update({lastActive: Date.now()});
        playersRef.once('value', snap => {
            const val = snap.val();
            if (!val || (val.X == null && val.O == null)) {
                rtdb.ref('xomultiplayer/' + onlineRoomId).remove();
            }
            else if (removeRoom) {
                rtdb.ref('xomultiplayer/' + onlineRoomId).remove();
            }
        });
    } catch (e) {}
    onlineRoomId = null;
    onlinePlayer = null;
}
window.addEventListener('beforeunload', () => leaveRoomCleanup(true));


// ----------- XO online sync+sound --------------
let prevBoardOnline = null;
let prevStateOnline = null;
let prevScoresOnline = null;
let prevRoundOnline = null;

function listenOnlineRoom() {
    const ref = rtdb.ref('xomultiplayer/' + onlineRoomId);
    if (onlineUnsub) onlineUnsub.off();
    onlineUnsub = ref;
    ref.on('value', (snap) => {
        if (!snap.exists()) {
            alert('‡∏´‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏');
            showMainMenu();
            return;
        }
        const data = snap.val();
        const newBoard = (data && data.board) ? data.board : ['', '', '', '', '', '', '', '', ''];
        const newScores = (data && data.scores) ? { ...data.scores } : { X: 0, O: 0 };
        const newState = data && data.state;
        const newRound = data && typeof data.round === 'number' ? data.round : 0;

        // ----playMoveSound: ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≠‡∏á XO ‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏´‡∏°‡πà----
        if (prevBoardOnline) {
            for (let i = 0; i < 9; i++) {
                if (prevBoardOnline[i] !== newBoard[i] && newBoard[i] !== '') {
                    playMoveSound(newBoard[i], i);
                }
            }
        }

        // ----playRoundResultSound: Win/Draw ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô----
        if (
            prevRoundOnline !== null &&
            newRound > prevRoundOnline
        ) {
            // Draw
            if (data.roundResult === 'draw') {
                playRoundResultSound('xodraw');
            }
            // Win
            if (data.roundResult === 'Xwin') {
                playRoundResultSound('xwin');
            }
            if (data.roundResult === 'Owin') {
                playRoundResultSound('owin');
            }
        }

        // ----playFinalResultSound: ‡∏à‡∏ö‡πÄ‡∏Å‡∏°----
        if (prevStateOnline && prevStateOnline !== "ended" && newState === "ended") {
            if (newScores.X > newScores.O) playFinalResultSound('endx');
            else if (newScores.O > newScores.X) playFinalResultSound('endo');
            else playFinalResultSound('enddraw');
        }

        prevBoardOnline = newBoard.slice();
        prevStateOnline = newState;
        prevScoresOnline = { ...newScores };
        prevRoundOnline = newRound;

        board = newBoard;
        xScore = typeof newScores.X === 'number' ? newScores.X : 0;
        oScore = typeof newScores.O === 'number' ? newScores.O : 0;
        round = newRound;
        currentPlayer = data && data.currentPlayer ? data.currentPlayer : 'X';
        firstPlayerForNextRound = data && data.firstPlayer ? data.firstPlayer : 'X';
        gameActive = data && data.state === 'playing';
        renderOnlineBoard();
        updateScoreDisplay();

        if (!data.players || !data.players.X || !data.players.O) {
            updateGameInfo('‡∏£‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏ô...');
            return;
        }
        if (data && data.state === 'ended') {
            let msg = '';
            if (xScore > oScore) msg = '‡∏à‡∏ö‡πÄ‡∏Å‡∏°! X ‡∏ä‡∏ô‡∏∞ üéâ';
            else if (oScore > xScore) msg = '‡∏à‡∏ö‡πÄ‡∏Å‡∏°! O ‡∏ä‡∏ô‡∏∞ üéâ';
            else msg = '‡∏à‡∏ö‡πÄ‡∏Å‡∏°! ‡πÄ‡∏™‡∏°‡∏≠‡∏Å‡∏±‡∏ô ü§ù';
            updateGameInfo(msg);
            return;
        }
        // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• draw ‡πÉ‡∏ô UI
        if (data.roundResult === 'draw') {
            updateGameInfo('‡πÄ‡∏™‡∏°‡∏≠! ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞‡πÉ‡∏ô‡∏¢‡∏Å‡∏ô‡∏µ‡πâ ü§ù');
        } else if (!board.includes('')) {
            updateGameInfo('‡πÄ‡∏™‡∏°‡∏≠! ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞‡πÉ‡∏ô‡∏¢‡∏Å‡∏ô‡∏µ‡πâ ü§ù');
        } else {
            updateGameInfo(
                currentPlayer === onlinePlayer
                    ? '‡∏ñ‡∏∂‡∏á‡∏ï‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß!' : '‡∏£‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏ô'
            );
        }
    });
}

// ----------- XO local/game logic --------------
function updateGameInfo(message) { gameInfo.textContent = message; }
function updateScoreDisplay() {
    scoreDisplay.textContent = `‡∏¢‡∏Å‡∏ó‡∏µ‡πà ${round} | ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: X: ${xScore} - O: ${oScore}`;
}
function resetRound() {
    board = ['', '', '', '', '', '', '', '', ''];
    currentPlayer = firstPlayerForNextRound;
    gameActive = true;
    initializeBoard();
    updateGameInfo(`‡∏ï‡∏≤‡∏Ç‡∏≠‡∏á: ${currentPlayer}`);
    if (gameMode === 'singlePlayer' && currentPlayer === 'O') setTimeout(botMove, 500);
}
function switchPlayer() {
    currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
    updateGameInfo(`‡∏ï‡∏≤‡∏Ç‡∏≠‡∏á: ${currentPlayer}`);
}
function checkResult() {
    let roundWon = false;
    const winningConditions = [
        [0, 1, 2], [3, 4, 5], [6, 7, 8],
        [0, 3, 6], [1, 4, 7], [2, 5, 8],
        [0, 4, 8], [2, 4, 6]
    ];
    for (let i = 0; i < winningConditions.length; i++) {
        const [a, b, c] = winningConditions[i];
        if (board[a] === '' || board[b] === '' || board[c] === '') continue;
        if (board[a] === board[b] && board[b] === board[c]) {
            roundWon = true; break;
        }
    }
    if (roundWon) {
        gameActive = false;
        if (currentPlayer === 'X') { xScore++; playRoundResultSound('xwin'); updateGameInfo(`X ‡∏ä‡∏ô‡∏∞‡πÉ‡∏ô‡∏¢‡∏Å‡∏ô‡∏µ‡πâ! üéâ`);}
        else { oScore++; playRoundResultSound('owin'); updateGameInfo(`O ‡∏ä‡∏ô‡∏∞‡πÉ‡∏ô‡∏¢‡∏Å‡∏ô‡∏µ‡πâ! üéâ`);}
        setTimeout(handleRoundEnd, 2000);
        return;
    }
    if (!board.includes('')) {
        gameActive = false;
        updateGameInfo('‡πÄ‡∏™‡∏°‡∏≠! ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞‡πÉ‡∏ô‡∏¢‡∏Å‡∏ô‡∏µ‡πâ ü§ù');
        playRoundResultSound('xodraw');
        setTimeout(handleRoundEnd, 2000);
        return;
    }
}
function handleRoundEnd() {
    round++;
    updateScoreDisplay();
    firstPlayerForNextRound = firstPlayerForNextRound === 'X' ? 'O' : 'X';
    if (round >= maxRounds) handleGameEnd();
    else {
        updateGameInfo('‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏Å‡∏ï‡πà‡∏≠‡πÑ‡∏õ!');
        setTimeout(gameMode === 'online' ? resetOnlineRound : resetRound, 1500);
    }
}
function handleGameEnd() {
    let finalMessage = '';
    if (xScore > oScore) { finalMessage = '‡∏à‡∏ö‡πÄ‡∏Å‡∏°! X ‡∏ä‡∏ô‡∏∞ üéâ'; playFinalResultSound('endx'); }
    else if (oScore > xScore) { finalMessage = '‡∏à‡∏ö‡πÄ‡∏Å‡∏°! O ‡∏ä‡∏ô‡∏∞ üéâ'; playFinalResultSound('endo'); }
    else { finalMessage = '‡∏à‡∏ö‡πÄ‡∏Å‡∏°! ‡πÄ‡∏™‡∏°‡∏≠‡∏Å‡∏±‡∏ô ü§ù'; playFinalResultSound('enddraw'); }
    updateGameInfo(finalMessage);
    if (gameMode === 'online') publishOnlineGameEnd();
}
function botMove() {
    if (!gameActive) return;
    let bestMove = -1;
    const winningConditions = [
        [0,1,2],[3,4,5],[6,7,8],
        [0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]
    ];
    for (let i=0;i<winningConditions.length;i++) {
        const [a,b,c] = winningConditions[i];
        if (board[a] === 'O' && board[b] === 'O' && board[c]==='') {bestMove=c;break;}
        if (board[a] === 'O' && board[c] === 'O' && board[b]==='') {bestMove=b;break;}
        if (board[b] === 'O' && board[c] === 'O' && board[a]==='') {bestMove=a;break;}
    }
    if (bestMove === -1)
    for (let i=0;i<winningConditions.length;i++) {
        const [a,b,c] = winningConditions[i];
        if (board[a] === 'X' && board[b] === 'X' && board[c]==='') {bestMove=c;break;}
        if (board[a] === 'X' && board[c] === 'X' && board[b]==='') {bestMove=b;break;}
        if (board[b] === 'X' && board[c] === 'X' && board[a]==='') {bestMove=a;break;}
    }
    if (bestMove===-1 && board[4]==='') bestMove=4;
    if (bestMove===-1) {
        const corners=[0,2,6,8]; for (const c of corners) { if (board[c]==='') {bestMove=c;break;}}
    }
    if (bestMove===-1) {
        const edges=[1,3,5,7]; for (const e of edges) { if (board[e]==='') {bestMove=e;break;}}
    }
    if (bestMove===-1) {
        let av=[]; for(let i=0;i<board.length;i++){if(board[i]===''){av.push(i);}}
        if(av.length>0)bestMove=av[Math.floor(Math.random()*av.length)];
    }
    if (bestMove !== -1) {
        const botCell = gameBoard.children[bestMove];
        board[bestMove] = 'O';
        botCell.textContent = 'O';
        botCell.dataset.player = 'O';
        playMoveSound('O', bestMove);
        checkResult();
        if (gameActive) switchPlayer();
    }
}

function handleCellClick(event) {
    const idx = parseInt(event.target.dataset.index, 10);
    if (board[idx] !== '' || !gameActive) return;
    if (gameMode === 'online') {
        if (!onlinePlayer || currentPlayer !== onlinePlayer) return;
        board[idx] = onlinePlayer;
        publishOnlineMove(idx, onlinePlayer);
    } else {
        board[idx] = currentPlayer;
        event.target.textContent = currentPlayer;
        event.target.dataset.player = currentPlayer;
        playMoveSound(currentPlayer, idx);
        checkResult();
        if (gameActive) {
            switchPlayer();
            if (gameMode === 'singlePlayer' && currentPlayer === 'O') setTimeout(botMove, 500);
        }
    }
}

// ------------- Mode selection/flow -------------
singlePlayerBtn.addEventListener('click', () => { handleModeSelection('singlePlayer'); });
twoPlayersBtn.addEventListener('click', () => { handleModeSelection('twoPlayers'); });
onlineBtn.addEventListener('click', showOnlineLobby);

function handleModeSelection(mode) {
    playAudio('bell.ogg');
    startNewGame(mode);
}
function startNewGame(mode) {
    gameMode = mode;
    modeSelectionScreen.classList.add('hidden');
    gameScreen.classList.remove('hidden');
    xScore = 0; oScore = 0; round = 0; updateScoreDisplay();
    firstPlayerForNextRound = (mode === 'singlePlayer') ? (Math.random() < 0.5 ? 'X' : 'O') : 'X';
    initializeBoard();
    resetRound();
    exitRoomBtn.classList.add('hidden');
	if (mode === 'online') {
        backToMenuBtn.classList.add('hidden');
    } else {
        backToMenuBtn.classList.remove('hidden');
    }
}

initializeBoard();

function showMainMenu() {
    modeSelectionScreen.classList.remove('hidden');
    gameScreen.classList.add('hidden');
    onlineLobby.classList.add('hidden');
    if (onlineUnsub) onlineUnsub.off();
    onlinePlayer = null;
    onlineRoomId = null;
    lobbyStatus.textContent = '';
    initializeBoard();
    exitRoomBtn.classList.add('hidden');
	backToMenuBtn.classList.add('hidden');
}
window.showOnlineLobby = showOnlineLobby; // Ensure available for onclick/global

function showOnlineLobby() {
    modeSelectionScreen.classList.add('hidden');
    gameScreen.classList.add('hidden');
    onlineLobby.classList.remove('hidden');
    lobbyStatus.textContent = '';
    createRoomInput.value = '';
    if (onlineUnsub) onlineUnsub.off();
    onlinePlayer = null;
    onlineRoomId = null;
    startRoomListListener();
}

// ----------------- Online Room logic -----------------
function randomRoomCode() {
    return Math.random().toString(36).substring(2, 8).toUpperCase();
}
async function createOnlineRoomWithInput() {
    let code = createRoomInput.value.trim().toUpperCase();
    code = code.replace(/[^A-Z0-9]/g, '').substring(0,12);
    if (!code) { code = randomRoomCode(); }

    const ref = rtdb.ref('xomultiplayer/' + code);
    const snap = await ref.get();
    const now = Date.now();
    if (snap.exists()) {
        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏° ‡∏ï‡∏£‡∏ß‡∏à lastActive ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô
        const data = snap.val();
        const noPlayers = !data.players || (!data.players.X && !data.players.O);
        const oldRoom = !data.lastActive || (now - data.lastActive > 5*60*1000);
        if (noPlayers || oldRoom) {
            await ref.remove(); // ‡∏•‡∏ö‡∏ó‡∏¥‡πâ‡∏á
        } else {
            lobbyStatus.textContent = '‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∑‡πà‡∏ô';
            createOnlineGameBtn.disabled = false;
            return false;
        }
    }
    await ref.set({
        state: 'waiting',
        players: {X: true, O: null},
        board: ['', '', '', '', '', '', '', '', ''],
        currentPlayer: 'X',
        scores: {X: 0, O: 0},
        round: 0,
        maxRounds: maxRounds,
        firstPlayer: 'X',
        lastActive: Date.now()
    });
    onlineRoomId = code;
    onlinePlayer = 'X';
    lobbyStatus.textContent = `‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: ${code} ‡∏£‡∏≠‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°...`;
    listenOnlineRoom();
    enterOnlineGame();
    stopRoomListListener();
    return code;
}
async function joinOnlineRoom(code) {
    code = code.trim().toUpperCase().replace(/[^A-Z0-9]/g,"").substring(0,12);
    if (!code) throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á');
    const ref = rtdb.ref('xomultiplayer/' + code);
    const snap = await ref.get();
    if (!snap.exists()) throw new Error('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ');
    const data = snap.val();
    if (data.state !== 'waiting' && data.state !== 'playing') throw new Error('‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°');
    let player = null;
    if (!data.players || data.players.X !== true) player = 'X';
    else if (data.players.O !== true) player = 'O';
    else throw new Error('‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
    await ref.update({
        [`players/${player}`]: true,
        state: 'playing',
        lastActive: Date.now()
    });
    onlineRoomId = code;
    onlinePlayer = player;
    return player;
}

// ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
createOnlineGameBtn.addEventListener('click', async () => {
	playAudio('bell.ogg'); // <--- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
    createOnlineGameBtn.disabled = true;
    try {
        await createOnlineRoomWithInput();
    } catch (e) {
        lobbyStatus.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message;
    }
    createOnlineGameBtn.disabled = false;
});

// ‡∏Å‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô roomList ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
async function joinOnlineGameBtnFromList(code) {
    playAudio('bell.ogg');
    try {
        await joinOnlineRoom(code);
        listenOnlineRoom();
        enterOnlineGame();
        stopRoomListListener();
    } catch (e) {
        lobbyStatus.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message;
    }
}

// Game screen will always show newGameBtn (‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà) and exitRoomBtn (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå)
function enterOnlineGame() {
    onlineLobby.classList.add('hidden');
    gameScreen.classList.remove('hidden');
    modeSelectionScreen.classList.add('hidden');
    gameMode = 'online';
    initializeBoard();
    updateGameInfo('‡∏£‡∏≠‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ!');
    updateScoreDisplay();
    stopRoomListListener();
    exitRoomBtn.classList.remove('hidden');
}

// ------ publishOnlineMove/publishOnlineGameEnd (same as before) ------
async function publishOnlineMove(idx, player) {
    const ref = rtdb.ref('xomultiplayer/' + onlineRoomId);
    const snap = await ref.get();
    let data = snap.val();
    let newBoard = data && data.board ? data.board.slice() : ['', '', '', '', '', '', '', '', ''];
    newBoard[idx] = player;

    let roundWon = false;
    const winningConditions = [
        [0,1,2],[3,4,5],[6,7,8],
        [0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]
    ];
    for (let i = 0; i < winningConditions.length; i++) {
        const [a, b, c] = winningConditions[i];
        if (newBoard[a] && newBoard[a] === newBoard[b] && newBoard[b] === newBoard[c]) {
            roundWon = true;
            break;
        }
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏ú‡∏•‡πÄ‡∏™‡∏°‡∏≠
    let isDraw = !roundWon && !newBoard.includes('');
    let nextScores = data && data.scores ? { ...data.scores } : { X: 0, O: 0 };
    let nextRound = data && typeof data.round === "number" ? data.round : 0;
    let newFirst = data && data.firstPlayer ? data.firstPlayer : 'X';
    let roundResult = null;
    if (roundWon) roundResult = player + 'win';
    else if (isDraw) roundResult = 'draw';

    if (roundWon || isDraw) {
        if (roundWon)
            nextScores[player] = (nextScores[player] || 0) + 1;
        nextRound += 1;
        newFirst = newFirst === 'X' ? 'O' : 'X';
        await ref.update({
            board: ['', '', '', '', '', '', '', '', ''],
            scores: nextScores,
            round: nextRound,
            currentPlayer: newFirst,
            firstPlayer: newFirst,
            state: (nextRound >= maxRounds ? 'ended' : 'playing'),
            lastActive: Date.now(),
            roundResult // ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤ draw/win
        });
    } else {
        await ref.update({
            board: newBoard,
            currentPlayer: player === 'X' ? 'O' : 'X',
            lastActive: Date.now(),
            roundResult: null // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏£‡∏≠‡∏ö
        });
    }
}

async function publishOnlineGameEnd() {
    if (!onlineRoomId) return;
    await rtdb.ref('xomultiplayer/' + onlineRoomId).update({state: 'ended'});
}
function resetOnlineRound() {} // dummy

// --------- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà (‡∏ó‡∏∏‡∏Å‡πÇ‡∏´‡∏°‡∏î) -----------
newGameBtn.addEventListener('click', async () => {
    playAudio('bell.ogg');
    if (gameMode === 'online') {
        const ref = rtdb.ref('xomultiplayer/' + onlineRoomId);
        await ref.update({
            board: ['', '', '', '', '', '', '', '', ''],
            scores: {X: 0, O: 0},
            round: 0,
            currentPlayer: 'X',
            firstPlayer: 'X',
            state: 'playing',
            lastActive: Date.now()
        });
        prevBoardOnline = null;
        prevStateOnline = null;
        prevScoresOnline = null;
    } else {
        startNewGame(gameMode);
    }
});

// --------- Exit Room Button handler (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå) -------
exitRoomBtn.addEventListener('click', async () => {
    if (gameMode === 'online') {
        await leaveRoomCleanup(true);
        showMainMenu();
    }
});

// ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏ß‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á .ogg (x1-x9.ogg, o1-o9.ogg, xwin.ogg, owin.ogg, xodraw.ogg, endx.ogg, endo.ogg, enddraw.ogg, bell.ogg) ‡πÉ‡∏ô path ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ -->
    </script>
</body>
</html>