<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>7-Second Song Quiz: International Hits</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .game-container {
            background-color: #ffffff;
            border-radius: 20px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
            max-width: 600px;
            width: 100%;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: relative;
        }
        .btn {
            padding: 12px 25px;
            border-radius: 10px;
            font-weight: bold;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-image: linear-gradient(to right, #6a11cb 0%, #20e2d7 100%);
            color: white;
            border: none;
        }
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
            opacity: 0.9;
        }
        .btn-secondary {
            background-color: #f0f4f8;
            color: #2d3748;
            border: 1px solid #cbd5e0;
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: #e2e8f0;
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.08);
        }
        .btn-disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .answer-button {
            width: 100%;
            text-align: center;
            white-space: normal;
            word-wrap: break-word;
        }
        .score-display {
            font-size: 1.8em;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 20px;
        }
        #backToMainMenuButton {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 8px 15px;
            font-size: 0.9em;
            background-color: #cbd5e0;
            color: #2d3748;
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease-in-out;
            z-index: 10;
        }
        #backToMainMenuButton:hover {
            background-color: #a0aec0;
            transform: translateY(-1px);
        }
        .input-box {
            width: 100%;
            padding: 12px 16px;
            font-size: 1.1em;
            border: 2px solid #cbd5e0;
            border-radius: 10px;
            margin-bottom: 16px;
            text-align: center;
        }
        .input-box:focus {
            outline: none;
            border-color: #6a11cb;
            box-shadow: 0 0 0 3px rgba(106, 17, 203, 0.2);
        }
    </style>
</head>
<body>
    <div class="game-container">
        <button id="backToMainMenuButton" class="btn">Back to Menu</button>

        <!-- Start Screen -->
        <div id="start-screen" class="screen">
            <h1 class="text-4xl font-extrabold text-indigo-700 mb-6" tabindex="-1">7-Second Song Quiz: International Hits</h1>
            <p class="text-lg text-gray-700 mb-8 leading-relaxed">
                Test your knowledge of famous songs from around the world!<br>
                Get all 10 questions correct with no mistakes to become the Ultimate Music Master!
            </p>
            <button id="startButton" class="btn btn-primary text-xl">Start Game</button>
        </div>

        <!-- Question Screen -->
        <div id="question-screen" class="screen hidden">
            <h2 id="question-heading" class="text-2xl font-bold text-gray-800 mb-4" tabindex="-1">Question 1</h2>
            <button id="playMusicButton" class="btn btn-primary text-xl mb-6">Play Again</button>
            <div id="answer-choices" class="grid grid-cols-1 gap-4"></div>
        </div>

        <!-- Result Screen -->
        <div id="result-screen" class="screen hidden">
            <h2 id="result-heading" class="text-3xl font-bold text-indigo-700 mb-4" tabindex="-1"></h2>
            <p id="result-score" class="score-display mb-6"></p>
            <button id="ultimate-button" class="btn btn-primary text-xl hidden">Ultimate Challenge</button>
        </div>

        <!-- Ultimate Challenge Screen -->
        <div id="ultimate-screen" class="screen hidden">
            <h2 class="text-3xl font-bold text-indigo-700 mb-6" tabindex="-1">
                Perfect Score! You're a True Music Master!
            </h2>
            <input type="text" id="ultimate-input" class="input-box" placeholder="Type the song title" autocomplete="off">
            <button id="ultimate-submit" class="btn btn-primary text-xl">Submit</button>
        </div>

        <!-- Final Summary Screen -->
        <div id="final-summary-screen" class="screen hidden">
            <h2 id="final-heading" class="text-3xl font-bold text-indigo-700 mb-6" tabindex="-1"></h2>
            <p id="final-message" class="text-lg text-gray-700 leading-relaxed"></p>
        </div>
    </div>

    <script>
        // === Song data (88 international hits) ===
        const questionSongsData = [
            { file: '500 Miles.mp3', answer: '500 Miles' },
            { file: 'A Thousand Miles.mp3', answer: 'A Thousand Miles' },
            { file: 'Another One Bites The Dust.mp3', answer: 'Another One Bites The Dust' },
            { file: 'Baby One More Time.mp3', answer: 'Baby One More Time' },
            { file: 'Baby Shark.mp3', answer: 'Baby Shark' },
            { file: 'Balada.mp3', answer: 'Balada' },
            { file: 'Barbie Girl.mp3', answer: 'Barbie Girl' },
            { file: 'Beat It.mp3', answer: 'Beat It' },
            { file: 'Believe.mp3', answer: 'Believe' },
            { file: 'Billie Jean.mp3', answer: 'Billie Jean' },
            { file: 'Black Magic Woman.mp3', answer: 'Black Magic Woman' },
            { file: 'Blame It on the Boogie.mp3', answer: 'Blame It on the Boogie' },
            { file: 'Blue Bird.mp3', answer: 'Blue Bird' },
            { file: 'Bohemian Rhapsody.mp3', answer: 'Bohemian Rhapsody' },
            { file: 'Boom Boom Boom Boom.mp3', answer: 'Boom Boom Boom Boom' },
            { file: 'Butterfly.mp3', answer: 'Butterfly' },
            { file: 'Can\'t Take My Eyes Off You.mp3', answer: 'Can\'t Take My Eyes Off You' },
            { file: 'Careless Whisper.mp3', answer: 'Careless Whisper' },
            { file: 'Come and Get Your Love.mp3', answer: 'Come and Get Your Love' },
            { file: 'Dame Tu Cosita.mp3', answer: 'Dame Tu Cosita' },
            { file: 'Danza Kuduro.mp3', answer: 'Danza Kuduro' },
            { file: 'doraemon.mp3', answer: 'doraemon' },
            { file: 'EveryTime.mp3', answer: 'EveryTime' },
            { file: 'Eye of the Tiger.mp3', answer: 'Eye of the Tiger' },
            { file: 'Family Affair.mp3', answer: 'Family Affair' },
            { file: 'Fire.mp3', answer: 'Fire' },
            { file: 'Future Days.mp3', answer: 'Future Days' },
            { file: 'Gee.mp3', answer: 'Gee' },
            { file: 'Girls Just Want to Have Fun.mp3', answer: 'Girls Just Want to Have Fun' },
            { file: 'Good Times.mp3', answer: 'Good Times' },
            { file: 'Gotta Go Home.mp3', answer: 'Gotta Go Home' },
            { file: 'Hotel California.mp3', answer: 'Hotel California' },
            { file: 'How Deep Is Your Love.mp3', answer: 'How Deep Is Your Love' },
            { file: 'I Believe I Can Fly.mp3', answer: 'I Believe I Can Fly' },
            { file: 'I Don\'t Want to Miss a Thing.mp3', answer: 'I Don\'t Want to Miss a Thing' },
            { file: 'I Got You (I Feel Good).mp3', answer: 'I Got You (I Feel Good)' },
            { file: 'I Love You Baby.mp3', answer: 'I Love You Baby' },
            { file: 'I Remember You.mp3', answer: 'I Remember You' },
            { file: 'Imagine.mp3', answer: 'Imagine' },
            { file: 'Joanna.mp3', answer: 'Joanna' },
            { file: 'Kiss Me.mp3', answer: 'Kiss Me' },
            { file: 'Lemon Tree.mp3', answer: 'Lemon Tree' },
            { file: 'Let It Be.mp3', answer: 'Let It Be' },
            { file: 'Low.mp3', answer: 'Low' },
            { file: 'Lullabye (Goodnight_ My Angel).mp3', answer: 'Lullabye (Goodnight_ My Angel)' },
            { file: 'Macarena.mp3', answer: 'Macarena' },
            { file: 'Mi Mi Mi.mp3', answer: 'Mi Mi Mi' },
            { file: 'Money.mp3', answer: 'Money' },
            { file: 'More Than I Can Say.mp3', answer: 'More Than I Can Say' },
            { file: 'Mr. Lonely.mp3', answer: 'Mr. Lonely' },
            { file: 'My Love.mp3', answer: 'My Love' },
            { file: 'Never Gonna Give You Up.mp3', answer: 'Never Gonna Give You Up' },
            { file: 'Nobody.mp3', answer: 'Nobody' },
            { file: 'One More Night.mp3', answer: 'One More Night' },
            { file: 'One Way Ticket.mp3', answer: 'One Way Ticket' },
            { file: 'Oops...I Did It Again.mp3', answer: 'Oops...I Did It Again' },
            { file: 'Perhaps Love.mp3', answer: 'Perhaps Love' },
            { file: 'Planetarium.mp3', answer: 'Planetarium' },
            { file: 'Pretty Little Baby.mp3', answer: 'Pretty Little Baby' },
            { file: 'Put Your Head On My Shoulder.mp3', answer: 'Put Your Head On My Shoulder' },
            { file: 'Rasputin.mp3', answer: 'Rasputin' },
            { file: 'Right Here Waiting.mp3', answer: 'Right Here Waiting' },
            { file: 'Right Now (Na Na Na).mp3', answer: 'Right Now (Na Na Na)' },
            { file: 'Rock and Roll.mp3', answer: 'Rock and Roll' },
            { file: 'Sailing.mp3', answer: 'Sailing' },
            { file: 'say yes.mp3', answer: 'say yes' },
            { file: 'September.mp3', answer: 'September' },
            { file: 'Shalala Lala.mp3', answer: 'Shalala Lala' },
            { file: 'Smoke On The Water.mp3', answer: 'Smoke On The Water' },
            { file: 'Smooth Criminal.mp3', answer: 'Smooth Criminal' },
            { file: 'Smooth Operator.mp3', answer: 'Smooth Operator' },
            { file: 'Stay With Me.mp3', answer: 'Stay With Me' },
            { file: 'Sunshine Day.mp3', answer: 'Sunshine Day' },
            { file: 'Super Freak.mp3', answer: 'Super Freak' },
            { file: 'Take Me Home Country Roads.mp3', answer: 'Take Me Home Country Roads' },
            { file: 'Take on mee.mp3', answer: 'Take on mee' },
            { file: 'That\'s the Way (I Like It).mp3', answer: 'That\'s the Way (I Like It)' },
            { file: 'The One You Love.mp3', answer: 'The One You Love' },
            { file: 'The Reason.mp3', answer: 'The Reason' },
            { file: 'Thunder struck.mp3', answer: 'Thunder struck' },
            { file: 'Tokyo Drift.mp3', answer: 'Tokyo Drift' },
            { file: 'ToNight You Belong to Me.mp3', answer: 'ToNight You Belong to Me' },
            { file: 'Too Much Heaven.mp3', answer: 'Too Much Heaven' },
            { file: 'Top Of The World.mp3', answer: 'Top Of The World' },
            { file: 'Trouble Is a Friend.mp3', answer: 'Trouble Is a Friend' },
            { file: 'Wannabe.mp3', answer: 'Wannabe' },
            { file: 'Way Back Into Love.mp3', answer: 'Way Back Into Love' },
            { file: 'We Are The World.mp3', answer: 'We Are The World' },
            { file: 'Why.mp3', answer: 'Why' },
            { file: 'Wonderful Tonight.mp3', answer: 'Wonderful Tonight' }
        ];

        const additionalFakeAnswers = [
            'How Do You Do','I Want It That Way','Bang Bang','Toxic','Let\'s Get Loud','Best Friend',
            'Timber','We Will Rock You','Welcome To The Jungle','Bad To The Bone','Tiny Dancer','She\'s Gone',
            'Stayin Alive','Funkytown','New Kid in Town','Tears in Heaven','Losing My Religion','Heartbeat',
            'Back In Black','More Than Words','I Found Somebody','Doolin-Dalton','Turn Around',
            'Don\'t Look Back in Anger','Sugar Rain','Everybody Wants To Rule The World','Drive',
            'Exchange of Hearts','Missing You','When You Know Love','Do Something','I\'m Still Standing',
            'Train Leaves Here This Morning','Tip Of The Iceberg','Free Bird','Outlaw Man',
            'You Belong To The City','I Can Dream About You','Twenty-One','Love Will Keep Us Alive',
            'House of the Rising Sun','Purple Rain','Think of Laura'
        ];

        // === Game variables ===
        let currentRoundSongs = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let incorrectAttempts = 0;
        const maxIncorrect = 1;
        const totalQuestions = 10;
        let userAnswers = [];
        let audioPlayer = new Audio();
        let audioTimeout;
        let audioPlayCount = 0;
        let lastCorrectPosition = -1;
        let previousChoices = [];
        let ultimateSong = null;
        let isUltimateRound = false;
        let skipInput = '';
        let skipTimeout = null;

        // === DOM Elements ===
        const startScreen = document.getElementById('start-screen');
        const questionScreen = document.getElementById('question-screen');
        const resultScreen = document.getElementById('result-screen');
        const ultimateScreen = document.getElementById('ultimate-screen');
        const finalSummaryScreen = document.getElementById('final-summary-screen');
        const startButton = document.getElementById('startButton');
        const playMusicButton = document.getElementById('playMusicButton');
        const questionHeading = document.getElementById('question-heading');
        const answerChoicesDiv = document.getElementById('answer-choices');
        const resultHeading = document.getElementById('result-heading');
        const resultScore = document.getElementById('result-score');
        const ultimateButton = document.getElementById('ultimate-button');
        const ultimateInput = document.getElementById('ultimate-input');
        const ultimateSubmit = document.getElementById('ultimate-submit');
        const finalHeading = document.getElementById('final-heading');
        const finalMessage = document.getElementById('final-message');
        const backToMainMenuButton = document.getElementById('backToMainMenuButton');

        // === Focus Management (แบบเดียวกับไฟล์ลูกทุ่งต้นฉบับ) ===
        function focusFirstHeading() {
            const heading = document.querySelector('.screen:not(.hidden) h1, .screen:not(.hidden) h2');
            if (heading) {
                heading.setAttribute('tabindex', '-1');
                heading.focus();
            }
        }

        function showScreen(screen) {
            [startScreen, questionScreen, resultScreen, ultimateScreen, finalSummaryScreen].forEach(s => s.classList.add('hidden'));
            screen.classList.remove('hidden');
            setTimeout(focusFirstHeading, 100);
        }

        // === Helper Functions ===
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function playAudio(filename, duration = 7000) {
            return new Promise((resolve) => {
                if (audioTimeout) clearTimeout(audioTimeout);
                if (!audioPlayer.paused) {
                    audioPlayer.pause();
                    audioPlayer.currentTime = 0;
                }
                audioPlayer.src = `audio/${filename}`;
                audioPlayer.play().catch(e => console.error("Error playing audio:", e));

                const onEnded = () => {
                    audioPlayer.removeEventListener('ended', onEnded);
                    resolve();
                };
                audioPlayer.addEventListener('ended', onEnded);

                if (duration > 0) {
                    audioTimeout = setTimeout(() => {
                        audioPlayer.pause();
                        audioPlayer.currentTime = 0;
                        audioPlayer.removeEventListener('ended', onEnded);
                        resolve();
                    }, duration);
                }
            });
        }

        function getUniqueIncorrectAnswers(correctAnswer, previousChoices = []) {
            const candidates = new Set();
            questionSongsData.forEach(s => {
                if (s.answer !== correctAnswer && !previousChoices.includes(s.answer)) candidates.add(s.answer);
            });
            additionalFakeAnswers.forEach(ans => {
                if (ans !== correctAnswer && !previousChoices.includes(ans)) candidates.add(ans);
            });
            let arr = Array.from(candidates);
            shuffleArray(arr);
            return arr.slice(0, 2);
        }

        function getValidCorrectPosition() {
            const positions = [0, 1, 2];
            const available = positions.filter(pos => pos !== lastCorrectPosition);
            const chosen = available.length > 0 ? available[Math.floor(Math.random() * available.length)] : 0;
            lastCorrectPosition = chosen;
            return chosen;
        }

        // === Game Logic ===
        async function startGame() {
            try { await playAudio('qstart.mp3', 0); } catch(err) {}
            initNewRound();
        }

        function initNewRound() {
            currentRoundSongs = shuffleArray([...questionSongsData]).slice(0, totalQuestions);
            currentQuestionIndex = 0;
            score = 0;
            incorrectAttempts = 0;
            userAnswers = [];
            lastCorrectPosition = -1;
            previousChoices = [];
            isUltimateRound = false;
            renderQuestion();
            playCurrentSong();
        }

        function renderQuestion() {
            showScreen(questionScreen);
            questionHeading.textContent = `Question ${currentQuestionIndex + 1}`;

            audioPlayCount = 0;
            playMusicButton.disabled = false;
            playMusicButton.classList.remove('btn-disabled');

            const currentSong = currentRoundSongs[currentQuestionIndex];
            const correct = currentSong.answer;
            const correctPos = getValidCorrectPosition();
            const incorrects = getUniqueIncorrectAnswers(correct, previousChoices);

            const choices = new Array(3);
            choices[correctPos] = correct;
            let wrongIdx = 0;
            for (let i = 0; i < 3; i++) {
                if (i !== correctPos) choices[i] = incorrects[wrongIdx++];
            }
            previousChoices = [...choices];

            answerChoicesDiv.innerHTML = '';
            choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.textContent = choice;
                btn.classList.add('btn', 'btn-secondary', 'answer-button');
                btn.onclick = () => checkAnswer(choice);
                answerChoicesDiv.appendChild(btn);
            });

            // โฟกัสปุ่ม Play Again หลังแสดงข้อใหม่
            setTimeout(() => playMusicButton.focus(), 200);
        }

        async function playCurrentSong() {
            if (audioPlayCount < 2) {
                const file = currentRoundSongs[currentQuestionIndex].file;
                await playAudio(file, 7000);
                audioPlayCount++;
                if (audioPlayCount >= 2) {
                    playMusicButton.disabled = true;
                    playMusicButton.classList.add('btn-disabled');
                }
                // หลังเล่นเสียงจบ → โฟกัสปุ่ม Play Again (หรือไม่โฟกัสอีกถ้าเล่นครบ 2 ครั้ง)
                if (audioPlayCount === 1) {
                    setTimeout(() => playMusicButton.focus(), 300);
                }
            }
        }

        function checkAnswer(selected) {
            const song = currentRoundSongs[currentQuestionIndex];
            const isCorrect = selected === song.answer;

            if (!isCorrect) {
                incorrectAttempts++;
                playAudio('qwrong.mp3', 0);
            } else {
                score++;
                playAudio('qtrue.mp3', 0);
            }

            userAnswers.push({ userAnswer: selected, correctAnswer: song.answer, isCorrect });

            Array.from(answerChoicesDiv.children).forEach(btn => {
                btn.disabled = true;
                btn.classList.add('btn-disabled');
                if (btn.textContent === song.answer) {
                    btn.classList.remove('btn-secondary');
                    btn.classList.add('bg-green-200', 'text-green-800');
                } else if (btn.textContent === selected && !isCorrect) {
                    btn.classList.remove('btn-secondary');
                    btn.classList.add('bg-red-200', 'text-red-800');
                }
            });

            playMusicButton.disabled = true;
            playMusicButton.classList.add('btn-disabled');

            setTimeout(() => {
                if (incorrectAttempts > maxIncorrect || currentQuestionIndex === totalQuestions - 1) {
                    endGame();
                } else {
                    currentQuestionIndex++;
                    renderQuestion();
                    playCurrentSong();
                }
            }, 2000);
        }

        function calculateFinalScore() {
            if (incorrectAttempts === 0 && score === 10) return 1000;
            if (incorrectAttempts === 1 && score === 9) return 700;
            return score * 50;
        }

        async function endGame() {
            const finalScore = calculateFinalScore();
            showScreen(resultScreen);

            if (incorrectAttempts > maxIncorrect) {
                await playAudio('qSad.mp3', 0).catch(() => {});
                resultHeading.textContent = 'Nice try! Play again?';
            } else {
                await playAudio('qend.mp3', 0).catch(() => {});
                resultHeading.textContent = 'Congratulations! You\'re a True Music Fan!';
            }

            resultScore.textContent = `Score: ${finalScore} points`;

            if (score === 10 && incorrectAttempts === 0) {
                ultimateButton.classList.remove('hidden');
                setTimeout(() => ultimateButton.focus(), 500);
            }
        }

        async function startUltimateChallenge() {
            const usedFiles = currentRoundSongs.map(s => s.file);
            const remainingSongs = questionSongsData.filter(s => !usedFiles.includes(s.file));
            const shuffled = shuffleArray(remainingSongs);
            ultimateSong = shuffled[0];

            isUltimateRound = true;
            showScreen(ultimateScreen);

            await playAudio('qstart.mp3', 0).catch(() => {});
            await new Promise(r => setTimeout(r, 500));
            await playAudio(ultimateSong.file, 7000);

            setTimeout(() => ultimateInput.focus(), 300);
        }

        async function submitUltimateAnswer() {
            const userAnswer = ultimateInput.value.trim();
            const isCorrect = userAnswer === ultimateSong.answer;

            ultimateSubmit.disabled = true;
            ultimateInput.disabled = true;

            if (isCorrect) {
                await playAudio('great.mp3', 0).catch(() => {});
                showScreen(finalSummaryScreen);
                finalHeading.textContent = 'Incredible!';
                finalMessage.textContent = 'You are the Ultimate Music Master!';
            } else {
                await playAudio('iwrong.mp3', 0).catch(() => {});
                showScreen(finalSummaryScreen);
                finalHeading.textContent = 'So close!';
                finalMessage.textContent = 'You were amazing to reach the final round. Try again!';
            }
        }

        // === Secret cheat: type "skip" ===
        function handleSkipInput(e) {
            if (isUltimateRound || !questionScreen.classList.contains('hidden')) {
                const key = e.key.toLowerCase();
                if (/[a-z]/.test(key)) {
                    skipInput += key;
                    if (skipTimeout) clearTimeout(skipTimeout);
                    skipTimeout = setTimeout(() => skipInput = '', 2000);
                    if (skipInput === 'skip') {
                        skipInput = '';
                        score = 10;
                        incorrectAttempts = 0;
                        currentQuestionIndex = totalQuestions - 1;
                        endGame();
                    }
                }
            }
        }

        // === Event Listeners ===
        startButton.addEventListener('click', startGame);
        playMusicButton.addEventListener('click', playCurrentSong);
        backToMainMenuButton.addEventListener('click', () => {
            if (!audioPlayer.paused) {
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
            }
            window.location.href = '../index.html';
        });
        ultimateButton.addEventListener('click', startUltimateChallenge);
        ultimateSubmit.addEventListener('click', submitUltimateAnswer);
        ultimateInput.addEventListener('keypress', e => {
            if (e.key === 'Enter') submitUltimateAnswer();
        });
        document.addEventListener('keydown', handleSkipInput);

        // Start
        window.onload = () => {
            showScreen(startScreen);
        };
    </script>
</body>
</html>