<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>‡πÄ‡∏Å‡∏°‡∏ù‡∏∂‡∏Å Braille Chord (Perkins Style) - Bop It! ‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏±‡∏ö</title>
  <style>
    :root {
      --bg: #0b1220; --card:#121a2b; --text:#e6ecff; --accent:#7cc4ff; --good:#2ecc71; --bad:#ff6b6b; --warning:#f39c12;
    }
    html,body{height:100%;}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);-webkit-tap-highlight-color: transparent;}
    .container{max-width:950px;margin:0 auto;padding:16px;}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.04),rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.08);box-shadow:0 10px 30px rgba(0,0,0,.35);border-radius:18px;padding:20px}
    .card:focus{outline:none;}
    h1{font-size:clamp(20px,4vw,36px);margin:0 0 8px 0}
    h2{font-size:clamp(18px,3vw,24px);margin:0 0 12px 0}
    p{line-height:1.6}
    .grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.6rem;padding:14px 18px;border-radius:14px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);color:var(--text);font-weight:700;cursor:pointer;transition:all 0.2s ease; user-select: none;}
    .btn:hover{background:rgba(255,255,255,.12);border-color:rgba(255,255,255,.25)}
    .btn:focus{outline:3px solid var(--accent);outline-offset:2px}
    .btn:active{transform: scale(0.97);}
    .btn[disabled]{opacity:.6;cursor:not-allowed; transform: none;}
    .btn.warning{background:rgba(243,156,18,.1);border-color:rgba(243,156,18,.3);color:var(--warning)}
    .btn.warning:hover{background:rgba(243,156,18,.2)}
    .btn.big{font-size:22px;padding:18px 22px}
    .status{display:flex;gap:12px;flex-wrap:wrap}
    .pill{padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12)}
    .flex{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .panel{background:var(--card);border-radius:16px;padding:16px;border:1px solid rgba(255,255,255,.08)}
    .prompt{font-size:clamp(24px,5vw,44px);font-weight:900;letter-spacing:.5px; min-height: 50px;}
    .prompt:focus{outline:none;}
    .good{color:var(--good)}
    .bad{color:var(--bad)}
    .footer{opacity:.8; margin-top: 16px; font-size: 0.9em;}
    .stats-actions{margin-top:12px}
    .tap-hint{font-size:0.9em;opacity:0.8;margin-top:8px;font-style:italic}

    #modeSelect, #game-container { min-height: 60vh; display: flex; flex-direction: column; justify-content: center; }

    @media (max-width: 768px) {
      .container { padding: 12px; }
      .card { padding: 16px; }
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<main class="container">

  <button class="flex items-center rounded-md border border-slate-300 py-2 px-4 text-center text-sm transition-all shadow-sm hover:shadow-lg text-slate-600 hover:text-white hover:bg-slate-800 hover:border-slate-800 focus:text-white focus:bg-slate-800 focus:border-slate-800 active:border-slate-800 active:text-white active:bg-slate-800 disabled:pointer-events-none disabled:opacity-50 disabled:shadow-none mb-6" type="button" onclick="location.href='../index.html'">
    ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 ml-1.5">
      <path fill-rule="evenodd" d="M16.28 11.47a.75.75 0 0 1 0 1.06l-7.5 7.5a.75.75 0 0 1-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 0 1 1.06-1.06l7.5 7.5Z" clip-rule="evenodd" />
    </svg>
  </button>

  <!-- ‚îÄ‚îÄ ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î ‚îÄ‚îÄ -->
  <section id="modeSelect" class="card" aria-labelledby="modeTitle">
    <h1 id="modeTitle" class="text-center">‡∏ù‡∏∂‡∏Å Braille Chord (Perkins)</h1>
    <p class="text-center mt-3 mb-8 max-w-xl mx-auto">
      ‡∏ù‡∏∂‡∏Å‡∏Å‡∏î‡∏à‡∏∏‡∏î‡πÄ‡∏ö‡∏£‡∏•‡∏•‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô (chord) ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡πà‡∏≤‡∏ô<br>
      ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏µ‡∏¢‡πå f d s j k l ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ö‡∏£‡∏•‡∏•‡πå Perkins
    </p>

    <div class="grid gap-6 mt-6">
      <button id="btnEasy" class="btn big bg-green-800/30 border-green-600 hover:bg-green-700/40">
        ‡πÇ‡∏´‡∏°‡∏î‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô<br><span class="text-sm opacity-80">(‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏° 30% ‚Äì ‡πÄ‡∏£‡∏¥‡πà‡∏° 3.9 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</span>
      </button>
      <button id="btnHard" class="btn big bg-red-800/30 border-red-600 hover:bg-red-700/40">
        ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏ã‡∏µ‡∏¢‡∏ô<br><span class="text-sm opacity-80">(‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß ‚Äì ‡πÄ‡∏£‡∏¥‡πà‡∏° 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</span>
      </button>
    </div>
  </section>

  <!-- ‚îÄ‚îÄ ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏Å‡∏° ‚îÄ‚îÄ -->
  <section id="game-container" class="card hidden" aria-labelledby="title" tabindex="0">
    <h1 id="title">‡πÄ‡∏Å‡∏°‡∏ù‡∏∂‡∏Å‡∏Å‡∏î Braille Chord (Perkins Style)</h1>
    <p>‡∏Å‡∏î‡∏à‡∏∏‡∏î‡πÄ‡∏ö‡∏£‡∏•‡∏•‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô / ‡∏≠‡πà‡∏≤‡∏ô</p>
    
    <div class="grid mt-6">
      <div class="panel">
        <div id="prompt" class="prompt text-center" role="status" aria-live="assertive">‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß...</div>
        <div id="sr-aria" class="sr-only" aria-live="assertive" aria-atomic="true"></div>
        <div class="flex gap-4 flex-wrap justify-center mt-6">
          <button id="stopBtn" class="btn" disabled>‚èπ ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏Å‡∏°</button>
          <button id="audioModeBtn" class="btn">‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á: Audio</button>
        </div>
      </div>
    </div>

    <div class="status mt-4" aria-live="polite" aria-atomic="true">
      <div class="pill" id="scorePill" role="status">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: <strong id="score">0</strong></div>
      <div class="pill">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: <strong id="best">0</strong></div>
      <div class="pill">‡∏£‡∏≠‡∏ö: <strong id="round">0</strong></div>
      <div class="pill">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß: <strong id="speed">‡∏ä‡πâ‡∏≤</strong></div>
    </div>

    <div class="stats-actions mt-4">
      <button id="clearStatsBtn" class="btn warning" aria-describedby="clearStatsDesc">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</button>
      <div id="clearStatsDesc" class="sr-only">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</div>
      <div id="confirmClear" class="confirm-dialog hidden mt-3 p-4 bg-amber-900/20 border border-amber-700/40 rounded-xl">
        <p>‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
        <div class="flex gap-3 mt-4">
          <button id="confirmClearYes" class="btn warning">‡πÉ‡∏ä‡πà, ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏¢</button>
          <button id="confirmClearNo" class="btn">‡πÑ‡∏°‡πà, ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
      </div>
    </div>

    <div class="mt-8 text-center">
      <button id="restartBtn" class="btn big hidden">‚ñ∂Ô∏è ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà (‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏î‡∏¥‡∏°)</button>
      <button id="backMenuBtn" class="btn big hidden">‚óÄÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>
    </div>
  </section>

</main>

<!-- Audio files -->
<audio id="snd-1" preload="auto" src="sounds/1.mp3"></audio>
<audio id="snd-2" preload="auto" src="sounds/2.mp3"></audio>
<audio id="snd-3" preload="auto" src="sounds/3.mp3"></audio>
<audio id="snd-4" preload="auto" src="sounds/4.mp3"></audio>
<audio id="snd-5" preload="auto" src="sounds/5.mp3"></audio>
<audio id="snd-6" preload="auto" src="sounds/6.mp3"></audio>
<audio id="snd-7" preload="auto" src="sounds/7.mp3"></audio>
<audio id="snd-8" preload="auto" src="sounds/8.mp3"></audio>
<audio id="snd-9" preload="auto" src="sounds/9.mp3"></audio>

<audio id="snd-correct" preload="auto" src="sounds/correct.mp3"></audio>
<audio id="snd-wrong"   preload="auto" src="sounds/wrong.mp3"></audio>
<audio id="snd-tick"    preload="auto" src="sounds/tick.mp3"></audio>
<audio id="snd-start"   preload="auto" src="sounds/start.mp3"></audio>
<audio id="snd-gameover" preload="auto" src="sounds/gameover.mp3"></audio>

<script>
(() => {
  const qs = sel => document.querySelector(sel);

  // Elements
  const topBackBtn      = qs('.mb-6');
  const modeSelect      = qs('#modeSelect');
  const gameContainer   = qs('#game-container');
  const promptEl        = qs('#prompt');
  const srLive          = qs('#sr-aria');
  const scoreEl         = qs('#score');
  const bestEl          = qs('#best');
  const roundEl         = qs('#round');
  const speedEl         = qs('#speed');
  const stopBtn         = qs('#stopBtn');
  const audioModeBtn    = qs('#audioModeBtn');
  const clearStatsBtn   = qs('#clearStatsBtn');
  const confirmClear    = qs('#confirmClear');
  const confirmYes      = qs('#confirmClearYes');
  const confirmNo       = qs('#confirmClearNo');
  const restartBtn      = qs('#restartBtn');
  const backMenuBtn     = qs('#backMenuBtn');
  const titleEl         = qs('#title');
  const descP           = gameContainer.querySelector('p');
  const statusDiv       = qs('.status');
  const statsActions    = qs('.stats-actions');
  const gameButtons     = gameContainer.querySelector('.flex.gap-4.flex-wrap.justify-center.mt-6');

  // Audio
  const audioBank = {
    1: qs('#snd-1'), 2: qs('#snd-2'), 3: qs('#snd-3'),
    4: qs('#snd-4'), 5: qs('#snd-5'), 6: qs('#snd-6'),
    7: qs('#snd-7'), 8: qs('#snd-8'), 9: qs('#snd-9'),
    correct: qs('#snd-correct'), wrong: qs('#snd-wrong'),
    tick: qs('#snd-tick'), start: qs('#snd-start'),
    gameover: qs('#snd-gameover')
  };

  let audioMode = 'file'; // file | tts | off
  let selectedMode = null; // 'easy' or 'hard'

  const patterns = [
    { num:1, dots:"1"      },
    { num:2, dots:"1,2"    },
    { num:3, dots:"1,4"    },
    { num:4, dots:"1,4,5"  },
    { num:5, dots:"1,5"    },
    { num:6, dots:"1,2,4"  },
    { num:7, dots:"1,2,4,5"},
    { num:8, dots:"1,2,5"  },
    { num:9, dots:"2,4"    }
  ];

  const keyToDot = {
    'f':'1', 'd':'2', 's':'3', 'j':'4', 'k':'5', 'l':'6',
    '‡∏î':'1', '‡∏Å':'2', '‡∏´':'3', '‡πà':'4', '‡∏≤':'5', '‡∏™':'6'
  };

  // Game state
  let currentPattern = null;
  let pressed = new Set();
  let awaitingInput = false;
  let score = 0;
  let best = Number(localStorage.getItem('braillechord_best')||0);
  let round = 0;
  let baseTimeLimit = 3000;
  let timeLimit = baseTimeLimit;
  let running = false;
  let timer = null;
  let isAudioUnlocked = false;

  bestEl.textContent = best;

  // ‚îÄ‚îÄ ARIA / Screen Reader Mode Switch ‚îÄ‚îÄ
  function enterApplicationMode() {
    modeSelect.setAttribute('aria-hidden', 'true');
    gameContainer.setAttribute('aria-hidden', 'false');
    gameContainer.setAttribute('role', 'application');
    gameContainer.setAttribute('tabindex', '0');

    // ‡πÉ‡∏ä‡πâ RAF + setTimeout ‡πÄ‡∏û‡∏∑‡πà‡∏≠ timing ‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡∏Å‡∏ß‡πà‡∏≤
    requestAnimationFrame(() => {
      setTimeout(() => {
        try {
          gameContainer.focus();
          // Announce ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á SR ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
          srLive.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏Å‡∏° Braille Chord ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°...';
        } catch (e) {}
      }, 120); // 120ms ‚Üí ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 50ms ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ SR settle ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
    });
  }

  function exitApplicationMode() {
    gameContainer.setAttribute('aria-hidden', 'true');
    gameContainer.removeAttribute('role');
    gameContainer.removeAttribute('tabindex');
    modeSelect.setAttribute('aria-hidden', 'false');
  }

  // ‚îÄ‚îÄ Audio Helpers ‚îÄ‚îÄ
  function stopAllSounds() {
    Object.values(audioBank).forEach(a => {
      if (a && !a.paused) { a.pause(); a.currentTime = 0; }
    });
  }

  function speakThai(text) {
    if (audioMode !== 'tts' || !text) return;
    try {
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'th-TH';
      u.rate = 1.1;
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    } catch {}
  }

  function play(name) {
    if (audioMode === 'off') return;
    if (audioMode === 'tts') {
      if (name >=1 && name <=9) speakThai(`‡∏Å‡∏î ${name}`);
      else if (name === 'correct') speakThai('‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
      else if (name === 'wrong') speakThai('‡∏ú‡∏¥‡∏î');
      return;
    }
    const a = audioBank[name];
    if (a) {
      a.currentTime = 0;
      a.play().catch(()=>{});
    }
  }

  function vibrate(ms) {
    try { navigator.vibrate?.(ms); } catch {}
  }

  // ‚îÄ‚îÄ Game Logic ‚îÄ‚îÄ
  function setPrompt(text, cls='') {
    promptEl.className = 'prompt text-center';
    if (cls) promptEl.classList.add(cls);
    promptEl.textContent = text;
    srLive.textContent = text;
  }

  function difficultyLabel(ms) {
    if (ms > 3500) return '‡∏ä‡πâ‡∏≤‡∏°‡∏≤‡∏Å';
    if (ms > 2500) return '‡∏ä‡πâ‡∏≤';
    if (ms > 1500) return '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á';
    if (ms > 900)  return '‡πÄ‡∏£‡πá‡∏ß';
    return '‡πÄ‡∏£‡πá‡∏ß‡∏°‡∏≤‡∏Å';
  }

  function nextRound() {
    awaitingInput = true;
    round++;
    roundEl.textContent = round;

    currentPattern = patterns[Math.floor(Math.random()*patterns.length)];
    const num = currentPattern.num;

    setPrompt(`${num}`);
    play(num);
    vibrate(40);

    pressed.clear();

    clearInterval(timer);
    const deadline = performance.now() + timeLimit;
    let ticked = false;

    timer = setInterval(() => {
      const now = performance.now();
      if (now > deadline) {
        clearInterval(timer);
        fail("‡∏ä‡πâ‡∏≤‡πÑ‡∏õ!");
        return;
      }
      if (!ticked && deadline - now < 700) {
        play('tick');
        ticked = true;
      }
    }, 50);
  }

  function succeed() {
    clearInterval(timer);
    awaitingInput = false;
    score++;
    scoreEl.textContent = score;
    setPrompt('‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!', 'good');
    play('correct');
    vibrate([30,60,30]);

    timeLimit = Math.max(550, Math.floor(timeLimit * 0.94));
    speedEl.textContent = difficultyLabel(timeLimit);

    setTimeout(nextRound, 450);
  }

  function fail(reason='‡∏ú‡∏¥‡∏î!') {
    if (!running) return;
    awaitingInput = false;
    running = false;
    clearInterval(timer);
    stopAllSounds();
    play('gameover');
    vibrate([120,60,120]);

    // Clean end game screen
    setPrompt(`‡∏à‡∏ö‡πÄ‡∏Å‡∏°: ${reason}\n‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: ${score}\n‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: ${best}`, 'bad');
    titleEl.classList.add('hidden');
    descP.classList.add('hidden');
    statusDiv.classList.add('hidden');
    statsActions.classList.add('hidden');
    gameButtons.classList.add('hidden');
    stopBtn.disabled = true;
    restartBtn.classList.remove('hidden');
    backMenuBtn.classList.remove('hidden');

    if (score > best) {
      best = score;
      localStorage.setItem('braillechord_best', best);
      bestEl.textContent = best;
    }

    exitApplicationMode();
    try { restartBtn.focus(); } catch (e) {}
  }

  function startGame(mode) {
    selectedMode = mode;
    timeLimit = mode === 'easy' ? Math.round(baseTimeLimit * 1.3) : baseTimeLimit;

    if (running) return;

    // Unlock audio
    if (!isAudioUnlocked) {
      Object.values(audioBank).forEach(a => {
        if (a) { a.play().catch(()=>{}); a.pause(); a.currentTime=0; }
      });
      isAudioUnlocked = true;
    }

    // Reset visibility for game start
    titleEl.classList.remove('hidden');
    descP.classList.remove('hidden');
    statusDiv.classList.remove('hidden');
    statsActions.classList.remove('hidden');
    gameButtons.classList.remove('hidden');
    restartBtn.classList.add('hidden');
    backMenuBtn.classList.add('hidden');

    play('start');
    running = true;
    score = 0; round = 0;
    scoreEl.textContent = '0';
    roundEl.textContent = '0';
    speedEl.textContent = difficultyLabel(timeLimit);

    stopBtn.disabled = false;

    topBackBtn.classList.add('hidden');
    modeSelect.classList.add('hidden');
    gameContainer.classList.remove('hidden');

    // ‡πÄ‡∏û‡∏¥‡πà‡∏° announcement ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà DOM ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏ß‡∏¢ SR ‡∏ö‡∏≤‡∏á‡∏ï‡∏±‡∏ß
    srLive.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Å‡∏°...';

    // Delay ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤ application mode
    setTimeout(() => {
      enterApplicationMode();
      setPrompt('‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß...');
      setTimeout(nextRound, 1800);
    }, 80);   // 80ms ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á DOM ‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤ mode (‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ö 120ms ‡πÉ‡∏ô enter ‚Üí ‡∏£‡∏ß‡∏° ~200ms)
  }

  function restartSameMode() {
    if (!selectedMode) return;
    startGame(selectedMode);
  }

  function stopGame() {
    if (!running) return;
    fail('‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏î‡∏´‡∏¢‡∏∏‡∏î');
  }

  function toggleAudioMode() {
    if (audioMode === 'file') {
      audioMode = 'tts';
      audioModeBtn.textContent = '‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á: TTS';
      stopAllSounds();
    } else if (audioMode === 'tts') {
      audioMode = 'off';
      audioModeBtn.textContent = '‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á: ‡∏õ‡∏¥‡∏î';
      speechSynthesis.cancel();
    } else {
      audioMode = 'file';
      audioModeBtn.textContent = '‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á: Audio';
    }
  }

  function backToMenu() {
    running = false;
    clearInterval(timer);
    stopAllSounds();
    topBackBtn.classList.remove('hidden');
    gameContainer.classList.add('hidden');
    modeSelect.classList.remove('hidden');
    exitApplicationMode();
    try { modeSelect.focus(); } catch (e) {}
  }

  // ‚îÄ‚îÄ Event Listeners ‚îÄ‚îÄ
  qs('#btnEasy').addEventListener('click', () => startGame('easy'));
  qs('#btnHard').addEventListener('click', () => startGame('hard'));

  restartBtn.addEventListener('click', restartSameMode);
  backMenuBtn.addEventListener('click', backToMenu);
  stopBtn.addEventListener('click', stopGame);
  audioModeBtn.addEventListener('click', toggleAudioMode);

  clearStatsBtn.addEventListener('click', () => confirmClear.classList.remove('hidden'));
  confirmYes.addEventListener('click', () => {
    best = 0;
    localStorage.removeItem('braillechord_best');
    bestEl.textContent = '0';
    setPrompt('‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß');
    vibrate([50,50,50]);
    confirmClear.classList.add('hidden');
  });
  confirmNo.addEventListener('click', () => confirmClear.classList.add('hidden'));

  // Chord input with strict mode check
  window.addEventListener('keydown', e => {
    if (!running || !awaitingInput || !gameContainer.hasAttribute('role')) return;
    const key = e.key.toLowerCase();
    if (!(key in keyToDot)) return;
    e.preventDefault();
    const dot = keyToDot[key];
    if (!pressed.has(dot)) {
      pressed.add(dot);
      checkChord();
    }
  });

  window.addEventListener('keyup', e => {
    if (!running || !awaitingInput || !gameContainer.hasAttribute('role')) return;
    const key = e.key.toLowerCase();
    if (!(key in keyToDot)) return;
    pressed.delete(keyToDot[key]);
  });

  function checkChord() {
    if (!currentPattern) return;
    const required = new Set(currentPattern.dots.split(',').map(d=>d.trim()));

    if (pressed.size > required.size) {
      fail('‡∏Å‡∏î‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏∏‡∏î');
      return;
    }

    if (pressed.size === required.size && [...pressed].every(d => required.has(d))) {
      succeed();
    }
  }

})();
</script>
</body>
</html>