<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Accessible Bop It! (Thai) - Upgraded</title>
  <style>
    :root {
      --bg: #0b1220; --card:#121a2b; --text:#e6ecff; --accent:#7cc4ff; --good:#2ecc71; --bad:#ff6b6b; --warning:#f39c12;
    }
    html,body{height:100%;}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);-webkit-tap-highlight-color: transparent;}
    .container{max-width:950px;margin:0 auto;padding:16px;}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.04),rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.08);box-shadow:0 10px 30px rgba(0,0,0,.35);border-radius:18px;padding:20px}
    .card:focus{outline:none;}
    h1{font-size:clamp(20px,4vw,36px);margin:0 0 8px 0}
    h2{font-size:clamp(18px,3vw,24px);margin:0 0 12px 0}
    p{line-height:1.6}
    .grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.6rem;padding:14px 18px;border-radius:14px;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);color:var(--text);font-weight:700;cursor:pointer;transition:all 0.2s ease; user-select: none;}
    .btn:hover{background:rgba(255,255,255,.12);border-color:rgba(255,255,255,.25)}
    .btn:focus{outline:3px solid var(--accent);outline-offset:2px}
    .btn:active{transform: scale(0.97);}
    .btn[disabled]{opacity:.6;cursor:not-allowed; transform: none;}
    .btn.warning{background:rgba(243,156,18,.1);border-color:rgba(243,156,18,.3);color:var(--warning)}
    .btn.warning:hover{background:rgba(243,156,18,.2)}
    .btn.small{padding:8px 12px;font-size:14px}
    .big{font-size:22px;padding:18px 22px}
    .status{display:flex;gap:12px;flex-wrap:wrap}
    .pill{padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12)}
    .flex{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .panel{background:var(--card);border-radius:16px;padding:16px;border:1px solid rgba(255,255,255,.08)}
    .prompt{font-size:clamp(24px,5vw,44px);font-weight:900;letter-spacing:.5px; min-height: 50px;}
    .prompt:focus{outline:none;}
    .good{color:var(--good)}
    .bad{color:var(--bad)}
    .footer{opacity:.8; margin-top: 16px; font-size: 0.9em;}
    .stats-actions{margin-top:12px}
    .tap-hint{font-size:0.9em;opacity:0.8;margin-top:8px;font-style:italic}
    
    .key-config{margin-top:16px;padding:12px;background:rgba(255,255,255,.03);border-radius:12px}
    .key-row{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
    .key-row:last-child{margin-bottom:0}
    .key-label{min-width:80px;font-weight:600}
    .key-display{background:#0e1527;border:1px solid rgba(255,255,255,.2);padding:4px 8px;border-radius:6px;min-width:30px;text-align:center;font-family:monospace}
    .waiting-key{background:var(--accent);color:#000;animation:pulse 1s infinite}
    @keyframes pulse{0%,100%{opacity:1} 50%{opacity:0.7}}

    /* --- Confirmation Dialog --- */
    .confirm-dialog { display: none; margin-top: 12px; background: rgba(243,156,18,.1); padding: 12px; border-radius: 12px; border: 1px solid rgba(243,156,18,.3);}
    .confirm-dialog p { margin: 0 0 8px 0; }

    /* --- Responsive Styles --- */
    .mobile-only { display: none; }
    .mobile-controls {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-top: 16px;
    }

    /* On screens smaller than 768px (tablets/phones) */
    @media (max-width: 768px) {
        .desktop-only { display: none; }
        .mobile-only { display: grid; }
        .container { padding: 12px; }
        .card { padding: 16px; }
        .grid { grid-template-columns: 1fr; } /* Stack panels on mobile */
    }
  </style>
</head>
<body>
  <main class="container">
  <button class="flex items-center rounded-md border border-slate-300 py-2 px-4 text-center text-sm transition-all shadow-sm hover:shadow-lg text-slate-600 hover:text-white hover:bg-slate-800 hover:border-slate-800 focus:text-white focus:bg-slate-800 focus:border-slate-800 active:border-slate-800 active:text-white active:bg-slate-800 disabled:pointer-events-none disabled:opacity-50 disabled:shadow-none" type="button" onclick="location.href='../index.html'">
			‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å
		   <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 ml-1.5">
			<path fill-rule="evenodd" d="M16.28 11.47a.75.75 0 0 1 0 1.06l-7.5 7.5a.75.75 0 0 1-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 0 1 1.06-1.06l7.5 7.5Z" clip-rule="evenodd" />
		  </svg>
		</button>
    <section id="game-container" class="card" aria-labelledby="title" tabindex="-1">
      <h1 id="title">‡πÄ‡∏Å‡∏° Bop It! ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏≠‡πà‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠)</h1>
      <p>‡πÄ‡∏•‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏µ‡∏¢‡πå‡∏ö‡∏≠‡∏£‡πå‡∏î ‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡πÅ‡∏•‡∏∞‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠</p>
      
      <div class="status" aria-live="polite" aria-atomic="true">
        <div class="pill" id="scorePill" role="status">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô: <strong id="score">0</strong></div>
        <div class="pill">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î: <strong id="best">0</strong></div>
        <div class="pill">‡∏£‡∏≠‡∏ö: <strong id="round">0</strong></div>
        <div class="pill">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß: <strong id="speed">‡∏ä‡πâ‡∏≤</strong></div>
      </div>

      <div class="stats-actions">
        <button id="clearStatsBtn" class="btn warning" aria-describedby="clearStatsDesc">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</button>
        <div id="clearStatsDesc" class="sr-only">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</div>
        <div id="confirmClear" class="confirm-dialog">
            <p>‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
            <div class="flex">
                <button id="confirmClearYes" class="btn warning small">‡πÉ‡∏ä‡πà, ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏¢</button>
                <button id="confirmClearNo" class="btn small">‡πÑ‡∏°‡πà, ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>
      </div>

      <div class="grid" style="margin-top:16px">
        <div class="panel">
          <div id="prompt" class="prompt" role="status" aria-live="assertive">‡∏Å‡∏î "‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°</div>
          <div id="sr-aria" class="sr-only" aria-live="assertive" aria-atomic="true"></div>
          <div class="flex" style="margin-top:10px">
            <button id="startBtn" class="btn big">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
            <button id="stopBtn" class="btn" disabled>‚èπ ‡∏´‡∏¢‡∏∏‡∏î</button>
            <button id="audioModeBtn" class="btn">‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á: Audio</button>
          </div>
          <!-- Mobile Controls: Shown only on small screens -->
          <div class="mobile-only mobile-controls">
              <button class="btn" data-act="bop">‡∏Å‡∏î (Bop)</button>
              <button class="btn" data-act="pull">‡∏î‡∏∂‡∏á (Pull)</button>
              <button class="btn" data-act="twistLeft">‡∏ö‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢</button>
              <button class="btn" data-act="twistRight">‡∏ö‡∏¥‡∏î‡∏Ç‡∏ß‡∏≤</button>
          </div>
        </div>

        <!-- Desktop-only panel for key configuration and on-screen buttons -->
        <div class="panel desktop-only">
          <h2>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏µ‡∏¢‡πå</h2>
          <p>‡∏Ñ‡∏•‡∏¥‡∏Å "‡∏Å‡∏≥‡∏´‡∏ô‡∏î" ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏µ‡∏¢‡πå‡∏ú‡∏™‡∏° (‡πÄ‡∏ä‡πà‡∏ô Alt+S)</p>
          
          <div id="keyConfig">
             <!-- Key config rows from original code -->
            <div class="key-row"><span class="key-label">‡πÄ‡∏£‡∏¥‡πà‡∏°/‡∏´‡∏¢‡∏∏‡∏î:</span><span class="key-display" id="key-startStop"></span><button class="btn small" data-cmd="startStop">‡∏Å‡∏≥‡∏´‡∏ô‡∏î</button></div>
            <div class="key-row"><span class="key-label">‡∏Å‡∏î!:</span><span class="key-display" id="key-bop"></span><button class="btn small" data-cmd="bop">‡∏Å‡∏≥‡∏´‡∏ô‡∏î</button></div>
            <div class="key-row"><span class="key-label">‡∏î‡∏∂‡∏á!:</span><span class="key-display" id="key-pull"></span><button class="btn small" data-cmd="pull">‡∏Å‡∏≥‡∏´‡∏ô‡∏î</button></div>
            <div class="key-row"><span class="key-label">‡∏ö‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢!:</span><span class="key-display" id="key-twistLeft"></span><button class="btn small" data-cmd="twistLeft">‡∏Å‡∏≥‡∏´‡∏ô‡∏î</button></div>
            <div class="key-row"><span class="key-label">‡∏ö‡∏¥‡∏î‡∏Ç‡∏ß‡∏≤!:</span><span class="key-display" id="key-twistRight"></span><button class="btn small" data-cmd="twistRight">‡∏Å‡∏≥‡∏´‡∏ô‡∏î</button></div>
            <div class="key-row"><span class="key-label">‡πÄ‡∏Ç‡∏¢‡πà‡∏≤!:</span><span class="key-display" id="key-shake"></span><button class="btn small" data-cmd="shake">‡∏Å‡∏≥‡∏´‡∏ô‡∏î</button></div>
            <div class="key-row"><span class="key-label">‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡∏ã‡πâ‡∏≤‡∏¢!:</span><span class="key-display" id="key-tiltLeft"></span><button class="btn small" data-cmd="tiltLeft">‡∏Å‡∏≥‡∏´‡∏ô‡∏î</button></div>
            <div class="key-row"><span class="key-label">‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡∏Ç‡∏ß‡∏≤!:</span><span class="key-display" id="key-tiltRight"></span><button class="btn small" data-cmd="tiltRight">‡∏Å‡∏≥‡∏´‡∏ô‡∏î</button></div>
          </div>
          
          <div class="flex" style="margin-top:12px">
            <button id="resetKeysBtn" class="btn small">üîÑ ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</button>
          </div>

          <div class="controls grid" style="margin-top:16px" aria-label="‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏ö‡∏ô‡∏à‡∏≠">
            <button class="btn" data-act="bop">‡∏Å‡∏î (Bop)</button>
            <button class="btn" data-act="pull">‡∏î‡∏∂‡∏á (Pull)</button>
            <button class="btn" data-act="twistLeft">‡∏ö‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢ (Twist Left)</button>
            <button class="btn" data-act="twistRight">‡∏ö‡∏¥‡∏î‡∏Ç‡∏ß‡∏≤ (Twist Right)</button>
            <button class="btn" data-act="shake">‡πÄ‡∏Ç‡∏¢‡πà‡∏≤ (Shake)</button>
            <button class="btn" data-act="tiltLeft">‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡∏ã‡πâ‡∏≤‡∏¢</button>
            <button class="btn" data-act="tiltRight">‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡∏Ç‡∏ß‡∏≤</button>
          </div>
          <div class="tap-hint">
            üí° ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠: ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° (‡∏Å‡∏î ‡∏î‡∏∂‡∏á ‡∏ö‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢ ‡∏ö‡∏¥‡∏î‡∏Ç‡∏ß‡∏≤) ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö
          </div>
        </div>
      </div>

    </section>
  </main>

  <!-- Audio files -->
  <audio id="snd-bop" preload="auto" src="sounds/bop.mp3"></audio>
  <audio id="snd-pull" preload="auto" src="sounds/pull.mp3"></audio>
  <audio id="snd-twistLeft" preload="auto" src="sounds/twistLeft.mp3"></audio>
  <audio id="snd-twistRight" preload="auto" src="sounds/twistRight.mp3"></audio>
  <audio id="snd-shake" preload="auto" src="sounds/shake.mp3"></audio>
  <audio id="snd-tiltLeft" preload="auto" src="sounds/tiltLeft.mp3"></audio>
  <audio id="snd-tiltRight" preload="auto" src="sounds/tiltRight.mp3"></audio>
  <audio id="snd-correct" preload="auto" src="sounds/correct.mp3"></audio>
  <audio id="snd-wrong" preload="auto" src="sounds/wrong.mp3"></audio>
  <audio id="snd-tick" preload="auto" src="sounds/tick.mp3"></audio>
  <audio id="snd-start" preload="auto" src="sounds/start.mp3"></audio>
  <audio id="snd-gameover" preload="auto" src="sounds/gameover.mp3"></audio>

  <script>
  (() => {
    const qs = sel => document.querySelector(sel);
    const qsa = sel => Array.from(document.querySelectorAll(sel));

    // --- DOM Elements ---
    const gameContainer = qs('#game-container');
    const promptEl = qs('#prompt');
    const srLive = qs('#sr-aria');
    const scoreEl = qs('#score');
    const bestEl = qs('#best');
    const roundEl = qs('#round');
    const speedEl = qs('#speed');
    const startBtn = qs('#startBtn');
    const stopBtn = qs('#stopBtn');
    const audioModeBtn = qs('#audioModeBtn');
    const clearStatsBtn = qs('#clearStatsBtn');
    const resetKeysBtn = qs('#resetKeysBtn');
    const confirmClearDialog = qs('#confirmClear');
    const confirmClearYesBtn = qs('#confirmClearYes');
    const confirmClearNoBtn = qs('#confirmClearNo');

    // --- Constants and State ---
    const audioBank = {
      bop: qs('#snd-bop'), pull: qs('#snd-pull'), twistLeft: qs('#snd-twistLeft'),
      twistRight: qs('#snd-twistRight'), shake: qs('#snd-shake'), tiltLeft: qs('#snd-tiltLeft'),
      tiltRight: qs('#snd-tiltRight'), correct: qs('#snd-correct'), wrong: qs('#snd-wrong'), tick: qs('#snd-tick'),
      start: qs('#snd-start'), gameover: qs('#snd-gameover'),
    };

    const CMD_THAI = {
      bop: '‡∏Å‡∏î!', pull: '‡∏î‡∏∂‡∏á!', twistLeft: '‡∏ö‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢!', twistRight: '‡∏ö‡∏¥‡∏î‡∏Ç‡∏ß‡∏≤!',
      shake: '‡πÄ‡∏Ç‡∏¢‡πà‡∏≤!', tiltLeft: '‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡∏ã‡πâ‡∏≤‡∏¢!', tiltRight: '‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡∏Ç‡∏ß‡∏≤!',
      startStop: '‡πÄ‡∏£‡∏¥‡πà‡∏°/‡∏´‡∏¢‡∏∏‡∏î ‡πÄ‡∏Å‡∏°'
    };

    const TTS_TEXTS = {
      ...CMD_THAI,
      correct: '‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
      wrong: '‡∏ú‡∏¥‡∏î',
      tick: '', // Tick is better silent in TTS mode
      start: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°',
      gameover: '‡πÄ‡∏Å‡∏°‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß'
    };
    
    const GAME_CMDS = ['bop', 'pull', 'twistLeft', 'twistRight', 'shake', 'tiltLeft', 'tiltRight'];

    const DEFAULT_KEYS = {
      startStop: ' ',
      bop: 'ArrowDown',
      pull: 'ArrowUp',
      twistLeft: 'a',
      twistRight: 'd', 
      shake: 'w',
      tiltLeft: 'ArrowLeft',
      tiltRight: 'ArrowRight'
    };
    let customKeys = {...DEFAULT_KEYS};
    let waitingForKey = null;
    let audioMode = 'file'; // 'file', 'tts', 'off'
    let motionSensorsEnabled = false;
    let isAudioUnlocked = false;

    // --- GAME STATE ---
    let currentCmd = null;
    let score = 0, best = Number(localStorage.getItem('bopit_best')||0), round = 0, timer = null, timeLimit = 3000, running = false, awaitingInput = false;

    // --- Audio and Haptics ---
    function stopAllSounds() {
        Object.values(audioBank).forEach(audio => {
            if (audio && !audio.paused) {
                audio.pause();
                audio.currentTime = 0;
            }
        });
    }

    function speakThai(text) {
        if (!text) return;
        try {
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'th-TH';
            u.rate = 1.2;
            speechSynthesis.cancel();
            speechSynthesis.speak(u);
        } catch (e) {
            console.error("Speech synthesis failed", e);
        }
    }

    function play(name){
      if (audioMode === 'off') return;

      if (audioMode === 'tts') {
          const textToSpeak = TTS_TEXTS[name];
          speakThai(textToSpeak);
      } else { // 'file' mode
        const a = audioBank[name];
        if(a){
          a.currentTime = 0;
          a.play().catch(error => {
            // console.error(`Error playing sound '${name}':`, error);
          });
        }
      }
    }
    
    function vibrate(ms){
      try { navigator.vibrate?.(ms); } catch(_){} 
    }

    // --- Game Core Logic ---
    function setPrompt(text, cls){
      promptEl.className = 'prompt';
      if(cls) promptEl.classList.add(cls);
      promptEl.textContent = text;
      srLive.textContent = text;
    }

    function difficultyLabel(ms){
      if(ms > 1800) return '‡∏ä‡πâ‡∏≤';
      if(ms > 1200) return '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á';
      if(ms > 800) return '‡πÄ‡∏£‡πá‡∏ß';
      return '‡πÄ‡∏£‡πá‡∏ß‡∏°‡∏≤‡∏Å';
    }

    function nextRound(){
      awaitingInput = true;
      round += 1; roundEl.textContent = String(round);
      currentCmd = GAME_CMDS[Math.floor(Math.random()*GAME_CMDS.length)];
      setPrompt(CMD_THAI[currentCmd]);
      play(currentCmd);
      vibrate(40);
      
      clearInterval(timer);
      const deadline = performance.now() + timeLimit;
      let ticked = false;
      timer = setInterval(() => {
        const now = performance.now();
        if(now > deadline){
          clearInterval(timer);
          fail("‡∏ä‡πâ‡∏≤‡πÑ‡∏õ!");
          return;
        }
        if(!ticked && deadline - now < 700){ play('tick'); ticked = true; }
      }, 50);
    }

    function succeed(){
      clearInterval(timer);
      awaitingInput = false;
      score += 1; scoreEl.textContent = String(score);
      setPrompt('‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!', 'good');
      play('correct'); vibrate([30, 60, 30]);
      timeLimit = Math.max(550, Math.floor(timeLimit * 0.94));
      speedEl.textContent = difficultyLabel(timeLimit);
      setTimeout(nextRound, 450);
    }

    function fail(reason='‡∏ú‡∏¥‡∏î!'){
      if (!running) return;
      awaitingInput = false;
      running = false;
      clearInterval(timer);
      stopAllSounds(); // Stop any currently playing sounds (like 'tick')
      play('gameover'); // Now play the gameover sound on a clean slate
      setPrompt(`‡∏à‡∏ö‡πÄ‡∏Å‡∏°: ${reason}`, 'bad');
      vibrate([120,60,120]);
      startBtn.disabled = false; stopBtn.disabled = true;
      if(score > best){ best = score; localStorage.setItem('bopit_best', String(best)); bestEl.textContent = String(best); }
      
      gameContainer.removeAttribute('role'); 
      startBtn.focus(); 
    }

    function startGame(){
      if(running) return;
      
      // Robust audio unlock on the first user interaction.
      if (!isAudioUnlocked) {
          console.log("Unlocking audio for mobile...");
          Object.values(audioBank).forEach(audio => {
              if (audio) {
                  audio.play();
                  audio.pause();
                  audio.currentTime = 0;
              }
          });
          isAudioUnlocked = true;
      }

      play('start');
      requestMotionSensors(); 
      running = true; 
      score = 0; 
      round = 0; 
      timeLimit = 3000;
      scoreEl.textContent = '0'; 
      roundEl.textContent = '0'; 
      speedEl.textContent = difficultyLabel(timeLimit);
      startBtn.disabled = true; 
      stopBtn.disabled = false;
      
      setPrompt('‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß...', '');
      gameContainer.setAttribute('role', 'application'); 
      gameContainer.focus();
      setTimeout(nextRound, 2000);
    }

    function stopGame(){ 
      if(!running) return; 
      fail('‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏î‡∏´‡∏¢‡∏∏‡∏î');
    }
    
    function toggleAudioMode() {
        if (audioMode === 'file') {
            audioMode = 'tts';
            audioModeBtn.textContent = '‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á: TTS';
            stopAllSounds();
        } else if (audioMode === 'tts') {
            audioMode = 'off';
            audioModeBtn.textContent = '‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á: ‡∏õ‡∏¥‡∏î';
            speechSynthesis.cancel();
        } else { // 'off'
            audioMode = 'file';
            audioModeBtn.textContent = '‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á: Audio';
        }
    }

    function handleClearStatsRequest() {
        confirmClearDialog.style.display = 'block';
        clearStatsBtn.style.display = 'none';
    }

    function confirmClearAction() {
        best = 0;
        localStorage.removeItem('bopit_best');
        bestEl.textContent = '0';
        setPrompt('‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß');
        vibrate([50, 50, 50]);
        setTimeout(() => { if(!running) setPrompt('‡∏Å‡∏î "‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°'); }, 1500);
        cancelClearAction();
    }
    
    function cancelClearAction() {
        confirmClearDialog.style.display = 'none';
        clearStatsBtn.style.display = 'inline-flex';
    }


    // --- Input Event Handlers ---
    window.addEventListener('keydown', e => {
      // 1. Handle key configuration mode
      if (waitingForKey) {
        e.preventDefault(); e.stopPropagation();
        const keyCombo = getCanonicalKey(e);
        if (!keyCombo || ['Control', 'Alt', 'Shift', 'Meta'].includes(keyCombo)) {
            setPrompt("‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏î‡∏Ñ‡∏µ‡∏¢‡πå‡∏ú‡∏™‡∏°‡∏Å‡∏±‡∏ö‡∏Ñ‡∏µ‡∏¢‡πå‡∏≠‡∏∑‡πà‡∏ô (‡πÄ‡∏ä‡πà‡∏ô Alt+S)");
            return;
        }
        customKeys[waitingForKey] = keyCombo;
        saveCustomKeys();
        const keyDisplay = qs(`#key-${waitingForKey}`);
        keyDisplay.classList.remove('waiting-key');
        updateKeyDisplays();
        setPrompt(`‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${CMD_THAI[waitingForKey]} ‡∏Ñ‡∏∑‡∏≠ ${keyDisplay.textContent}`);
        waitingForKey = null;
        return;
      }

      const pressedCombo = getCanonicalKey(e);

      // 2. Handle events when the game IS RUNNING
      if (running) {
        if (!e.key.startsWith('F') && e.key !== 'Tab') {
          e.preventDefault();
          e.stopPropagation();
        }
        if (e.key === 'Escape') { stopGame(); return; }
        if (customKeys['startStop'].toLowerCase() === pressedCombo.toLowerCase()) { stopGame(); return; }
        if (awaitingInput) {
          const matchedCmd = GAME_CMDS.find(cmd => customKeys[cmd].toLowerCase() === pressedCombo.toLowerCase());
          if (matchedCmd) {
            if (matchedCmd === currentCmd) succeed();
            else fail('‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á');
          }
        }
      }
      // 3. Handle events when the game IS NOT RUNNING
      else {
        if (customKeys['startStop'].toLowerCase() === pressedCombo.toLowerCase()) {
          if (e.key === ' ') e.preventDefault();
          if (!startBtn.disabled) {
            startGame();
          }
        }
      }
    }, { capture: true });


    if(resetKeysBtn){
        resetKeysBtn.addEventListener('click', () => {
            customKeys = {...DEFAULT_KEYS};
            saveCustomKeys();
            updateKeyDisplays();
            setPrompt('‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
        });
    }

    // UPDATED: More responsive button presses for all devices
    qsa('[data-act]').forEach(btn => {
      const handlePress = (e) => {
        e.preventDefault(); // Prevents zoom/scroll and potential double events
        if(!awaitingInput) return;
        const act = btn.getAttribute('data-act');
        if(act === currentCmd) succeed();
        else fail('‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏ô‡∏à‡∏≠‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á');
      };

      btn.addEventListener('touchstart', handlePress, { passive: false });
      btn.addEventListener('mousedown', handlePress); // Fallback for desktop
    });

    // --- Mobile / Touch Controls ---
    let lastTapTime = 0, lastTapX = 0;
    document.body.addEventListener('touchend', e => {
      if(!awaitingInput) return;
      const touch = e.changedTouches[0]; if(!touch) return;
      const currentTime = Date.now();
      const currentX = touch.clientX;
      if(currentTime - lastTapTime < 300 && Math.abs(currentX - lastTapX) < 80){
          const targetCmd = currentX < window.innerWidth / 2 ? 'twistLeft' : 'twistRight';
          if(currentCmd === targetCmd) succeed();
          else fail(`‡πÅ‡∏ï‡∏∞ ${targetCmd === 'twistLeft' ? '‡∏ã‡πâ‡∏≤‡∏¢' : '‡∏Ç‡∏ß‡∏≤'} 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á`);
          lastTapTime = 0; 
      } else { lastTapTime = currentTime; lastTapX = currentX; }
    });

    // --- Mobile / Motion Controls ---
    let lastShakeTime = 0;
    function handleDeviceMotion(e){
      if(!awaitingInput || currentCmd !== 'shake') return;
      const {x, y, z} = e.accelerationIncludingGravity || {x:0,y:0,z:0};
      const mag = Math.sqrt(x*x + y*y + z*z);
      const now = performance.now();
      // UPDATED: Lowered magnitude threshold and debounce time for faster response
      if(mag > 22 && (now - lastShakeTime) > 400){ 
        lastShakeTime = now; 
        succeed(); 
      }
    }

    let isTilted = false;
    function handleDeviceOrientation(e) {
      if (!awaitingInput || isTilted || (currentCmd !== 'tiltLeft' && currentCmd !== 'tiltRight')) return;
      const gamma = e.gamma; // Left-to-right tilt
      let tiltCmd = null;
      if (gamma > 25) tiltCmd = 'tiltRight'; else if (gamma < -25) tiltCmd = 'tiltLeft';
      if (tiltCmd) {
          isTilted = true;
          if (currentCmd === currentCmd) succeed(); else fail(`‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á`);
          // UPDATED: Shortened cooldown for quicker successive tilts
          setTimeout(() => { isTilted = false; }, 300);
      }
    }

    function requestMotionSensors() {
      if (motionSensorsEnabled) return;
      if (typeof DeviceMotionEvent?.requestPermission === 'function') {
        DeviceMotionEvent.requestPermission()
        .then(state => {
            if (state === 'granted') {
                window.addEventListener('devicemotion', handleDeviceMotion);
                window.addEventListener('deviceorientation', handleDeviceOrientation);
                motionSensorsEnabled = true;
            }
        }).catch(console.error);
      } else {
        // For browsers that don't require permission (e.g., Android)
        window.addEventListener('devicemotion', handleDeviceMotion);
        window.addEventListener('deviceorientation', handleDeviceOrientation);
        motionSensorsEnabled = true;
      }
    }

    // --- INITIALIZATION ---
    promptEl.textContent = '‡∏Å‡∏î "‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°';
    
    startBtn.addEventListener('click', startGame);
    stopBtn.addEventListener('click', stopGame);
    audioModeBtn.addEventListener('click', toggleAudioMode);
    clearStatsBtn.addEventListener('click', handleClearStatsRequest);
    confirmClearYesBtn.addEventListener('click', confirmClearAction);
    confirmClearNoBtn.addEventListener('click', cancelClearAction);

    bestEl.textContent = String(best);
    loadCustomKeys();

    function getCanonicalKey(e) {
      const parts = [];
      if (e.ctrlKey) parts.push('Ctrl');
      if (e.altKey) parts.push('Alt');
      if (e.shiftKey) parts.push('Shift');
      
      const mainKey = e.key;
      if (!['Control', 'Alt', 'Shift', 'Meta'].includes(mainKey)) {
          parts.push(mainKey);
      } else if (parts.length === 0) {
          return mainKey;
      }
      return parts.join('+');
    }

    function loadCustomKeys(){
      try{
        const saved = localStorage.getItem('bopit_custom_keys_v3');
        if(saved){
          customKeys = {...DEFAULT_KEYS, ...JSON.parse(saved)};
        }
      }catch(e){
        customKeys = {...DEFAULT_KEYS};
      }
      updateKeyDisplays();
    }

    function saveCustomKeys(){
      try{
        localStorage.setItem('bopit_custom_keys_v3', JSON.stringify(customKeys));
      }catch(e){}
    }
    
    function updateKeyDisplays(){
      Object.keys(customKeys).forEach(cmd => {
        const el = qs(`#key-${cmd}`);
        if(el){
          const keyString = customKeys[cmd];
          el.textContent = keyString === ' ' ? 'Space' : keyString;
        }
      });
    }

    qsa('[data-cmd]').forEach(btn => {
      btn.addEventListener('click', () => {
        const cmd = btn.getAttribute('data-cmd');
        if (waitingForKey) {
          qs(`#key-${waitingForKey}`).classList.remove('waiting-key');
          updateKeyDisplays();
        }
        waitingForKey = cmd;
        const keyDisplay = qs(`#key-${cmd}`);
        keyDisplay.classList.add('waiting-key');
        keyDisplay.textContent = '‡∏£‡∏≠...';
        setPrompt(`‡∏Å‡∏î‡∏Ñ‡∏µ‡∏¢‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "${CMD_THAI[cmd]}"`);
      });
    });
  })();
  </script>
</body>
</html>

