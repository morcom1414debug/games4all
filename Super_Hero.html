<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เกมผจญภัยซุปเปอร์ฮีโร่</title>
    <!-- Tailwind CSS CDN สำหรับการจัดสไตล์ที่ตอบสนองต่อทุกอุปกรณ์ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tone.js CDN สำหรับการสร้างเสียงประกอบ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <!-- Google Fonts - Inter สำหรับรูปแบบตัวอักษร -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* กำหนดรูปแบบตัวอักษรเริ่มต้นสำหรับ body */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* กำหนดให้ปุ่มเริ่มต้นเกมมีแอนิเมชันกระพริบ */
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }
        .animate-pulse {
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex items-center justify-center">
    <!-- คอนเทนเนอร์หลักสำหรับเกม (จะถูกสลับไปมาระหว่างหน้าเริ่มต้นและหน้าเกม) -->
    <div id="game-container" class="min-h-screen flex items-center justify-center bg-gray-900 p-4 font-inter text-gray-100 w-full">
        <!-- เนื้อหาเริ่มต้นจะถูกสร้างโดย JavaScript -->
    </div>

    <script>
        // ตัวแปรสถานะของเกม
        let currentSceneId = 'origin'; // ID ของฉากปัจจุบัน
        let playerTraits = {};        // คุณสมบัติของผู้เล่นที่สะสมจากการตัดสินใจ
        let playerPower = '';         // พลังพิเศษที่ผู้เล่นเลือกในตอนแรก
        const totalStoryScenes = 6;   // จำนวนฉากเนื้อเรื่องหลักหลังฉาก origin (scene1 ถึง scene6)
        let scenesPlayedCount = 0;    // จำนวนฉากเนื้อเรื่องที่เล่นไปแล้ว (ไม่รวม origin)

        // Tone.js synthesizers สำหรับเอฟเฟกต์เสียง
        // ใช้ Synth สำหรับเสียงคลิกปุ่ม
        const choiceSynth = new Tone.Synth({
            oscillator: { type: "sine" },
            envelope: {
                attack: 0.005,
                decay: 0.1,
                sustain: 0.0,
                release: 0.1
            }
        }).toDestination();
        // ใช้ PolySynth สำหรับเสียงเปลี่ยนฉาก (เป็นคอร์ดสั้นๆ)
        const sceneTransitionSynth = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: "triangle" },
            envelope: {
                attack: 0.01,
                decay: 0.2,
                sustain: 0.0,
                release: 0.2
            }
        }).toDestination();


        // ตัวแปร DOM elements ที่สำคัญ (จะถูกกำหนดค่าใหม่เมื่อเนื้อหาถูกโหลด)
        let gameTextElement;
        let choicesContainer;
        let endingContainer;
        let endingTitleElement;
        let endingTextElement;
        let restartButton;
        let bgMusic; // สำหรับเพลงประกอบฉาก

        // คำจำกัดความของฉากต่างๆ ในเกม
        const scenes = {
            'origin': {
                text: "คุณตื่นขึ้นมาในห้องทดลองลับที่ไม่คุ้นเคย ทั่วร่างคุณรู้สึกถึงพลังงานอันมหาศาลที่ปะทุขึ้นมา คุณได้ถูกเลือกให้มีพลังพิเศษบางอย่าง พลังใดที่คุณต้องการ?",
                choices: [
                    { text: "พลังควบคุมธาตุ: ควบคุมไฟ, น้ำ, ดิน, ลมได้ดั่งใจนึก", nextSceneId: 'elemental_scene1', trait: 'elemental', powerType: 'elemental' },
                    { text: "ความเร็วเหนือเสียง: เคลื่อนที่ได้เร็วกว่าสายตาเห็น", nextSceneId: 'speed_scene1', trait: 'speed', powerType: 'speed' },
                    { text: "พลังจิต: เคลื่อนย้ายสิ่งของ อ่านใจ และสร้างภาพลวงตา", nextSceneId: 'telekinetic_scene1', trait: 'telekinetic', powerType: 'telekinetic' }
                ]
            },
            // --- ฉากสำหรับผู้ใช้พลังธาตุ ---
            'elemental_scene1': {
                text: "เสียงกรีดร้องดังขึ้นจากใจกลางเมือง 'วิลเลน' ปรากฏตัวขึ้นพร้อมกองทัพหุ่นยนต์ก่อความวุ่นวาย คุณจะใช้พลังธาตุของคุณรับมืออย่างไร?",
                choices: [
                    { text: "สร้างกำแพงหินขนาดใหญ่ปกป้องพลเมือง และใช้ไฟเผาผลาญหุ่นยนต์", nextSceneId: 'elemental_scene2', trait: 'bravery' },
                    { text: "ควบคุมน้ำจากท่อประปาใต้ดินเพื่อลัดวงจรหุ่นยนต์และใช้ลมพัดให้กระจัดกระจาย", nextSceneId: 'elemental_scene2', trait: 'intellect' },
                    { text: "สร้างพายุทอร์นาโดขนาดเล็กเพื่ออพยพผู้คน และใช้กระแสไฟฟ้าจากฟ้าผ่าทำลายหุ่นยนต์", nextSceneId: 'elemental_scene2', trait: 'heroism' }
                ]
            },
            'elemental_scene2': {
                text: "เมื่อคุณเข้าใกล้ 'วิลเลน' คุณพบว่าเขาไม่ได้ควบคุมหุ่นยนต์ด้วยตัวเอง แต่ถูกสะกดจิตอยู่ คุณในฐานะผู้ควบคุมธาตุจะช่วยเขาได้อย่างไร?",
                choices: [
                    { text: "ใช้พลังธาตุโจมตี 'วิลเลน' ให้สลบเพื่อหยุดเขา แม้รู้ว่าถูกสะกดจิต", nextSceneId: 'elemental_scene3', trait: 'ruthless' },
                    { text: "พยายามใช้ธาตุสายลมปลุกกระแสประสาทของ 'วิลเลน' เพื่อปลดปล่อยเขาจากการควบคุม", nextSceneId: 'elemental_scene3', trait: 'compassion' },
                    { text: "ติดตามพลังงานมืดที่สะกดจิต 'วิลเลน' เพื่อหาต้นตอที่แท้จริง", nextSceneId: 'elemental_scene3', trait: 'investigative' }
                ]
            },
            'elemental_scene3': {
                text: "ขณะที่คุณกำลังปฏิบัติภารกิจ ฮีโร่อีกคนนามว่า 'เดอะไนท์' ก็ปรากฏตัวขึ้น เขามีเป้าหมายเดียวกันแต่ใช้วิธีที่รุนแรงกว่า 'เดอะไนท์' ใช้พลังความมืด คุณจะร่วมมือกับเขาหรือไม่?",
                choices: [
                    { text: "ร่วมมือกับ 'เดอะไนท์': การผสานพลังธาตุกับพลังความมืดอาจหยุดยั้งภัยคุกคามได้เร็วขึ้น", nextSceneId: 'elemental_scene4', trait: 'teamwork' },
                    { text: "ทำงานแยกกัน: คุณไม่เห็นด้วยกับวิธีการที่รุนแรงของเขา และจะใช้ธาตุของคุณอย่างบริสุทธิ์ใจ", nextSceneId: 'elemental_scene4', trait: 'independent' },
                    { text: "แข่งขันกับเขา: พิสูจน์ว่าพลังธาตุของคุณคือหนทางที่เหนือกว่าในการจัดการกับวายร้าย", nextSceneId: 'elemental_scene4', trait: 'competitive' }
                ]
            },
            'elemental_scene4': {
                text: "สถานการณ์บีบคั้น ผู้บงการที่แท้จริงกำลังจะปล่อยพลังทำลายล้างที่สามารถกวาดล้างเมืองได้ทั้งหมด คุณต้องเลือกระหว่างความเสียหายเล็กน้อยกับหายนะใหญ่หลวง คุณจะใช้พลังธาตุหยุดยั้งอย่างไร?",
                choices: [
                    { text: "สร้างโล่ธาตุขนาดมหึมาครอบคลุมเมืองเพื่อรับแรงระเบิดทั้งหมด แม้คุณจะใช้พลังเกินขีดจำกัด", nextSceneId: 'elemental_scene5', trait: 'ultimate_heroism' },
                    { text: "ใช้ธาตุดินสร้างอุโมงค์ใต้ดินเพื่ออพยพผู้คน และใช้ธาตุลมเบี่ยงเบนพลังทำลายล้าง", nextSceneId: 'elemental_scene5', trait: 'resourceful' },
                    { text: "สร้างเกราะน้ำแข็งรอบตัวเองและหาที่กำบังที่ดีที่สุด รอโอกาสอื่นที่จะจัดการกับผู้บงการ", nextSceneId: 'elemental_scene5', trait: 'selfish' }
                ]
            },
            'elemental_scene5': {
                text: "คุณเผชิญหน้ากับ 'จอมบงการ' ตัวจริงในรังลับของเขา ซึ่งเป็นมิติที่เต็มไปด้วยพลังงานมืดและสิ่งมีชีวิตที่ถูกบิดเบือน นี่คือการต่อสู้ครั้งสุดท้ายเพื่อชี้ชะตาโลก! คุณจะเอาชนะเขาด้วยพลังธาตุได้อย่างไร?",
                choices: [
                    { text: "ปลดปล่อยพลังธาตุทั้งหมดเข้าใส่ 'จอมบงการ' สร้างพายุไฟ, แผ่นดินไหว และพายุหมุนเข้าทำลายล้างทุกสิ่ง", nextSceneId: 'elemental_scene6', trait: 'power_oriented' },
                    { text: "ใช้พลังธาตุวิเคราะห์จุดอ่อนของมิติพลังงานมืด และโจมตีจุดศูนย์กลางเพื่อทำลายรังลับก่อน 'จอมบงการ' จะตอบโต้", nextSceneId: 'elemental_scene6', trait: 'intellect_oriented' },
                    { text: "ใช้ธาตุธรรมชาติที่บริสุทธิ์เพื่อสลายพลังงานมืดรอบตัว 'จอมบงการ' และพยายามโน้มน้าวเขาให้เปลี่ยนใจ", nextSceneId: 'elemental_scene6', trait: 'diplomatic_oriented' }
                ]
            },
            'elemental_scene6': {
                text: "หลังจากการต่อสู้อันดุเดือด 'จอมบงการ' ได้ปลดปล่อยสัตว์ธาตุโบราณที่ถูกชั่วร้ายครอบงำ มันคือการทดสอบขั้นสุดยอดของพลังธาตุของคุณ คุณจะจัดการกับภัยคุกคามนี้อย่างไร?",
                choices: [
                    { text: "ใช้พลังธาตุทั้งหมดที่คุณมีเข้าห้ำหั่นกับสัตว์ร้าย พยายามบดขยี้มันด้วยพละกำลังสูงสุด", nextSceneId: 'ending', trait: 'brute_force' },
                    { text: "วิเคราะห์องค์ประกอบของสัตว์ร้ายและใช้ธาตุที่เหมาะสมที่สุดเพื่อทำให้มันอ่อนแอลงและควบคุมมัน", nextSceneId: 'ending', trait: 'strategic_mastery' },
                    { text: "พยายามใช้พลังธาตุแห่งธรรมชาติที่บริสุทธิ์เพื่อชำระล้างความชั่วร้ายออกจากสัตว์ร้ายนั้น", nextSceneId: 'ending', trait: 'purification' }
                ]
            },

            // --- ฉากสำหรับผู้ใช้พลังความเร็ว ---
            'speed_scene1': {
                text: "เสียงกรีดร้องดังขึ้นจากใจกลางเมือง 'วิลเลน' ปรากฏตัวขึ้นพร้อมกองทัพหุ่นยนต์ก่อความวุ่นวาย คุณจะใช้ความเร็วเหนือเสียงของคุณรับมืออย่างไร?",
                choices: [
                    { text: "พุ่งเข้าใส่ 'วิลเลน' ด้วยความเร็วสูงเพื่อจัดการเขาโดยตรงก่อนหุ่นยนต์จะสร้างความเสียหาย", nextSceneId: 'speed_scene2', trait: 'bravery' },
                    { text: "เคลื่อนที่ด้วยความเร็วแสงเพื่อปลดอาวุธหุ่นยนต์ทั้งหมดภายในพริบตาและผูกมัดพวกมัน", nextSceneId: 'speed_scene2', trait: 'intellect' },
                    { text: "วิ่งอพยพพลเมืองออกจากพื้นที่อันตรายด้วยความเร็วสูงสุดเป็นอันดับแรก", nextSceneId: 'speed_scene2', trait: 'heroism' }
                ]
            },
            'speed_scene2': {
                text: "เมื่อคุณเข้าใกล้ 'วิลเลน' คุณพบว่าเขาไม่ได้ควบคุมหุ่นยนต์ด้วยตัวเอง แต่ถูกสะกดจิตอยู่ คุณในฐานะผู้มีความเร็วสูงจะช่วยเขาได้อย่างไร?",
                choices: [
                    { text: "ใช้ความเร็วโจมตีจุดชีพจรสำคัญของ 'วิลเลน' เพื่อให้เขาหมดสติอย่างรวดเร็วและปลอดภัย", nextSceneId: 'speed_scene3', trait: 'ruthless' },
                    { text: "เคลื่อนที่รอบตัว 'วิลเลน' สร้างกระแสลมหมุนเพื่อสลายพลังงานที่สะกดจิตเขา", nextSceneId: 'speed_scene3', trait: 'compassion' },
                    { text: "วิ่งสำรวจพื้นที่โดยรอบด้วยความเร็วสูงเพื่อค้นหาแหล่งกำเนิดพลังงานที่สะกดจิต 'วิลเลน'", nextSceneId: 'speed_scene3', trait: 'investigative' }
                ]
            },
            'speed_scene3': {
                text: "ขณะที่คุณกำลังปฏิบัติภารกิจ ฮีโร่อีกคนนามว่า 'เดอะไนท์' ก็ปรากฏตัวขึ้น เขามีเป้าหมายเดียวกันแต่ใช้วิธีที่รุนแรงกว่า 'เดอะไนท์' เคลื่อนไหวรวดเร็วเหมือนเงา คุณจะร่วมมือกับเขาหรือไม่?",
                choices: [
                    { text: "ร่วมมือกับ 'เดอะไนท์': การประสานความเร็วสองคนจะทำให้การเคลื่อนไหวไร้เทียมทาน", nextSceneId: 'speed_scene4', trait: 'teamwork' },
                    { text: "ทำงานแยกกัน: ความเร็วของคุณบริสุทธิ์กว่า และคุณไม่เห็นด้วยกับวิธีการของเขา", nextSceneId: 'speed_scene4', trait: 'independent' },
                    { text: "แข่งขันกับเขา: พิสูจน์ว่าคุณคือผู้ที่มีความเร็วเหนือกว่า และจัดการกับภัยคุกคามได้ก่อน", nextSceneId: 'speed_scene4', trait: 'competitive' }
                ]
            },
            'speed_scene4': {
                text: "สถานการณ์บีบคั้น ผู้บงการที่แท้จริงกำลังจะปล่อยพลังทำลายล้างที่สามารถกวาดล้างเมืองได้ทั้งหมด คุณต้องเลือกระหว่างความเสียหายเล็กน้อยกับหายนะใหญ่หลวง คุณจะใช้ความเร็วหยุดยั้งอย่างไร?",
                choices: [
                    { text: "วิ่งด้วยความเร็วเหนือแสงเพื่อสร้างสนามพลังงานป้องกันรอบเมือง แม้ร่างกายจะรับภาระหนักหน่วง", nextSceneId: 'speed_scene5', trait: 'ultimate_heroism' },
                    { text: "เคลื่อนที่ด้วยความเร็วสูงเพื่อเข้าไปแทรกแซงและทำลายกลไกการปล่อยพลังทำลายล้างที่กำลังทำงาน", nextSceneId: 'speed_scene5', trait: 'resourceful' },
                    { text: "วิ่งหาที่หลบภัยที่ปลอดภัยที่สุดในเมือง ใช้ความเร็วของคุณเพื่อเอาชีวิตรอดก่อน", nextSceneId: 'speed_scene5', trait: 'selfish' }
                ]
            },
            'speed_scene5': {
                text: "คุณเผชิญหน้ากับ 'จอมบงการ' ตัวจริงในรังลับของเขา ซึ่งเป็นเขาวงกตแห่งกาลเวลาที่ซับซ้อนและมีกับดักมากมาย นี่คือการต่อสู้ครั้งสุดท้ายเพื่อชี้ชะตาโลก! คุณจะเอาชนะเขาด้วยความเร็วได้อย่างไร?",
                choices: [
                    { text: "ใช้ความเร็วของคุณเพื่อโจมตี 'จอมบงการ' นับพันครั้งในเสี้ยววินาทีจนเขาพ่ายแพ้", nextSceneId: 'speed_scene6', trait: 'power_oriented' },
                    { text: "วิ่งผ่านเขาวงกตแห่งกาลเวลาเพื่อย้อนเวลาและหยุดยั้ง 'จอมบงการ' ก่อนเขาจะสร้างหายนะครั้งใหญ่", nextSceneId: 'speed_scene6', trait: 'intellect_oriented' },
                    { text: "วิ่งรอบตัว 'จอมบงการ' สร้างพายุหมุนแห่งเวลาเพื่อทำให้เขาช้าลงและรับฟังเหตุผล", nextSceneId: 'speed_scene6', trait: 'diplomatic_oriented' }
                ]
            },
            'speed_scene6': {
                text: "หลังจากการต่อสู้อันดุเดือด 'จอมบงการ' ได้เปิดประตูมิติแห่งความอลวน ทำให้เวลาในเมืองเริ่มผิดเพี้ยนไปหมด คุณต้องหยุดยั้งความพินาศทางเวลา คุณจะใช้ความเร็วของคุณจัดการอย่างไร?",
                choices: [
                    { text: "ใช้ความเร็วขั้นสูงสุดเพื่อเข้าสู่ประตูมิติและทำลายแกนกลางแห่งความอลวนโดยตรง", nextSceneId: 'ending', trait: 'brute_force' },
                    { text: "วิ่งย้อนเวลาเพื่อไปแก้ไขจุดเริ่มต้นของความอลวน ก่อนที่มันจะส่งผลกระทบไปทั่ว", nextSceneId: 'ending', trait: 'temporal_manipulation' },
                    { text: "สร้างความอลวนทางเวลาขนาดเล็กรอบประตูมิติเพื่อทำให้มันเสถียรขึ้นและปิดตัวลงเอง", nextSceneId: 'ending', trait: 'time_stabilization' }
                ]
            },

            // --- ฉากสำหรับผู้ใช้พลังจิต ---
            'telekinetic_scene1': {
                text: "เสียงกรีดร้องดังขึ้นจากใจกลางเมือง 'วิลเลน' ปรากฏตัวขึ้นพร้อมกองทัพหุ่นยนต์ก่อความวุ่นวาย คุณจะใช้พลังจิตของคุณรับมืออย่างไร?",
                choices: [
                    { text: "ใช้พลังจิตยกหุ่นยนต์ขึ้นกลางอากาศแล้วกระแทกพวกมันเข้าด้วยกันจนพัง", nextSceneId: 'telekinetic_scene2', trait: 'bravery' },
                    { text: "แทรกซึมจิตใจของหุ่นยนต์บางส่วนให้หันมาโจมตีกันเองเพื่อสร้างความสับสนในกองทัพศัตรู", nextSceneId: 'telekinetic_scene2', trait: 'intellect' },
                    { text: "สร้างภาพลวงตาขนาดใหญ่เพื่อเบี่ยงเบนความสนใจของหุ่นยนต์ แล้วช่วยผู้คนหลบหนี", nextSceneId: 'telekinetic_scene2', trait: 'heroism' }
                ]
            },
            'telekinetic_scene2': {
                text: "เมื่อคุณเข้าใกล้ 'วิลเลน' คุณพบว่าเขาไม่ได้ควบคุมหุ่นยนต์ด้วยตัวเอง แต่ถูกสะกดจิตอยู่ คุณในฐานะผู้มีพลังจิตจะช่วยเขาได้อย่างไร?",
                choices: [
                    { text: "ใช้พลังจิตบีบคั้นจิตสำนึกของ 'วิลเลน' เพื่อให้เขาหมดสติอย่างรวดเร็ว", nextSceneId: 'telekinetic_scene3', trait: 'ruthless' },
                    { text: "ส่งกระแสจิตเข้าไปในจิตใจของ 'วิลเลน' เพื่อคลายพลังงานที่สะกดจิตเขา", nextSceneId: 'telekinetic_scene3', trait: 'compassion' },
                    { text: "อ่านใจของ 'วิลเลน' เพื่อหาเบาะแสเกี่ยวกับผู้บงการที่แท้จริงและที่ซ่อนของเขา", nextSceneId: 'telekinetic_scene3', trait: 'investigative' }
                ]
            },
            'telekinetic_scene3': {
                text: "ขณะที่คุณกำลังปฏิบัติภารกิจ ฮีโร่อีกคนนามว่า 'เดอะไนท์' ก็ปรากฏตัวขึ้น เขามีเป้าหมายเดียวกันแต่ใช้วิธีที่รุนแรงกว่า 'เดอะไนท์' มีพลังจิตที่ดุดัน คุณจะร่วมมือกับเขาหรือไม่?",
                choices: [
                    { text: "ร่วมมือกับ 'เดอะไนท์': การผสานพลังจิตสองคนจะทำให้การโจมตีทางจิตไร้เทียมทาน", nextSceneId: 'telekinetic_scene4', trait: 'teamwork' },
                    { text: "ทำงานแยกกัน: คุณไม่เห็นด้วยกับวิธีการที่รุนแรงของเขา และจะใช้พลังจิตอย่างสุขุม", nextSceneId: 'telekinetic_scene4', trait: 'independent' },
                    { text: "แข่งขันกับเขา: พิสูจน์ว่าพลังจิตของคุณเหนือกว่า และจัดการกับภัยคุกคามได้ก่อน", nextSceneId: 'telekinetic_scene4', trait: 'competitive' }
                ]
            },
            'telekinetic_scene4': {
                text: "สถานการณ์บีบคั้น ผู้บงการที่แท้จริงกำลังจะปล่อยพลังทำลายล้างที่สามารถกวาดล้างเมืองได้ทั้งหมด คุณต้องเลือกระหว่างความเสียหายเล็กน้อยกับหายนะใหญ่หลวง คุณจะใช้พลังจิตหยุดยั้งอย่างไร?",
                choices: [
                    { text: "สร้างโล่พลังจิตขนาดมหึมาปกคลุมเมืองเพื่อรับแรงระเบิดทั้งหมด แม้คุณจะใช้พลังเกินขีดจำกัด", nextSceneId: 'telekinetic_scene5', trait: 'ultimate_heroism' },
                    { text: "ใช้พลังจิตแทรกซึมเข้าไปในอุปกรณ์ปล่อยพลังงาน และย้อนทิศทางการทำลายล้างเข้าหาผู้บงการ", nextSceneId: 'telekinetic_scene5', trait: 'resourceful' },
                    { text: "สร้างภาพลวงตาขนาดใหญ่เพื่อซ่อนตัวและพลเรือนส่วนหนึ่ง รอให้พลังทำลายล้างผ่านไปก่อน", nextSceneId: 'telekinetic_scene5', trait: 'selfish' }
                ]
            },
            'telekinetic_scene5': {
                text: "คุณเผชิญหน้ากับ 'จอมบงการ' ตัวจริงในรังลับของเขา ซึ่งเป็นปราสาทลอยฟ้าที่ป้องกันด้วยพลังจิตอันซับซ้อน นี่คือการต่อสู้ครั้งสุดท้ายเพื่อชี้ชะตาโลก! คุณจะเอาชนะเขาด้วยพลังจิตได้อย่างไร?",
                choices: [
                    { text: "ปลดปล่อยพลังจิตอันมหาศาลเพื่อบดขยี้ปราสาทและ 'จอมบงการ' ไปพร้อมกัน", nextSceneId: 'telekinetic_scene6', trait: 'power_oriented' },
                    { text: "ใช้พลังจิตอ่านรูปแบบการป้องกันของปราสาทและเจาะเข้าไปในจิตใจ 'จอมบงการ' เพื่อทำลายเขาจากภายใน", nextSceneId: 'telekinetic_scene6', trait: 'intellect_oriented' },
                    { text: "พยายามเชื่อมโยงจิตใจกับ 'จอมบงการ' เพื่อทำความเข้าใจแรงจูงใจและโน้มน้าวให้เขายอมแพ้", nextSceneId: 'telekinetic_scene6', trait: 'diplomatic_oriented' }
                ]
            },
            'telekinetic_scene6': {
                text: "หลังจากการต่อสู้อันดุเดือด 'จอมบงการ' ได้สร้างภาพลวงตาทางจิตขนาดใหญ่ที่บิดเบือนความเป็นจริงรอบตัวคุณ คุณถูกขังอยู่ในเขาวงกตแห่งภาพหลอน คุณจะหนีและตอบโต้ได้อย่างไร?",
                choices: [
                    { text: "ใช้พลังจิตดิบๆ ระเบิดภาพลวงตาทั้งหมดออกไปด้วยกำลังมหาศาล", nextSceneId: 'ending', trait: 'brute_force' },
                    { text: "วิเคราะห์โครงสร้างของภาพลวงตาและหาจุดอ่อนทางจิตวิทยาเพื่อทำลายมันจากภายใน", nextSceneId: 'ending', trait: 'mental_mastery' },
                    { text: "สร้างภาพลวงตาซ้อนทับเพื่อหลอกล่อ 'จอมบงการ' และหลบหนีออกจากเขาวงกตแห่งจิต", nextSceneId: 'ending', trait: 'counter_illusion' }
                ]
            }
        };

        // คำจำกัดความของตอนจบต่างๆ ขึ้นอยู่กับคุณสมบัติที่สะสม
        const endings = {
            heroicLegend: {
                title: "ตำนานวีรบุรุษผู้ยิ่งใหญ่",
                text: "คุณกลายเป็นสัญลักษณ์แห่งความหวังและการปกป้อง นามของคุณจะถูกจารึกไว้ในประวัติศาสตร์ว่าเป็นผู้กอบกู้โลก และเป็นแรงบันดาลใจให้กับคนรุ่นหลัง โลกจดจำการเสียสละและความกล้าหาญของคุณ."
            },
            loneVigilante: {
                title: "ผู้พิทักษ์เงาแห่งรัตติกาล",
                text: "คุณยังคงทำหน้าที่ปกป้องเมืองจากเงามืด ผู้คนต่างเกรงกลัวเหล่าวายร้ายที่ถูกคุณจัดการ แต่ก็ไม่เคยเห็นใบหน้าแท้จริงของคุณ คุณคือปริศนาที่ปกป้องความสงบสุข ความยุติธรรมเป็นสิ่งสำคัญที่สุด แม้ต้องใช้วิธีที่เด็ดขาด."
            },
            tacticalMastermind: {
                title: "จอมวางแผนผู้เหนือชั้น",
                text: "คุณเลือกที่จะทำงานเบื้องหลัง ใช้สติปัญญาอันเฉียบแหลมในการวิเคราะห์และล้มล้างภัยคุกคามก่อนที่จะสายเกินไป โลกอาจไม่รู้จักคุณ แต่คุณคือผู้ควบคุมหมากตัวสำคัญ ผู้ชักใยอยู่เบื้องหลังความสงบสุข."
            },
            tragicHero: {
                title: "วีรบุรุษผู้พลีชีพ",
                text: "คุณกอบกู้สถานการณ์ได้สำเร็จ แต่ด้วยราคาอันแสนแพง การเสียสละของคุณทำให้โลกปลอดภัย แม้คุณจะไม่ได้อยู่เพื่อเห็นมันก็ตาม นามของคุณจะถูกจดจำในฐานะผู้กล้าที่ยอมสละทุกสิ่งเพื่อส่วนรวม."
            },
            villainousOverlord: {
                title: "ผู้ปกครองผู้ไร้ความปรานี",
                text: "คุณตัดสินใจใช้พลังของคุณเพื่อผลประโยชน์ส่วนตน คุณกลายเป็นผู้มีอำนาจที่ไม่มีใครกล้าต่อกร โลกอยู่ภายใต้การปกครองของคุณ ไม่ว่าใครจะเห็นด้วยหรือไม่ก็ตาม คุณคือผู้คุมอำนาจสูงสุด."
            },
            unforeseenConsequences: {
                title: "ผลพวงที่คาดไม่ถึง",
                text: "การตัดสินใจของคุณนำไปสู่ผลลัพธ์ที่ไม่เป็นไปตามที่คาดไว้ แม้ภัยคุกคามจะหมดไป แต่โลกก็เปลี่ยนแปลงไปในทิศทางที่ไม่แน่นอน อนาคตยังคงเต็มไปด้วยความท้าทายที่คุณต้องเผชิญ."
            }
        };

        // ฟังก์ชันสำหรับเล่นเสียง Synth แบบง่ายๆ เมื่อยืนยันการเลือก
        async function playChoiceSound() {
            // ตรวจสอบให้แน่ใจว่า AudioContext ถูกเริ่มต้นแล้ว
            await Tone.start();
            choiceSynth.triggerAttackRelease("C4", "8n"); // เล่นโน้ต C4 เป็นเวลา 1/8 โน้ต
        }

        // ฟังก์ชันสำหรับเล่นเสียง Synth แบบง่ายๆ เมื่อเปลี่ยนฉาก
        async function playSceneTransitionSound() {
            // ตรวจสอบให้แน่ใจว่า AudioContext ถูกเริ่มต้นแล้ว
            await Tone.start();
            // เล่นคอร์ด C Major (C5, E5, G5) เป็นเวลา 1/4 โน้ต
            sceneTransitionSynth.triggerAttackRelease(["C5", "E5", "G5"], "4n");
        }

        // ฟังก์ชันสำหรับเพิ่มคุณสมบัติให้กับผู้เล่น
        function addTrait(trait) {
            playerTraits[trait] = (playerTraits[trait] || 0) + 1;
        }

        // ฟังก์ชันสำหรับโหลดและแสดงฉากใหม่
        function loadScene(sceneId) {
            const scene = scenes[sceneId];
            if (!scene) {
                console.error("ไม่พบฉาก:", sceneId);
                return;
            }

            // เล่นเสียงเปลี่ยนฉากสำหรับทุกฉากยกเว้นฉากแรกสุด (origin)
            // หรือเมื่อเปลี่ยนจากฉาก origin ไปยังฉากเฉพาะพลัง (e.g., elemental_scene1)
            if (scenesPlayedCount > 0 || sceneId.includes('_scene1')) {
                playSceneTransitionSound();
            }

            gameTextElement.textContent = scene.text;
            choicesContainer.innerHTML = ''; // ล้างตัวเลือกก่อนหน้า

            scene.choices.forEach((choice) => {
                const button = document.createElement('button');
                button.textContent = choice.text;
                button.className = "choice-button px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg shadow-md transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 w-full";
                button.addEventListener('click', () => makeChoice(choice));
                choicesContainer.appendChild(button);
            });

            currentSceneId = sceneId;
        }

        // ฟังก์ชันสำหรับจัดการการตัดสินใจของผู้เล่น
        async function makeChoice(choice) {
            await playChoiceSound(); // เล่นเสียงทันทีเมื่อเลือก
            addTrait(choice.trait);   // เพิ่มคุณสมบัติให้กับโปรไฟล์ผู้เล่น

            // ตรวจสอบและบันทึกพลังพิเศษที่เลือกในฉากแรก
            if (currentSceneId === 'origin' && choice.powerType) {
                playerPower = choice.powerType;
            }

            // นับฉากเนื้อเรื่องที่เล่นไปแล้ว (เฉพาะฉากที่เป็น _sceneX)
            if (currentSceneId.includes('_scene')) {
                scenesPlayedCount++;
            }

            // ตรวจสอบว่าถึงฉากสุดท้ายของเรื่องราวแล้วหรือยัง (เมื่อเล่นครบ totalStoryScenes)
            if (scenesPlayedCount === totalStoryScenes) {
                showEnding(); // จบเกมทันทีหลังจากเลือกจาก _scene6
            } else {
                // ไปยังฉากถัดไป
                loadScene(choice.nextSceneId);
            }
        }

        // ฟังก์ชันสำหรับกำหนดและแสดงตอนจบ
        function showEnding() {
            choicesContainer.classList.add('hidden'); // ซ่อนตัวเลือก
            endingContainer.classList.remove('hidden'); // แสดงคอนเทนเนอร์ตอนจบ

            let finalEnding = endings.heroicLegend; // กำหนดตอนจบเริ่มต้น

            // ตรรกะในการกำหนดตอนจบตามคุณสมบัติของผู้เล่น
            const getTraitCount = (trait) => playerTraits[trait] || 0;

            // ตรรกะตอนจบที่ซับซ้อนขึ้น
            if (getTraitCount('ultimate_heroism') >= 1 && getTraitCount('compassion') >= 1 && getTraitCount('heroism') >= 1 && getTraitCount('diplomatic_oriented') === 0) {
                finalEnding = endings.heroicLegend;
            } else if (getTraitCount('independent') >= 1 && getTraitCount('ruthless') >= 1 && getTraitCount('heroism') === 0 && getTraitCount('compassion') === 0 && getTraitCount('teamwork') === 0) {
                finalEnding = endings.loneVigilante;
            } else if (getTraitCount('intellect') >= 1 && getTraitCount('investigative') >= 1 && getTraitCount('intellect_oriented') >= 1 && getTraitCount('resourceful') >= 1) {
                finalEnding = endings.tacticalMastermind;
            } else if (getTraitCount('selfish') >= 1 || (getTraitCount('competitive') >= 1 && getTraitCount('heroism') === 0 && getTraitCount('compassion') === 0 && getTraitCount('teamwork') === 0)) {
                finalEnding = endings.villainousOverlord;
            } else if (getTraitCount('ultimate_heroism') >= 1 && getTraitCount('heroism') === 0 && getTraitCount('compassion') === 0 && getTraitCount('selfish') === 0 && getTraitCount('ruthless') === 0) {
                 finalEnding = endings.tragicHero; // เสียสละอย่างบริสุทธิ์ใจ แต่ไม่มีปัจจัยฮีโร่โดดเด่นอื่น
            } else if (getTraitCount('diplomatic_oriented') >= 1 && getTraitCount('compassion') >= 1 && getTraitCount('teamwork') >= 1) {
                finalEnding = endings.heroicLegend; // เน้นการทูต, เมตตา, ทำงานร่วมกัน = ฮีโร่ที่ยิ่งใหญ่
            } else if (getTraitCount('brute_force') >= 1 && getTraitCount('intellect_oriented') === 0 && getTraitCount('diplomatic_oriented') === 0) {
                finalEnding = endings.unforeseenConsequences; // ใช้แต่กำลัง อาจนำไปสู่ผลลัพธ์ที่ไม่คาดคิด
            } else if (getTraitCount('purification') >= 1 || getTraitCount('temporal_manipulation') >= 1 || getTraitCount('mental_mastery') >= 1 || getTraitCount('time_stabilization') >= 1 || getTraitCount('counter_illusion') >= 1 || getTraitCount('strategic_mastery') >= 1) {
                // หากมีการใช้ความสามารถขั้นสูงเฉพาะทางอย่างชาญฉลาด
                finalEnding = endings.tacticalMastermind;
            } else {
                // ตอนจบสำรองหากไม่มีเงื่อนไขเฉพาะเจาะจงที่ชัดเจน
                finalEnding = endings.heroicLegend;
            }

            endingTitleElement.textContent = finalEnding.title;
            endingTextElement.textContent = finalEnding.text;

            // หยุดเพลงประกอบ
            if (bgMusic && !bgMusic.paused) {
				bgMusic.volume = 0.1; //ลดเสียงลง
                 bgMusic.pause();
                 bgMusic.currentTime = 0;
            }
        }

        // ฟังก์ชันสำหรับเริ่มเกมใหม่
        function restartGame() {
            currentSceneId = 'origin';
            playerTraits = {};
            playerPower = '';
            scenesPlayedCount = 0;
            endingContainer.classList.add('hidden');
            createStartScreen(); // กลับไปหน้าจอเริ่มต้น
        }

        // ฟังก์ชันสำหรับกำหนดค่า DOM elements ใหม่หลังจากโหลดเนื้อหาเกม
        function reInitializeGameElements() {
            gameTextElement = document.getElementById('game-text');
            choicesContainer = document.getElementById('choices-container');
            endingContainer = document.getElementById('ending-container');
            endingTitleElement = document.getElementById('ending-title');
            endingTextElement = document.getElementById('ending-text');
            restartButton = document.getElementById('restart-button');
            bgMusic = document.getElementById('bg-music'); // ชี้ไปยัง audio tag ในเนื้อหาเกม
            if (restartButton) {
                restartButton.removeEventListener('click', restartGame); // ป้องกัน listener ซ้ำซ้อน
                restartButton.addEventListener('click', restartGame);
				bgMusic.volume = 0.1; //ลดเสียงลง
            }
        }

        // ฟังก์ชันสำหรับสร้างหน้าจอเริ่มต้น
        function createStartScreen() {
            const gameContainer = document.getElementById('game-container');
            gameContainer.innerHTML = `
                <div id="start-screen" class="min-h-screen flex flex-col items-center justify-center bg-gray-900 p-4 font-inter text-gray-100 w-full">
                    <div class="bg-gray-800 p-8 rounded-xl shadow-lg w-full max-w-2xl border border-gray-700 text-center">
					<button class="flex items-center rounded-md border border-slate-300 py-2 px-4 text-center text-sm transition-all shadow-sm hover:shadow-lg text-slate-600 hover:text-white hover:bg-slate-800 hover:border-slate-800 focus:text-white focus:bg-slate-800 focus:border-slate-800 active:border-slate-800 active:text-white active:bg-slate-800 disabled:pointer-events-none disabled:opacity-50 disabled:shadow-none" type="button" onclick="location.href='index.html'">
						กลับเมนูหลัก
						<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 ml-1.5">
							<path fill-rule="evenodd" d="M16.28 11.47a.75.75 0 0 1 0 1.06l-7.5 7.5a.75.75 0 0 1-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 0 1 1.06-1.06l7.5 7.5Z" clip-rule="evenodd" />
						</svg>
					</button>
                        <h1 class="text-4xl font-extrabold text-red-500 mb-6 drop-shadow-lg">เกมผจญภัยซุปเปอร์ฮีโร่</h1>
                        <p class="text-lg mb-8 leading-relaxed text-gray-300">คุณพร้อมที่จะสวมบทบาทเป็นซุปเปอร์ฮีโร่และกำหนดชะตากรรมของโลกแล้วหรือยัง?</p>
                        <button id="start-game-button" class="px-8 py-4 bg-gradient-to-r from-green-500 to-green-700 hover:from-green-600 hover:to-green-800 text-white text-xl font-bold rounded-lg shadow-xl transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-400 focus:ring-opacity-75 animate-pulse">
                            เริ่มการผจญภัย!
                        </button>
                        <!-- เพลงประกอบฉาก: โปรดแทนที่ 'your-background-music.mp3' ด้วย URL เพลงจริง -->
                        <!-- สำหรับตัวอย่างนี้ ใช้เพลงจาก SoundHelix ซึ่งเป็นเพลงฟรี -->
                        <audio id="bg-music-start-screen" loop>
                             <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
                             Your browser does not support the audio element.
                        </audio>
                    </div>
                </div>
            `;
			// เพิ่ม Event Listener ให้กับปุ่ม "เริ่มการผจญภัย"
            document.getElementById('start-game-button').addEventListener('click', () => {
                // ลบหน้าจอเริ่มต้นและโหลดเนื้อหาเกมจริง
                gameContainer.innerHTML = `
                    <div class="bg-gray-800 p-8 rounded-xl shadow-lg w-full max-w-2xl border border-gray-700">
                        <h1 id="game-title" class="text-4xl font-extrabold text-center mb-6 text-red-500 drop-shadow-lg">เกมผจญภัยซุปเปอร์ฮีโร่</h1>
                        <p id="game-text" class="text-lg mb-8 text-center leading-relaxed text-gray-300"></p>

                        <div id="choices-container" class="flex flex-col space-y-4">
                            <!-- ตัวเลือกจะถูกสร้างที่นี่ -->
                        </div>

                        <div id="ending-container" class="hidden mt-8 text-center">
                            <h2 id="ending-title" class="text-3xl font-bold mb-4 text-yellow-400 drop-shadow-lg"></h2>
                            <p id="ending-text" class="text-lg text-gray-300"></p>
                            <button id="restart-button" class="mt-6 px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-700 hover:from-blue-600 hover:to-blue-800 text-white font-bold rounded-lg shadow-xl transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-400 focus:ring-opacity-75">
                                เล่นอีกครั้ง
                            </button>
                        </div>

                        <!-- Audio element สำหรับเพลงประกอบเกมหลัก (ถูกย้ายมาที่นี่) -->
                        <audio id="bg-music" loop>
                            <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio>
                    </div>
                `;
                // กำหนดค่า DOM elements ใหม่เนื่องจากมีการเปลี่ยนเนื้อหา
                reInitializeGameElements();
                // เล่นเพลงประกอบ
                if (bgMusic) {
					bgMusic.volume = 0.1; //ลดเสียงลง
                    bgMusic.play().catch(e => console.warn("ไม่สามารถเล่นเพลงประกอบได้อัตโนมัติ:", e));
                }
				
                startGame(); // เริ่มเกมจริง
            });
            // เล่นเพลงประกอบหน้าเริ่มต้น (อาจถูกบล็อกถ้าไม่มีการโต้ตอบผู้ใช้)
            const startScreenMusic = document.getElementById('bg-music-start-screen');
            if (startScreenMusic) {
                startScreenMusic.play().catch(e => console.warn("ไม่สามารถเล่นเพลงหน้าจอเริ่มต้นได้อัตโนมัติ:", e));
            }
        }

        // ฟังก์ชันเริ่มต้นเกม
        function startGame() {
            // โหลดฉากเริ่มต้น (ฉากเลือกพลังพิเศษ)
            loadScene('origin');
            choicesContainer.classList.remove('hidden'); // แสดงตัวเลือกเมื่อเกมเริ่ม
        }

        // เริ่มต้นด้วยการสร้างหน้าจอเริ่มต้นเมื่อหน้าเว็บโหลดเสร็จสมบูรณ์
        window.onload = createStartScreen;

    </script>
</body>
</html>
