<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แพนด้าน้อยผจญภัยตามหาน้ำผึ้ง</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc; /* Light gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .game-container {
            background-color: #ffffff;
            border-radius: 1.5rem; /* rounded-3xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-xl */
            padding: 2.5rem; /* p-10 */
            max-width: 800px; /* Max width */
            width: 100%;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 1.5rem; /* gap-6 */
        }
        .game-text {
            color: #2d3748; /* gray-800 */
            line-height: 1.6;
            font-size: 1.125rem; /* text-lg */
        }
        .game-choices {
            display: flex;
            flex-direction: column;
            gap: 1rem; /* gap-4 */
        }
        .game-button {
            background-color: #63b3ed; /* blue-400 */
            color: white;
            padding: 0.75rem 1.5rem; /* py-3 px-6 */
            border-radius: 0.75rem; /* rounded-xl */
            font-weight: 700; /* font-bold */
            font-size: 1.125rem; /* text-lg */
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            border: none;
            outline: none;
        }
        .game-button:hover {
            background-color: #4299e1; /* blue-500 */
            transform: translateY(-2px);
        }
        .game-button:active {
            transform: translateY(0);
            box-shadow: none;
        }
        .restart-button {
            background-color: #f6ad55; /* orange-400 */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 700;
            font-size: 1.125rem;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: none;
            outline: none;
            margin-top: 1.5rem; /* mt-6 */
        }
        .restart-button:hover {
            background-color: #ed8936; /* orange-500 */
            transform: translateY(-2px);
        }
        .restart-button:active {
            transform: translateY(0);
            box-shadow: none;
        }
        .image-container {
            margin-bottom: 1.5rem; /* mb-6 */
        }
        .image-container img {
            max-width: 100%;
            height: auto;
            border-radius: 0.75rem; /* rounded-xl */
        }

        /* Responsive adjustments */
        @media (min-width: 640px) { /* sm breakpoint */
            .game-choices {
                flex-direction: row;
                justify-content: center;
            }
            .game-button {
                flex: 1;
                max-width: 48%; /* Adjust for spacing between buttons */
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
		<button class="flex items-center rounded-md border border-slate-300 py-2 px-4 text-center text-sm transition-all shadow-sm hover:shadow-lg text-slate-600 hover:text-white hover:bg-slate-800 hover:border-slate-800 focus:text-white focus:bg-slate-800 focus:border-slate-800 active:border-slate-800 active:text-white active:bg-slate-800 disabled:pointer-events-none disabled:opacity-50 disabled:shadow-none" type="button" onclick="location.href='index.html'">
			กลับเมนูหลัก
		   <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 ml-1.5">
			<path fill-rule="evenodd" d="M16.28 11.47a.75.75 0 0 1 0 1.06l-7.5 7.5a.75.75 0 0 1-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 0 1 1.06-1.06l7.5 7.5Z" clip-rule="evenodd" />
		  </svg>
		</button>
		
        <h1 class="text-4xl font-bold text-gray-900 mb-4">แพนด้าน้อยผจญภัยตามหาน้ำผึ้ง</h1>
        <div class="image-container">
            <img id="scene-image" src="https://placehold.co/600x300/e0e0e0/ffffff?text=Forest+Path" alt="ภาพประกอบฉาก" onerror="this.src='https://placehold.co/600x300/e0e0e0/ffffff?text=Forest+Path'">
        </div>
        <p id="game-text" class="game-text"></p>
        <div id="game-choices" class="game-choices">
            <button id="choice1" class="game-button"></button>
            <button id="choice2" class="game-button"></button>
        </div>
        <button id="restart-button" class="restart-button" style="display: none;">เริ่มใหม่</button>
    </div>

    <script>
        // Initialize Firebase variables (provided by Canvas environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebase imports (if needed for future extensions, not directly for this game logic)
        // import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Game Sound Definitions using Tone.js
        const player = new Tone.Player().toDestination(); // General purpose player

        // Samplers for specific sounds if needed, or simple Synths
        const forestAmbient = new Tone.Loop(time => {
            if (Tone.context.state === 'running') {
                new Tone.NoiseSynth({
                    envelope: {
                        attack: 0.05,
                        decay: 0.5,
                        sustain: 0.1,
                        release: 1.5
                    },
                    volume: -20
                }).toDestination().triggerAttackRelease("4n", time);
            }
        }, "4s").start(0);

        const buzzingSound = new Tone.NoiseSynth({
            envelope: {
                attack: 0.01,
                decay: 0.1,
                sustain: 0.1,
                release: 0.5
            },
            volume: -15 // Slightly louder
        }).toDestination();

        const happyMelody = new Tone.Sequence((time, note) => {
            if (Tone.context.state === 'running') {
                new Tone.Synth().toDestination().triggerAttackRelease(note, "8n", time);
            }
        }, ["C4", "E4", "G4", "C5"], "8n");

        const sadMelody = new Tone.Sequence((time, note) => {
            if (Tone.context.state === 'running') {
                new Tone.Synth().toDestination().triggerAttackRelease(note, "8n", time);
            }
        }, ["C4", "A3", "F3", "D3"], "8n");

        const stingSound = new Tone.MembraneSynth({
            pitchDecay: 0.02,
            octaves: 8,
            oscillator: { type: "square" },
            envelope: {
                attack: 0.001,
                decay: 0.4,
                sustain: 0.01,
                release: 0.5,
                attackCurve: "exponential"
            },
            volume: -10
        }).toDestination();

        const crunchSound = new Tone.NoiseSynth({
            envelope: {
                attack: 0.01,
                decay: 0.3,
                sustain: 0.05,
                release: 0.2
            },
            volume: -18
        }).toDestination();

        const riverSound = new Tone.NoiseSynth({
            envelope: {
                attack: 0.05,
                decay: 1.0,
                sustain: 0.5,
                release: 2.0
            },
            filterEnvelope: {
                attack: 0.001,
                decay: 0.8,
                sustain: 0.1,
                release: 1.2,
                baseFrequency: 600,
                octaves: 2
            },
            volume: -25
        }).toDestination();


        // Game Data: Scenes, choices, and outcomes
        const gameData = {
            'start': {
                text: "เจ้าแพนด้าน้อย 'ป๋อ' ตื่นขึ้นมาในป่าใหญ่อันกว้างใหญ่ ท้องร้องจ๊อกๆ อยากกินน้ำผึ้งแสนอร่อย! ป๋อมองไปรอบๆ เห็นทางสองทางที่แยกออกไป",
                image: "https://placehold.co/600x300/a0e0a0/333333?text=Forest+Entrance",
                choices: [
                    { text: "เดินลึกเข้าไปในป่าทึบ", nextScene: "deep_forest" },
                    { text: "เดินตามทางเดินเล็กๆ ริมป่า", nextScene: "forest_path" }
                ],
                sound: forestAmbient
            },
            'deep_forest': {
                text: "ป๋อเดินลึกเข้ามาในป่าทึบ ต้นไม้สูงใหญ่ปกคลุมจนแสงแดดส่องลงมาได้น้อย อากาศเย็นสบายและเงียบสงัด จู่ๆ ก็เห็นทางเข้าถ้ำมืดๆ และลำธารเล็กๆ อยู่ข้างหน้า",
                image: "https://placehold.co/600x300/70a070/ffffff?text=Mysterious+Cave+and+River",
                choices: [
                    { text: "เข้าไปสำรวจในถ้ำ", nextScene: "explore_cave" },
                    { text: "ข้ามลำธารไปอีกฝั่ง", nextScene: "cross_river" }
                ],
                sound: forestAmbient // Continue forest ambient
            },
            'forest_path': {
                text: "ป๋อเลือกเดินตามทางเดินเล็กๆ ริมป่า แสงแดดส่องถึง อากาศอบอุ่น มีเสียงนกร้องเจื้อยแจ้ว และเห็นพุ่มไม้ลูกเบอร์รี่น่ากินอยู่ข้างทาง",
                image: "https://placehold.co/600x300/b0e0b0/333333?text=Sunny+Forest+Path",
                choices: [
                    { text: "ชิมลูกเบอร์รี่แก้หิว", nextScene: "eat_berries" },
                    { text: "เดินต่อไปเพื่อหาน้ำผึ้ง", nextScene: "continue_path" }
                ],
                sound: happyMelody // Play a happy melody once
            },
            'explore_cave': {
                text: "ป๋อตัดสินใจเข้าไปในถ้ำ ภายในถ้ำมืดและชื้น มีเสียงหยดน้ำแว่วๆ เดินไปเรื่อยๆ ก็พบกับโพรงเล็กๆ ที่มีแสงสว่างรอดเข้ามา",
                image: "https://placehold.co/600x300/404040/ffffff?text=Inside+Cave",
                choices: [
                    { text: "มุดเข้าไปในโพรง", nextScene: "hidden_beehive" },
                    { text: "กลับออกจากถ้ำ", nextScene: "deep_forest_retry" } // A way to go back
                ],
                sound: riverSound // Sound of dripping water
            },
            'cross_river': {
                text: "ป๋อพยายามข้ามลำธาร น้ำใสไหลเอื่อยๆ แต่ก็ลึกพอสมควร เมื่อข้ามมาได้ ป๋อก็เห็นต้นไม้ใหญ่ยักษ์ที่มีโพรงขนาดใหญ่อยู่บนต้น",
                image: "https://placehold.co/600x300/80c080/ffffff?text=Giant+Tree+Across+River",
                choices: [
                    { text: "ปีนขึ้นไปดูบนต้นไม้", nextScene: "giant_beehive" },
                    { text: "สำรวจรอบๆ โคนต้นไม้", nextScene: "curious_squirrel" }
                ],
                sound: riverSound // River sound, then fade out
            },
            'eat_berries': {
                text: "ป๋อชิมลูกเบอร์รี่รสหวานฉ่ำจนอิ่มท้อง รู้สึกมีพลังขึ้นมาทันที! แต่เมื่อมองไปรอบๆ ก็ไม่เห็นร่องรอยน้ำผึ้งเลย",
                image: "https://placehold.co/600x300/c0f0c0/333333?text=Berry+Bush",
                choices: [
                    { text: "เดินย้อนกลับไป", nextScene: "start" }, // Back to start for a new path
                    { text: "ลองเดินไปอีกทาง", nextScene: "empty_field" } // Leads to a less fruitful path
                ],
                sound: crunchSound // Munching sound
            },
            'continue_path': {
                text: "ป๋อเดินตามทางเดินต่อไปอย่างมุ่งมั่น หวังว่าจะเจอแหล่งน้ำผึ้งไม่ไกลนี้ ในที่สุดก็เห็นต้นไม้เก่าแก่ที่มีรังผึ้งเล็กๆ เกาะอยู่",
                image: "https://placehold.co/600x300/d0e0d0/333333?text=Small+Beehive",
                choices: [
                    { text: "เก็บน้ำผึ้งจากรังเล็กๆ", nextScene: "small_honey_success" },
                    { text: "มองหารังที่ใหญ่กว่า", nextScene: "empty_field" } // Risky, might find nothing
                ],
                sound: buzzingSound // Gentle buzzing
            },
            'hidden_beehive': {
                text: "ป๋อมุดเข้าไปในโพรงเล็กๆ และพบว่ามันนำไปสู่ห้องลับขนาดใหญ่! ภายในมีรังผึ้งขนาดมหึมาเต็มไปด้วยน้ำผึ้งสีทองอร่าม! ป๋อกินน้ำผึ้งจนพุงป่องและกลับบ้านอย่างมีความสุข",
                image: "https://placehold.co/600x300/f0d080/333333?text=Giant+Hidden+Beehive",
                choices: [],
                sound: happyMelody, // Happy ending music
                ending: true,
                endingText: "จบแบบมีความสุข: พุงป่องกลับบ้าน!"
            },
            'deep_forest_retry': {
                text: "ป๋อตัดสินใจกลับออกจากถ้ำและหันกลับมาที่ลำธารอีกครั้ง แต่คราวนี้รู้สึกว่าควรไปอีกทางแล้ว",
                image: "https://placehold.co/600x300/70a070/ffffff?text=Mysterious+Cave+and+River",
                choices: [
                    { text: "ข้ามลำธารไปอีกฝั่ง", nextScene: "cross_river" } // Force to take the other path
                ],
                sound: forestAmbient
            },
            'giant_beehive': {
                text: "ป๋อปีนขึ้นไปบนต้นไม้ใหญ่ พบกับรังผึ้งขนาดใหญ่ยักษ์ที่เต็มไปด้วยผึ้งมากมาย ป๋อดีใจมาก! แต่ผึ้งก็ดูไม่ค่อยเป็นมิตรเท่าไหร่...",
                image: "https://placehold.co/600x300/f0b060/333333?text=Giant+Beehive+Danger",
                choices: [
                    { text: "พยายามเก็บน้ำผึ้ง", nextScene: "get_stung_ending" },
                    { text: "ค่อยๆ ถอยห่างออกมา", nextScene: "curious_squirrel" } // Retreat, maybe find alternative
                ],
                sound: buzzingSound // Intense buzzing
            },
            'curious_squirrel': {
                text: "ขณะที่ป๋อกำลังสำรวจรอบๆ โคนต้นไม้ ก็มีกระรอกตัวน้อยวิ่งผ่านมา มันชวนป๋อไปดูอะไรบางอย่าง...",
                image: "https://placehold.co/600x300/a0c0e0/333333?text=Friendly+Squirrel",
                choices: [
                    { text: "ตามกระรอกไป", nextScene: "squirrel_friend_ending" },
                    { text: "ปฏิเสธและหาน้ำผึ้งต่อ", nextScene: "empty_field" }
                ],
                sound: new Tone.Synth().toDestination().triggerAttackRelease("C5", "8n") // Small happy chirp
            },
            'empty_field': {
                text: "ป๋อเดินไปเรื่อยๆ จนมาถึงทุ่งหญ้าโล่งกว้าง ไม่เห็นร่องรอยของน้ำผึ้งเลย ท้องยังคงร้องจ๊อกๆ และรู้สึกเหนื่อยล้า",
                image: "https://placehold.co/600x300/e0e0f0/333333?text=Empty+Field",
                choices: [],
                sound: sadMelody, // Sad ending music
                ending: true,
                endingText: "จบแบบเศร้า: ไม่เจอน้ำผึ้ง และเหนื่อยล้า"
            },
            'small_honey_success': {
                text: "ป๋อเก็บน้ำผึ้งจากรังเล็กๆ ได้จำนวนหนึ่ง แม้จะไม่มาก แต่ก็พอให้หายหิวและมีความสุขได้ ป๋อกลับบ้านพร้อมรอยยิ้มเล็กๆ",
                image: "https://placehold.co/600x300/f0e0c0/333333?text=Small+Honey+Success",
                choices: [],
                sound: happyMelody, // Happy ending music
                ending: true,
                endingText: "จบแบบพอเพียง: ได้น้ำผึ้งนิดหน่อยกลับบ้าน"
            },
            'get_stung_ending': {
                text: "ป๋อพยายามเก็บน้ำผึ้งจากรังใหญ่ แต่โดนผึ้งต่อย! เจ็บปวดไปหมด ป๋อต้องวิ่งหนีกลับบ้านโดยไม่ได้น้ำผึ้งเลย",
                image: "https://placehold.co/600x300/ff6666/ffffff?text=Bee+Sting+Warning",
                choices: [],
                sound: stingSound, // Sting sound
                ending: true,
                endingText: "จบแบบเจ็บปวด: โดนผึ้งต่อย และไม่ได้น้ำผึ้ง"
            },
            'squirrel_friend_ending': {
                text: "กระรอกพาป๋อไปที่ต้นไม้ที่มีรูเล็กๆ และยื่นถั่วให้ ป๋อกับกระรอกแบ่งกันกินถั่วและกลายเป็นเพื่อนที่ดีต่อกัน แม้จะไม่ได้น้ำผึ้ง แต่ป๋อก็ได้มิตรภาพดีๆ กลับมา",
                image: "https://placehold.co/600x300/a0c0e0/333333?text=Squirrel+Friendship",
                choices: [],
                sound: happyMelody, // Happy ending music
                ending: true,
                endingText: "จบแบบมิตรภาพ: ได้เพื่อนใหม่กลับบ้าน"
            }
        };

        let currentSceneId = 'start';
        let activeSoundLoop = null; // To manage and stop current sound loops

        const gameTextElement = document.getElementById('game-text');
        const choice1Button = document.getElementById('choice1');
        const choice2Button = document.getElementById('choice2');
        const restartButton = document.getElementById('restart-button');
        const gameChoicesDiv = document.getElementById('game-choices');
        const sceneImage = document.getElementById('scene-image');

        // Function to play sound and manage loops
        async function playSceneSound(sound) {
            if (activeSoundLoop) {
                activeSoundLoop.stop(); // Stop any previous loops
                activeSoundLoop = null;
            }

            // Ensure Tone.js audio context is running
            if (Tone.context.state !== 'running') {
                await Tone.start();
            }

            if (sound instanceof Tone.Loop) {
                activeSoundLoop = sound;
                sound.start(0);
                Tone.Transport.start(); // Start Tone.js transport for loops
            } else if (sound instanceof Tone.Sequence) {
                sound.start(0);
                Tone.Transport.start();
                // For sequences, let them play once and then stop transport if no loop is active
                sound.on("ended", () => {
                    if (!activeSoundLoop) {
                        Tone.Transport.stop();
                    }
                });
            } else if (sound instanceof Tone.Synth || sound instanceof Tone.MembraneSynth || sound instanceof Tone.NoiseSynth) {
                // For one-shot sounds, trigger them directly
                if (sound.triggerAttackRelease) {
                    sound.triggerAttackRelease("C4", "0.5"); // Default note and duration, adjust as needed
                }
            } else if (sound) {
                // If it's a simple function (e.g., from an anonymous synth), call it
                sound();
            }
        }


        // Function to update the game display
        function updateGameDisplay() {
            const scene = gameData[currentSceneId];
            gameTextElement.textContent = scene.text;
            sceneImage.src = scene.image;

            // Stop all sounds before playing new ones for the scene
            Tone.Transport.stop();
            if (activeSoundLoop) {
                activeSoundLoop.stop();
                activeSoundLoop = null;
            }

            // Play the sound for the current scene
            if (scene.sound) {
                playSceneSound(scene.sound);
            }

            if (scene.ending) {
                gameChoicesDiv.style.display = 'none';
                restartButton.style.display = 'block';
                gameTextElement.textContent += "\n\n" + scene.endingText; // Add ending specific text
            } else {
                gameChoicesDiv.style.display = 'flex';
                restartButton.style.display = 'none';

                choice1Button.textContent = scene.choices[0].text;
                choice1Button.onclick = () => choose(scene.choices[0].nextScene);

                if (scene.choices.length > 1) {
                    choice2Button.style.display = 'block';
                    choice2Button.textContent = scene.choices[1].text;
                    choice2Button.onclick = () => choose(scene.choices[1].nextScene);
                } else {
                    choice2Button.style.display = 'none';
                }
            }
        }

        // Function to handle choices
        function choose(nextScene) {
            currentSceneId = nextScene;
            updateGameDisplay();
        }

        // Function to restart the game
        restartButton.addEventListener('click', () => {
            currentSceneId = 'start';
            updateGameDisplay();
        });

        // Start the game when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            updateGameDisplay();
        });
    </script>
</body>
</html>
