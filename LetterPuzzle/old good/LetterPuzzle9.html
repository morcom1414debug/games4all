<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Letter Puzzle - อักษรพาซน!</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;800;900&display=swap');
        * { box-sizing: border-box; }
        body {
            margin: 0; font-family: 'Kanit', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh; color: #fff; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }
        .container { width: 100%; max-width: 480px; padding: 15px; position: relative; }
        #backToMenu {
            position: absolute; top: 10px; left: 10px; background: rgba(255,255,255,0.25);
            padding: 8px 20px; border: none; border-radius: 50px; color: white; font-weight: 600;
            font-size: 1rem; cursor: pointer; backdrop-filter: blur(12px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.4); z-index: 1000; transition: all 0.3s;
        }
        #backToMenu:hover { background: rgba(255,255,255,0.4); }
        #levelSelect { text-align: center; }
        h1 { font-size: 2.8rem; margin: 0 0 10px; text-shadow: 0 8px 20px rgba(0,0,0,0.4); }
        .subtitle { font-size: 1.3rem; margin-bottom: 30px; opacity: 0.9; }
        .level-buttons { display: flex; flex-direction: column; gap: 18px; align-items: center; }
        .level-btn {
            width: 80%; max-width: 320px; padding: 20px; font-size: 1.8rem; font-weight: 800;
            border: none; border-radius: 25px; cursor: pointer;
            box-shadow: 0 12px 30px rgba(0,0,0,0.45); transition: all 0.3s;
        }
        .level-btn:hover { transform: translateY(-8px) scale(1.05); }
        #easy { background: #51cf66; }
        #medium { background: #ffd43b; color: #333; }
        #hard { background: #ff6b6b; }
        #game { display: none; text-align: center; }
        .question-heading {
            font-size: 1.9rem; font-weight: 900; margin-bottom: 15px;
            padding: 12px 20px; background: rgba(255,255,255,0.18);
            border-radius: 20px; backdrop-filter: blur(8px);
        }
        .spelling-display {
            font-size: 3.2rem; font-weight: bold; min-height: 70px;
            margin: 20px 0; letter-spacing: 10px; color: #ffd93d;
        }
        .timer { display: none !important; }
        .letters {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px;
            margin: 30px 10px 20px; aria-live: polite; aria-atomic: false;
        }
        .letter-btn {
            width: 100%; padding: 20px 10px; font-size: 2.2rem; font-weight: bold;
            background: #ffd93d; color: #333; border: none; border-radius: 20px;
            cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.35); transition: all 0.3s;
        }
        .letter-btn:hover:not(.used) { transform: scale(1.12); }
        .letter-btn.used {
            background: #999 !important; color: #bbb !important; opacity: 0.7;
            cursor: not-allowed; transform: scale(0.92);
        }
        .letter-btn.wrong { background: #ff6b6b !important; animation: shake 0.5s; }
        @keyframes shake { 0%,100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
        #result { display: none; text-align: center; }
        #result h2 { font-size: 3.5rem; margin: 0 0 20px; }
        #resultMsg { font-size: 1.6rem; line-height: 1.6; margin: 20px 0; }
        #score { font-size: 4.5rem; font-weight: 900; margin: 30px 0; }
        .btn-restart {
            padding: 16px 50px; font-size: 1.7rem; background: #4ecdc4;
            border: none; border-radius: 50px; color: white; cursor: pointer;
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
        }
        .btn-restart:hover { transform: translateY(-6px); }
    </style>
</head>
<body>

<div class="container">
    <button id="backToMenu">กลับเมนูหลัก</button>

    <div id="levelSelect">
        <h1>Letter Puzzle - อักษรพาซน!</h1>
        <p class="subtitle">เลือกระดับความยาก แล้วมาเริ่มสนุกกันเลย!<br>รวมให้เป็นคำศัพท์ภาษาอังกฤษที่ถูกต้อง 10 ข้อต่อรอบ</p>
        <div class="level-buttons">
            <button class="level-btn" id="easy">ฝึกพื้นฐานเซียน</button>
            <button class="level-btn" id="medium">ระดับเซียน</button>
            <button class="level-btn" id="hard">ปราบเซียน</button>
        </div>
    </div>

    <div id="game">
        <h2 class="question-heading" id="question" tabindex="-1">ข้อ 1 : แมว ภาษาอังกฤษเขียนว่า</h2>
        <div class="spelling-display" id="spellingDisplay">_ _ _</div>
        <div class="timer"><span id="timer">20</span></div>
        <div class="letters" id="letters" role="region" aria-label="ตัวอักษรให้เลือก"></div>
    </div>

    <div id="result">
        <h2 id="resultTitle" tabindex="-1">สุดยอดมาก!</h2>
        <div id="resultMsg" style="font-size: 2.4rem; margin: 30px 0; line-height: 1.6;"></div>
        <div id="score">1000 คะแนน</div>
        <button class="btn-restart" id="restartBtn">เริ่มเล่นใหม่</button>
    </div>
</div>

<!-- เสียง -->
<audio id="correctSound" src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-reward-952.mp3" preload="auto"></audio>
<audio id="wrongSound" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-946.mp3" preload="auto"></audio>
<audio id="bgm" src="audio/b.mp3" preload="auto" loop></audio>
<audio id="doorSound" src="audio/door.mp3" preload="auto"></audio>
<audio id="t1Sound" src="audio/t1.mp3" preload="auto"></audio>
<audio id="tSound" src="audio/t.mp3" preload="auto"></audio>
<audio id="fSound" src="audio/f.mp3" preload="auto"></audio>
<audio id="endSound" src="audio/end.mp3" preload="auto"></audio>
<audio id="end1Sound" src="audio/end1.mp3" preload="auto"></audio>

<script>
// ======== AudioEngine (แก้ไขแล้ว) ========
class AudioEngine {
  constructor(map) {
    this.map = map;
    this.isUnlocked = false;
    this.bgmEl = map['bgm'] || null;
    this.bgmStarted = false;
    this.currentEndPromise = null;
  }
  async unlockAll() {
    if (this.isUnlocked) return;
    for (const [key, el] of Object.entries(this.map)) {
      try {
        const origVol = el.volume;
        el.volume = 0;
        el.currentTime = 0;
        if (el.readyState < 2) {
          await new Promise(r => {
            const fn = () => { el.removeEventListener('loadeddata', fn); el.removeEventListener('canplaythrough', fn); r(); };
            el.addEventListener('loadeddata', fn);
            el.addEventListener('canplaythrough', fn);
            setTimeout(r, 500);
          });
        }
        await el.play().catch(() => {});
        if (!el.paused) { await new Promise(r => setTimeout(r, 50)); el.pause(); }
        el.currentTime = 0;
        el.volume = origVol;
      } catch(e) {}
    }
    this.isUnlocked = true;
  }
  async startBGM() {
    if (!this.bgmEl) return;
    this.bgmEl.currentTime = 0;
    this.bgmEl.volume = 0.6;
    try {
      await this.bgmEl.play();
      this.bgmStarted = true;
    } catch(e) {}
  }
  stopBGM() {
    if (this.bgmEl) {
      this.bgmEl.pause();
      this.bgmEl.currentTime = 0;
      this.bgmStarted = false;
    }
  }
  async playEffect(key) {
    const el = this.map[key];
    if (!el) return;
    if ((key === 'endSound' || key === 'end1Sound') && this.currentEndPromise) {
      return this.currentEndPromise;
    }
    const p = new Promise(resolve => {
      let settled = false;
      let timer = null;
      const cleanup = () => {
        try { el.onended = null; el.onpause = null; el.onerror = null; } catch(e) {}
        if (timer) { clearTimeout(timer); timer = null; }
      };
      const done = () => {
        if (settled) return;
        settled = true;
        cleanup();
        try { el.currentTime = 0; } catch(e) {}
        resolve();
      };
      el.onended = done;
      el.onpause = done;
      el.onerror = done;
      timer = setTimeout(done, 4000);
      try {
        el.currentTime = 0;
        el.volume = 0.8;
        el.play().catch(() => done());
      } catch (e) {
        done();
      }
    });
    if (key === 'endSound' || key === 'end1Sound') {
      this.currentEndPromise = p;
      p.then(() => { this.currentEndPromise = null; }).catch(() => { this.currentEndPromise = null; });
    }
    return p;
  }
}

const audioEngine = new AudioEngine({
  bgm: document.getElementById("bgm"),
  correctSound: document.getElementById("correctSound"),
  wrongSound: document.getElementById("wrongSound"),
  doorSound: document.getElementById("doorSound"),
  t1Sound: document.getElementById("t1Sound"),
  tSound: document.getElementById("tSound"),
  fSound: document.getElementById("fSound"),
  endSound: document.getElementById("endSound"),
  end1Sound: document.getElementById("end1Sound")
});

let hasUserInteracted = false;
async function unlockAudio(){
  if (hasUserInteracted) return;
  hasUserInteracted = true;
  await audioEngine.unlockAll();
  await audioEngine.startBGM();
}
document.addEventListener("touchstart", unlockAudio, {once:true, passive:true});
document.addEventListener("click", unlockAudio, {once:true});

// คำศัพท์ทั้งหมด (รวมทั้งหมด 333 คำ)
const vocab = [
    {th:"แมว", en:"cat"}, {th:"หมา", en:"dog"}, {th:"ช้าง", en:"elephant"}, {th:"เสือ", en:"tiger"},
    {th:"ม้า", en:"horse"}, {th:"วัว", en:"cow"}, {th:"หมู", en:"pig"}, {th:"ไก่", en:"chicken"},
    {th:"เป็ด", en:"duck"}, {th:"กบ", en:"frog"}, {th:"ปลา", en:"fish"}, {th:"นก", en:"bird"},
    {th:"กระต่าย", en:"rabbit"}, {th:"งู", en:"snake"}, {th:"สิงโต", en:"lion"}, {th:"หมี", en:"bear"},
    {th:"โต๊ะ", en:"table"}, {th:"เก้าอี้", en:"chair"}, {th:"เตียง", en:"bed"}, {th:"หนังสือ", en:"book"},
    {th:"ปากกา", en:"pen"}, {th:"ดินสอ", en:"pencil"}, {th:"รถยนต์", en:"car"}, {th:"จักรยาน", en:"bicycle"},
    {th:"พ่อ", en:"father"}, {th:"แม่", en:"mother"}, {th:"พี่ชาย", en:"brother"}, {th:"น้องสาว", en:"sister"},
    {th:"ครู", en:"teacher"}, {th:"หมอ", en:"doctor"}, {th:"โรงเรียน", en:"school"}, {th:"บ้าน", en:"house"},
    {th:"ข้าว", en:"rice"}, {th:"น้ำ", en:"water"}, {th:"นม", en:"milk"}, {th:"ไข่", en:"egg"},
    {th:"กล้วย", en:"banana"}, {th:"แอปเปิ้ล", en:"apple"}, {th:"ส้ม", en:"orange"}, {th:"เค้ก", en:"cake"},
    {th:"รองเท้า", en:"shoes"}, {th:"เสื้อ", en:"shirt"}, {th:"กางเกง", en:"pants"}, {th:"หมวก", en:"hat"},
    {th:"ช้อน", en:"spoon"}, {th:"ส้อม", en:"fork"}, {th:"จาน", en:"plate"}, {th:"แก้ว", en:"glass"},
    {th:"ลูกบอล", en:"ball"}, {th:"ตุ๊กตา", en:"doll"}, {th:"ดอกไม้", en:"flower"}, {th:"ต้นไม้", en:"tree"},
    {th:"ดวงอาทิตย์", en:"sun"}, {th:"ดวงจันทร์", en:"moon"}, {th:"ดาว", en:"star"}, {th:"ฝน", en:"rain"},
    {th:"รถไฟ", en:"train"}, {th:"เครื่องบิน", en:"airplane"}, {th:"เรือ", en:"boat"},
    {th:"ยีราฟ", en:"giraffe"}, {th:"จิงโจ้", en:"kangaroo"}, {th:"ผีเสื้อ", en:"butterfly"}, {th:"เต่า", en:"turtle"},
    {th:"มะม่วง", en:"mango"}, {th:"สับปะรด", en:"pineapple"}, {th:"แตงโม", en:"watermelon"}, {th:"องุ่น", en:"grapes"},
    {th:"ช็อกโกแลต", en:"chocolate"}, {th:"ไอศกรีม", en:"ice cream"}, {th:"พิซซ่า", en:"pizza"},
    {th:"โรงพยาบาล", en:"hospital"}, {th:"สวนสาธารณะ", en:"park"}, {th:"ทะเล", en:"sea"}, {th:"ภูเขา", en:"mountain"},
    {th:"หุ่นยนต์", en:"robot"}, {th:"โทรศัพท์", en:"phone"}, {th:"คอมพิวเตอร์", en:"computer"}, {th:"ทีวี", en:"television"},
    {th:"กล้อง", en:"camera"}, {th:"หน้าต่าง", en:"window"}, {th:"ประตู", en:"door"}, {th:"กุญแจ", en:"key"},
    {th:"กระเป๋า", en:"bag"}, {th:"นาฬิกา", en:"clock"}, {th:"แว่นตา", en:"glasses"}, {th:"ร่ม", en:"umbrella"},
    {th:"ดิน", en:"soil"}, {th:"เมฆ", en:"cloud"}, {th:"สายรุ้ง", en:"rainbow"}, {th:"หิมะ", en:"snow"},
    {th:"ลม", en:"wind"}, {th:"ไฟ", en:"fire"}, {th:"ฟุตบอล", en:"football"}, {th:"บาสเก็ตบอล", en:"basketball"},
    {th:"ว่ายน้ำ", en:"swim"}, {th:"วิ่ง", en:"run"}, {th:"กระโดด", en:"jump"}, {th:"เต้นรำ", en:"dance"},
    {th:"ร้องเพลง", en:"sing"}, {th:"วาดรูป", en:"draw"}, {th:"อ่านหนังสือ", en:"read"}, {th:"เขียน", en:"write"},
    {th:"กิน", en:"eat"}, {th:"ดื่ม", en:"drink"}, {th:"นอน", en:"sleep"}, {th:"ตื่น", en:"wake"},
    {th:"ยิ้ม", en:"smile"}, {th:"หัวเราะ", en:"laugh"}, {th:"ร้องไห้", en:"cry"}, {th:"โกรธ", en:"angry"},
    {th:"ดีใจ", en:"happy"}, {th:"กลัว", en:"afraid"}, {th:"เหนื่อย", en:"tired"}, {th:"หิว", en:"hungry"},
    {th:"กระหาย", en:"thirsty"}, {th:"ร้อน", en:"hot"}, {th:"เย็น", en:"cold"}, {th:"ใหญ่", en:"big"},
    {th:"เล็ก", en:"small"}, {th:"ยาว", en:"long"}, {th:"สั้น", en:"short"}, {th:"สูง", en:"tall"},
    {th:"เตี้ย", en:"short"}, {th:"หนัก", en:"heavy"}, {th:"เบา", en:"light"},
    {th:"ปาก", en:"mouth"}, {th:"ตา", en:"eye"}, {th:"หู", en:"ear"}, {th:"จมูก", en:"nose"},
    {th:"หัว", en:"head"}, {th:"มือ", en:"hand"}, {th:"เท้า", en:"foot"}, {th:"ผม", en:"hair"},
    {th:"ฟัน", en:"tooth"}, {th:"ลิ้น", en:"tongue"}, {th:"คอ", en:"neck"}, {th:"ไหล่", en:"shoulder"},
    {th:"หน้าอก", en:"chest"}, {th:"ท้อง", en:"stomach"}, {th:"หลัง", en:"back"}, {th:"ขา", en:"leg"},
    {th:"เข่า", en:"knee"}, {th:"นิ้ว", en:"finger"}, {th:"เล็บ", en:"nail"}, {th:"ผิวหนัง", en:"skin"},
    {th:"สีแดง", en:"red"}, {th:"สีน้ำเงิน", en:"blue"}, {th:"สีเขียว", en:"green"}, {th:"สีเหลือง", en:"yellow"},
    {th:"สีดำ", en:"black"}, {th:"สีขาว", en:"white"}, {th:"สีชมพู", en:"pink"}, {th:"สีส้ม", en:"orange"},
    {th:"สีม่วง", en:"purple"}, {th:"สีน้ำตาล", en:"brown"}, {th:"หนึ่ง", en:"one"}, {th:"สอง", en:"two"},
    {th:"สาม", en:"three"}, {th:"สี่", en:"four"}, {th:"ห้า", en:"five"}, {th:"หก", en:"six"},
    {th:"เจ็ด", en:"seven"}, {th:"แปด", en:"eight"}, {th:"เก้า", en:"nine"}, {th:"สิบ", en:"ten"},
    {th:"วันจันทร์", en:"monday"}, {th:"วันอังคาร", en:"tuesday"}, {th:"วันพุธ", en:"wednesday"}, {th:"วันพฤหัสบดี", en:"thursday"},
    {th:"วันศุกร์", en:"friday"}, {th:"วันเสาร์", en:"saturday"}, {th:"วันอาทิตย์", en:"sunday"}, {th:"เช้า", en:"morning"},
    {th:"บ่าย", en:"afternoon"}, {th:"เย็น", en:"evening"}, {th:"กลางคืน", en:"night"}, {th:"เมื่อวาน", en:"yesterday"},
    {th:"วันนี้", en:"today"}, {th:"พรุ่งนี้", en:"tomorrow"}, {th:"สัปดาห์", en:"week"}, {th:"เดือน", en:"month"},
    {th:"ปี", en:"year"}, {th:"ฤดูร้อน", en:"summer"}, {th:"ฤดูฝน", en:"rainy"}, {th:"ฤดูหนาว", en:"winter"},
    {th:"ฤดูใบไม้ผลิ", en:"spring"}, {th:"ร้านค้า", en:"shop"}, {th:"ตลาด", en:"market"}, {th:"ธนาคาร", en:"bank"},
    {th:"โรงหนัง", en:"cinema"}, {th:"สวนสัตว์", en:"zoo"}, {th:"พิพิธภัณฑ์", en:"museum"}, {th:"ห้างสรรพสินค้า", en:"mall"},
    {th:"สนามบิน", en:"airport"}, {th:"สถานีรถไฟ", en:"station"}, {th:"ป้ายรถเมล์", en:"bus stop"}, {th:"ถนน", en:"road"},
    {th:"สะพาน", en:"bridge"}, {th:"แม่น้ำ", en:"river"}, {th:"น้ำตก", en:"waterfall"}, {th:"เกาะ", en:"island"},
    {th:"หาดทราย", en:"beach"}, {th:"ป่า", en:"forest"}, {th:"ถ้ำ", en:"cave"}, {th:"ดวงดาว", en:"planet"},
    {th:"จักรวาล", en:"universe"}, {th:"ดาวอังคาร", en:"mars"}, {th:"ดาวพฤหัสบดี", en:"jupiter"}, {th:"ยานอวกาศ", en:"spaceship"},
    {th:"นักบินอวกาศ", en:"astronaut"}, {th:"ดอกกุหลาบ", en:"rose"}, {th:"ดอกทานตะวัน", en:"sunflower"}, {th:"ผัก", en:"vegetable"},
    {th:"ผลไม้", en:"fruit"}, {th:"เนื้อ", en:"meat"}, {th:"ขนมปัง", en:"bread"}, {th:"เนย", en:"butter"},
    {th:"ชีส", en:"cheese"}, {th:"ซุป", en:"soup"}, {th:"สลัด", en:"salad"}, {th:"น้ำผลไม้", en:"juice"},
    {th:"กางเกงใน", en:"underwear"}, {th:"เสื้อกันหนาว", en:"jacket"}, {th:"ถุงเท้า", en:"socks"}, {th:"ผ้าพันคอ", en:"scarf"},
    {th:"ถุงมือ", en:"gloves"}, {th:"เข็มขัด", en:"belt"}, {th:"กระโปรง", en:"skirt"}, {th:"ชุดเดรส", en:"dress"},
    {th:"เสื้อโปโล", en:"polo"}, {th:"กางเกงขาสั้น", en:"shorts"}, {th:"หม้อ", en:"pot"}, {th:"กระทะ", en:"pan"},
    {th:"มีด", en:"knife"}, {th:"เขียง", en:"cutting board"}, {th:"ตู้เย็น", en:"fridge"}, {th:"เตาแก๊ส", en:"stove"},
    {th:"ไมโครเวฟ", en:"microwave"}, {th:"เครื่องซักผ้า", en:"washing machine"}, {th:"เตารีด", en:"iron"}, {th:"ไม้กวาด", en:"broom"},
    {th:"ที่โกยผง", en:"dustpan"}, {th:"ผงซักฟอก", en:"detergent"}, {th:"สบู่", en:"soap"}, {th:"ยาสีฟัน", en:"toothpaste"},
    {th:"แปรงสีฟัน", en:"toothbrush"}, {th:"แชมพู", en:"shampoo"}, {th:"ครีมนวดผม", en:"conditioner"}, {th:"หวี", en:"comb"},
    {th:"กระจก", en:"mirror"}, {th:"ผ้าเช็ดตัว", en:"towel"}, {th:"หมอน", en:"pillow"}, {th:"ผ้าห่ม", en:"blanket"},
    {th:"ม่าน", en:"curtain"}, {th:"พรม", en:"carpet"}, {th:"โคมไฟ", en:"lamp"}, {th:"พัดลม", en:"fan"},
    {th:"เครื่องปรับอากาศ", en:"air conditioner"}, {th:"รีโมท", en:"remote"}, {th:"แบตเตอรี่", en:"battery"}, {th:"ปลั๊กไฟ", en:"plug"},
    {th:"สายชาร์จ", en:"charger"}, {th:"หูฟัง", en:"headphones"}, {th:"ลำโพง", en:"speaker"}, {th:"เมาส์", en:"mouse"},
    {th:"คีย์บอร์ด", en:"keyboard"}, {th:"จอคอม", en:"monitor"}, {th:"ปริ้นเตอร์", en:"printer"}, {th:"สแกนเนอร์", en:"scanner"},
    {th:"แท็บเล็ต", en:"tablet"}, {th:"สมาร์ทวอทช์", en:"smartwatch"}, {th:"รถเข็นเด็ก", en:"stroller"}, {th:"เปล", en:"crib"},
    {th:"ของเล่น", en:"toy"}, {th:"ตุ๊กตาหมี", en:"teddy bear"}, {th:"เลโก้", en:"lego"}, {th:"จิ๊กซอว์", en:"puzzle"},
    {th:"สีเทียน", en:"crayon"}, {th:"ดินสอสี", en:"colored pencil"}, {th:"สมุดวาดเขียน", en:"sketchbook"}, {th:"กรรไกร", en:"scissors"},
    {th:"กาว", en:"glue"}, {th:"เทปกาว", en:"tape"}, {th:"ไม้บรรทัด", en:"ruler"}, {th:"ยางลบ", en:"eraser"},
    {th:"กระดาษ", en:"paper"}, {th:"สมุด", en:"notebook"}, {th:"ปากกาไฮไลต์", en:"highlighter"}, {th:"คลิปหนีบกระดาษ", en:"paperclip"},
    {th:"ลวดเสียบ", en:"stapler"}, {th:"เครื่องคิดเลข", en:"calculator"}, {th:"ปฏิทิน", en:"calendar"}, {th:"นาฬิกาปลุก", en:"alarm clock"},
    {th:"ไฟฉาย", en:"flashlight"}, {th:"แบตสำรอง", en:"power bank"}, {th:"ร่มกันแดด", en:"parasol"}, {th:"กระติกน้ำ", en:"thermos"},
    {th:"กล่องข้าว", en:"lunchbox"}, {th:"ขวดน้ำ", en:"water bottle"}, {th:"เป้", en:"backpack"}, {th:"ดินสอกราไฟต์", en:"graphite"},
    {th:"ยางลบดินสอ", en:"pencil eraser"}, {th:"สมุดโน้ต", en:"notepad"}, {th:"โพสต์อิท", en:"sticky note"}, {th:"ปากกาลูกลื่น", en:"ballpoint pen"},
    {th:"สมุดรายงาน", en:"report book"}, {th:"กระดานไวท์บอร์ด", en:"whiteboard"}, {th:"ปากกาไวท์บอร์ด", en:"whiteboard marker"}, {th:"ฟองน้ำลบกระดาน", en:"board eraser"}
];

let currentQuestions = [], currentQ = 0, score = 0, timerInterval, selectedLetters = [], timePerQuestion = 20;
const TOTAL_QUESTIONS = 10;
let isProcessingTimeout = false;
const backBtn = document.getElementById('backToMenu');

function shuffle(array) {
    const arr = [...array];
    for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
}

async function startGameWithTime(seconds) {
    timePerQuestion = seconds;
    document.getElementById('levelSelect').style.display = 'none';
    document.getElementById('game').style.display = 'block';
    backBtn.style.display = 'none';

    await audioEngine.startBGM();

    currentQuestions = shuffle(vocab).slice(0, TOTAL_QUESTIONS);
    currentQ = 0; score = 0;
    nextQuestion();
}

function nextQuestion() {
    if (currentQ >= TOTAL_QUESTIONS) { endGame(); return; }

    isProcessingTimeout = false;
    selectedLetters = [];
    const word = currentQuestions[currentQ];
    document.getElementById('spellingDisplay').textContent = '_ '.repeat(word.en.length).trim();
    document.getElementById('question').textContent = `ข้อ ${currentQ + 1} : ${word.th} ภาษาอังกฤษเขียนว่า`;
    document.getElementById('question').focus();

    clearInterval(timerInterval);

    const letters = shuffle(word.en.toLowerCase().split(''));
    const lettersDiv = document.getElementById('letters');
    lettersDiv.innerHTML = '';

    requestAnimationFrame(() => {
        setTimeout(() => {
            letters.forEach(letter => {
                const btn = document.createElement('button');
                btn.className = 'letter-btn';
                btn.textContent = letter;                   // แก้ตรงนี้: ใช้ตัวเล็ก
                btn.dataset.letter = letter;                // แก้ตรงนี้
                btn.setAttribute('role', 'button');
                btn.setAttribute('aria-label', letter);     // แก้ตรงนี้
                btn.onclick = () => selectLetter(btn, letter, word.en.toLowerCase());
                lettersDiv.appendChild(btn);
            });
        }, 50);
    });

    let timeLeft = timePerQuestion;
    document.getElementById('timer').textContent = timeLeft;
    timerInterval = setInterval(() => {
        timeLeft--;
        document.getElementById('timer').textContent = timeLeft;
        if (timeLeft <= 0 && !isProcessingTimeout) {
            isProcessingTimeout = true;
            clearInterval(timerInterval);
            audioEngine.playEffect('wrongSound');
            audioEngine.playEffect('fSound').then(() => { currentQ++; nextQuestion(); });
        }
    }, 1000);
}

async function selectLetter(btn, letter, correct) {
    if (btn.classList.contains('used')) return;

    selectedLetters.push(letter);
    btn.classList.add('used');
    btn.setAttribute('aria-label', btn.dataset.letter + ' เลือกแล้ว');
    btn.setAttribute('aria-pressed', 'true');

    document.getElementById('spellingDisplay').textContent = selectedLetters.join(' ');  // แก้ตรงนี้: ไม่มี .toUpperCase()

    const typed = selectedLetters.join('');

    if (typed.length < correct.length && correct.startsWith(typed)) {
        await audioEngine.playEffect('t1Sound');
    }

    if (typed === correct) {
        clearInterval(timerInterval); isProcessingTimeout = true;
        await audioEngine.playEffect('correctSound');
        score++;
        await audioEngine.playEffect('tSound');
        currentQ++; nextQuestion();
    } else if (!correct.startsWith(typed)) {
        clearInterval(timerInterval); isProcessingTimeout = true;
        btn.classList.add('wrong');
        await audioEngine.playEffect('wrongSound');
        await audioEngine.playEffect('fSound');
        currentQ++; nextQuestion();
    }
}

async function endGame() {
    clearInterval(timerInterval);
    audioEngine.stopBGM();
    document.getElementById('game').style.display = 'none';
    document.getElementById('result').style.display = 'block';
    backBtn.style.display = 'block';
    const title = document.getElementById('resultTitle');
    const msg = document.getElementById('resultMsg');
    const scoreDiv = document.getElementById('score');
    let points;
    if (score === TOTAL_QUESTIONS) {
        title.textContent = "สุดยอดมาก!";
        msg.innerHTML = `ตอบถูกทั้ง ${TOTAL_QUESTIONS} ข้อเลย!<br>เก่งสุด ๆ ไปเลยนะ!`;
        points = 1000;
        await audioEngine.playEffect('endSound');
    } else {
        if (score >= Math.max(1, Math.floor(TOTAL_QUESTIONS * 0.8))) {
            title.textContent = "เก่งมากเลย!";
            msg.innerHTML = `ตอบถูก ${score} จาก ${TOTAL_QUESTIONS} ข้อ<br>เยี่ยมมาก! ใกล้เต็มแล้ว`;
            points = 700;
        } else {
            points = score * 50;
            const encourages = [
              "ไม่เป็นไรนะ ครั้งหน้าต้องเก่งขึ้นแน่!",
              "พยายามเข้าไว้ สู้ ๆ นะจ๊ะ!",
              "เยี่ยมแล้วที่เล่นจนจบ!",
              "ทุกครั้งที่เล่น เราจะเก่งขึ้นนะ",
              "อย่ายอมแพ้นะ เดี๋ยวก็เก่งเอง!"
            ];
            title.textContent = "ไม่เป็นไร สู้ต่อไป!";
            msg.textContent = encourages[Math.floor(Math.random() * encourages.length)];
        }
        await audioEngine.playEffect('end1Sound');
    }
    scoreDiv.textContent = points + " คะแนน";
    setTimeout(() => {
      try { title.focus(); } catch(e) {}
    }, 50);
}

document.getElementById('easy').onclick = () => startGameWithTime(40);
document.getElementById('medium').onclick = () => startGameWithTime(25);
document.getElementById('hard').onclick = () => startGameWithTime(15);

document.getElementById('restartBtn').onclick = async () => {
    await audioEngine.playEffect('doorSound');
    document.getElementById('result').style.display = 'none';
    document.getElementById('levelSelect').style.display = 'block';
    backBtn.style.display = 'block';
};

backBtn.onclick = async () => {
    audioEngine.stopBGM();
    await audioEngine.playEffect('doorSound');
    location.href = '../index.html';
};

window.addEventListener('beforeunload', () => audioEngine.stopBGM());
</script>
</body>
</html>