<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Letter Puzzle - อักษรพาซน!</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;800;900&display=swap');
        
        body {
            margin: 0;
            font-family: 'Kanit', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            color: #fff;
            overflow: hidden;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        #backToMenu {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(255,255,255,0.25);
            padding: 12px 28px;
            border: none;
            border-radius: 50px;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            backdrop-filter: blur(12px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
            z-index: 1000;
            transition: all 0.3s;
        }
        #backToMenu:hover {
            background: rgba(255,255,255,0.4);
            transform: translateY(-4px);
        }

        #levelSelect {
            text-align: center;
            padding-top: 15vh;
        }
        h1 {
            font-size: 4.8rem;
            margin: 0 0 10px;
            text-shadow: 0 10px 30px rgba(0,0,0,0.4);
        }
        .subtitle {
            font-size: 1.9rem;
            margin-bottom: 60px;
            opacity: 0.9;
        }
        .level-buttons {
            display: flex;
            justify-content: center;
            gap: 40px;
            flex-wrap: wrap;
        }
        .level-btn {
            width: 280px;
            padding: 38px 20px;
            font-size: 2.3rem;
            font-weight: 800;
            border: none;
            border-radius: 32px;
            cursor: pointer;
            box-shadow: 0 18px 40px rgba(0,0,0,0.45);
            transition: all 0.3s;
        }
        .level-btn:hover {
            transform: translateY(-18px) scale(1.06);
        }
        #easy { background: #51cf66; }
        #medium { background: #ffd43b; color: #333; }
        #hard { background: #ff6b6b; }

        #game {
            display: none;
            text-align: center;
            padding-top: 8vh;
        }
        .question-heading {
            font-size: 3.6rem;
            font-weight: 900;
            margin-bottom: 25px;
            text-shadow: 0 6px 22px rgba(0,0,0,0.5);
            padding: 18px 30px;
            background: rgba(255,255,255,0.18);
            border-radius: 25px;
            display: inline-block;
            backdrop-filter: blur(8px);
        }
        .spelling-display {
            font-size: 4.2rem;
            font-weight: bold;
            min-height: 110px;
            margin: 30px 0;
            letter-spacing: 14px;
            color: #ffd93d;
        }
        .timer {
            display: none;
        }
        .letters {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 28px;
            margin: 55px 0;
        }
        .letter-btn {
            position: relative;
            width: 100px;
            height: 100px;
            font-size: 3rem;
            font-weight: bold;
            background: #ffd93d;
            color: #333;
            border: none;
            border-radius: 26px;
            cursor: pointer;
            box-shadow: 0 12px 28px rgba(0,0,0,0.35);
            transition: all 0.3s;
        }
        .letter-btn:hover:not(.used) { transform: scale(1.15); }
        .letter-btn.used {
            background: #999 !important;
            color: #555 !important;
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
            transform: scale(0.85);
            font-size: 1.3rem;
        }
        .letter-btn.wrong {
            background: #ff6b6b !important;
            animation: shake 0.5s;
        }
        @keyframes shake {
            0%,100% { transform: translateX(0); }
            25% { transform: translateX(-14px); }
            75% { transform: translateX(14px); }
        }

        #result {
            display: none;
            text-align: center;
            padding-top: 15vh;
        }
        #result h2 {
            font-size: 5.8rem;
            margin: 0 0 35px;
            text-shadow: 0 12px 35px rgba(0,0,0,0.5);
        }
        #score {
            font-size: 7rem;
            font-weight: 900;
            margin: 50px 0;
            text-shadow: 0 12px 35px rgba(0,0,0,0.5);
        }
        .btn-restart {
            margin: 25px 15px;
            padding: 20px 55px;
            font-size: 1.9rem;
            background: #4ecdc4;
            border: none;
            border-radius: 50px;
            color: white;
            cursor: pointer;
            box-shadow: 0 14px 30px rgba(0,0,0,0.4);
        }
        .btn-restart:hover {
            transform: translateY(-10px);
        }
    </style>
</head>
<body>

<div class="container">
    <button id="backToMenu">กลับเมนูหลัก</button>

    <div id="levelSelect">
        <h1>Letter Puzzle - อักษรพาซน!</h1>
        <p class="subtitle">เลือกระดับความยาก แล้วมาเริ่มสนุกกันเลย!</p>
        <div class="level-buttons">
            <button class="level-btn" id="easy">ง่าย<br><small>(40 วินาที/ข้อ)</small></button>
            <button class="level-btn" id="medium">ปานกลาง<br><small>(25 วินาที/ข้อ)</small></button>
            <button class="level-btn" id="hard">ปราบเซียน<br><small>(15 วินาที/ข้อ)</small></button>
        </div>
    </div>

    <div id="game">
        <h2 class="question-heading" id="question" tabindex="-1">ข้อ 1 : แมว ภาษาอังกฤษเขียนว่า</h2>
        <div class="spelling-display" id="spellingDisplay">_ _ _</div>
        <div class="timer"><span id="timer">20</span></div>
        <div class="letters" id="letters"></div>
    </div>

    <div id="result">
        <h2 id="resultTitle" tabindex="-1">สุดยอดมาก!</h2>
        <div id="resultMsg" style="font-size: 2.4rem; margin: 30px 0; line-height: 1.6;"></div>
        <div id="score">1000 คะแนน</div>
        <button class="btn-restart" id="restartBtn">เริ่มเล่นใหม่</button>
    </div>
</div>

<!-- เสียงเดิม -->
<audio id="correctSound" src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-reward-952.mp3" preload="auto"></audio>
<audio id="wrongSound" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-946.mp3" preload="auto"></audio>

<!-- เสียงใหม่ทั้งหมด (อยู่ใน folder audio) -->
<audio id="bgm" src="audio/b.mp3" preload="auto" loop></audio>
<audio id="startSound" src="audio/start.mp3" preload="auto"></audio>
<audio id="doorSound" src="audio/door.mp3" preload="auto"></audio>
<audio id="t1Sound" src="audio/t1.mp3" preload="auto"></audio>
<audio id="tSound" src="audio/t.mp3" preload="auto"></audio>
<audio id="fSound" src="audio/f.mp3" preload="auto"></audio>
<audio id="endSound" src="audio/end.mp3" preload="auto"></audio>
<audio id="end1Sound" src="audio/end1.mp3" preload="auto"></audio>

<script>
// ======== AudioEngine (ปรับปรุงสำหรับ iOS) ========
class AudioEngine {
  constructor(map) { 
    this.map = map; 
    this.queue = []; 
    this.isPlaying = false; 
    this.bgmEl = this.map['bgm'] || null;
    this.isUnlocked = false;
  }
  
  async unlockAll() {
    if (this.isUnlocked) return;
    
    // unlock ทีละตัวอย่างระมัดระวัง
    for (const [key, el] of Object.entries(this.map)) {
      try {
        el.muted = false;
        el.volume = 0.8;
        el.currentTime = 0;
        
        // รอให้ audio โหลดเสร็จก่อน
        if (el.readyState < 2) {
          await new Promise(resolve => {
            const onLoad = () => {
              el.removeEventListener('loadeddata', onLoad);
              el.removeEventListener('canplaythrough', onLoad);
              resolve();
            };
            el.addEventListener('loadeddata', onLoad);
            el.addEventListener('canplaythrough', onLoad);
            setTimeout(resolve, 500); // timeout fallback
          });
        }
        
        // ลอง play แล้ว pause ทันที
        const playPromise = el.play();
        if (playPromise) {
          await playPromise.catch(() => {});
        }
        
        if (!el.paused) {
          await new Promise(resolve => setTimeout(resolve, 50));
          el.pause();
        }
        el.currentTime = 0;
      } catch(e) {
        console.warn(`Failed to unlock ${key}:`, e);
      }
    }
    
    this.isUnlocked = true;
  }
  
  async startBGM() { 
    if (!this.bgmEl) return;
    try {
      // รอสักครู่ให้ unlock เสร็จสนิท
      await new Promise(resolve => setTimeout(resolve, 100));
      
      if (this.bgmEl.paused) { 
        this.bgmEl.currentTime = 0;
        this.bgmEl.volume = 0.6;
        await this.bgmEl.play().catch(e => console.warn('BGM play failed:', e));
      }
    } catch(e) {
      console.warn('BGM start failed:', e);
    }
  }
  
  stopBGM() { 
    if (this.bgmEl) { 
      this.bgmEl.pause(); 
      this.bgmEl.currentTime = 0; 
    } 
  }
  
  playEffect(key) {
    if (!this.map[key]) return Promise.resolve();
    return new Promise(resolve => { 
      this.queue.push({key, resolve}); 
      if (!this.isPlaying) this._dequeue(); 
    });
  }
  
  async _dequeue() {
    if (!this.queue.length) { 
      this.isPlaying = false; 
      return; 
    }
    
    this.isPlaying = true;
    const {key, resolve} = this.queue.shift();
    const el = this.map[key];
    
    if (!el) { 
      resolve(); 
      this._dequeue(); 
      return; 
    }

    let settled = false;
    const cleanup = () => { 
      try { el.onended = null; } catch(e){} 
    };
    
    const onEnded = () => { 
      if (settled) return; 
      settled = true; 
      cleanup(); 
      el.currentTime = 0; 
      resolve(); 
      setTimeout(() => this._dequeue(), 40); 
    };
    
    try { el.onended = onEnded; } catch(e){}

    const duration = (el.duration && isFinite(el.duration) && el.duration > 0) ? el.duration * 1000 : 600;
    const timer = setTimeout(() => {
      if (settled) return;
      settled = true; 
      cleanup(); 
      try { el.pause(); } catch(e){} 
      el.currentTime = 0; 
      resolve(); 
      setTimeout(() => this._dequeue(), 40);
    }, duration + 300);

    try { 
      el.currentTime = 0;
      el.volume = 0.8;
      await el.play().catch(() => {});
    } catch(e) { 
      clearTimeout(timer); 
      if (!settled) { 
        settled = true; 
        resolve(); 
        setTimeout(() => this._dequeue(), 40); 
      } 
    }
  }
}

const audioMap = {
  bgm: document.getElementById("bgm"),
  correctSound: document.getElementById("correctSound"),
  wrongSound: document.getElementById("wrongSound"),
  startSound: document.getElementById("startSound"),
  doorSound: document.getElementById("doorSound"),
  t1Sound: document.getElementById("t1Sound"),
  tSound: document.getElementById("tSound"),
  fSound: document.getElementById("fSound"),
  endSound: document.getElementById("endSound"),
  end1Sound: document.getElementById("end1Sound")
};
const audioEngine = new AudioEngine(audioMap);

let hasUserInteracted = false;

// ======== Unlock Audio ========
async function unlockAudio(){
  if (hasUserInteracted) return;
  hasUserInteracted = true;
  await audioEngine.unlockAll();
}
document.addEventListener("touchstart", unlockAudio, {once:true, passive:true});
document.addEventListener("click", unlockAudio, {once:true});

// คำศัพท์
const vocab = [
    {th:"แมว", en:"cat"}, {th:"หมา", en:"dog"}, {th:"ช้าง", en:"elephant"}, {th:"เสือ", en:"tiger"},
    {th:"ม้า", en:"horse"}, {th:"วัว", en:"cow"}, {th:"หมู", en:"pig"}, {th:"ไก่", en:"chicken"},
    {th:"เป็ด", en:"duck"}, {th:"กบ", en:"frog"}, {th:"ปลา", en:"fish"}, {th:"นก", en:"bird"},
    {th:"กระต่าย", en:"rabbit"}, {th:"งู", en:"snake"}, {th:"สิงโต", en:"lion"}, {th:"หมี", en:"bear"},
    {th:"โต๊ะ", en:"table"}, {th:"เก้าอี้", en:"chair"}, {th:"เตียง", en:"bed"}, {th:"หนังสือ", en:"book"},
    {th:"ปากกา", en:"pen"}, {th:"ดินสอ", en:"pencil"}, {th:"รถยนต์", en:"car"}, {th:"จักรยาน", en:"bicycle"},
    {th:"พ่อ", en:"father"}, {th:"แม่", en:"mother"}, {th:"พี่ชาย", en:"brother"}, {th:"น้องสาว", en:"sister"},
    {th:"ครู", en:"teacher"}, {th:"หมอ", en:"doctor"}, {th:"โรงเรียน", en:"school"}, {th:"บ้าน", en:"house"},
    {th:"ข้าว", en:"rice"}, {th:"น้ำ", en:"water"}, {th:"นม", en:"milk"}, {th:"ไข่", en:"egg"},
    {th:"กล้วย", en:"banana"}, {th:"แอปเปิ้ล", en:"apple"}, {th:"ส้ม", en:"orange"}, {th:"เค้ก", en:"cake"},
    {th:"รองเท้า", en:"shoes"}, {th:"เสื้อ", en:"shirt"}, {th:"กางเกง", en:"pants"}, {th:"หมวก", en:"hat"},
    {th:"ช้อน", en:"spoon"}, {th:"ส้อม", en:"fork"}, {th:"จาน", en:"plate"}, {th:"แก้ว", en:"glass"},
    {th:"ลูกบอล", en:"ball"}, {th:"ตุ๊กตา", en:"doll"}, {th:"ดอกไม้", en:"flower"}, {th:"ต้นไม้", en:"tree"},
    {th:"ดวงอาทิตย์", en:"sun"}, {th:"ดวงจันทร์", en:"moon"}, {th:"ดาว", en:"star"}, {th:"ฝน", en:"rain"},
    {th:"รถไฟ", en:"train"}, {th:"เครื่องบิน", en:"airplane"}, {th:"เรือ", en:"boat"},
    {th:"ยีราฟ", en:"giraffe"}, {th:"จิงโจ้", en:"kangaroo"}, {th:"ผีเสื้อ", en:"butterfly"}, {th:"เต่า", en:"turtle"},
    {th:"มะม่วง", en:"mango"}, {th:"สับปะรด", en:"pineapple"}, {th:"แตงโม", en:"watermelon"}, {th:"องุ่น", en:"grapes"},
    {th:"ช็อกโกแลต", en:"chocolate"}, {th:"ไอศกรีม", en:"ice cream"}, {th:"พิซซ่า", en:"pizza"},
    {th:"โรงพยาบาล", en:"hospital"}, {th:"สวนสาธารณะ", en:"park"}, {th:"ทะเล", en:"sea"}, {th:"ภูเขา", en:"mountain"}
];

let currentQuestions = [];
let currentQ = 0;
let score = 0;
let timerInterval;
let selectedLetters = [];
let timePerQuestion = 20;
const TOTAL_QUESTIONS = 10;
let isProcessingTimeout = false; // ป้องกันเล่นเสียง f.mp3 ซ้ำ

const backBtn = document.getElementById('backToMenu');

function shuffle(array) {
    const arr = [...array];
    for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
}

async function startGameWithTime(seconds) {
    await unlockAudio();
    
    timePerQuestion = seconds;
    document.getElementById('levelSelect').style.display = 'none';
    document.getElementById('game').style.display = 'block';
    backBtn.style.display = 'none';

    // เล่น BGM และ startSound ตามลำดับ
    await audioEngine.startBGM();
    await audioEngine.playEffect('startSound');
    
    currentQuestions = shuffle(vocab).slice(0, TOTAL_QUESTIONS);
    currentQ = 0;
    score = 0;
    nextQuestion();
}

function nextQuestion() {
    if (currentQ >= TOTAL_QUESTIONS) {
        endGame();
        return;
    }

    isProcessingTimeout = false; // reset flag
    selectedLetters = [];
    const word = currentQuestions[currentQ];
    document.getElementById('spellingDisplay').textContent = '_ '.repeat(word.en.length).trim();
    document.getElementById('question').textContent = `ข้อ ${currentQ + 1} : ${word.th} ภาษาอังกฤษเขียนว่า`;
    document.getElementById('question').focus();

    clearInterval(timerInterval);

    const letters = shuffle(word.en.toLowerCase().split(''));
    const lettersDiv = document.getElementById('letters');
    lettersDiv.innerHTML = '';
    letters.forEach(letter => {
        const btn = document.createElement('button');
        btn.className = 'letter-btn';
        btn.textContent = letter.toUpperCase();
        btn.onclick = () => selectLetter(btn, letter, word.en.toLowerCase());
        lettersDiv.appendChild(btn);
    });

    let timeLeft = timePerQuestion;
    document.getElementById('timer').textContent = timeLeft;

    timerInterval = setInterval(() => {
        timeLeft--;
        document.getElementById('timer').textContent = timeLeft;
        
        if (timeLeft <= 0) {
            // ป้องกันเล่นซ้ำ
            if (isProcessingTimeout) return;
            isProcessingTimeout = true;
            
            clearInterval(timerInterval);
            audioEngine.playEffect('wrongSound');
            audioEngine.playEffect('fSound').then(() => {
                currentQ++;
                nextQuestion();
            });
        }
    }, 1000);
}

async function selectLetter(btn, letter, correct) {
    if (btn.classList.contains('used')) return;

    selectedLetters.push(letter);
    btn.classList.add('used');
    btn.textContent = 'เลือกแล้ว'; // เปลี่ยน label ที่นี่
    btn.setAttribute('aria-label', 'เลือกแล้ว');
    
    document.getElementById('spellingDisplay').textContent = selectedLetters.map(l => l.toUpperCase()).join(' ');

    const typed = selectedLetters.join('');

    if (typed.length < correct.length && correct.startsWith(typed)) {
        await audioEngine.playEffect('t1Sound');
    }

    if (typed === correct) {
        clearInterval(timerInterval);
        isProcessingTimeout = true; // ป้องกัน timeout ทำงาน
        
        await audioEngine.playEffect('correctSound');
        score++;
        await audioEngine.playEffect('tSound');
        currentQ++;
        nextQuestion();
    } else if (!correct.startsWith(typed)) {
        clearInterval(timerInterval);
        isProcessingTimeout = true; // ป้องกัน timeout ทำงาน
        
        btn.classList.add('wrong');
        await audioEngine.playEffect('wrongSound');
        await audioEngine.playEffect('fSound');
        currentQ++;
        nextQuestion();
    }
}

async function endGame() {
    clearInterval(timerInterval);
    audioEngine.stopBGM();

    document.getElementById('game').style.display = 'none';
    document.getElementById('result').style.display = 'block';
    backBtn.style.display = 'block';

    const title = document.getElementById('resultTitle');
    const msg = document.getElementById('resultMsg');
    const scoreDiv = document.getElementById('score');

    let points;
    if (score === 10) {
        title.textContent = "สุดยอดมาก!";
        msg.innerHTML = "ตอบถูกทั้ง 10 ข้อเลย!<br>เก่งสุด ๆ ไปเลยนะ!";
        points = 1000;
        await audioEngine.playEffect('endSound');
    } else {
        if (score >= 8) {
            title.textContent = "เก่งมากเลย!";
            msg.innerHTML = `ตอบถูก ${score} จาก 10 ข้อ<br>เยี่ยมมาก! ใกล้เต็มแล้ว`;
            points = 700;
        } else {
            points = score * 50;
            const encourages = [
                "ไม่เป็นไรนะ ครั้งหน้าต้องเก่งขึ้นแน่!",
                "พยายามเข้าไว้ สู้ ๆ นะจ๊ะ!",
                "เยี่ยมแล้วที่เล่นจนจบ!",
                "ทุกครั้งที่เล่น เราจะเก่งขึ้นนะ",
                "อย่ายอมแพ้นะ เดี๋ยวก็เก่งเอง!"
            ];
            title.textContent = "ไม่เป็นไร สู้ต่อไป!";
            msg.textContent = encourages[Math.floor(Math.random() * encourages.length)];
        }
        await audioEngine.playEffect('end1Sound');
    }
    
    scoreDiv.textContent = points + " คะแนน";
    title.focus();
}

// Event Listeners
document.getElementById('easy').onclick = () => startGameWithTime(40);
document.getElementById('medium').onclick = () => startGameWithTime(25);
document.getElementById('hard').onclick = () => startGameWithTime(15);

document.getElementById('restartBtn').onclick = async () => {
    await audioEngine.playEffect('doorSound');
    document.getElementById('result').style.display = 'none';
    document.getElementById('levelSelect').style.display = 'block';
    backBtn.style.display = 'block';
};

backBtn.onclick = async () => {
    audioEngine.stopBGM();
    await audioEngine.playEffect('doorSound');
    location.href = '../index.html';
};

window.addEventListener('beforeunload', () => audioEngine.stopBGM());

// Load audio on ready
document.addEventListener("DOMContentLoaded", () => {
    for (const k in audioMap) { 
        try { 
            audioMap[k].load(); 
        } catch(e){} 
    }
});
</script>
</body>
</html>