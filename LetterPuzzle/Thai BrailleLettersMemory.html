<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Thai Braille letters memory - อักษรพาซน!</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;800;900&display=swap');
        * { box-sizing: border-box; }
        body {
            margin: 0; font-family: 'Kanit', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh; color: #fff; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }
        .container { width: 100%; max-width: 480px; padding: 15px; position: relative; }
        #backToMenu {
            position: absolute; top: 10px; left: 10px; background: rgba(255,255,255,0.25);
            padding: 8px 20px; border: none; border-radius: 50px; color: white; font-weight: 600;
            font-size: 1rem; cursor: pointer; backdrop-filter: blur(12px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.4); z-index: 1000; transition: all 0.3s;
        }
        #backToMenu:hover { background: rgba(255,255,255,0.4); }
        #levelSelect { text-align: center; }
        h1 { font-size: 2.8rem; margin: 0 0 10px; text-shadow: 0 8px 20px rgba(0,0,0,0.4); }
        .subtitle { font-size: 1.3rem; margin-bottom: 30px; opacity: 0.9; }
        .level-buttons { display: flex; flex-direction: column; gap: 18px; align-items: center; }
        .level-btn {
            width: 80%; max-width: 320px; padding: 20px; font-size: 1.8rem; font-weight: 800;
            border: none; border-radius: 25px; cursor: pointer;
            box-shadow: 0 12px 30px rgba(0,0,0,0.45); transition: all 0.3s;
        }
        .level-btn:hover { transform: translateY(-8px) scale(1.05); }
        #easy { background: #51cf66; }
        #medium { background: #ffd43b; color: #333; }
        #hard { background: #ff6b6b; }
        #game { display: none; text-align: center; }
        .question-heading {
            font-size: 1.9rem; font-weight: 900; margin-bottom: 15px;
            padding: 12px 20px; background: rgba(255,255,255,0.18);
            border-radius: 20px; backdrop-filter: blur(8px);
        }
        .spelling-display {
            font-size: 3.2rem; font-weight: bold; min-height: 70px;
            margin: 20px 0; letter-spacing: 10px; color: #ffd93d;
        }
        .timer { display: none !important; }
        .letters {
            display: grid; grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(3, auto); gap: 14px;
            margin: 30px 10px 20px; aria-live: polite; aria-atomic: false;
        }
        .letter-btn {
            width: 100%; padding: 20px 10px; font-size: 2.2rem; font-weight: bold;
            background: #ffd93d; color: #333; border: none; border-radius: 20px;
            cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.35); transition: all 0.3s;
        }
        .letter-btn:hover { transform: scale(1.12); }
        .letter-btn.wrong { background: #ff6b6b !important; animation: shake 0.5s; }
        @keyframes shake { 0%,100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
        #result { display: none; text-align: center; }
        #result h2 { font-size: 3.5rem; margin: 0 0 20px; }
        #resultMsg { font-size: 1.6rem; line-height: 1.6; margin: 20px 0; }
        #score { font-size: 4.5rem; font-weight: 900; margin: 30px 0; }
        .btn-restart {
            padding: 16px 50px; font-size: 1.7rem; background: #4ecdc4;
            border: none; border-radius: 50px; color: white; cursor: pointer;
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
        }
        .btn-restart:hover { transform: translateY(-6px); }
    </style>
</head>
<body>

<div class="container">
    <button id="backToMenu">กลับเมนูหลัก</button>

    <div id="levelSelect">
        <h1>Thai Braille letters memory - อักษรพาซน!</h1>
        <p class="subtitle">เรียงจุดเบรลล์ อักษรเบรลล์ภาษาไทยให้ถูกต้องตามลำดับ 10 ข้อต่อรอบ<br>เวลาต่อข้อใน ฝึกพื้นฐานเซียน 40 วิ - ระดับเซียน 20 วิ - โหมดยากสุด ปราบเซียน 10 วิ<br>เลือกระดับความยาก แล้วมาสนุกกันเลย</p>
        <div class="level-buttons">
            <button class="level-btn" id="easy">ฝึกพื้นฐานเซียน</button>
            <button class="level-btn" id="medium">ระดับเซียน</button>
            <button class="level-btn" id="hard">ปราบเซียน</button>
        </div>
    </div>

    <div id="game">
        <h2 class="question-heading" id="question" tabindex="-1">ข้อ 1 : ตัวอักษร “เอ (a)” ใช้จุดเบรลล์อะไร</h2>
        <div class="spelling-display" id="spellingDisplay">_ _ _ _ _ _</div>
        <div class="timer"><span id="timer">20</span></div>
        <div class="letters" id="letters" role="region" aria-label="จุดให้เลือก"></div>
    </div>

    <div id="result">
        <h2 id="resultTitle" tabindex="-1">สุดยอดมาก!</h2>
        <div id="resultMsg" style="font-size: 2.4rem; margin: 30px 0; line-height: 1.6;"></div>
        <div id="score">1000 คะแนน</div>
        <button class="btn-restart" id="restartBtn">เริ่มเล่นใหม่</button>
    </div>
</div>

<!-- เสียง (ยังคงไว้เพื่อให้โหลดเป็น AudioBuffer) -->
<audio id="correctSound" src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-reward-952.mp3" preload="auto" crossorigin="anonymous"></audio>
<audio id="wrongSound" src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-946.mp3" preload="auto" crossorigin="anonymous"></audio>
<audio id="bgm" src="audio/b.mp3" preload="auto" crossorigin="anonymous"></audio>
<audio id="doorSound" src="audio/door.mp3" preload="auto" crossorigin="anonymous"></audio>
<audio id="t1Sound" src="audio/t1.mp3" preload="auto" crossorigin="anonymous"></audio>
<audio id="tSound" src="audio/t.mp3" preload="auto" crossorigin="anonymous"></audio>
<audio id="fSound" src="audio/f.mp3" preload="auto" crossorigin="anonymous"></audio>
<audio id="endSound" src="audio/end.mp3" preload="auto" crossorigin="anonymous"></audio>
<audio id="end1Sound" src="audio/end1.mp3" preload="auto" crossorigin="anonymous"></audio>

<script>
// ======== Web Audio API Engine ========
class AudioEngine {
  constructor() {
    this.ctx = null;
    this.buffers = {};
    this.bgmSource = null;
    this.bgmGain = null;
    this.isUnlocked = false;
    this.currentEndPromise = null;
  }

  async init() {
    if (this.ctx) return;
    this.ctx = new (window.AudioContext || window.webkitAudioContext)();

    const audioElements = {
      bgm: document.getElementById("bgm"),
      correctSound: document.getElementById("correctSound"),
      wrongSound: document.getElementById("wrongSound"),
      doorSound: document.getElementById("doorSound"),
      t1Sound: document.getElementById("t1Sound"),
      tSound: document.getElementById("tSound"),
      fSound: document.getElementById("fSound"),
      endSound: document.getElementById("endSound"),
      end1Sound: document.getElementById("end1Sound")
    };

    // โหลดทุกไฟล์เป็น AudioBuffer
    for (const [key, el] of Object.entries(audioElements)) {
      try {
        const response = await fetch(el.src);
        const arrayBuffer = await response.arrayBuffer();
        this.buffers[key] = await this.ctx.decodeAudioData(arrayBuffer);
      } catch (e) {
        console.warn(`ไม่สามารถโหลดเสียง ${key}:`, e);
        this.buffers[key] = null;
      }
    }

    // สร้าง gain สำหรับ BGM
    this.bgmGain = this.ctx.createGain();
    this.bgmGain.connect(this.ctx.destination);
  }

  async unlock() {
    if (this.isUnlocked) return;
    await this.init();
    if (this.ctx.state === 'suspended') {
      await this.ctx.resume();
    }
    this.isUnlocked = true;
  }

  async startBGM() {
    await this.unlock();
    if (this.bgmSource) this.stopBGM();

    const buffer = this.buffers['bgm'];
    if (!buffer) return;

    this.bgmSource = this.ctx.createBufferSource();
    this.bgmSource.buffer = buffer;
    this.bgmSource.loop = true;

    this.bgmGain.gain.setValueAtTime(0.6, this.ctx.currentTime);

    this.bgmSource.connect(this.bgmGain);
    this.bgmSource.start(0);
  }

  stopBGM() {
    if (this.bgmSource) {
      this.bgmSource.stop();
      this.bgmSource = null;
    }
  }

  async playEffect(key) {
    await this.unlock();
    const buffer = this.buffers[key];
    if (!buffer) return Promise.resolve();

    if ((key === 'endSound' || key === 'end1Sound') && this.currentEndPromise) {
      return this.currentEndPromise;
    }

    const source = this.ctx.createBufferSource();
    source.buffer = buffer;

    const gainNode = this.ctx.createGain();
    gainNode.gain.setValueAtTime(0.8, this.ctx.currentTime);
    source.connect(gainNode);
    gainNode.connect(this.ctx.destination);

    const p = new Promise(resolve => {
      source.onended = () => resolve();
      // สำรองกรณีไม่มี onended
      setTimeout(() => resolve(), buffer.duration * 1000 + 100);
    });

    source.start(0);

    if (key === 'endSound' || key === 'end1Sound') {
      this.currentEndPromise = p;
      p.finally(() => { this.currentEndPromise = null; });
    }

    return p;
  }
}

const audioEngine = new AudioEngine();

let hasUserInteracted = false;
async function unlockAudio() {
  if (hasUserInteracted) return;
  hasUserInteracted = true;
  await audioEngine.unlock();
  await audioEngine.startBGM();
}
document.addEventListener("touchstart", unlockAudio, {once: true, passive: true});
document.addEventListener("click", unlockAudio, {once: true});

// คำศัพท์ทั้งหมด (เหมือนเดิม)
const vocab = [
  {th:"กอไก่ <span aria-hidden='true'>(ก)</span>", dots:"1 2 4 5"},
  {th:"ขอไข่ <span aria-hidden='true'>(ข)</span>", dots:"1 3"},
  {th:"คอควาย <span aria-hidden='true'>(ค)</span>", dots:"1 3 6"},
  {th:"ฆอระฆัง <span aria-hidden='true'>(ฆ)</span>", dots:"6 1 3 6"},
  {th:"งองู <span aria-hidden='true'>(ง)</span>", dots:"1 2 4 5 6"},
  {th:"จอจาน <span aria-hidden='true'>(จ)</span>", dots:"2 4 5"},
  {th:"ฉอฉิ่ง <span aria-hidden='true'>(ฉ)</span>", dots:"3 4"},
  {th:"ชอช้าง <span aria-hidden='true'>(ช)</span>", dots:"3 4 6"},
  {th:"ซอโซ่ <span aria-hidden='true'>(ซ)</span>", dots:"2 3 4 6"},
  {th:"ฌอเฌอ <span aria-hidden='true'>(ฌ)</span>", dots:"6 3 4 6"},
  {th:"ญอหญิง <span aria-hidden='true'>(ญ)</span>", dots:"6 1 3 4 5 6"},
  {th:"ฎอชฎา <span aria-hidden='true'>(ฎ)</span>", dots:"6 1 4 5"},
  {th:"ฏอปฏัก <span aria-hidden='true'>(ฏ)</span>", dots:"6 1 2 5 6"},
  {th:"ฐอฐาน <span aria-hidden='true'>(ฐ)</span>", dots:"6 2 3 4 5"},
  {th:"ฑอนามณโฑ <span aria-hidden='true'>(ฑ)</span>", dots:"6 2 3 4 5 6"},
  {th:"ฒอผู้เฒ่า <span aria-hidden='true'>(ฒ)</span>", dots:"3 6 2 3 4 5 6"},
  {th:"ณอเณร <span aria-hidden='true'>(ณ)</span>", dots:"6 1 3 4 5"},
  {th:"ดอเด็ก <span aria-hidden='true'>(ด)</span>", dots:"1 4 5"},
  {th:"ตอเต่า <span aria-hidden='true'>(ต)</span>", dots:"1 2 5 6"},
  {th:"ถอถุง <span aria-hidden='true'>(ถ)</span>", dots:"2 3 4 5"},
  {th:"ทอทหาร <span aria-hidden='true'>(ท)</span>", dots:"2 3 4 5 6"},
  {th:"ธอธง <span aria-hidden='true'>(ธ)</span>", dots:"3 5 6 2 3 4 5 6"},
  {th:"นอหนู <span aria-hidden='true'>(น)</span>", dots:"1 3 4 5"},
  {th:"บอใบไม้ <span aria-hidden='true'>(บ)</span>", dots:"1 2 3 6"},
  {th:"ปอปลา <span aria-hidden='true'>(ป)</span>", dots:"1 2 3 4 6"},
  {th:"ผอผึ้ง <span aria-hidden='true'>(ผ)</span>", dots:"1 2 3 4"},
  {th:"ฝอฝา <span aria-hidden='true'>(ฝ)</span>", dots:"1 3 4 6"},
  {th:"พอพาน <span aria-hidden='true'>(พ)</span>", dots:"1 4 5 6"},
  {th:"ฟอฟัน <span aria-hidden='true'>(ฟ)</span>", dots:"1 2 4 6"},
  {th:"ภอสำเภา <span aria-hidden='true'>(ภ)</span>", dots:"6 1 4 5 6"},
  {th:"มอม้า <span aria-hidden='true'>(ม)</span>", dots:"1 3 4"},
  {th:"ยอยักษ์ <span aria-hidden='true'>(ย)</span>", dots:"1 3 4 5 6"},
  {th:"รอเรือ <span aria-hidden='true'>(ร)</span>", dots:"1 2 3 5"},
  {th:"ลอลิง <span aria-hidden='true'>(ล)</span>", dots:"1 2 3"},
  {th:"วอแหวน <span aria-hidden='true'>(ว)</span>", dots:"2 4 5 6"},
  {th:"ศอศาลา <span aria-hidden='true'>(ศ)</span>", dots:"6 2 3 4"},
  {th:"ษอฤๅษี <span aria-hidden='true'>(ษ)</span>", dots:"3 6 2 3 4"},
  {th:"สอเสือ <span aria-hidden='true'>(ส)</span>", dots:"2 3 4"},
  {th:"หอหีบ <span aria-hidden='true'>(ห)</span>", dots:"1 2 5"},
  {th:"ฬอจุฬา <span aria-hidden='true'>(ฬ)</span>", dots:"6 1 2 3"},
  {th:"อออ่าง <span aria-hidden='true'>(อ)</span>", dots:"1 3 5"},
  {th:"ฮอนกฮูก <span aria-hidden='true'>(ฮ)</span>", dots:"1 2 3 4 5 6"}
];

let currentQuestions = [], currentQ = 0, score = 0, timerInterval, selectedLetters = [], timePerQuestion = 20;
const TOTAL_QUESTIONS = 10;
let isProcessingTimeout = false;
const backBtn = document.getElementById('backToMenu');

function shuffle(array) {
    const arr = [...array];
    for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
}

async function startGameWithTime(seconds) {
    timePerQuestion = seconds;
    document.getElementById('levelSelect').style.display = 'none';
    document.getElementById('game').style.display = 'block';
    backBtn.style.display = 'none';

    await audioEngine.startBGM();

    currentQuestions = shuffle(vocab).slice(0, TOTAL_QUESTIONS);
    currentQ = 0; score = 0;
    nextQuestion();
}

function nextQuestion() {
    if (currentQ >= TOTAL_QUESTIONS) { endGame(); return; }

    isProcessingTimeout = false;
    selectedLetters = [];
    const word = currentQuestions[currentQ];
    document.getElementById('spellingDisplay').textContent = '_ _ _ _ _ _ _ _ _ _ _ _';
    document.getElementById('question').innerHTML = `ข้อ ${currentQ + 1} : ตัวอักษร “${word.th}” ใช้จุดเบรลล์อะไร`;
    document.getElementById('question').focus();

    clearInterval(timerInterval);

    const allDots = ['1','2','3','4','5','6'];
    const lettersDiv = document.getElementById('letters');
    lettersDiv.innerHTML = '';

    const positions = {
        '1': {row: 1, col: 1},
        '2': {row: 2, col: 1},
        '3': {row: 3, col: 1},
        '4': {row: 1, col: 2},
        '5': {row: 2, col: 2},
        '6': {row: 3, col: 2}
    };

    requestAnimationFrame(() => {
        setTimeout(() => {
            allDots.forEach(dot => {
                const btn = document.createElement('button');
                btn.className = 'letter-btn';
                btn.textContent = dot;
                btn.dataset.letter = dot;
                btn.setAttribute('role', 'button');
                btn.setAttribute('aria-label', 'จุด ' + dot);
                btn.style.gridRow = positions[dot].row;
                btn.style.gridColumn = positions[dot].col;
                btn.onclick = () => selectLetter(btn, dot);
                lettersDiv.appendChild(btn);
            });
        }, 50);
    });

    let timeLeft = timePerQuestion;
    document.getElementById('timer').textContent = timeLeft;
    timerInterval = setInterval(() => {
        timeLeft--;
        document.getElementById('timer').textContent = timeLeft;
        if (timeLeft <= 0 && !isProcessingTimeout) {
            isProcessingTimeout = true;
            clearInterval(timerInterval);
            audioEngine.playEffect('wrongSound');
            audioEngine.playEffect('fSound').then(() => { currentQ++; nextQuestion(); });
        }
    }, 1000);
}

async function selectLetter(btn, dot) {
    const word = currentQuestions[currentQ];
    const correctDots = word.dots.trim().split(/\s+/).filter(d => d);

    const expectedDot = correctDots[selectedLetters.length];

    if (dot !== expectedDot) {
        clearInterval(timerInterval);
        isProcessingTimeout = true;
        btn.classList.add('wrong');
        setTimeout(() => btn.classList.remove('wrong'), 600);
        await audioEngine.playEffect('wrongSound');
        await audioEngine.playEffect('fSound');
        currentQ++;
        nextQuestion();
        return;
    }

    selectedLetters.push(dot);

    const displayText = selectedLetters.join(' ') + (selectedLetters.length < correctDots.length ? ' _ _ _ _ _ _ _ _ _ _ _ _'.substring(selectedLetters.join(' ').length) : '');
    document.getElementById('spellingDisplay').textContent = displayText;

    await audioEngine.playEffect('t1Sound');

    if (selectedLetters.length === correctDots.length) {
        clearInterval(timerInterval);
        isProcessingTimeout = true;
        await audioEngine.playEffect('correctSound');
        score++;
        await audioEngine.playEffect('tSound');
        currentQ++;
        nextQuestion();
    }
}

async function endGame() {
    clearInterval(timerInterval);
    audioEngine.stopBGM();
    document.getElementById('game').style.display = 'none';
    document.getElementById('result').style.display = 'block';
    backBtn.style.display = 'block';
    const title = document.getElementById('resultTitle');
    const msg = document.getElementById('resultMsg');
    const scoreDiv = document.getElementById('score');
    let points;
    if (score === TOTAL_QUESTIONS) {
        title.textContent = "สุดยอดมาก!";
        msg.innerHTML = `ตอบถูกทั้ง ${TOTAL_QUESTIONS} ข้อเลย!<br>เก่งสุด ๆ ไปเลยนะ!`;
        points = 1000;
        await audioEngine.playEffect('endSound');
    } else {
        if (score >= Math.max(1, Math.floor(TOTAL_QUESTIONS * 0.8))) {
            title.textContent = "เก่งมากเลย!";
            msg.innerHTML = `ตอบถูก ${score} จาก ${TOTAL_QUESTIONS} ข้อ<br>เยี่ยมมาก! ใกล้เต็มแล้ว`;
            points = 700;
        } else {
            points = score * 50;
            const encourages = [
              "ไม่เป็นไรนะ ครั้งหน้าต้องเก่งขึ้นแน่!",
              "พยายามเข้าไว้ สู้ ๆ นะจ๊ะ!",
              "เยี่ยมแล้วที่เล่นจนจบ!",
              "ทุกครั้งที่เล่น เราจะเก่งขึ้นนะ",
              "อย่ายอมแพ้นะ เดี๋ยวก็เก่งเอง!"
            ];
            title.textContent = "ไม่เป็นไร สู้ต่อไป!";
            msg.textContent = encourages[Math.floor(Math.random() * encourages.length)];
        }
        await audioEngine.playEffect('end1Sound');
    }
    scoreDiv.textContent = points + " คะแนน";
    setTimeout(() => {
      try { title.focus(); } catch(e) {}
    }, 50);
}

document.getElementById('easy').onclick = () => startGameWithTime(40);
document.getElementById('medium').onclick = () => startGameWithTime(20);
document.getElementById('hard').onclick = () => startGameWithTime(10);

document.getElementById('restartBtn').onclick = async () => {
    await audioEngine.playEffect('doorSound');
    document.getElementById('result').style.display = 'none';
    document.getElementById('levelSelect').style.display = 'block';
    backBtn.style.display = 'block';
};

backBtn.onclick = async () => {
    audioEngine.stopBGM();
    await audioEngine.playEffect('doorSound');
    location.href = '../index.html';
};

window.addEventListener('beforeunload', () => audioEngine.stopBGM());
</script>
</body>
</html>