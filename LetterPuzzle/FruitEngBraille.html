<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>What is the missing letter?- ‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ! ‡∏´‡∏°‡∏ß‡∏î‡∏ú‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡πÑ‡∏°‡πâ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;800;900&display=swap');
        * { box-sizing: border-box; }
        body {
            margin: 0; font-family: 'Kanit', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh; color: #fff; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }
        .container { width: 100%; max-width: 480px; padding: 15px; position: relative; }
        #backToMenu {
            position: absolute; top: 10px; left: 10px; background: rgba(255,255,255,0.25);
            padding: 8px 20px; border: none; border-radius: 50px; color: white; font-weight: 600;
            font-size: 1rem; cursor: pointer; backdrop-filter: blur(12px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.4); z-index: 1000; transition: all 0.3s;
        }
        #backToMenu:hover { background: rgba(255,255,255,0.4); }
        #levelSelect { text-align: center; }
        h1 { font-size: 2.8rem; margin: 0 0 10px; text-shadow: 0 8px 20px rgba(0,0,0,0.4); }
        .subtitle { font-size: 1.3rem; margin-bottom: 30px; opacity: 0.9; }
        .level-buttons { display: flex; flex-direction: column; gap: 18px; align-items: center; }
        .level-btn {
            width: 80%; max-width: 320px; padding: 20px; font-size: 1.8rem; font-weight: 800;
            border: none; border-radius: 25px; cursor: pointer;
            box-shadow: 0 12px 30px rgba(0,0,0,0.45); transition: all 0.3s;
        }
        .level-btn:hover { transform: translateY(-8px) scale(1.05); }
        #easy { background: #51cf66; }
        #medium { background: #ffd43b; color: #333; }
        #hard { background: #ff6b6b; }
        #game { display: none; text-align: center; }
        .question-heading {
            font-size: 1.9rem; font-weight: 900; margin-bottom: 15px;
            padding: 12px 20px; background: rgba(255,255,255,0.18);
            border-radius: 20px; backdrop-filter: blur(8px);
        }
        .spelling-display {
            font-size: 3.2rem; font-weight: bold; min-height: 70px;
            margin: 20px 0; letter-spacing: 10px; color: #ffd93d;
        }
        .timer { display: none !important; }
        .letters {
            display: grid; grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(3, auto); gap: 14px;
            margin: 30px 10px 20px; aria-live: polite; aria-atomic: false;
        }
        .letter-btn {
            width: 100%; padding: 20px 10px; font-size: 2.2rem; font-weight: bold;
            background: #ffd93d; color: #333; border: none; border-radius: 20px;
            cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.35); transition: all 0.3s;
        }
        .letter-btn:hover:not(.used) { transform: scale(1.12); }
        .letter-btn.used {
            background: #999 !important; color: #bbb !important; opacity: 0.7;
            cursor: not-allowed; transform: scale(0.92);
        }
        .letter-btn.wrong { background: #ff6b6b !important; animation: shake 0.5s; }
        @keyframes shake { 0%,100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
        #result { display: none; text-align: center; }
        #result h2 { font-size: 3.5rem; margin: 0 0 20px; }
        #resultMsg { font-size: 1.6rem; line-height: 1.6; margin: 20px 0; }
        #score { font-size: 4.5rem; font-weight: 900; margin: 30px 0; }
        .btn-restart {
            padding: 16px 50px; font-size: 1.7rem; background: #4ecdc4;
            border: none; border-radius: 50px; color: white; cursor: pointer;
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
        }
        .btn-restart:hover { transform: translateY(-6px); }
    </style>
</head>
<body>

<div class="container">
    <button id="backToMenu">‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</button>

    <div id="levelSelect">
        <h1>What is the missing letter?- ‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ! ‡∏´‡∏°‡∏ß‡∏î‡∏ú‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡πÑ‡∏°‡πâ</h1>
        <p class="subtitle">‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ ‡∏Ñ‡∏∑‡∏≠‡∏ï‡∏±‡∏ß‡∏≠‡∏∞‡πÑ‡∏£? ‡∏£‡∏π‡πâ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÄ‡∏ö‡∏£‡∏•‡∏•‡πå‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©<br>‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡πÉ‡∏ô ‡∏ù‡∏∂‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÄ‡∏ã‡∏µ‡∏¢‡∏ô 40 ‡∏ß‡∏¥ - ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏ã‡∏µ‡∏¢‡∏ô 20 ‡∏ß‡∏¥ - ‡πÇ‡∏´‡∏°‡∏î‡∏¢‡∏≤‡∏Å‡∏™‡∏∏‡∏î ‡∏õ‡∏£‡∏≤‡∏ö‡πÄ‡∏ã‡∏µ‡∏¢‡∏ô 10 ‡∏ß‡∏¥<br>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏Å ‡πÅ‡∏•‡πâ‡∏ß‡∏°‡∏≤‡∏™‡∏ô‡∏∏‡∏Å‡∏Å‡∏±‡∏ô‡πÄ‡∏•‡∏¢</p>
        <div class="level-buttons">
            <button class="level-btn" id="easy">‡∏ù‡∏∂‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÄ‡∏ã‡∏µ‡∏¢‡∏ô</button>
            <button class="level-btn" id="medium">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏ã‡∏µ‡∏¢‡∏ô</button>
            <button class="level-btn" id="hard">‡∏õ‡∏£‡∏≤‡∏ö‡πÄ‡∏ã‡∏µ‡∏¢‡∏ô</button>
        </div>
    </div>

    <div id="game">
        <h2 class="question-heading" id="question" tabindex="-1">‡∏Ç‡πâ‡∏≠ 1 : ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ ‚Äú‡πÄ‡∏≠ (a)‚Äù ‡πÉ‡∏ä‡πâ‡∏à‡∏∏‡∏î‡πÄ‡∏ö‡∏£‡∏•‡∏•‡πå‡∏≠‡∏∞‡πÑ‡∏£</h2>
        <div class="spelling-display" id="spellingDisplay">_ _ _ _ _ _</div>
        <div class="timer"><span id="timer">20</span></div>
        <div class="letters" id="letters" role="region" aria-label="‡∏à‡∏∏‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å"></div>
    </div>

    <div id="result">
        <h2 id="resultTitle" tabindex="-1">‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î‡∏°‡∏≤‡∏Å!</h2>
        <div id="resultMsg" style="font-size: 2.4rem; margin: 30px 0; line-height: 1.6;"></div>
        <div id="score">1000 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
        <button class="btn-restart" id="restartBtn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
    </div>
</div>

<script>
// ======== Web Audio API Engine ========
class AudioEngine {
  constructor() {
    this.ctx = null;
    this.isUnlocked = false;
    this.bgmSource = null;
    this.bgmGain = null;
    this.bgmBuffer = null;
    this.currentEndPromise = null;

    this.sounds = {
      correctSound: "https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-reward-952.mp3",
      wrongSound: "https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-946.mp3",
      bgm: "audio/b2.mp3",
      doorSound: "audio/door.mp3",
      t1Sound: "audio/t1.mp3",
      tSound: "audio/t.mp3",
      fSound: "audio/f.mp3",
      endSound: "audio/end.mp3",
      end1Sound: "audio/end1.mp3"
    };

    this.buffers = {};
  }

  async initContext() {
    if (this.ctx) return;
    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
    await this.loadAllBuffers();
  }

  async loadAllBuffers() {
    const promises = Object.entries(this.sounds).map(async ([key, url]) => {
      try {
        const response = await fetch(url);
        const arrayBuffer = await response.arrayBuffer();
        const audioBuffer = await this.ctx.decodeAudioData(arrayBuffer);
        this.buffers[key] = audioBuffer;
      } catch (e) {
        console.warn(`Failed to load sound: ${key} - ${url}`, e);
      }
    });
    await Promise.all(promises);
  }

  async unlockAll() {
    if (this.isUnlocked) return;
    await this.initContext();
    const source = this.ctx.createBufferSource();
    source.buffer = this.ctx.createBuffer(1, 1, 22050);
    source.connect(this.ctx.destination);
    source.start(0);
    this.isUnlocked = true;
  }

  async startBGM() {
    if (!this.buffers.bgm || this.bgmSource) return;
    await this.unlockAll();

    this.bgmSource = this.ctx.createBufferSource();
    this.bgmSource.buffer = this.buffers.bgm;
    this.bgmSource.loop = true;

    this.bgmGain = this.ctx.createGain();
    this.bgmGain.gain.value = 0.6;

    this.bgmSource.connect(this.bgmGain);
    this.bgmGain.connect(this.ctx.destination);

    this.bgmSource.start(0);
  }

  stopBGM() {
    if (this.bgmSource) {
      this.bgmSource.stop();
      this.bgmSource = null;
      this.bgmGain = null;
    }
  }

  async playEffect(key) {
    if (!this.buffers[key]) return;
    await this.unlockAll();

    if ((key === 'endSound' || key === 'end1Sound') && this.currentEndPromise) {
      return this.currentEndPromise;
    }

    const source = this.ctx.createBufferSource();
    source.buffer = this.buffers[key];

    const gainNode = this.ctx.createGain();
    gainNode.gain.value = key.includes('end') || key === 'bgm' ? 0.8 : 0.8;

    source.connect(gainNode);
    gainNode.connect(this.ctx.destination);

    const p = new Promise(resolve => {
      source.onended = () => resolve();
      setTimeout(resolve, 4000);
    });

    source.start(0);

    if (key === 'endSound' || key === 'end1Sound') {
      this.currentEndPromise = p;
      p.finally(() => { this.currentEndPromise = null; });
    }

    return p;
  }
}

const audioEngine = new AudioEngine();

let hasUserInteracted = false;
async function unlockAudio(){
  if (hasUserInteracted) return;
  hasUserInteracted = true;
  await audioEngine.unlockAll();
  await audioEngine.startBGM();
}
document.addEventListener("touchstart", unlockAudio, {once:true, passive:true});
document.addEventListener("click", unlockAudio, {once:true});

// ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
const vocab = [
    {th:"A P P _ E ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡πÅ‡∏≠‡∏õ‡πÄ‡∏õ‡∏¥‡∏•", dots:"1 2 3"},
    {th:"B A N A N _ ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏Å‡∏•‡πâ‡∏ß‡∏¢", dots:"1"},
    {th:"O R A N G _ ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏™‡πâ‡∏°", dots:"1 5"},
    {th:"G R A _ E ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏≠‡∏á‡∏∏‡πà‡∏ô", dots:"1 2 3 4"},
    {th:"_ A N G O ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á", dots:"1 3 4"},
    {th:"P _ N E A P P L E ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏™‡∏±‡∏õ‡∏õ‡∏∞‡∏£‡∏î", dots:"2 4"},
    {th:"W A T E R M E L _ N ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡πÅ‡∏ï‡∏á‡πÇ‡∏°", dots:"1 3 5"},
    {th:"P A P A _ A ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏°‡∏∞‡∏•‡∏∞‡∏Å‡∏≠", dots:"1 3 4 5 6"},
    {th:"_ T R A W B E R R Y ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏™‡∏ï‡∏£‡∏≠‡∏ß‡πå‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ", dots:"2 3 4"},
    {th:"C O C O N U _ ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏°‡∏∞‡∏û‡∏£‡πâ‡∏≤‡∏ß", dots:"2 3 4 5"},
    {th:"_ U R I A N ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏ó‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", dots:"1 4 5"},
    {th:"R A M _ U T A N ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡πÄ‡∏á‡∏≤‡∏∞", dots:"1 2"},
    {th:"M A N _ O S T E E N ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏°‡∏±‡∏á‡∏Ñ‡∏∏‡∏î", dots:"1 2 4 5"},
    {th:"G U A _ A ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏ù‡∏£‡∏±‡πà‡∏á", dots:"1 2 3 6"},
    {th:"_ O M E L O ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏™‡πâ‡∏°‡πÇ‡∏≠", dots:"1 2 3 4"},
    {th:"L Y _ H E E ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏•‡∏¥‡πâ‡∏ô‡∏à‡∏µ‡πà", dots:"1 4"},
    {th:"_ O N G A N ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏•‡∏≥‡πÑ‡∏¢", dots:"1 2 3"},
    {th:"_ O S E A P P L E ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏ä‡∏°‡∏û‡∏π‡πà", dots:"1 2 3 5"},
    {th:"D R A G O N _ R U I T ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡πÅ‡∏Å‡πâ‡∏ß‡∏°‡∏±‡∏á‡∏Å‡∏£", dots:"1 2 4"},
    {th:"A V O C A D _ ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏≠‡∏∞‡πÇ‡∏ß‡∏Ñ‡∏≤‡πÇ‡∏î", dots:"1 3 5"},
    {th:"P E _ R ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏•‡∏π‡∏Å‡πÅ‡∏û‡∏£‡πå", dots:"1"},
    {th:"P E A C _ ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏•‡∏π‡∏Å‡∏û‡∏µ‡∏ä", dots:"1 2 5"},
    {th:"C H E R _ Y ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡πÄ‡∏ä‡∏≠‡∏£‡πå‡∏£‡∏µ‡πà", dots:"1 2 3 5"},
    {th:"_ I W I ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏Å‡∏µ‡∏ß‡∏µ‡πà", dots:"1 3"},
    {th:"_ L U E B E R R Y ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏ö‡∏•‡∏π‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ‡πà", dots:"1 2"},
    {th:"C A B B A _ E ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏Å‡∏∞‡∏´‡∏•‡πà‡∏≥‡∏õ‡∏•‡∏µ", dots:"1 2 4 5"},
    {th:"_ A R R O T ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡πÅ‡∏Ñ‡∏£‡∏≠‡∏ó", dots:"1 4"},
    {th:"T _ M A T O ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡πÄ‡∏ó‡∏®", dots:"1 3 5"},
    {th:"_ O T A T O ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏°‡∏±‡∏ô‡∏ù‡∏£‡∏±‡πà‡∏á", dots:"1 2 3 4"},
    {th:"O N _ O N ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏´‡∏≠‡∏°‡∏´‡∏±‡∏ß‡πÉ‡∏´‡∏ç‡πà", dots:"2 4"},
    {th:"_ A R L I C ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏Å‡∏£‡∏∞‡πÄ‡∏ó‡∏µ‡∏¢‡∏°", dots:"1 2 4 5"},
    {th:"_ H I L I ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏û‡∏£‡∏¥‡∏Å", dots:"1 4"},
    {th:"C U C U M B E _ ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡πÅ‡∏ï‡∏á‡∏Å‡∏ß‡∏≤", dots:"1 2 3 5"},
    {th:"P U _ P K I N ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏ü‡∏±‡∏Å‡∏ó‡∏≠‡∏á", dots:"1 3 4"},
    {th:"B R _ C C O L I ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏ö‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡∏•‡∏µ", dots:"1 3 5"},
    {th:"_ P I N A C H ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏ú‡∏±‡∏Å‡πÇ‡∏Ç‡∏°", dots:"2 3 4"},
    {th:"L E T T U C _ ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏ú‡∏±‡∏Å‡∏Å‡∏≤‡∏î‡∏´‡∏≠‡∏°", dots:"1 5"},
    {th:"_ U S H R O O M ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡πÄ‡∏´‡πá‡∏î", dots:"1 3 4"},
    {th:"_ O R N ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≤‡∏ß‡πÇ‡∏û‡∏î", dots:"1 4"},
    {th:"E _ G P L A N T ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏°‡∏∞‡πÄ‡∏Ç‡∏∑‡∏≠‡∏¢‡∏≤‡∏ß", dots:"1 2 4 5"},
    {th:"C E L E R _ ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡∏â‡πà‡∏≤‡∏¢", dots:"1 3 4 5 6"},
    {th:"C O R I A N _ E R ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏ú‡∏±‡∏Å‡∏ä‡∏µ", dots:"1 4 5"},
    {th:"_ P R I N G O N I O N ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏ô‡∏´‡∏≠‡∏°", dots:"2 3 4"},
    {th:"_ S P A R A G U S ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏´‡∏ô‡πà‡∏≠‡πÑ‡∏°‡πâ‡∏ù‡∏£‡∏±‡πà‡∏á", dots:"1"},
    {th:"C A U L I F L O _ E R ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏Å‡∏∞‡∏´‡∏•‡πà‡∏≥‡∏î‡∏≠‡∏Å", dots:"2 4 5 6"},
    {th:"_ E L L P E P P E R ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏û‡∏£‡∏¥‡∏Å‡∏´‡∏¢‡∏ß‡∏Å", dots:"1 2"},
    {th:"R A _ I S H ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏´‡∏±‡∏ß‡πÑ‡∏ä‡πÄ‡∏ó‡πâ‡∏≤", dots:"1 4 5"},
    {th:"B _ E T R O O T ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏ö‡∏µ‡∏ï‡∏£‡∏π‡∏ï", dots:"1 5"},
    {th:"O _ R A ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏Å‡∏£‡∏∞‡πÄ‡∏à‡∏µ‡πä‡∏¢‡∏ö‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß", dots:"1 3"},
    {th:"_ I N G E R ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏Ç‡∏¥‡∏á", dots:"1 2 4 5"}
]

let currentQuestions = [], currentQ = 0, correctCount = 0, timerInterval, selectedLetters = [], timePerQuestion = 20;
let totalQuestions = 10; // ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö
let isProcessingTimeout = false;
const backBtn = document.getElementById('backToMenu');

function shuffle(array) {
    const arr = [...array];
    for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
}

async function startGameWithTime(seconds, numQuestions) {
    timePerQuestion = seconds;
    totalQuestions = numQuestions;
    document.getElementById('levelSelect').style.display = 'none';
    document.getElementById('game').style.display = 'block';
    backBtn.style.display = 'none';

    await audioEngine.startBGM();

    currentQuestions = shuffle(vocab).slice(0, totalQuestions);
    currentQ = 0; correctCount = 0;
    nextQuestion();
}

function nextQuestion() {
    if (currentQ >= totalQuestions) { endGame(); return; }

    isProcessingTimeout = false;
    selectedLetters = [];
    const word = currentQuestions[currentQ];
    document.getElementById('spellingDisplay').textContent = '_ _ _ _ _ _';
    document.getElementById('question').innerHTML = `‡∏Ç‡πâ‡∏≠ ${currentQ + 1} : ‚Äú${word.th}‚Äù ‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ ‡πÉ‡∏ä‡πâ‡∏à‡∏∏‡∏î‡πÄ‡∏ö‡∏£‡∏•‡∏•‡πå‡∏≠‡∏∞‡πÑ‡∏£`;
    document.getElementById('question').focus();

    clearInterval(timerInterval);

    const allDots = ['1','2','3','4','5','6'];
    const lettersDiv = document.getElementById('letters');
    lettersDiv.innerHTML = '';

    const positions = {
        '1': {row: 1, col: 1},
        '2': {row: 2, col: 1},
        '3': {row: 3, col: 1},
        '4': {row: 1, col: 2},
        '5': {row: 2, col: 2},
        '6': {row: 3, col: 2}
    };

    requestAnimationFrame(() => {
        setTimeout(() => {
            allDots.forEach(dot => {
                const btn = document.createElement('button');
                btn.className = 'letter-btn';
                btn.textContent = dot;
                btn.dataset.letter = dot;
                btn.setAttribute('role', 'button');
                btn.setAttribute('aria-label', '‡∏à‡∏∏‡∏î ' + dot);
                btn.style.gridRow = positions[dot].row;
                btn.style.gridColumn = positions[dot].col;
                btn.onclick = () => selectLetter(btn, dot, word.dots);
                lettersDiv.appendChild(btn);
            });
        }, 50);
    });

    let timeLeft = timePerQuestion;
    document.getElementById('timer').textContent = timeLeft;
    timerInterval = setInterval(() => {
        timeLeft--;
        document.getElementById('timer').textContent = timeLeft;
        if (timeLeft <= 0 && !isProcessingTimeout) {
            isProcessingTimeout = true;
            clearInterval(timerInterval);
            audioEngine.playEffect('wrongSound');
            audioEngine.playEffect('fSound').then(() => { currentQ++; nextQuestion(); });
        }
    }, 1000);
}

async function selectLetter(bt, dot, correctDotsStr) {
    if (bt.classList.contains('used') || bt.classList.contains('wrong')) return;

    const correctDots = correctDotsStr.trim().split(/\s+/);

    if (selectedLetters.length >= correctDots.length || correctDots[selectedLetters.length] !== dot) {
        clearInterval(timerInterval); isProcessingTimeout = true;
        bt.classList.add('wrong');
        await audioEngine.playEffect('wrongSound');
        await audioEngine.playEffect('fSound');
        currentQ++; nextQuestion();
        return;
    }

    selectedLetters.push(dot);
    bt.classList.add('used');
    bt.setAttribute('aria-pressed', 'true');
    bt.setAttribute('aria-label', '‡∏à‡∏∏‡∏î ' + dot + ' ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß');

    document.getElementById('spellingDisplay').textContent = selectedLetters.join(' ') || '_ _ _ _ _ _';

    if (selectedLetters.length < correctDots.length) {
        await audioEngine.playEffect('t1Sound');
    } else {
        clearInterval(timerInterval); isProcessingTimeout = true;
        await audioEngine.playEffect('correctSound');
        correctCount++;
        await audioEngine.playEffect('tSound');
        currentQ++; nextQuestion();
    }
}

async function endGame() {
    clearInterval(timerInterval);
    audioEngine.stopBGM();
    document.getElementById('game').style.display = 'none';
    document.getElementById('result').style.display = 'block';
    backBtn.style.display = 'block';
    const title = document.getElementById('resultTitle');
    const msg = document.getElementById('resultMsg');
    const scoreDiv = document.getElementById('score');

    const totalScore = correctCount * 100;

    if (correctCount === totalQuestions) {
        title.textContent = "‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î‡πÑ‡∏õ‡πÄ‡∏•‡∏¢!";
        msg.innerHTML = `‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å‡∏ó‡∏±‡πâ‡∏á ${totalQuestions} ‡∏Ç‡πâ‡∏≠!<br>‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å ‡πÜ ‡πÄ‡∏•‡∏¢ ‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏£‡∏≠‡∏ö‡∏°‡∏±‡πâ‡∏¢‡∏ô‡∏∞? üíï`;
        await audioEngine.playEffect('endSound');
    } else if (correctCount >= Math.ceil(totalQuestions * 0.8)) {
        title.textContent = "‡πÄ‡∏Å‡πà‡∏á‡∏™‡∏∏‡∏î ‡πÜ!";
        msg.innerHTML = `‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å ${correctCount} ‡∏à‡∏≤‡∏Å ${totalQuestions} ‡∏Ç‡πâ‡∏≠<br>‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ‡∏à‡∏∞‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô! üåü`;
        await audioEngine.playEffect('endSound');
    } else {
        title.textContent = "‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏£‡∏ô‡∏∞!";
        const encourages = [
            "‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÅ‡∏ô‡πà ‡πÜ ‡∏™‡∏π‡πâ ‡πÜ ‡∏ô‡∏∞! üêæ",
            "‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏ô‡∏∏‡∏Å‡∏°‡∏≤‡∏Å‡πÄ‡∏•‡∏¢ ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏à‡∏∞‡πÄ‡∏Å‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô‡∏à‡πâ‡∏≤ üí™",
            "‡πÄ‡∏Å‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô‡∏ô‡∏∞ ‡∏°‡∏≤‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ‡∏™‡∏¥! üòä",
            "‡∏≠‡∏¢‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏ó‡πâ‡∏≠ ‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î‡∏à‡∏∞‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡πÅ‡∏ô‡πà‡πÄ‡∏•‡∏¢! ‚ú®",
            "‡∏¢‡∏¥‡πâ‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ß‡πâ ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô! ‚ù§Ô∏è"
        ];
        msg.textContent = encourages[Math.floor(Math.random() * encourages.length)];
        await audioEngine.playEffect('end1Sound');
    }

    scoreDiv.textContent = totalScore + " ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô";
    setTimeout(() => {
      try { title.focus(); } catch(e) {}
    }, 50);
}

document.getElementById('easy').onclick = () => startGameWithTime(40, 5);
document.getElementById('medium').onclick = () => startGameWithTime(20, 7);
document.getElementById('hard').onclick = () => startGameWithTime(10, 10);

document.getElementById('restartBtn').onclick = async () => {
    await audioEngine.playEffect('doorSound');
    document.getElementById('result').style.display = 'none';
    document.getElementById('levelSelect').style.display = 'block';
    backBtn.style.display = 'block';
};

backBtn.onclick = async () => {
    audioEngine.stopBGM();
    await audioEngine.playEffect('doorSound');
    location.href = '../index.html';
};

window.addEventListener('beforeunload', () => audioEngine.stopBGM());
</script>
</body>
</html>