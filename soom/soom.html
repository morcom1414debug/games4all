<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>โปรแกรมสุ่มตัวเลข</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; }
    .container { max-width:95%; margin:auto; min-height:100vh; display:flex; align-items:center; justify-content:center; padding:1rem 0; position:relative; }
    .card { background:#fff; padding:1.5rem; border-radius:1.5rem; box-shadow:0 10px 15px rgba(0,0,0,0.07); width:100%; max-width:600px; }
    .btn { padding:1rem 1.5rem; border-radius:9999px; font-weight:700; transition:all .2s ease; }
    .btn:disabled { background:#d1d5db; color:#9ca3af; cursor:not-allowed; }
    .result-display { font-size:8rem; font-weight:700; color:#3b82f6; text-shadow:2px 2px 4px rgba(0,0,0,0.08); outline:none; }
    @media(min-width:768px){ .result-display{ font-size:12rem; } }
    .list-group{ max-height:200px; overflow-y:auto; padding:.5rem; border-radius:.75rem; background:#f9fafb; }
    .error-message{ color:#b91c1c; background:#fee2e2; padding:.75rem; border-radius:.5rem; margin-top:1rem; text-align:center; }
  </style>
</head>
<body class="bg-gray-100">
  <div class="container">
    <button type="button" onclick="window.location.href='../index.html'" class="absolute top-4 left-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow">กลับเมนูหลัก</button>

    <div id="main-menu" class="card text-center">
      <h1 class="text-3xl font-bold mb-6 text-gray-800">โปรแกรมสุ่มตัวเลข</h1>
      <p class="text-gray-500 mb-8">เลือกโหมดการสุ่มที่ต้องการ</p>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <button id="mode-1" type="button" class="btn bg-blue-500 text-white">สุ่มตัวเลข 1 ถึง 99</button>
        <button id="mode-2" type="button" class="btn bg-green-500 text-white">สุ่มตัวเลขจากเลขไหนถึงเลขไหน</button>
        <button id="mode-3" type="button" class="btn bg-purple-500 text-white">สุ่มตัวเลขตามประสงค์</button>
      </div>
    </div>

    <!-- mode1 -->
    <div id="mode-1-page" class="card hidden text-center">
      <h2 class="text-2xl font-bold mb-4">สุ่มตัวเลข 1 ถึง 99</h2>
      <div class="h-48 flex items-center justify-center bg-blue-50 border-4 border-dashed border-blue-200 rounded-2xl">
        <span id="result-1" class="result-display" tabindex="-1" role="status" aria-live="polite">?</span>
      </div>
      <button id="start-1" type="button" class="btn bg-blue-500 text-white w-full mt-4">เริ่มสุ่มทันที</button>
      <button id="reset-1" type="button" class="btn bg-gray-400 text-white w-full mt-2 hidden">สุ่มใหม่</button>
      <div class="mt-4 text-left">
        <h3 class="font-bold text-gray-600 mb-2">ประวัติการสุ่ม:</h3>
        <div id="history-1" class="list-group text-gray-600 flex flex-wrap"></div>
      </div>
      <button id="back-1" type="button" class="btn bg-gray-300 text-gray-800 w-full mt-4">เลือกโหมดสุ่มใหม่</button>
    </div>

    <!-- mode2 -->
    <div id="mode-2-page" class="card hidden text-center">
      <h2 class="text-2xl font-bold mb-4">สุ่มตัวเลขจากเลขไหนถึงเลขไหน</h2>
      <input id="start-num" type="number" class="spin w-full mb-2 text-center border rounded" placeholder="เลขเริ่มต้น ตั้งแต่ 1 ถึง 999" min="1" max="999" inputmode="numeric" pattern="[0-9]*">
      <input id="end-num" type="number" class="spin w-full mb-2 text-center border rounded" placeholder="เลขสุดท้าย ตั้งแต่ 1 ถึง 999" min="1" max="999" inputmode="numeric" pattern="[0-9]*">
      <div id="error-2" class="error-message hidden" tabindex="-1"></div>
      <div class="h-48 flex items-center justify-center bg-green-50 border-4 border-dashed border-green-200 rounded-2xl">
        <span id="result-2" class="result-display text-green-500" tabindex="-1" role="status" aria-live="polite">?</span>
      </div>
      <button id="start-2" type="button" class="btn bg-green-500 text-white w-full mt-4">เริ่มสุ่มทันที</button>
      <button id="reset-2" type="button" class="btn bg-gray-400 text-white w-full mt-2 hidden">สุ่มใหม่</button>
      <div class="mt-4 text-left">
        <h3 class="font-bold text-gray-600 mb-2">ประวัติการสุ่ม:</h3>
        <div id="history-2" class="list-group text-gray-600 flex flex-wrap"></div>
      </div>
      <button id="back-2" type="button" class="btn bg-gray-300 text-gray-800 w-full mt-4">เลือกโหมดสุ่มใหม่</button>
    </div>

    <!-- mode3 -->
    <div id="mode-3-page" class="card hidden text-center">
      <h2 class="text-2xl font-bold mb-4">สุ่มตัวเลขตามประสงค์</h2>
      <input type="number" class="custom-num spin w-full mb-2 text-center border rounded" placeholder="ตัวเลขที่ 1 ตั้งแต่ 1 ถึง 999" min="1" max="999" inputmode="numeric" pattern="[0-9]*">
      <input type="number" class="custom-num spin w-full mb-2 text-center border rounded" placeholder="ตัวเลขที่ 2 ตั้งแต่ 1 ถึง 999" min="1" max="999" inputmode="numeric" pattern="[0-9]*">
      <div id="error-3" class="error-message hidden" tabindex="-1"></div>
      <button id="add-input-3" type="button" class="btn bg-gray-200 text-gray-800 w-full mb-2">เพิ่มช่องใส่ตัวเลข</button>
      <div class="h-48 flex items-center justify-center bg-purple-50 border-4 border-dashed border-purple-200 rounded-2xl">
        <span id="result-3" class="result-display text-purple-500" tabindex="-1" role="status" aria-live="polite">?</span>
      </div>
      <button id="start-3" type="button" class="btn bg-purple-500 text-white w-full mt-4">เริ่มสุ่มทันที</button>
      <button id="reset-3" type="button" class="btn bg-gray-400 text-white w-full mt-2 hidden">สุ่มใหม่</button>
      <div class="mt-4 text-left">
        <h3 class="font-bold text-gray-600 mb-2">ประวัติการสุ่ม:</h3>
        <div id="history-3" class="list-group text-gray-600 flex flex-wrap"></div>
      </div>
      <button id="back-3" type="button" class="btn bg-gray-300 text-gray-800 w-full mt-4">เลือกโหมดสุ่มใหม่</button>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  try {
    // โหลดเสียง
    const sounds = {
      a1: new Audio('audio/01.mp3'),
      a2: new Audio('audio/02.mp3')
    };
    Object.values(sounds).forEach(a => { a.preload = 'auto'; try { a.load(); } catch(e) { console.warn('audio load err', e); } });

    const playAudio = (audio) => {
      if(!audio) return;
      audio.currentTime = 0;
      const p = audio.play();
      if(p && p.catch) p.catch(e => console.warn('play blocked', e));
    };

    // helper: wait until audio 'ended' or fallback timeout
    const waitAudioEndOrTimeout = (audio, timeout=1500) => {
      return new Promise(resolve=>{
        if(!audio) { setTimeout(resolve, 0); return; }
        let done = false;
        const onEnd = () => { if(done) return; done = true; resolve(); };
        audio.addEventListener('ended', onEnd, {once:true});
        // fallback in case 'ended' never fires (blocked or short)
        const to = setTimeout(()=>{ if(done) return; done = true; try{ audio.removeEventListener('ended', onEnd); }catch(e){} resolve(); }, timeout);
      });
    };

    let used = [], custom = [];
    let busy = false;
    const rand = (min,max)=>Math.floor(Math.random()*(max-min+1))+min;

    const updateHistory=(el,num)=>{
      const span = document.createElement('span');
      span.className = 'px-2 py-1 bg-gray-200 rounded-full m-1';
      span.textContent = num;
      el.appendChild(span);
    };
    const clearHistory=(his,res,start,reset)=>{
      his.innerHTML = '';
      res.textContent = '?';
      used = [];
      start.classList.remove('hidden');
      reset.classList.add('hidden');
      start.textContent = start.dataset.defaultText || 'เริ่มสุ่มทันที';
    };

    const showError = (id,msg)=>{
      const el = document.getElementById(id);
      if(!el) return;
      el.textContent = msg;
      el.classList.remove('hidden');
      try { el.focus(); } catch(e){}
    };
    const hideError = (id)=>{
      const el = document.getElementById(id);
      if(!el) return;
      el.classList.add('hidden');
    };

    // ทำให้ randomize เป็น async และรองรับ fallback กรณี audio ไม่เล่น/ไม่ส่ง ended
    const randomize = async (res, his, getListFn, startBtn, resetBtn) => {
      if(busy) return;
      busy = true;
      try {
        res.textContent = '...';
        startBtn.disabled = true;
        startBtn.textContent = 'กำลังสุ่ม...';

        // เล่นเอฟเฟ็กต์เริ่ม
        playAudio(sounds.a1);
        // รอจนเสียง a1 จบหรือ timeout แล้วค่อยแสดงผล
        await waitAudioEndOrTimeout(sounds.a1, 3400); // เพิ่มเวลาเป็น 3.4 วินาที

        const avail = getListFn().filter(n => !used.includes(n));
        if(avail.length === 0){
          alert('หมดตัวเลขแล้ว');
          startBtn.textContent = 'เริ่มสุ่มทันที';
          resetBtn.classList.remove('hidden');
          busy = false;
          startBtn.disabled = false;
          return;
        }
        const result = avail[rand(0, avail.length - 1)];
        used.push(result);
        res.textContent = result;
        updateHistory(his, result);

        // Focus ไปที่ผลลัพธ์
        setTimeout(()=>{ try{ res.focus(); } catch(e){} }, 50);

        startBtn.textContent = 'สุ่มอีกครั้ง';
        resetBtn.classList.remove('hidden');
      } catch (e) {
        console.error('randomize error', e);
      } finally {
        busy = false;
        startBtn.disabled = false;
      }
    };

    const showPage = (id) => {
      ['main-menu','mode-1-page','mode-2-page','mode-3-page'].forEach(pid=>{
        const el = document.getElementById(pid);
        if(el) el.classList.add('hidden');
      });
      const showEl = document.getElementById(id);
      if(showEl) showEl.classList.remove('hidden');
    };

    // ผูกปุ่ม (ใช้ addEventListener)
    document.getElementById('mode-1')?.addEventListener('click', ()=>{
      playAudio(sounds.a2);
      clearHistory(document.getElementById('history-1'), document.getElementById('result-1'), document.getElementById('start-1'), document.getElementById('reset-1'));
      showPage('mode-1-page');
      setTimeout(()=>{ try{ document.getElementById('start-1')?.focus(); } catch(e){} }, 100);
    });
    document.getElementById('mode-2')?.addEventListener('click', ()=>{
      playAudio(sounds.a2);
      clearHistory(document.getElementById('history-2'), document.getElementById('result-2'), document.getElementById('start-2'), document.getElementById('reset-2'));
      showPage('mode-2-page');
    });
    document.getElementById('mode-3')?.addEventListener('click', ()=>{
      playAudio(sounds.a2);
      clearHistory(document.getElementById('history-3'), document.getElementById('result-3'), document.getElementById('start-3'), document.getElementById('reset-3'));
      showPage('mode-3-page');
    });

    // back buttons
    document.getElementById('back-1')?.addEventListener('click', ()=>{
      playAudio(sounds.a2);
      showPage('main-menu');
    });
    document.getElementById('back-2')?.addEventListener('click', ()=>{
      playAudio(sounds.a2);
      showPage('main-menu');
    });
    document.getElementById('back-3')?.addEventListener('click', ()=>{
      playAudio(sounds.a2);
      showPage('main-menu');
    });

    // mode1
    const start1 = document.getElementById('start-1');
    start1.dataset.defaultText = start1.textContent;
    document.getElementById('start-1')?.addEventListener('click', ()=> randomize(
      document.getElementById('result-1'),
      document.getElementById('history-1'),
      ()=> Array.from({length:99}, (_,i)=>i+1),
      document.getElementById('start-1'),
      document.getElementById('reset-1')
    ));
    document.getElementById('reset-1')?.addEventListener('click', ()=>{
      playAudio(sounds.a2);
      clearHistory(document.getElementById('history-1'), document.getElementById('result-1'), document.getElementById('start-1'), document.getElementById('reset-1'));
    });

    // mode2
    const start2 = document.getElementById('start-2');
    start2.dataset.defaultText = start2.textContent;
    document.getElementById('start-2')?.addEventListener('click', ()=>{
      const s = parseInt(document.getElementById('start-num').value);
      const e = parseInt(document.getElementById('end-num').value);
      if(isNaN(s) || isNaN(e) || s > e) { showError('error-2', 'กรุณาใส่ตัวเลขที่ถูกต้อง'); return; }
      hideError('error-2');
      randomize(document.getElementById('result-2'), document.getElementById('history-2'), ()=>Array.from({length:e-s+1}, (_,i)=>s+i), document.getElementById('start-2'), document.getElementById('reset-2'));
    });
    document.getElementById('reset-2')?.addEventListener('click', ()=>{
      playAudio(sounds.a2);
      clearHistory(document.getElementById('history-2'), document.getElementById('result-2'), document.getElementById('start-2'), document.getElementById('reset-2'));
      document.getElementById('start-num').value = '';
      document.getElementById('end-num').value = '';
    });

    // mode3
    document.getElementById('add-input-3')?.addEventListener('click', ()=>{
      const c = document.querySelectorAll('.custom-num').length;
      if(c >= 99) { alert('ใส่ได้สูงสุด 99 ช่อง'); return; }
      const inp = document.createElement('input');
      inp.type = 'number';
      inp.className = 'custom-num spin w-full mb-2 text-center border rounded';
      inp.placeholder = `ตัวเลขที่ ${c+1} ตั้งแต่ 1 ถึง 999`;
      inp.min = 1; inp.max = 999;
      inp.inputmode = 'numeric';
      inp.pattern = '[0-9]*';
      document.getElementById('add-input-3').before(inp);
    });

    const start3 = document.getElementById('start-3');
    start3.dataset.defaultText = start3.textContent;
    document.getElementById('start-3')?.addEventListener('click', ()=>{
      custom = []; let ok = true; let seen = new Set();
      document.querySelectorAll('.custom-num').forEach(inp=>{
        if(inp.value){
          const n = parseInt(inp.value);
          if(isNaN(n) || n < 1 || n > 999 || seen.has(n)) ok = false;
          else { custom.push(n); seen.add(n); }
        }
      });
      if(!ok || custom.length === 0) { showError('error-3', 'กรุณาใส่ตัวเลขที่ถูกต้องและไม่ซ้ำ'); return; }
      hideError('error-3');
      randomize(document.getElementById('result-3'), document.getElementById('history-3'), ()=>custom, document.getElementById('start-3'), document.getElementById('reset-3'));
    });

    document.getElementById('reset-3')?.addEventListener('click', ()=>{
      playAudio(sounds.a2);
      clearHistory(document.getElementById('history-3'), document.getElementById('result-3'), document.getElementById('start-3'), document.getElementById('reset-3'));
      document.querySelectorAll('.custom-num').forEach((inp, i)=>{ if(i < 2) inp.value = ''; else inp.remove(); });
    });

    // spin inputs: trim leading zeros and clamp 1-999
    document.addEventListener('input', e=>{
      if(e.target && e.target.classList && e.target.classList.contains('spin')) {
        let v = String(e.target.value).replace(/^0+/, '');
        if(v === '') { e.target.value = ''; return; }
        let n = parseInt(v);
        if(isNaN(n)) { e.target.value = ''; return; }
        if(n < 1) n = 1;
        if(n > 999) n = 999;
        e.target.value = n;
      }
    });

    // เพิ่ม inputmode สำหรับ PC และมือถือ
    document.querySelectorAll('input[type="number"]').forEach(input => {
      input.setAttribute('inputmode', 'numeric');
      input.setAttribute('pattern', '[0-9]*');
    });

    // หน้าเริ่มต้น: show main menu
    showPage('main-menu');

  } catch (err) {
    console.error('Initialization error', err);
    alert('มีข้อผิดพลาดขณะเริ่มต้นโปรแกรม (ดู console log)'); 
  }
});
</script>
</body>
</html>
