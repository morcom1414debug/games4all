<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>โปรแกรมสุ่มตัวเลข</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f3f4f6;
            transition: background-color 0.3s ease;
        }
        .container {
            max-width: 90%;
            margin: auto;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem 0;
        }
        .card {
            background-color: white;
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 600px;
            animation: fadeIn 0.5s ease-in-out;
        }
        .btn {
            padding: 1rem 1.5rem;
            border-radius: 9999px;
            font-weight: 700;
            transition: all 0.3s ease;
        }
        .btn:hover:enabled {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn:disabled {
            background-color: #d1d5db;
            color: #9ca3af;
            cursor: not-allowed;
        }
        .result-display {
            font-size: 4rem;
            font-weight: 700;
            color: #3b82f6;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            animation: popIn 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        .list-group {
            max-height: 200px;
            overflow-y: auto;
            padding: 0.5rem;
            border-radius: 0.75rem;
            background-color: #f9fafb;
        }
        .input-group input {
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 0.75rem;
            transition: border-color 0.3s ease;
            -moz-appearance: textfield; /* Hide number input arrows for Firefox */
        }
        .input-group input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        .input-group input::-webkit-outer-spin-button,
        .input-group input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .pop-up {
            animation: popUp 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        @keyframes popUp {
            from { transform: scale(0); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center">

<div class="container">
    <div id="main-menu" class="card text-center">
        <h1 class="text-3xl font-bold mb-6 text-gray-800">โปรแกรมสุ่มตัวเลข</h1>
        <p class="text-gray-500 mb-8">เลือกโหมดการสุ่มที่ต้องการ</p>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <button id="mode-1" class="btn bg-blue-500 text-white hover:bg-blue-600">
                สุ่มตัวเลข 1 ถึง 99
            </button>
            <button id="mode-2" class="btn bg-green-500 text-white hover:bg-green-600">
                สุ่มตัวเลขจากเลขไหนถึงเลขไหน
            </button>
            <button id="mode-3" class="btn bg-purple-500 text-white hover:bg-purple-600">
                สุ่มตัวเลขตามประสงค์
            </button>
        </div>
    </div>

    <!-- Mode 1: 1 to 99 -->
    <div id="mode-1-page" class="card hidden text-center">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">สุ่มตัวเลข 1 ถึง 99</h2>
        <div class="flex items-center justify-center h-48 my-8 bg-blue-50 border-4 border-dashed border-blue-200 rounded-2xl">
            <h1 id="result-1" class="result-display text-blue-500">?</h1>
        </div>
        <button id="start-1" class="btn bg-blue-500 text-white w-full">เริ่มสุ่มทันที</button>
        <button id="reset-1" class="btn bg-gray-400 text-white w-full mt-2 hidden">สุ่มใหม่</button>
        <div class="mt-8 text-left">
            <h3 class="font-bold text-gray-600 mb-2">ประวัติการสุ่ม:</h3>
            <div id="history-1" class="list-group text-gray-600 flex flex-wrap gap-2">
                <!-- History items will be added here -->
            </div>
        </div>
        <button id="back-1" class="btn bg-gray-300 text-gray-800 w-full mt-4">กลับ</button>
    </div>

    <!-- Mode 2: Custom Range -->
    <div id="mode-2-page" class="card hidden text-center">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">สุ่มตัวเลขจากเลขไหนถึงเลขไหน</h2>
        <p class="text-sm text-gray-500 mb-4">ใส่ตัวเลขระหว่าง 1 ถึง 999</p>
        <div class="flex flex-col md:flex-row gap-4 mb-6 input-group">
            <input type="number" id="start-num" placeholder="ตัวเลขตั้งต้น (1-999)" class="w-full text-center" min="1" max="999" inputmode="numeric">
            <input type="number" id="end-num" placeholder="ตัวเลขสุดท้าย (1-999)" class="w-full text-center" min="1" max="999" inputmode="numeric">
        </div>
        <div class="flex items-center justify-center h-48 my-8 bg-green-50 border-4 border-dashed border-green-200 rounded-2xl">
            <h1 id="result-2" class="result-display text-green-500">?</h1>
        </div>
        <button id="start-2" class="btn bg-green-500 text-white w-full">เริ่มสุ่มทันที</button>
        <button id="reset-2" class="btn bg-gray-400 text-white w-full mt-2 hidden">สุ่มใหม่</button>
        <div class="mt-8 text-left">
            <h3 class="font-bold text-gray-600 mb-2">ประวัติการสุ่ม:</h3>
            <div id="history-2" class="list-group text-gray-600 flex flex-wrap gap-2">
                <!-- History items will be added here -->
            </div>
        </div>
        <button id="back-2" class="btn bg-gray-300 text-gray-800 w-full mt-4">กลับ</button>
    </div>

    <!-- Mode 3: Custom List -->
    <div id="mode-3-page" class="card hidden text-center">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">สุ่มตัวเลขตามประสงค์</h2>
        <p class="text-sm text-gray-500 mb-4">ใส่ตัวเลขที่ต้องการสุ่ม (สูงสุด 99 ช่อง)</p>
        <div id="input-container-3" class="flex flex-col gap-4 mb-4">
            <div class="input-group flex gap-2">
                <input type="number" class="w-full text-center custom-num" placeholder="ตัวเลขที่ 1" inputmode="numeric">
                <input type="number" class="w-full text-center custom-num" placeholder="ตัวเลขที่ 2" inputmode="numeric">
            </div>
        </div>
        <button id="add-input-3" class="btn bg-gray-200 text-gray-800 w-full mb-6">เพิ่มช่องใส่ตัวเลข</button>
        <div class="flex items-center justify-center h-48 my-8 bg-purple-50 border-4 border-dashed border-purple-200 rounded-2xl">
            <h1 id="result-3" class="result-display text-purple-500">?</h1>
        </div>
        <button id="start-3" class="btn bg-purple-500 text-white w-full">เริ่มสุ่มทันที</button>
        <button id="reset-3" class="btn bg-gray-400 text-white w-full mt-2 hidden">สุ่มใหม่</button>
        <div class="mt-8 text-left">
            <h3 class="font-bold text-gray-600 mb-2">ประวัติการสุ่ม:</h3>
            <div id="history-3" class="list-group text-gray-600 flex flex-wrap gap-2">
                <!-- History items will be added here -->
            </div>
        </div>
        <button id="back-3" class="btn bg-gray-300 text-gray-800 w-full mt-4">กลับ</button>
    </div>

    <!-- General Message/Modal (Hidden by default) -->
    <div id="modal-container" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center hidden z-50">
        <div id="modal" class="bg-white p-8 rounded-2xl shadow-xl text-center w-full max-w-sm pop-up">
            <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
            <p id="modal-message" class="text-gray-600 mb-6"></p>
            <button id="modal-close" class="btn bg-blue-500 text-white w-full">ตกลง</button>
        </div>
    </div>

</div>

<script>
    // Helper function to convert base64 to ArrayBuffer
    const base64ToArrayBuffer = (base64) => {
        const binaryString = window.atob(base64);
        const len = binaryString.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes.buffer;
    };

    // Helper function to convert raw PCM to WAV audio format
    const pcmToWav = (pcm16, sampleRate) => {
        const dataLength = pcm16.length * 2;
        const buffer = new ArrayBuffer(44 + dataLength);
        const view = new DataView(buffer);

        // WAV header
        writeString(view, 0, 'RIFF');
        view.setUint32(4, 36 + dataLength, true);
        writeString(view, 8, 'WAVE');
        writeString(view, 12, 'fmt ');
        view.setUint32(16, 16, true);
        view.setUint16(20, 1, true); // PCM format
        view.setUint16(22, 1, true); // Mono channel
        view.setUint32(24, sampleRate, true);
        view.setUint32(28, sampleRate * 2, true);
        view.setUint16(32, 2, true); // Block align
        view.setUint16(34, 16, true); // Bits per sample
        writeString(view, 36, 'data');
        view.setUint32(40, dataLength, true);

        // Write PCM audio data
        let offset = 44;
        for (let i = 0; i < pcm16.length; i++, offset += 2) {
            view.setInt16(offset, pcm16[i], true);
        }

        return new Blob([view], { type: 'audio/wav' });
    };

    const writeString = (view, offset, string) => {
        for (let i = 0; i < string.length; i++) {
            view.setUint8(offset + i, string.charCodeAt(i));
        }
    };

    const announceResult = async (number) => {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
        const textToSpeak = `ตัวเลขที่สุ่มได้คือ ${number}`;

        const payload = {
            contents: [{
                parts: [{ text: textToSpeak }]
            }],
            generationConfig: {
                responseModalities: ["AUDIO"],
                speechConfig: {
                    voiceConfig: {
                        prebuiltVoiceConfig: { voiceName: "Achird" }
                    }
                }
            },
            model: "gemini-2.5-flash-preview-tts"
        };

        try {
            let response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            // Implement exponential backoff for retries
            let attempts = 0;
            const maxAttempts = 5;
            while (!response.ok && attempts < maxAttempts) {
                const delay = Math.pow(2, attempts) * 1000;
                await new Promise(res => setTimeout(res, delay));
                response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                attempts++;
            }

            if (!response.ok) {
                console.error('API call failed after multiple attempts:', response.status, response.statusText);
                return;
            }

            const result = await response.json();
            const part = result?.candidates?.[0]?.content?.parts?.[0];
            const audioData = part?.inlineData?.data;
            const mimeType = part?.inlineData?.mimeType;

            if (audioData && mimeType && mimeType.startsWith("audio/")) {
                const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10);
                const pcmData = base64ToArrayBuffer(audioData);
                const pcm16 = new Int16Array(pcmData);
                const wavBlob = pcmToWav(pcm16, sampleRate);
                const audioUrl = URL.createObjectURL(wavBlob);
                const audio = new Audio(audioUrl);
                audio.play();
            } else {
                console.error('Audio data not found in response.');
            }
        } catch (error) {
            console.error('Error during TTS API call:', error);
        }
    };

    // Function to play a simple beep sound using Web Audio API
    const playRandomizeSound = () => {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        // Configure the oscillator and gain
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(440, audioContext.currentTime); // A4 note
        gainNode.gain.setValueAtTime(0, audioContext.currentTime);
        gainNode.gain.linearRampToValueAtTime(0.5, audioContext.currentTime + 0.1);
        gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.7);

        // Connect everything
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        // Start and stop the oscillator after a short duration
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.8);
    };

    document.addEventListener('DOMContentLoaded', () => {
        // Elements
        const mainMenu = document.getElementById('main-menu');
        const mode1Page = document.getElementById('mode-1-page');
        const mode2Page = document.getElementById('mode-2-page');
        const mode3Page = document.getElementById('mode-3-page');
        const modalContainer = document.getElementById('modal-container');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close');

        // State
        let usedNumbers = [];
        let customListNumbers = [];
        let isRandomizing = false;

        // Utility Functions
        const showModal = (title, message) => {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalContainer.classList.remove('hidden');
        };

        const hideModal = () => {
            modalContainer.classList.add('hidden');
        };

        const showPage = (pageToShow) => {
            const pages = [mainMenu, mode1Page, mode2Page, mode3Page];
            pages.forEach(page => page.classList.add('hidden'));
            pageToShow.classList.remove('hidden');
        };

        const updateHistory = (historyElement, number) => {
            const span = document.createElement('span');
            span.className = 'px-3 py-1 text-sm bg-gray-200 text-gray-800 rounded-full transition-all duration-300 pop-up';
            span.textContent = number;
            historyElement.appendChild(span);
        };

        const clearHistory = (historyElement, resultElement, startBtn, resetBtn) => {
            historyElement.innerHTML = '';
            resultElement.textContent = '?';
            usedNumbers = [];
            startBtn.classList.remove('hidden');
            resetBtn.classList.add('hidden');
        };

        const getRandomNumber = (min, max) => {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        };

        const randomize = (resultEl, historyEl, getNumbersFunc, startBtn, resetBtn) => {
            if (isRandomizing) return;
            isRandomizing = true;
            resultEl.textContent = '...';
            startBtn.disabled = true;
            startBtn.textContent = 'กำลังสุ่ม...';
            playRandomizeSound();

            setTimeout(() => {
                const availableNumbers = getNumbersFunc().filter(num => !usedNumbers.includes(num));
                
                if (availableNumbers.length === 0) {
                    showModal('หมดตัวเลขที่จะสุ่มแล้ว', 'ไม่มีตัวเลขเหลือให้สุ่มอีกแล้ว กรุณาเริ่มใหม่');
                    startBtn.disabled = false;
                    startBtn.textContent = 'เริ่มสุ่มทันที';
                    resetBtn.classList.remove('hidden');
                    isRandomizing = false;
                    return;
                }

                const randomIndex = getRandomNumber(0, availableNumbers.length - 1);
                const result = availableNumbers[randomIndex];
                usedNumbers.push(result);

                resultEl.textContent = result;
                updateHistory(historyEl, result);
                announceResult(result);

                startBtn.disabled = false;
                startBtn.textContent = 'สุ่มอีกครั้ง';
                resetBtn.classList.remove('hidden');
                isRandomizing = false;
            }, 800);
        };

        // Event Listeners for Main Menu
        document.getElementById('mode-1').addEventListener('click', () => {
            clearHistory(document.getElementById('history-1'), document.getElementById('result-1'), document.getElementById('start-1'), document.getElementById('reset-1'));
            showPage(mode1Page);
        });
        document.getElementById('mode-2').addEventListener('click', () => {
            clearHistory(document.getElementById('history-2'), document.getElementById('result-2'), document.getElementById('start-2'), document.getElementById('reset-2'));
            showPage(mode2Page);
        });
        document.getElementById('mode-3').addEventListener('click', () => {
            clearHistory(document.getElementById('history-3'), document.getElementById('result-3'), document.getElementById('start-3'), document.getElementById('reset-3'));
            showPage(mode3Page);
        });

        // Event Listeners for Back Buttons
        document.getElementById('back-1').addEventListener('click', () => showPage(mainMenu));
        document.getElementById('back-2').addEventListener('click', () => showPage(mainMenu));
        document.getElementById('back-3').addEventListener('click', () => showPage(mainMenu));
        modalCloseBtn.addEventListener('click', hideModal);

        // --- Mode 1: 1 to 99 ---
        const result1El = document.getElementById('result-1');
        const history1El = document.getElementById('history-1');
        const start1Btn = document.getElementById('start-1');
        const reset1Btn = document.getElementById('reset-1');

        start1Btn.addEventListener('click', () => {
            randomize(result1El, history1El, () => {
                const numbers = [];
                for (let i = 1; i <= 99; i++) {
                    numbers.push(i);
                }
                return numbers;
            }, start1Btn, reset1Btn);
        });

        reset1Btn.addEventListener('click', () => {
            clearHistory(history1El, result1El, start1Btn, reset1Btn);
            start1Btn.textContent = 'เริ่มสุ่มทันที';
        });

        // --- Mode 2: Custom Range ---
        const startNumInput = document.getElementById('start-num');
        const endNumInput = document.getElementById('end-num');
        const result2El = document.getElementById('result-2');
        const history2El = document.getElementById('history-2');
        const start2Btn = document.getElementById('start-2');
        const reset2Btn = document.getElementById('reset-2');

        start2Btn.addEventListener('click', () => {
            const startNum = parseInt(startNumInput.value);
            const endNum = parseInt(endNumInput.value);

            if (isNaN(startNum) || isNaN(endNum) || startNum < 1 || endNum > 999 || startNum > endNum) {
                showModal('ข้อมูลไม่ถูกต้อง', 'กรุณาใส่ตัวเลขให้ครบถ้วนและถูกต้อง (1-999) และตัวเลขตั้งต้นต้องไม่เกินตัวเลขสุดท้าย');
                return;
            }

            const currentRange = `${startNum}-${endNum}`;
            const lastRange = start2Btn.dataset.range || '';
            if (currentRange !== lastRange) {
                clearHistory(history2El, result2El, start2Btn, reset2Btn);
                start2Btn.dataset.range = currentRange;
                start2Btn.textContent = 'เริ่มสุ่มทันที';
            }

            randomize(result2El, history2El, () => {
                const numbers = [];
                for (let i = startNum; i <= endNum; i++) {
                    numbers.push(i);
                }
                return numbers;
            }, start2Btn, reset2Btn);
        });

        reset2Btn.addEventListener('click', () => {
            clearHistory(history2El, result2El, start2Btn, reset2Btn);
            start2Btn.textContent = 'เริ่มสุ่มทันที';
            start2Btn.dataset.range = '';
        });

        // --- Mode 3: Custom List ---
        const inputContainer3 = document.getElementById('input-container-3');
        const addInput3Btn = document.getElementById('add-input-3');
        const result3El = document.getElementById('result-3');
        const history3El = document.getElementById('history-3');
        const start3Btn = document.getElementById('start-3');
        const reset3Btn = document.getElementById('reset-3');

        addInput3Btn.addEventListener('click', () => {
            const existingInputs = document.querySelectorAll('.custom-num');
            if (existingInputs.length >= 99) {
                showModal('เกินขีดจำกัด', 'สามารถเพิ่มช่องใส่ตัวเลขได้สูงสุด 99 ช่องเท่านั้น');
                return;
            }
            const newInput = document.createElement('input');
            newInput.type = 'number';
            newInput.className = 'w-full text-center custom-num px-3 py-2 border-2 rounded-xl transition-colors duration-300 focus:border-purple-500 pop-up';
            newInput.placeholder = `ตัวเลขที่ ${existingInputs.length + 1}`;
            newInput.inputmode = 'numeric';
            newInput.min = '1';
            newInput.max = '999';
            inputContainer3.appendChild(newInput);
        });

        start3Btn.addEventListener('click', () => {
            const inputElements = document.querySelectorAll('#input-container-3 .custom-num');
            customListNumbers = [];
            let isValid = true;
            const uniqueCheck = new Set();

            inputElements.forEach(input => {
                const num = parseInt(input.value);
                if (isNaN(num) || num < 1 || num > 999) {
                    isValid = false;
                    return;
                }
                if (uniqueCheck.has(num)) {
                    isValid = false;
                    return;
                }
                uniqueCheck.add(num);
                customListNumbers.push(num);
            });

            if (!isValid) {
                showModal('ข้อมูลไม่ถูกต้อง', 'กรุณาใส่ตัวเลขให้ครบถ้วนและไม่ซ้ำกัน และต้องเป็นตัวเลขระหว่าง 1-999');
                return;
            }

            if (customListNumbers.length === 0) {
                showModal('ไม่มีตัวเลข', 'กรุณาใส่ตัวเลขที่ต้องการสุ่มอย่างน้อย 1 ตัว');
                return;
            }

            const currentListHash = JSON.stringify(customListNumbers);
            const lastListHash = start3Btn.dataset.listHash || '';
            if (currentListHash !== lastListHash) {
                clearHistory(history3El, result3El, start3Btn, reset3Btn);
                start3Btn.dataset.listHash = currentListHash;
                start3Btn.textContent = 'เริ่มสุ่มทันที';
            }

            randomize(result3El, history3El, () => customListNumbers, start3Btn, reset3Btn);
        });

        reset3Btn.addEventListener('click', () => {
            clearHistory(history3El, result3El, start3Btn, reset3Btn);
            start3Btn.textContent = 'เริ่มสุ่มทันที';
            start3Btn.dataset.listHash = '';
        });
    });
</script>
</body>
</html>
