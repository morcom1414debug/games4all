<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ß‡∏≤‡∏•‡∏π‡∏Å‡πâ‡∏≤‡πÅ‡∏´‡πà‡∏á‡πÇ‡∏ä‡∏Ñ‡∏ä‡∏∞‡∏ï‡∏≤ - Valuga of Destiny</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6a11cb; --secondary: #2575fc; --danger: #ff4b2b;
            --success: #00b09b; --gold: #f1c40f; --dark-bg: #0f0c29;
            --glass: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: 'Kanit', sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: white; margin: 0; display: flex;
            justify-content: center; align-items: center;
            height: 100vh; overflow: hidden;
        }

        #game-outer { width: 100%; max-width: 600px; padding: 20px; box-sizing: border-box; }

        #game-container {
            background: rgba(22, 33, 62, 0.8); backdrop-filter: blur(15px);
            border-radius: 30px; padding: 2.5rem; text-align: center;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5); border: 2px solid rgba(255, 255, 255, 0.1);
            position: relative; min-height: 580px; display: flex; flex-direction: column;
        }

        .nav-header { display: flex; justify-content: flex-start; margin-bottom: 10px; }
        .btn-community {
            background: var(--glass); border: 1px solid rgba(255,255,255,0.2);
            color: #ddd; padding: 8px 15px; border-radius: 12px;
            cursor: pointer; text-decoration: none; font-size: 0.9rem; transition: 0.3s;
        }

        .scene { display: none; flex-direction: column; gap: 1.2rem; animation: fadeIn 0.6s ease; }
        .scene.active { display: flex; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h1, h2 { color: var(--gold); text-shadow: 0 0 15px rgba(241, 196, 15, 0.3); margin-top: 0; outline: none; }
        
        .wheel-wrapper { position: relative; width: 200px; height: 200px; margin: 10px auto; }
        .wheel-graphic {
            width: 100%; height: 100%; border-radius: 50%; border: 8px solid var(--gold);
            background: conic-gradient(#6a11cb 0% 12.5%, #2575fc 12.5% 25%, #6a11cb 25% 37.5%, #2575fc 37.5% 50%, #6a11cb 50% 62.5%, #2575fc 62.5% 75%, #6a11cb 75% 87.5%, #2575fc 87.5% 100%);
            transition: transform 4s cubic-bezier(0.15, 0, 0.15, 1);
        }
        .lever-container { position: absolute; right: -30px; top: 50%; height: 70px; width: 14px; background: #333; border-radius: 7px; }
        .lever-handle { width: 22px; height: 22px; background: var(--danger); border-radius: 50%; position: absolute; left: -4px; top: 0; transition: top 0.5s ease; }
        .lever-active .lever-handle { top: 48px; }

        .btn-main {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none; padding: 18px 40px; border-radius: 50px; color: white;
            font-size: 1.3rem; font-weight: 600; cursor: pointer; transition: 0.3s;
            align-self: center; margin-top: auto;
        }

        .options-grid { display: grid; gap: 10px; margin-top: 10px; }
        .btn-opt {
            background: var(--glass); border: 1px solid rgba(255,255,255,0.1);
            color: white; padding: 14px; border-radius: 12px; text-align: left;
            cursor: pointer; transition: 0.2s; font-size: 1.1rem;
        }
        .btn-opt.dim { opacity: 0.2; pointer-events: none; }
        .btn-opt.selected { background: var(--primary); border-color: var(--gold); }

        .stats-bar { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.9rem; }
        .stat-item { background: var(--glass); padding: 8px 15px; border-radius: 10px; }

        /* ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á Log ‡∏≠‡∏¢‡∏π‡πà‡∏•‡πà‡∏≤‡∏á‡∏™‡∏∏‡∏î ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô aria-live ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÄ‡∏™‡∏µ‡∏¢‡∏á */
        #game-log { margin-top: auto; padding-top: 15px; min-height: 2.5em; color: var(--gold); font-size: 1.1rem; font-weight: bold; border-top: 1px solid rgba(255,255,255,0.05); outline: none; }
        
        #loading-overlay { position: fixed; inset: 0; background: var(--dark-bg); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--glass); border-top-color: var(--gold); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loading-overlay" aria-hidden="true">
    <div class="spinner"></div>
    <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏û‡∏•‡∏±‡∏á‡∏ò‡∏≤‡∏ï‡∏∏...</p>
</div>

<div id="game-outer">
    <div id="game-container">
        <div class="nav-header">
            <a href="../index.html" class="btn-community" role="button">üè† ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏ä‡∏∏‡∏°‡∏ä‡∏ô</a>
        </div>

        <section id="scene-start" class="scene active">
            <h1 id="title-start" tabindex="-1">‡∏ß‡∏≤‡∏•‡∏π‡∏Å‡πâ‡∏≤‡πÅ‡∏´‡πà‡∏á‡πÇ‡∏ä‡∏Ñ‡∏ä‡∏∞‡∏ï‡∏≤</h1>
            <p class="description">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏Å‡∏•‡πâ‡∏≤! ‡∏û‡∏¥‡∏ä‡∏¥‡∏ï‡∏´‡∏≠‡∏Ñ‡∏≠‡∏¢‡πÅ‡∏´‡πà‡∏á‡∏ß‡∏≤‡∏•‡∏π‡∏Å‡πâ‡∏≤ 20 ‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏™‡∏π‡∏à‡∏ô‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÉ‡∏ô‡πÉ‡∏ï‡πâ‡∏´‡∏•‡πâ‡∏≤</p>
            <button id="btn-begin" class="btn-main">‡∏û‡∏¥‡∏ä‡∏¥‡∏ï‡∏´‡∏≠‡∏Ñ‡∏≠‡∏¢</button>
        </section>

        <section id="scene-tower" class="scene">
            <div class="stats-bar">
                <div class="stat-item" id="hp-display">‚ù§Ô∏è HP: 1,000</div>
                <div class="stat-item" id="shield-display">üõ°Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Å‡∏£‡∏≤‡∏∞</div>
            </div>

            <div id="quiz-area">
                <h2 id="question-heading" tabindex="-1"></h2>
                <div id="options-container" class="options-grid"></div>
            </div>

            <div id="wheel-area" style="display: none;">
                <h2 id="wheel-title" tabindex="-1">‡∏Å‡∏á‡∏•‡πâ‡∏≠‡πÅ‡∏´‡πà‡∏á‡πÇ‡∏ä‡∏Ñ‡∏ä‡∏∞‡∏ï‡∏≤</h2>
                <div class="wheel-wrapper" aria-hidden="true">
                    <div id="visual-wheel" class="wheel-graphic"></div>
                    <div class="lever-container" id="lever-visual">
                        <div class="lever-handle"></div>
                    </div>
                </div>
            </div>

            <p id="game-log" aria-live="polite"></p>
        </section>

        <section id="scene-result" class="scene">
            <h2 id="result-title" tabindex="-1">‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</h2>
            <div id="result-icon" style="font-size: 4rem;" aria-hidden="true"></div>
            <p id="result-desc" style="font-size: 1.3rem;"></p>
            <p id="result-stats" style="opacity: 0.8;"></p>
        </section>
    </div>
</div>

<script>
/** -----------------------------------------------------------
 * ENGINE & STATE
 * ----------------------------------------------------------- */
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const buffers = {};
const soundPaths = {
    start: 'audio/start.mp3', back: 'audio/back.mp3', wheel: 'audio/wheel.mp3', 
    wheel1: 'audio/wheel1.mp3', up: 'audio/up.mp3', up1: 'audio/up1.mp3',
    shield: 'audio/shield.mp3', wind: 'audio/wind.mp3', water: 'audio/water.mp3', 
    earth: 'audio/earth.mp3', winter: 'audio/winter.mp3', hp: 'audio/hp.mp3',
    t: 'audio/t.mp3', winner: 'audio/winner.mp3', lost: 'audio/lost.mp3'
};

let bgmSource = null;
let state = { hp: 1000, floor: 1, hasShield: false, isBusy: false, usedQuiz: [], lastEffects: [] };

async function loadSound(name, url) {
    try {
        const response = await fetch(url);
        const arrayBuffer = await response.arrayBuffer();
        buffers[name] = await audioCtx.decodeAudioData(arrayBuffer);
    } catch (e) { console.warn(`Sound fail: ${name}`); }
}

async function initPreload() {
    await loadSound('start', soundPaths.start);
    await loadSound('back', soundPaths.back);
    document.getElementById('loading-overlay').style.display = 'none';
    Object.entries(soundPaths).forEach(([n, u]) => { if (n!=='start'&&n!=='back') loadSound(n, u); });
}

function play(name, loop = false) {
    if (!buffers[name]) return null;
    const s = audioCtx.createBufferSource();
    s.buffer = buffers[name]; s.loop = loop;
    s.connect(audioCtx.destination); s.start(0);
    return s;
}

function playWait(name) {
    return new Promise(r => { const s = play(name); if (!s) return r(); s.onended = r; });
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Log ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
function updateLogAndUI(eventText) {
    const logEl = document.getElementById('game-log');
    const hpDisplay = document.getElementById('hp-display');
    const shieldDisplay = document.getElementById('shield-display');

    // 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
    hpDisplay.innerText = `‚ù§Ô∏è HP: ${Math.max(0, state.hp).toLocaleString()}`;
    shieldDisplay.innerText = state.hasShield ? "üõ°Ô∏è ‡∏°‡∏µ‡πÄ‡∏Å‡∏£‡∏≤‡∏∞" : "üõ°Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Å‡∏£‡∏≤‡∏∞";

    // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Log ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß: "‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ HP XXX"
    if (eventText) {
        logEl.innerText = `${eventText} ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ HP ${Math.max(0, state.hp)}`;
    } else {
        logEl.innerText = "";
    }
}

/** -----------------------------------------------------------
 * GAME LOGIC
 * ----------------------------------------------------------- */
const quiz1to19 = [
    { q: "‡∏™‡∏¥‡πà‡∏á‡πÉ‡∏î‡∏ó‡∏µ‡πà‡∏¢‡∏¥‡πà‡∏á‡∏î‡∏¥‡πâ‡∏ô‡∏£‡∏ô‡∏Ç‡∏±‡∏î‡∏Ç‡∏∑‡∏ô ‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡∏Ç‡∏≠‡∏á‡∏°‡∏±‡∏ô‡∏¢‡∏¥‡πà‡∏á‡∏£‡∏±‡∏î‡∏£‡πà‡∏≤‡∏á‡πÄ‡∏à‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏à‡∏°‡∏î‡∏¥‡πà‡∏á‡∏•‡∏á", opts: ["‡∏ò‡∏≤‡∏ï‡∏∏‡∏î‡∏¥‡∏ô", "‡∏ò‡∏≤‡∏ï‡∏∏‡∏ô‡πâ‡∏≥", "‡∏ò‡∏≤‡∏ï‡∏∏‡∏•‡∏°"], ans: 1 },
    { q: "‡∏Ç‡πâ‡∏≤‡πÑ‡∏£‡πâ‡∏£‡∏π‡∏õ‡∏£‡πà‡∏≤‡∏á ‡∏°‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô ‡πÅ‡∏ï‡πà‡∏´‡∏≤‡∏Å‡∏Ç‡πâ‡∏≤‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß ‡∏™‡∏¥‡πà‡∏á‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏¢‡πà‡∏≠‡∏°‡∏™‡∏¥‡πâ‡∏ô‡∏•‡∏°‡∏´‡∏≤‡∏¢‡πÉ‡∏à", opts: ["‡∏ò‡∏≤‡∏ï‡∏∏‡∏•‡∏°", "‡∏ò‡∏≤‡∏ï‡∏∏‡πÅ‡∏™‡∏á", "‡∏ò‡∏≤‡∏ï‡∏∏‡∏ó‡∏≠‡∏á"], ans: 0 },
    { q: "‡∏Ç‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡πÄ‡∏ô‡∏¥‡∏î‡∏û‡∏∑‡∏ä‡∏û‡∏£‡∏£‡∏ì ‡πÅ‡∏•‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ó‡∏∏‡∏Å‡∏™‡∏¥‡πà‡∏á‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏ç ‡∏Ç‡πâ‡∏≤‡∏Å‡πá‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏£‡πà‡∏≤‡∏á‡∏ô‡∏±‡πâ‡∏ô", opts: ["‡∏ò‡∏≤‡∏ï‡∏∏‡πÑ‡∏°‡πâ", "‡∏ò‡∏≤‡∏ï‡∏∏‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏∑‡∏î", "‡∏ò‡∏≤‡∏ï‡∏∏‡∏î‡∏¥‡∏ô"], ans: 2 },
    { q: "‡∏Ç‡πâ‡∏≤‡∏¢‡∏¥‡πà‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏™‡∏ß ‡∏¢‡∏≤‡∏°‡∏Ç‡πâ‡∏≤‡πÄ‡∏ú‡∏≤‡∏ú‡∏•‡∏≤‡∏ç‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏¥‡∏á", opts: ["‡∏ò‡∏≤‡∏ï‡∏∏‡∏™‡∏≤‡∏¢‡∏ü‡πâ‡∏≤", "‡∏ò‡∏≤‡∏ï‡∏∏‡πÑ‡∏ü", "‡∏ò‡∏≤‡∏ï‡∏∏‡πÅ‡∏™‡∏á"], ans: 1 },
    { q: "‡∏Ç‡πâ‡∏≤‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ‡πÉ‡∏ï‡πâ‡∏ú‡∏∑‡∏ô‡∏î‡∏¥‡∏ô ‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏≠‡∏°‡∏à‡∏∂‡∏á‡πÄ‡∏ú‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡∏î‡∏á‡∏≤‡∏°", opts: ["‡∏ò‡∏≤‡∏ï‡∏∏‡∏ó‡∏≠‡∏á", "‡∏ò‡∏≤‡∏ï‡∏∏‡∏î‡∏¥‡∏ô", "‡∏ò‡∏≤‡∏ï‡∏∏‡∏ô‡πâ‡∏≥"], ans: 0 }
];

const effects = {
    shield: { label: "‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡∏£‡∏≤‡∏∞‡πÅ‡∏´‡πà‡∏á‡πÅ‡∏™‡∏á!", sfx: 'shield', dmg: 0, shield: true },
    wind: { label: "‡πÇ‡∏î‡∏ô ‡∏ß‡∏≤‡∏¢‡∏∏‡∏•‡∏°‡∏Å‡∏•‡∏î! ‡∏•‡∏î 100", sfx: 'wind', dmg: 100 },
    water: { label: "‡πÇ‡∏î‡∏ô ‡∏°‡∏´‡∏≤‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏Ñ‡∏•‡∏±‡πà‡∏á! ‡∏•‡∏î 200", sfx: 'water', dmg: 200 },
    earth: { label: "‡πÇ‡∏î‡∏ô ‡∏õ‡∏ê‡∏û‡∏µ‡∏Å‡∏•‡∏∑‡∏ô‡∏Å‡∏¥‡∏ô! ‡∏•‡∏î 200", sfx: 'earth', dmg: 200 },
    fire: { label: "‡πÇ‡∏î‡∏ô ‡∏≠‡∏±‡∏Ñ‡∏ô‡∏µ‡∏û‡∏¥‡πÇ‡∏£‡∏ò! ‡∏•‡∏î 300", sfx: 'water', dmg: 300 },
    hp: { label: "‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏¢‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏•‡∏±‡∏á HP +200!", sfx: 'hp', dmg: -200 }
};

function switchScene(id) {
    document.querySelectorAll('.scene').forEach(s => s.classList.remove('active'));
    const sc = document.getElementById(id); sc.classList.add('active');
    const head = sc.querySelector('h1, h2'); if (head) head.focus();
}

document.getElementById('btn-begin').onclick = async () => {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    document.getElementById('btn-begin').disabled = true;
    await playWait('start');
    bgmSource = play('back', true);
    switchScene('scene-tower');
    startFloor();
};

function startFloor() {
    updateLogAndUI(""); // ‡∏•‡πâ‡∏≤‡∏á log ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ç‡∏∂‡πâ‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà
    showQuiz();
}

function showQuiz() {
    document.getElementById('quiz-area').style.display = 'block';
    document.getElementById('wheel-area').style.display = 'none';
    
    let idx = Math.floor(Math.random() * quiz1to19.length);
    const data = quiz1to19[idx];
    const h2 = document.getElementById('question-heading');
    h2.innerText = `‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà ${state.floor} - ${data.q}`; 
    h2.focus();

    const container = document.getElementById('options-container');
    container.innerHTML = "";
    data.opts.forEach((opt, i) => {
        const btn = document.createElement('button');
        btn.className = 'btn-opt'; btn.innerText = `${['‡∏Å','‡∏Ç','‡∏Ñ'][i]}. ${opt}`;
        btn.onclick = () => {
            document.querySelectorAll('.btn-opt').forEach(b => b.classList.add('dim'));
            btn.classList.replace('dim', 'selected');
            setTimeout(() => {
                document.getElementById('quiz-area').style.display = 'none';
                document.getElementById('wheel-area').style.display = 'block';
                spinWheel(i === data.ans);
            }, 600);
        };
        container.appendChild(btn);
    });
}

async function spinWheel(isCorrect) {
    if (state.isBusy) return; state.isBusy = true;
    const pool = isCorrect ? ['shield','hp','wind','water'] : ['wind','earth','fire'];
    const effectKey = pool[Math.floor(Math.random() * pool.length)];

    const wheel = document.getElementById('visual-wheel');
    const lever = document.getElementById('lever-visual');
    lever.classList.add('lever-active');
    wheel.style.transform = `rotate(${1800 + Math.random()*360}deg)`;
    
    document.getElementById('game-log').innerText = "‡∏Å‡∏á‡∏•‡πâ‡∏≠‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏°‡∏∏‡∏ô...";
    await playWait(isCorrect ? 'wheel' : 'wheel1');
    lever.classList.remove('lever-active');
    
    await applyEffect(effectKey);
}

async function applyEffect(key) {
    const eff = effects[key];
    let eventLabel = eff.label;
    await playWait(eff.sfx);

    if (eff.dmg > 0) {
        if (state.hasShield) { eventLabel += " ‡πÅ‡∏ï‡πà‡πÄ‡∏Å‡∏£‡∏≤‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏ß‡πâ!"; state.hasShield = false; }
        else state.hp -= eff.dmg;
    } else if (eff.dmg < 0) {
        state.hp = Math.min(1000, state.hp + 200);
    }
    if (eff.shield) state.hasShield = true;

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß: "‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ HP XXX"
    updateLogAndUI(eventLabel);

    await new Promise(r => setTimeout(r, 2000));
    if (state.hp <= 0) return endGame(false);

    await playWait('up');
    state.floor++; state.isBusy = false;
    startFloor();
}

async function endGame(win) {
    if (bgmSource) bgmSource.stop();
    switchScene('scene-result');
    
    const icon = document.getElementById('result-icon');
    const desc = document.getElementById('result-desc');
    const stats = document.getElementById('result-stats');
    
    stats.innerText = `‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÑ‡∏î‡πâ: ${state.floor} | HP ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢: ${state.hp}`;

    if (win) {
        icon.innerText = "üèÜ"; desc.innerText = "‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏û‡∏¥‡∏ä‡∏¥‡∏ï‡∏ß‡∏≤‡∏•‡∏π‡∏Å‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πâ‡∏à‡∏£‡∏¥‡∏á!";
        await playWait('winner');
    } else {
        icon.innerText = "üíÄ"; desc.innerText = "‡πÇ‡∏ä‡∏Ñ‡∏ä‡∏∞‡∏ï‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏ñ‡∏∂‡∏á ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞";
        await playWait('lost');
    }
}

initPreload();
</script>
</body>
</html>