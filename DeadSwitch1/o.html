<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>กดติด...ตาย : Dead switch (ออนไลน์)</title>
<style>
  body {font-family: Tahoma, sans-serif;background:#111;color:white;text-align:center;margin:0;padding:20px;height:100vh;overflow:hidden;position:relative;}
  #backToMainMenu{position:fixed;top:20px;left:20px;background:rgba(255,255,255,0.95);color:#333;border:3px solid #fff;border-radius:12px;padding:12px 20px;font-size:18px;font-weight:bold;cursor:pointer;z-index:1002;display:none;}
  #backToMainMenu:hover{background:#fff;transform:translateY(-2px);}
  #lifeBoard{position:fixed;top:10px;left:50%;transform:translateX(-50%);z-index:1001;background:rgba(0,0,0,0.9);padding:18px 60px;border-radius:15px;border:4px solid #ffff00;font-size:38px;font-weight:bold;color:#ffff00;text-shadow:3px 3px 6px #000;min-width:500px;}
  #turnIndicator{position:fixed;top:90px;left:50%;transform:translateX(-50%);z-index:1001;background:rgba(0,0,0,0.85);padding:12px 40px;border-radius:12px;border:3px solid #00ff00;font-size:28px;font-weight:bold;color:#00ff00;text-shadow:2px 2px 4px #000;}
  #grid-container{max-width:720px;margin:150px auto 0;padding:20px;background:#000;border-radius:20px;box-shadow:0 0 30px rgba(255,255,0,0.6);}
  #grid{display:grid;grid-template-columns:repeat(4,1fr);grid-gap:10px;background:#333;padding:20px;border-radius:15px;border:8px solid #ffff00;}
  .cell{position:relative;background:#fff;border:7px solid #00f;border-radius:15px;box-shadow:0 8px 20px rgba(0,0,0,0.7);cursor:pointer;transition:all .2s;font-weight:bold;font-size:32px;color:#000;aspect-ratio:1;}
  .cell:hover{background:#ffff99;border-color:#f00;transform:scale(1.06);}
  .cell:active{transform:scale(0.95);}
  .cell.safe{background:#0f0 !important;color:#fff;border-color:#0a0;cursor:default;}
  .cell.boom{background:#f00 !important;color:#fff;border-color:#a00;cursor:default;}
  #lobby,#room{display:none;}
  #createRoomBtn{background:#fff;color:#000;padding:20px 60px;border-radius:20px;font-weight:bold;font-size:32px;cursor:pointer;margin:30px;border:8px solid #ffff00;box-shadow:0 12px 30px rgba(255,255,0,0.6);}
  #readyBtn{background:#4CAF50;color:white;padding:18px 50px;border-radius:15px;font-weight:bold;font-size:28px;cursor:pointer;margin:20px;display:none;}
  #readyBtn:disabled{background:#666;cursor:not-allowed;}
  #statusMessage{font-size:28px;margin:20px;color:#ffff00;}
  #resultScreen{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:10000;display:none;gap:40px;}
  #resultScreen h1{font-size:82px;color:#ffff00;text-shadow:7px 7px #000;margin:0;}
  #resultScreen p{font-size:52px;margin:20px 0;}
  #resultScreen button{padding:25px 100px;font-size:40px;background:#4CAF50;color:white;border:none;border-radius:25px;cursor:pointer;box-shadow:0 10px 30px rgba(0,0,0,0.5);}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border-width:0;}
</style>
</head>
<body>

<button id="backToMainMenu" onclick="location.href='../index.html'">กลับเมนูหลัก</button>

<!-- ARIA Live Region (ใช้เฉพาะตอนแสดงผลสรุป) -->
<div aria-live="polite" aria-atomic="true" class="sr-only" id="ariaAnnouncer"></div>

<div id="lobby">
  <h1 style="font-size:56px;color:#ffff00;text-shadow:4px 4px #000;">กดติด...ตาย : Dead switch</h1>
  <p style="font-size:32px;color:#ffdd00;">ออนไลน์ 1 ต่อ 1 • แข่งขัน 2 ใน 3 รอบ</p>
  <button id="createRoomBtn">สร้างห้องใหม่</button>
  <h3 style="font-size:28px;">ห้องที่เปิดอยู่</h3>
  <ul id="roomList" style="list-style:none;padding:0;"></ul>
</div>

<div id="room">
  <h2 id="roomName" style="font-size:42px;color:#ffff00;"></h2>
  <p style="font-size:28px;">ผู้เล่นในห้อง:</p>
  <ul id="playerList" style="font-size:26px;list-style:none;padding:0;"></ul>
  <div id="statusMessage">รอผู้เล่นคนที่ 2 เข้ามา...</div>
  <button id="readyBtn">พร้อม!</button>
</div>

<div id="gameScreen" style="display:none;">
  <div id="lifeBoard">กำลังเริ่มเกม...</div>
  <div id="turnIndicator">รอสักครู่...</div>
  <div id="grid-container"><div id="grid"></div></div>
</div>

<div id="resultScreen">
  <h1 id="resultTitle"></h1>
  <p id="resultMessage"></p>
  <button id="okButton">ตกลง</button>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script>
// ==================== Firebase ====================
const firebaseConfig = {
  apiKey: "AIzaSyBIPeN4YUIrwM4MmFtDvT2DJ-v4toxc7tY",
  authDomain: "xo-game-134ec.firebaseapp.com",
  databaseURL: "https://xo-game-134ec-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "xo-game-134ec",
  storageBucket: "xo-game-134ec.firebasestorage.app",
  messagingSenderId: "318375224157",
  appId: "1:318375224157:web:77bda97639a3f67db77eb4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ==================== Web Audio API Engine ====================
class WebAudioEngine {
  constructor() {
    this.audioCtx = null;
    this.buffers = {};
    this.isUnlocked = false;
    this.queue = [];
    this.isPlaying = false;
    this.lastPlayedSound = null;
    this.lastPlayedTime = 0;
    this.bgmSource = null;
    this.bgmGain = null;
  }

  async init() {
    if (this.audioCtx) return;
    this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    // โหลดทุกไฟล์ใน folder audio/
    const soundFiles = [
      'bgm.mp3',
      'end.mp3',
      't3.mp3',
      't2.mp3',
      'f3.mp3',
      'f2.mp3',
      's3.mp3',
      's4.mp3',
      'friend.mp3'
    ];

    const loadPromises = soundFiles.map(async file => {
      const response = await fetch(`audio/${file}`);
      const arrayBuffer = await response.arrayBuffer();
      const audioBuffer = await this.audioCtx.decodeAudioData(arrayBuffer);
      this.buffers[file.replace('.mp3', '')] = audioBuffer;
    });

    await Promise.all(loadPromises);
  }

  async unlock() {
    if (this.isUnlocked) return;
    await this.init();
    // สร้าง silent source เพื่อ unlock บน iOS/Android
    const silent = this.audioCtx.createBufferSource();
    silent.buffer = this.audioCtx.createBuffer(1, 1, 22050);
    silent.connect(this.audioCtx.destination);
    silent.start(0);
    silent.stop(0);
    this.isUnlocked = true;
  }

  async startBGM() {
    if (!this.isUnlocked) await this.unlock();
    if (this.bgmSource) this.stopBGM();

    const source = this.audioCtx.createBufferSource();
    source.buffer = this.buffers['bgm'];
    source.loop = true;

    this.bgmGain = this.audioCtx.createGain();
    source.connect(this.bgmGain);
    this.bgmGain.connect(this.audioCtx.destination);

    source.start(0);
    this.bgmSource = source;
  }

  stopBGM() {
    if (this.bgmSource) {
      this.bgmSource.stop();
      this.bgmSource = null;
      this.bgmGain = null;
    }
  }

  async playEffect(key) {
    if (!this.isUnlocked) {
      this.queue.push(key);
      return;
    }

    const now = Date.now();
    if (this.lastPlayedSound === key && now - this.lastPlayedTime < 500) {
      return;
    }
    this.lastPlayedSound = key;
    this.lastPlayedTime = now;

    const buffer = this.buffers[key];
    if (!buffer) return;

    const source = this.audioCtx.createBufferSource();
    source.buffer = buffer;

    const gainNode = this.audioCtx.createGain();
    source.connect(gainNode);
    gainNode.connect(this.audioCtx.destination);

    source.start(0);
  }

  async _processQueue() {
    if (this.queue.length === 0) return;
    const sounds = [...this.queue];
    this.queue = [];
    for (const key of sounds) {
      await this.playEffect(key);
      await new Promise(r => setTimeout(r, 100));
    }
  }
}

const audio = new WebAudioEngine();

let hasUserInteracted = false;
async function unlockAudio() {
  if (hasUserInteracted) return;
  hasUserInteracted = true;
  await audio.unlock();
  audio._processQueue();
  if (roomId) audio.startBGM();
}
document.addEventListener("touchstart", unlockAudio, {once:true, passive:true});
document.addEventListener("click", unlockAudio, {once:true});

// ==================== ตัวแปร ====================
let roomId = "", playerId = Math.random().toString(36).substr(2,9);
let isHost = false, myRole = "";
let currentRoomListener = null, soundListener = null, lobbyListener = null;
let gameStarted = false;
let opened = new Set();
let lastSoundTimestamp = 0;
let pendingSounds = [];

// ==================== ARIA Announcer ====================
function announce(message) {
  const announcer = document.getElementById("ariaAnnouncer");
  announcer.textContent = "";
  setTimeout(() => {
    announcer.textContent = message;
  }, 100);
}

// ==================== เสียงซิงค์ ====================
async function playSound(file) {
  if (!roomId) return;
  
  const timestamp = Date.now();
  await db.ref(`deadswitchRooms/${roomId}/sound`).set({
    file,
    time: timestamp,
    sender: playerId
  });
}

function startSoundListener() {
  if (soundListener) soundListener.off();
  soundListener = db.ref(`deadswitchRooms/${roomId}/sound`);
  
  soundListener.on("value", async s => {
    const data = s.val();
    if (!data) return;
    
    const now = Date.now();
    const timeDiff = now - data.time;
    
    if (timeDiff > 2000 || data.time <= lastSoundTimestamp) return;
    
    lastSoundTimestamp = data.time;
    
    const key = data.file.replace(".mp3", "");
    
    if (!audio.isUnlocked) {
      pendingSounds.push(key);
      return;
    }
    
    await audio.playEffect(key);
  });
}

async function playPendingSounds() {
  await audio._processQueue();
}

// ==================== เริ่มต้น ====================
document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("lobby").style.display = "block";
  document.getElementById("backToMainMenu").style.display = "block";
  loadRooms();
});

// ==================== Lobby & Room ====================
document.getElementById("createRoomBtn").onclick = async () => {
  await unlockAudio();
  const name = prompt("ตั้งชื่อห้อง (หรือเว้นว่าง):") || "ห้องใหม่";
  const roomRef = db.ref("deadswitchRooms").push();
  roomId = roomRef.key;
  isHost = true;
  myRole = "Host";
  await roomRef.set({
    name: name.trim(),
    status: "waiting",
    host: playerId,
    created: Date.now(),
    players: {[playerId]: "Host"},
    ready: {[playerId]: false}
  });
  db.ref(`deadswitchRooms/${roomId}/players/${playerId}`).onDisconnect().remove();
  db.ref(`deadswitchRooms/${roomId}/ready/${playerId}`).onDisconnect().remove();
  showRoom();
};

async function joinRoom(id) {
  await unlockAudio();
  const snap = await db.ref(`deadswitchRooms/${id}`).once("value");
  const room = snap.val();
  if (!room || room.status !== "waiting" || Object.keys(room.players || {}).length >= 2) {
    alert("เข้าร่วมไม่ได้");
    return;
  }
  roomId = id;
  myRole = "Guest";
  await db.ref(`deadswitchRooms/${roomId}/players/${playerId}`).set("Guest");
  await db.ref(`deadswitchRooms/${roomId}/ready/${playerId}`).set(false);
  db.ref(`deadswitchRooms/${roomId}/players/${playerId}`).onDisconnect().remove();
  db.ref(`deadswitchRooms/${roomId}/ready/${playerId}`).onDisconnect().remove();
  
  setTimeout(() => {
    if (audio.isUnlocked) {
      playSound("friend.mp3");
    }
  }, 300);
  
  showRoom();
}

function loadRooms() {
  const list = document.getElementById("roomList");
  if (lobbyListener) lobbyListener.off();
  lobbyListener = db.ref("deadswitchRooms").orderByChild("status").equalTo("waiting");
  lobbyListener.on("value", snap => {
    list.innerHTML = "";
    snap.forEach(r => {
      const room = r.val();
      if (Object.keys(room.players || {}).length === 1) {
        const li = document.createElement("li");
        li.innerHTML = `<strong>${room.name}</strong> (1/2) <button style="margin-left:10px;padding:6px 15px;background:#4CAF50;color:white;border:none;border-radius:8px;cursor:pointer;">เข้าร่วม</button>`;
        li.querySelector("button").onclick = () => joinRoom(r.key);
        list.appendChild(li);
      }
    });
  });
}

function showRoom() {
  document.getElementById("lobby").style.display = "none";
  document.getElementById("room").style.display = "block";
  document.getElementById("backToMainMenu").style.display = "none";
  startSoundListener();
  audio.startBGM();

  if (currentRoomListener) currentRoomListener.off();
  currentRoomListener = db.ref(`deadswitchRooms/${roomId}`);
  currentRoomListener.on("value", snap => {
    const room = snap.val();
    if (!room) return location.reload();
    
    document.getElementById("roomName").textContent = `ห้อง: ${room.name}`;
    document.getElementById("playerList").innerHTML = Object.values(room.players || {}).map(p => `<li>${p}</li>`).join("");

    const statusMsg = document.getElementById("statusMessage");
    const readyBtn = document.getElementById("readyBtn");
    
    const playerCount = Object.keys(room.players || {}).length;
    const readyCount = Object.values(room.ready || {}).filter(r => r === true).length;
    
    if (playerCount === 2) {
      statusMsg.textContent = `พร้อมแล้ว: ${readyCount}/2`;
      readyBtn.style.display = "inline-block";
      
      const myReady = room.ready?.[playerId] || false;
      if (myReady) {
        readyBtn.textContent = "รอคู่แข่ง...";
        readyBtn.disabled = true;
      } else {
        readyBtn.textContent = "พร้อม!";
        readyBtn.disabled = false;
      }
      
      if (readyCount === 2 && isHost && room.status === "waiting") {
        setTimeout(() => startGameFromReady(), 500);
      }
    } else {
      statusMsg.textContent = "รอผู้เล่นคนที่ 2 เข้ามา...";
      readyBtn.style.display = "none";
    }

    if (room.status === "playing") startGameplay();
    if (room.status === "finished") showResult(room);
  });
}

document.getElementById("readyBtn").onclick = async () => {
  await unlockAudio();
  await db.ref(`deadswitchRooms/${roomId}/ready/${playerId}`).set(true);
};

async function startGameFromReady() {
  const bombs = [];
  while (bombs.length < 4) {
    const n = Math.floor(Math.random() * 16);
    if (!bombs.includes(n)) bombs.push(n);
  }
  
  const firstTurn = "Host";
  await db.ref(`deadswitchRooms/${roomId}`).update({
    status: "playing",
    currentRound: 1,
    hostWins: 0,
    guestWins: 0,
    bombs,
    opened: {},
    turn: firstTurn,
    lastBoom: false,
    lastAction: Date.now()
  });

  playSound(firstTurn === "Host" ? "s3.mp3" : "s4.mp3");
}

// ==================== เกม ====================
function startGameplay() {
  gameStarted = true;
  document.getElementById("room").style.display = "none";
  document.getElementById("gameScreen").style.display = "block";

  const gameRef = db.ref(`deadswitchRooms/${roomId}`);
  let lastActionTime = 0;
  let lastAnnouncedRound = 0;
  let hasShownScoreThisRound = false;
  
  gameRef.on("value", snap => {
    const d = snap.val();
    if (!d || d.status !== "playing") return;

    const scoreLine = `รอบที่ ${d.currentRound || 1}/3 | Host ${d.hostWins || 0} - Guest ${d.guestWins || 0}`;
    document.getElementById("lifeBoard").textContent = scoreLine;

    const turnText = d.turn === "Host" ? "ตานี้ Host เป็นฝ่ายเลือก" : "ตานี้ Guest เป็นฝ่ายเลือก";
    document.getElementById("turnIndicator").textContent = turnText;

    if (!document.getElementById("grid").children.length) {
      createBoard();
    }

    if (d.lastAction && d.lastAction > lastActionTime) {
      lastActionTime = d.lastAction;
      hasShownScoreThisRound = false;
      
      if (d.opened) {
        Object.keys(d.opened).forEach(idxStr => {
          const idx = parseInt(idxStr);
          if (opened.has(idx)) return;
          opened.add(idx);

          const cell = document.querySelectorAll("#grid .cell")[idx];
          cell.disabled = true;

          if (d.bombs.includes(idx)) {
            cell.classList.add("boom");
            cell.textContent = "ระเบิด";
            playSound(d.turn === "Host" ? "t3.mp3" : "t2.mp3");
          } else {
            cell.classList.add("safe");
            cell.textContent = `ช่อง${idx + 1} ว่างเปล่า`;
            playSound(d.turn === "Host" ? "f3.mp3" : "f2.mp3");
          }
        });
      }

      if (d.lastBoom) {
        setTimeout(() => {
          const h = d.hostWins || 0;
          const g = d.guestWins || 0;
          if (h >= 2 || g >= 2 || d.currentRound >= 3) {
            gameRef.update({status: "finished"});
          } else {
            startNewRound(d);
          }
        }, 4000);
      }
    }
  });
}

function createBoard() {
  const grid = document.getElementById("grid");
  grid.innerHTML = "";
  for (let i = 0; i < 16; i++) {
    const cell = document.createElement("button");
    cell.className = "cell";
    cell.textContent = `ช่อง ${i + 1}`;
    cell.onclick = async () => {
      await unlockAudio();
      playerClick(i);
    };
    grid.appendChild(cell);
  }
}

async function playerClick(idx) {
  if (!gameStarted) return;
  const snap = await db.ref(`deadswitchRooms/${roomId}`).once("value");
  const d = snap.val();
  if (d.turn !== myRole || d.opened?.[idx]) return;

  const isBomb = d.bombs.includes(idx);
  const updates = {
    [`opened/${idx}`]: true,
    lastBoom: isBomb,
    lastAction: Date.now()
  };
  
  if (!isBomb) {
    updates.turn = myRole === "Host" ? "Guest" : "Host";
  } else {
    if (myRole === "Host") updates.guestWins = (d.guestWins || 0) + 1;
    else updates.hostWins = (d.hostWins || 0) + 1;
  }
  
  db.ref(`deadswitchRooms/${roomId}`).update(updates);
}

function startNewRound(d) {
  const bombs = [];
  while (bombs.length < 4) {
    const n = Math.floor(Math.random() * 16);
    if (!bombs.includes(n)) bombs.push(n);
  }
  const nextRound = (d.currentRound || 1) + 1;
  const nextTurn = nextRound % 2 === 1 ? "Host" : "Guest";

  db.ref(`deadswitchRooms/${roomId}`).update({
    bombs,
    opened: {},
    lastBoom: false,
    turn: nextTurn,
    currentRound: nextRound,
    lastAction: Date.now()
  });

  opened.clear();
  document.getElementById("grid").innerHTML = "";
  playSound(nextTurn === "Host" ? "s3.mp3" : "s4.mp3");
}

// ==================== ผลลัพธ์ ====================
function showResult(room) {
  audio.stopBGM();
  document.getElementById("gameScreen").style.display = "none";
  document.getElementById("resultScreen").style.display = "flex";

  const hostScore = room.hostWins || 0;
  const guestScore = room.guestWins || 0;

  let winner = hostScore >= 2 || (hostScore > guestScore && room.currentRound >= 3) ? "Host" : "Guest";
  let message = hostScore > guestScore ? `Host ชนะ ${hostScore}-${guestScore}` : `Guest ชนะ ${guestScore}-${hostScore}`;

  document.getElementById("resultTitle").textContent = `${winner} ชนะ!`;
  document.getElementById("resultMessage").textContent = message;

  setTimeout(() => {
    announce(`${winner} ชนะ! ${message}`);
  }, 500);

  document.getElementById("okButton").onclick = async () => {
    await unlockAudio();
    await audio.playEffect("end");
    setTimeout(() => location.href = "../index.html", 2000);
  };
}
</script>
</body>
</html>