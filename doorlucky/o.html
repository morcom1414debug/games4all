<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>กดติด...ตาย : Dead switch (ออนไลน์) - เวอร์ชันเสียงสมบูรณ์</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body {font-family: Tahoma, sans-serif;background:#111;color:white;text-align:center;margin:0;padding:20px;height:100vh;overflow:hidden;position:relative;}
  #backToMainMenu{position:fixed;top:20px;left:20px;background:rgba(255,255,255,0.95);color:#333;border:3px solid #fff;border-radius:12px;padding:12px 20px;font-size:18px;font-weight:bold;cursor:pointer;z-index:1002;display:none;}
  #backToMainMenu:hover{background:#fff;transform:translateY(-2px);}
  #lifeBoard{position:fixed;top:10px;left:50%;transform:translateX(-50%);z-index:1001;background:rgba(0,0,0,0.9);padding:18px 60px;border-radius:15px;border:4px solid #ffff00;font-size:38px;font-weight:bold;color:#ffff00;text-shadow:3px 3px 6px #000;min-width:500px;}
  #grid-container{max-width:720px;margin:110px auto 0;padding:20px;background:#000;border-radius:20px;box-shadow:0 0 30px rgba(255,255,0,0.6);}
  #grid{display:grid;grid-template-columns:repeat(4,1fr);grid-gap:10px;background:#333;padding:20px;border-radius:15px;border:8px solid #ffff00;}
  .cell{position:relative;background:#fff;border:7px solid #00f;border-radius:15px;box-shadow:0 8px 20px rgba(0,0,0,0.7);cursor:pointer;transition:all .2s;font-weight:bold;font-size:32px;color:#000;aspect-ratio:1;}
  .cell:hover{background:#ffff99;border-color:#f00;transform:scale(1.06);}
  .cell:active{transform:scale(0.95);}
  .cell.safe{background:#0f0 !important;color:#fff;border-color:#0a0;cursor:default;}
  .cell.boom{background:#f00 !important;color:#fff;border-color:#a00;cursor:default;}
  #lobby,#room{display:none;}
  #createRoomBtn{background:#fff;color:#000;padding:20px 60px;border-radius:20px;font-weight:bold;font-size:32px;cursor:pointer;margin:30px;border:8px solid #ffff00;box-shadow:0 12px 30px rgba(255,255,0,0.6);}
  #startBtn{background:#4CAF50;color:white;padding:18px 50px;border-radius:15px;font-weight:bold;font-size:28px;cursor:pointer;margin:20px;display:none;}
  #statusMessage{font-size:28px;margin:20px;color:#ffff00;}
  #resultScreen{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:10000;display:none;gap:40px;}
  #resultScreen h1{font-size:82px;color:#ffff00;text-shadow:7px 7px #000;margin:0;}
  #resultScreen p{font-size:52px;margin:20px 0;}
  #resultScreen button{padding:25px 100px;font-size:40px;background:#4CAF50;color:white;border:none;border-radius:25px;cursor:pointer;}
  #ttsDisplay{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.8);color:white;padding:15px 30px;border-radius:15px;font-size:24px;z-index:1002;opacity:0;transition:opacity 0.3s;pointer-events:none;max-width:90%;word-wrap:break-word;}
  #ttsDisplay.show{opacity:1;}
</style>
</head>
<body>

<button id="backToMainMenu" onclick="location.href='../index.html'">กลับเมนูหลัก</button>

<div id="lobby">
  <h1 style="font-size:56px;color:#ffff00;text-shadow:4px 4px #000;">กดติด...ตาย : Dead switch</h1>
  <p style="font-size:32px;color:#ffdd00;">ออนไลน์ 1 ต่อ 1 • 2 ใน 3 รอบ</p>
  <button id="createRoomBtn">สร้างห้องใหม่</button>
  <h3 style="font-size:28px;">ห้องที่เปิดอยู่</h3>
  <ul id="roomList" style="list-style:none;padding:0;max-height:400px;overflow-y:auto;"></ul>
</div>

<div id="room">
  <h2 id="roomName" style="font-size:42px;color:#ffff00;"></h2>
  <p style="font-size:28px;">ผู้เล่นในห้อง:</p>
  <ul id="playerList" style="font-size:26px;list-style:none;padding:0;"></ul>
  <div id="statusMessage">รอผู้เล่นคนที่ 2...</div>
  <button id="startBtn">เริ่มเกม!</button>
</div>

<div id="gameScreen" style="display:none;">
  <div id="lifeBoard">กำลังเริ่มเกม...</div>
  <div id="grid-container"><div id="grid"></div></div>
</div>

<div id="resultScreen">
  <h1 id="resultTitle"></h1>
  <p id="resultMessage"></p>
  <button id="okButton">ตกลง</button>
</div>

<div id="ttsDisplay"></div>
<div id="tts" aria-live="assertive" style="position:absolute;left:-9999px;"></div>

<!-- เสียงทั้งหมด -->
<audio id="bgm" loop preload="auto" src="audio/b.mp3"></audio>
<audio preload="auto" src="audio/end.mp3"></audio>
<audio preload="auto" src="audio/pop.mp3"></audio>
<audio preload="auto" src="audio/friend.mp3"></audio>
<audio preload="auto" src="audio/t3.mp3"></audio>
<audio preload="auto" src="audio/t2.mp3"></audio>
<audio preload="auto" src="audio/f3.mp3"></audio>
<audio preload="auto" src="audio/f2.mp3"></audio>
<audio preload="auto" src="audio/s3.mp3"></audio>
<audio preload="auto" src="audio/s4.mp3"></audio>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script>
// ====================== ระบบเสียงเทพจากเกมจุดโทษ ======================
const goalSounds = ["t3.mp3", "t2.mp3"];      // ระเบิด (Host โดน = t2, Guest โดน = t3)
const safeSounds = ["f3.mp3", "f2.mp3"];      // รอด
const startSounds = ["s3.mp3", "s4.mp3"];     // เริ่มตา
const popSound = "pop.mp3";

let preloadedAudios = {};

function preloadAllSounds() {
  const files = ["b.mp3","end.mp3","pop.mp3","friend.mp3","t3.mp3","t2.mp3","f3.mp3","f2.mp3","s3.mp3","s4.mp3"];
  files.forEach(name => {
    const audio = new Audio(`audio/${name}`);
    audio.preload = "auto";
    preloadedAudios[name] = audio;
  });
}

function startBGM() {
  const bgm = preloadedAudios["b.mp3"];
  if (bgm) { 
    bgm.currentTime = 0; 
    bgm.volume = 0.35; 
    bgm.loop = true; 
    bgm.play().catch(()=>{}); 
  }
}

function stopBGM() {
  const bgm = preloadedAudios["b.mp3"];
  if (bgm) { 
    bgm.pause(); 
    bgm.currentTime = 0; 
  }
}

function triggerSound(name) {
  if (!roomId) return;
  db.ref(`deadswitchRooms/${roomId}/soundTrigger`).set({
    name: name,
    time: Date.now()
  });
}

// ฟังเสียงจาก Firebase
let soundListener = null;
function startSoundListener() {
  if (soundListener) soundListener.off();
  soundListener = db.ref(`deadswitchRooms/${roomId}/soundTrigger`);
  soundListener.on("value", s => {
    const data = s.val();
    if (!data || Date.now() - data.time > 1200) return;
    const audio = preloadedAudios[data.name];
    if (audio) {
      audio.currentTime = 0;
      audio.volume = 1.0;
      audio.play().catch(()=>{});
    }

    // TTS จากเสียง
    let msg = "";
    if (data.name === "friend.mp3") msg = "มีผู้เล่นเข้ามาแล้ว";
    else if (data.name === "s3.mp3") msg = "Host เริ่มก่อน";
    else if (data.name === "s4.mp3") msg = "Guest เริ่มก่อน";
    else if (data.name === "t3.mp3") msg = "Host โดนระเบิด!";
    else if (data.name === "t2.mp3") msg = "Guest โดนระเบิด!";
    else if (data.name === "f3.mp3") msg = "Host รอด ต่อไป Guest";
    else if (data.name === "f2.mp3") msg = "Guest รอด ต่อไป Host";
    else if (data.name === "end.mp3") msg = "จบเกม!";

    if (msg) speak(msg);
  });
}

// TTS คิว
let ttsQueue = [], isSpeaking = false;
const ttsDisplay = document.getElementById("ttsDisplay");
function speak(text){
  ttsQueue.push(text);
  if (!isSpeaking) processTTS();
}
function processTTS(){
  if (isSpeaking || ttsQueue.length===0) return;
  isSpeaking = true;
  const msg = ttsQueue.shift();
  if (ttsDisplay) {
    ttsDisplay.textContent = msg;
    ttsDisplay.classList.add("show");
  }
  const ttsEl = document.getElementById("tts");
  if (ttsEl) ttsEl.textContent = msg;
  setTimeout(()=>{
    isSpeaking = false;
    if (ttsDisplay) ttsDisplay.classList.remove("show");
    if (ttsEl) ttsEl.textContent = "";
    processTTS();
  }, Math.max(1200, msg.length*70));
}

// ====================== Firebase ======================
const firebaseConfig = {
  apiKey: "AIzaSyBIPeN4YUIrwM4MmFtDvT2DJ-v4toxc7tY",
  authDomain: "xo-game-134ec.firebaseapp.com",
  databaseURL: "https://xo-game-134ec-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "xo-game-134ec",
  storageBucket: "xo-game-134ec.appspot.com",
  messagingSenderId: "318375224157",
  appId: "1:318375224157:web:348a410dfd625359b77eb4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ====================== ตัวแปรเกม ======================
let roomId = "", playerId = Math.random().toString(36).substr(2,9);
let isHost = false, myRole = "";
let currentRoomListener = null, lobbyListener = null;
let opened = new Set();
let currentRound = 1;  // สำหรับ startNewRound

// ====================== เริ่มต้น ======================
document.addEventListener("DOMContentLoaded", () => {
  preloadAllSounds();
  document.getElementById("lobby").style.display = "block";
  document.getElementById("backToMainMenu").style.display = "block";
  loadRooms();
});

// ====================== Lobby & Room ======================
document.getElementById("createRoomBtn").onclick = async () => {
  const name = prompt("ตั้งชื่อห้อง (หรือเว้นว่าง):") || "ห้องใหม่";
  if (!name.trim()) return;
  const roomRef = db.ref("deadswitchRooms").push();
  roomId = roomRef.key;
  isHost = true;
  myRole = "Host";
  await roomRef.set({name: name.trim(), status:"waiting", host:playerId, created:Date.now(), players:{[playerId]:{role:"Host"}}});
  db.ref(`deadswitchRooms/${roomId}/players/${playerId}`).onDisconnect().remove();
  showRoom();
  startBGM();
};

async function joinRoom(id) {
  const snap = await db.ref(`deadswitchRooms/${id}`).once("value");
  const room = snap.val();
  if (!room || room.status!=="waiting" || Object.keys(room.players||{}).length>=2) {
    alert("เข้าร่วมไม่ได้"); return;
  }
  roomId = id;
  myRole = "Guest";
  await db.ref(`deadswitchRooms/${roomId}/players/${playerId}`).set({role:"Guest"});
  db.ref(`deadswitchRooms/${roomId}/players/${playerId}`).onDisconnect().remove();
  triggerSound("friend.mp3");
  speak("มีผู้เล่นเข้ามาแล้ว");
  showRoom();
  startBGM();
}

function loadRooms() {
  const list = document.getElementById("roomList");
  if(lobbyListener) lobbyListener.off();
  lobbyListener = db.ref("deadswitchRooms").orderByChild("status").equalTo("waiting");
  lobbyListener.on("value", snap => {
    list.innerHTML = "";
    const now = Date.now();
    snap.forEach(r => {
      const room = r.val();
      const key = r.key;
      if (!room || (room.created && now - room.created > 300000)) {  // ลบห้องเก่า >5 นาที
        db.ref(`deadswitchRooms/${key}`).remove();
        return;
      }
      if (Object.keys(room.players||{}).length === 1) {
        const li = document.createElement("li");
        li.innerHTML = `<strong>${room.name}</strong> (1/2) <button style="margin-left:10px;padding:6px 15px;background:#4CAF50;color:white;border:none;border-radius:8px;cursor:pointer;">เข้าร่วม</button>`;
        li.querySelector("button").onclick = () => joinRoom(key);
        list.appendChild(li);
      }
    });
  });
}

function showRoom() {
  document.getElementById("lobby").style.display = "none";
  document.getElementById("room").style.display = "block";
  startSoundListener();

  if(currentRoomListener) currentRoomListener.off();
  currentRoomListener = db.ref(`deadswitchRooms/${roomId}`);
  currentRoomListener.on("value", snap => {
    const room = snap.val();
    if(!room) return location.reload();

    document.getElementById("roomName").textContent = `ห้อง: ${room.name}`;
    const pl = Object.values(room.players||{}).map(p=>p.role || 'Unknown');
    document.getElementById("playerList").innerHTML = pl.map(r=>`<li>${r}</li>`).join("");

    const statusMsg = document.getElementById("statusMessage");
    const startBtn = document.getElementById("startBtn");
    if(pl.length===2){
      statusMsg.textContent = isHost ? "กดเริ่มเกมได้เลย" : "รอ Host เริ่มเกม";
      startBtn.style.display = isHost ? "inline-block" : "none";
    } else {
      statusMsg.textContent = "รอผู้เล่นคนที่ 2...";
      startBtn.style.display = "none";
    }

    if(room.status==="playing") startGameplay(room);
    if(room.status==="finished") showResult(room);
  });
}

document.getElementById("startBtn").onclick = () => {
  const bombs = [];
  while(bombs.length<4){
    const n = Math.floor(Math.random()*16);
    if(!bombs.includes(n)) bombs.push(n);
  }
  const firstTurn = Math.random()<0.5 ? "Host" : "Guest";
  db.ref(`deadswitchRooms/${roomId}`).update({
    status:"playing",
    currentRound:1,
    hostWins:0,
    guestWins:0,
    bombs,
    opened:{},
    turn: firstTurn,
    lastBoom:false
  });
  triggerSound(firstTurn==="Host" ? "s3.mp3" : "s4.mp3");
  speak(`${firstTurn} เริ่มก่อน เลือกได้เลย`);
};

// ====================== เกม ======================
function startGameplay(initialRoom) {
  document.getElementById("room").style.display = "none";
  document.getElementById("gameScreen").style.display = "block";

  const gameRef = db.ref(`deadswitchRooms/${roomId}`);
  let lastBoomProcessed = false;

  gameRef.on("value", snap => {
    const d = snap.val();
    if(!d || d.status!=="playing") return;

    document.getElementById("lifeBoard").textContent = `รอบที่ ${d.currentRound||1}/3 | Host ${d.hostWins||0} - Guest ${d.guestWins||0}`;

    if(!document.getElementById("grid").children.length) {
      createBoard();
      // เสียงเริ่มจาก initial
      if (initialRoom && initialRoom.turn) {
        triggerSound(initialRoom.turn==="Host" ? "s3.mp3" : "s4.mp3");
        speak(`${initialRoom.turn} เริ่มก่อน เลือกได้เลย`);
      }
    }

    // แสดงผลที่เปิดแล้ว
    if(d.opened){
      Object.keys(d.opened).forEach(idxStr => {
        const idx = parseInt(idxStr);
        if(opened.has(idx)) return;
        opened.add(idx);
        const cell = document.querySelectorAll("#grid .cell")[idx];
        if (!cell) return;
        cell.disabled = true;
        if(d.bombs && d.bombs.includes(idx)){
          cell.classList.add("boom");
          cell.textContent = "ระเบิด";
          const sound = myRole==="Host" ? "t2.mp3" : "t3.mp3";  // ถ้า Host กดระเบิด = Guest ได้คะแนน (t2)
          triggerSound(sound);
          speak(`${myRole==="Host" ? "Guest" : "Host"} ได้คะแนน!`);
        } else {
          cell.classList.add("safe");
          cell.textContent = "รอด";
          const sound = myRole==="Host" ? "f3.mp3" : "f2.mp3";
          triggerSound(sound);
          speak(`${myRole==="Host" ? "Host" : "Guest"} รอด ต่อไป ${myRole==="Host" ? "Guest" : "Host"}`);
        }
      });
    }

    // จบรอบ
    if(d.lastBoom && !lastBoomProcessed){
      lastBoomProcessed = true;
      setTimeout(() => {
        const h = d.hostWins || 0;
        const g = d.guestWins || 0;
        if (h >= 2 || g >= 2 || (d.currentRound || 1) >= 3){
          gameRef.update({status:"finished", winner: h > g ? "Host" : "Guest"});
          triggerSound("end.mp3");
          stopBGM();
        } else {
          startNewRound(d.currentRound || 1);
        }
      }, 3000);
    }
  });
}

function createBoard(){
  const grid = document.getElementById("grid");
  grid.innerHTML = "";
  for(let i=0;i<16;i++){
    const cell = document.createElement("button");
    cell.className = "cell";
    cell.textContent = `ช่อง ${i+1}`;
    cell.onclick = () => {
      if (roomId) triggerSound("pop.mp3");
      playerClick(i);
    };
    cell.setAttribute("aria-label", `ช่อง ${i+1}`);
    if(i===0) cell.id = "cell0";
    grid.appendChild(cell);
  }
  setTimeout(()=> { const firstCell = document.getElementById("cell0"); if (firstCell) firstCell.focus(); }, 500);
}

async function playerClick(idx){
  if(!roomId) return;
  const snap = await db.ref(`deadswitchRooms/${roomId}`).once("value");
  const d = snap.val();
  if(!d || d.turn !== myRole || d.opened?.[idx]) return;

  const isBomb = d.bombs && d.bombs.includes(idx);
  const updates = {[`opened/${idx}`]: true, lastBoom: isBomb};
  if(!isBomb){
    updates.turn = myRole==="Host" ? "Guest" : "Host";
  } else {
    if(myRole==="Host") updates.guestWins = (d.guestWins||0)+1;
    else updates.hostWins = (d.hostWins||0)+1;
  }
  db.ref(`deadswitchRooms/${roomId}`).update(updates);
}

function startNewRound(currentRd) {
  const bombs = [];
  while(bombs.length<4){
    const n = Math.floor(Math.random()*16);
    if(!bombs.includes(n)) bombs.push(n);
  }
  const nextRound = currentRd + 1;
  const nextTurn = nextRound % 2 === 1 ? "Host" : "Guest";

  db.ref(`deadswitchRooms/${roomId}`).update({
    bombs,
    opened:{},
    lastBoom:false,
    turn: nextTurn,
    currentRound: nextRound
  });
  opened.clear();
  document.getElementById("grid").innerHTML = "";
  setTimeout(() => createBoard(), 100);
  triggerSound(nextTurn==="Host" ? "s3.mp3" : "s4.mp3");
  speak(`${nextTurn} เริ่มรอบที่ ${nextRound}`);
}

// ====================== ผลลัพธ์ ======================
function showResult(room){
  stopBGM();
  document.getElementById("gameScreen").style.display = "none";
  document.getElementById("resultScreen").style.display = "flex";

  const h = room.hostWins || 0;
  const g = room.guestWins || 0;
  const winner = h > g ? "Host" : "Guest";

  document.getElementById("resultTitle").textContent = `${winner} ชนะ!`;
  document.getElementById("resultMessage").textContent = `คะแนน ${h} - ${g}`;
  speak(`${winner} ชนะด้วยคะแนน ${h} ต่อ ${g} ยินดีด้วย!`);

  document.getElementById("okButton").onclick = () => location.href = "../index.html";
}
</script>
</body>
</html>