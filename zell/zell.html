<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>จำให้ได้ ไปให้ถึง</title>
<style>
  body { font-family: sans-serif; text-align: center; background: #222; color: #fff; }
  #game, #result { display: none; }
  button { font-size: 1.5rem; padding: 1rem 2rem; margin-top: 2rem; cursor: pointer; border-radius: 1rem; border: none; background: #4CAF50; color: white; }
  .sr-only { position: absolute; left: -10000px; top: auto; width: 1px; height: 1px; overflow: hidden; }
</style>
</head>
<body>
  <h1>จำให้ได้ ไปให้ถึง</h1>
  <p>เอียงหรือเขย่ามือถือตามจังหวะให้ถูกต้อง</p>

  <div id="start">
    <button id="startBtn">เริ่มเกม</button>
  </div>

  <div id="game" aria-hidden="true">
    <h2 id="roundInfo"></h2>
    <p id="instruction">เตรียมพร้อม...</p>
    <p id="scoreBoard">คะแนน: 0</p>
    <p id="wrongCountBoard">ผิด: 0</p>
    <p id="timeBoard">เวลา: 0</p>
  </div>

  <div id="result">
    <h2 id="summary" tabindex="0"></h2>
    <button id="restartBtn">เล่นเกมใหม่</button>
  </div>

  <div id="srApp" class="sr-only" tabindex="-1"></div>
  <div id="announcer" aria-live="polite" class="sr-only"></div>

  <!-- เสียงประกอบ -->
  <audio id="bgm" src="background.mp3" loop></audio>
  <audio id="right" src="right.mp3"></audio>
  <audio id="left" src="left.mp3"></audio>
  <audio id="front" src="front.mp3"></audio>
  <audio id="back" src="back.mp3"></audio>
  <audio id="shake" src="shake.mp3"></audio>
  <audio id="win" src="win.mp3"></audio>
  <audio id="lost" src="lost.mp3"></audio>
  <audio id="endhappy" src="endhappy.mp3"></audio>
  <audio id="endlost" src="endlost.mp3"></audio>

<script>
const actions = [
  { type: 'right', audioId: 'right', name: 'ขวา' },
  { type: 'left', audioId: 'left', name: 'ซ้าย' },
  { type: 'front', audioId: 'front', name: 'หน้า' },
  { type: 'back', audioId: 'back', name: 'หลัง' },
  { type: 'shake', audioId: 'shake', name: 'เขย่า' }
];

let round = 1;
let playing = false;
let sequence = [];
let playbackIndex = 0;
let inputIndex = 0;
let baseTimeLimit = 5000;
let inputTimeout = null;
let score = 0;
let wrongCount = 0;
let timeLeft = 0;
let timeTimer = null;
let lastShakeTime = 0;

const srApp = document.getElementById('srApp');
const announcer = document.getElementById('announcer');
const startBtn = document.getElementById('startBtn');
const restartBtn = document.getElementById('restartBtn');
const scoreBoard = document.getElementById('scoreBoard');
const wrongBoard = document.getElementById('wrongCountBoard');
const timeBoard = document.getElementById('timeBoard');
const summary = document.getElementById('summary');

startBtn.addEventListener('click', requestPermissionAndStart);
restartBtn.addEventListener('click', requestPermissionAndStart);

function announce(text){
  announcer.textContent = '';
  setTimeout(()=> announcer.textContent = text, 50);
}

function requestScreenReaderFocusMode(){
  srApp.setAttribute('role', 'application');
  srApp.focus({preventScroll:true});
}

function restoreBrowseMode(){
  srApp.removeAttribute('role');
  document.body.focus({preventScroll:true});
}

async function requestPermissionAndStart(){
  try {
    if (typeof DeviceMotionEvent !== "undefined" &&
        typeof DeviceMotionEvent.requestPermission === "function") {
      const motion = await DeviceMotionEvent.requestPermission();
      const orient = await DeviceOrientationEvent.requestPermission();
      if (motion === "granted" && orient === "granted") {
        startGame();
      } else {
        alert("กรุณาอนุญาต motion & orientation sensor เพื่อเล่นเกม");
      }
    } else {
      startGame();
    }
  } catch (err) {
    console.error(err);
  }
}

function startGame(){
  document.getElementById('start').style.display = 'none';
  document.getElementById('game').style.display = 'block';
  document.getElementById('result').style.display = 'none';

  round = 1;
  baseTimeLimit = 5000;
  score = 0;
  wrongCount = 0;
  updateScore();
  updateWrong();
  updateTime(0);

  const bgm = document.getElementById('bgm');
  bgm.currentTime = 0; bgm.play().catch(()=>{});

  requestScreenReaderFocusMode();
  announce('เริ่มเกมแล้ว กรุณาเตรียมตัว');

  nextRound();
}

function updateScore(){ scoreBoard.textContent = 'คะแนน: ' + score; }
function updateWrong(){ wrongBoard.textContent = 'ผิด: ' + wrongCount; }
function updateTime(val){ timeBoard.textContent = 'เวลา: ' + Math.ceil(val/1000) + ' วิ'; }

function nextRound(){
  clearInputTimeout();
  clearInterval(timeTimer);

  if(wrongCount >= 3){ endGameFailed(); return; }

  document.getElementById('roundInfo').textContent = 'รอบที่ ' + round;
  announce('รอบที่ ' + round);

  // กำหนดจำนวน action ต่อรอบ
  let count = 1;
  if(round > 3) {
    count = Math.min(2 + Math.floor((round-4)/1), 8); 
  }

  sequence = [];
  while(sequence.length < count){
    let pick = actions[Math.floor(Math.random()*actions.length)];
    if(sequence.length && pick.type === sequence[sequence.length-1].type) continue;
    sequence.push(pick);
  }

  playbackIndex = 0;
  inputIndex = 0;
  playing = true;

  window.addEventListener('deviceorientation', handleOrientation);
  window.addEventListener('devicemotion', handleShake);

  // หน่วงเวลา 3 วินาที ก่อนเล่นรอบใหม่
  setTimeout(()=>{
    timeLeft = baseTimeLimit + (sequence.length*1000);
    updateTime(timeLeft);
    timeTimer = setInterval(()=>{
      timeLeft -= 200;
      updateTime(timeLeft);
      if(timeLeft<=0){
        wrongCount++;
        updateWrong();
        stopPlayerInput();
        clearInterval(timeTimer);
        if(wrongCount>=3){ endGameFailed(); }
        else {
          document.getElementById('lost').play().catch(()=>{});
          setTimeout(()=>{ round++; nextRound(); }, 2000);
        }
      }
    },200);

    playSequence();
  },3000); // หน่วง 3 วินาที
}

function playSequence(){
  if(playbackIndex < sequence.length){
    const audioEl = document.getElementById(sequence[playbackIndex].audioId);
    audioEl.onended = () => {
      playbackIndex++;
      setTimeout(playSequence, 500);
    };
    audioEl.currentTime = 0;
    audioEl.play().catch(()=>{
      setTimeout(()=>{ audioEl.onended && audioEl.onended(); }, 500);
    });
  }
}

function handleOrientation(e){
  if(!playing) return;

  let action = null;
  if(e.gamma > 20) action = 'right';
  else if(e.gamma < -20) action = 'left';
  else if(e.beta > 25) action = 'front';
  else if(e.beta < -15) action = 'back';

  if(action) checkAction(action);
}

function handleShake(e){
  if(!playing) return;
  let acc = e.accelerationIncludingGravity;
  if(!acc) return;
  let magnitude = Math.sqrt(acc.x*acc.x + acc.y*acc.y + acc.z*acc.z);
  if(magnitude > 30){
    let now = Date.now();
    if(now - lastShakeTime > 1200){
      lastShakeTime = now;
      checkAction('shake');
    }
  }
}

function checkAction(action){
  if(action === sequence[inputIndex].type){
    try{ new Audio('01.mp3').play().catch(()=>{}); }catch(e){}
    score += 10; updateScore(); inputIndex++;
    if(inputIndex >= sequence.length){
      stopPlayerInput();
      document.getElementById('win').play().catch(()=>{});
      setTimeout(()=>{ round++; baseTimeLimit = Math.max(3000, baseTimeLimit - 200); nextRound(); },2000);
    }
  }else{
    wrongCount++; updateWrong(); stopPlayerInput();
    document.getElementById('lost').play().catch(()=>{});
    setTimeout(()=>{
      if(wrongCount>=3){ endGameFailed(); }
      else { round++; baseTimeLimit = Math.max(3000, baseTimeLimit - 200); nextRound(); }
    },2000);
  }
}

function stopPlayerInput(){
  playing = false;
  clearInterval(timeTimer);
  window.removeEventListener('deviceorientation', handleOrientation);
  window.removeEventListener('devicemotion', handleShake);
  clearInputTimeout();
}

function clearInputTimeout(){ if(inputTimeout){ clearTimeout(inputTimeout); inputTimeout = null; } }

function endGameFailed(){
  const bgm = document.getElementById('bgm');
  bgm.pause(); bgm.currentTime = 0;
  restoreBrowseMode();
  document.getElementById('endlost').play().catch(()=>{});
  document.getElementById('game').style.display = 'none';
  document.getElementById('result').style.display = 'block';
  let rank = score>=300?"ยอดเยี่ยม":score>=150?"เก่งมาก":"ยังต้องฝึก";
  summary.textContent = `คุณได้ ${score} คะแนน (${rank})`;
  summary.focus();
  announce('จบเกม คุณได้ '+score+' คะแนน '+rank);
}
</script>
</body>
</html>
