<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Squid Game - for blind</title>
<style>
body{
  font-family:sans-serif;
  text-align:center;
  background-color:#000;
  color:#fff;
  margin:0;
  padding:0;
}
img{
  max-width:300px;
  display:block;
  margin:20px auto 10px auto;
}
button{
  font-size:1.5em;
  padding:10px 20px;
  margin-top:20px;
  border-radius:12px;
  border:none;
  background-color:#e50914;
  color:#fff;
  cursor:pointer;
  transition:background-color 0.3s;
}
button:hover{ background-color:#ff3b30; }
button:disabled{ background-color:#555; cursor:not-allowed; }
#gameContainer{ margin-top:50px; }
.status-text{ font-size:1.2em; margin-top:10px; }
</style>
</head>
<body>
<div id="gameContainer" role="main" aria-live="assertive"></div>

<script>
const audioFiles=[
 'start.mp3','go1.mp3','go2.mp3','go3.mp3','go4.mp3',
 'pass.mp3','pass-die1.mp3','pass-die2.mp3','over.mp3','end.mp3','pic.png'
];
let audios={},deaths=0,distance=0,startTime=0,
isGoing=false,inGoRound=false,playerStoppedDuringGo=false,lastDieSound='';
let isGameEnded=false,isLocked=false,isAudioLoaded=false;
let tempAudio=null;
const container=document.getElementById('gameContainer');
let motionAllowed=false, lastTiltTime=0;

// --------------------- Focus Mode ---------------------
function activateFocusMode(){
 container.setAttribute('role','application');
 container.setAttribute('tabindex','0');
 try{container.focus();}catch(e){}
}
function deactivateFocusMode(){
 container.removeAttribute('role');
 container.removeAttribute('tabindex');
}

// --------------------- โหลดไฟล์เสียง ---------------------
function loadAssets(){
 container.innerHTML=`
   <img src="audio/pic.png" alt="ลุยไปด้วยกัน">
   <p id="loadText" class="status-text">กำลังโหลดไฟล์เสียง กรุณารอสักครู่...</p>
   <button id="startGameBtn" disabled>เริ่มเกม</button>
 `;
 const startBtn=document.getElementById('startGameBtn');
 const loadText=document.getElementById('loadText');

 let loaded=0,total=audioFiles.length;

 function checkDone(){
   if(loaded===total){
     isAudioLoaded=true;
     startBtn.disabled=false;
     loadText.textContent='พร้อมแล้ว กดปุ่มเริ่มเกมได้ทันที';
   }
 }

 audioFiles.forEach(f=>{
   if(f.endsWith('.mp3')){
     const a=new Audio('audio/'+f);
     a.addEventListener('canplaythrough',()=>{
       loaded++; checkDone();
     },{once:true});
     a.load();
     audios[f]=a;
   }else{
     const img=new Image();
     img.src='audio/'+f;
     img.onload=()=>{ loaded++; checkDone(); };
   }
 });

 startBtn.onclick=()=>{
   if(tempAudio){ try{tempAudio.pause();tempAudio.currentTime=0;}catch(e){} }
   setTimeout(()=>{
     startMainGame();
     activateFocusMode();
   },500);
 };
}

// --------------------- ขออนุญาต motion sensor ---------------------
async function requestMotionPermission(){
 if(typeof DeviceMotionEvent!=='undefined' && typeof DeviceMotionEvent.requestPermission==='function'){
   try{
     const res=await DeviceMotionEvent.requestPermission();
     if(res==='granted'){
       motionAllowed=true;
       window.addEventListener('deviceorientation',handleTilt);
       alert('✅ อนุญาตการเคลื่อนไหวแล้ว สามารถควบคุมด้วยการเอียงโทรศัพท์ได้');
     }else{
       alert('⚠️ ไม่ได้อนุญาตการเคลื่อนไหว ใช้ปุ่มแทนได้');
     }
   }catch(e){
     alert('เกิดข้อผิดพลาดในการขออนุญาตการเคลื่อนไหว');
   }
 }else{
   // Android หรือ browser ที่ไม่ต้องขออนุญาต
   motionAllowed=true;
   window.addEventListener('deviceorientation',handleTilt);
 }
}

// --------------------- ควบคุมด้วยการเอียง ---------------------
function handleTilt(e){
 if(!motionAllowed || isLocked)return;
 const goBtn=document.getElementById('goBtn');
 if(!goBtn || goBtn.disabled)return;
 const tilt=e.beta; // ค่าการเอียงไปข้างหน้า
 const now=Date.now();
 if(Math.abs(tilt)>30 && now-lastTiltTime>1500){
   lastTiltTime=now;
   toggleGoStop(goBtn);
 }
}

// --------------------- หยุดเสียงทั้งหมด ---------------------
function stopAllAudio(){
 for(let key in audios){
   try{ audios[key].pause(); audios[key].currentTime=0; }catch(e){}
 }
}

// --------------------- หน้าหลัก ---------------------
function startGameMenu(){
 deactivateFocusMode();
 isLocked=false;
 container.innerHTML=`
   <h1 tabindex="0">Squid Game - for blind</h1>
   <img src="audio/pic.png" alt="S">
   <p>คุณมี 2 ชีวิต และต้องเดินให้ครบ 20 เมตร!<br>กด "เตรียมตัว" เพื่อเริ่มโหลดเสียง</p>
   <button id="prepareBtn">เตรียมตัว</button>
 `;
 document.querySelector('h1').focus();

 document.getElementById('prepareBtn').onclick=()=>{
   if(/Android|iPhone|iPad/i.test(navigator.userAgent)){
     requestMotionPermission();
   }
   if(tempAudio){ try{tempAudio.pause();tempAudio.currentTime=0;}catch(e){} }
   tempAudio=new Audio('audio/start.mp3');
   tempAudio.play().catch(()=>{console.warn('ต้องแตะก่อนเล่นเสียงในบางเบราว์เซอร์');});
   loadAssets();
 };
}

// --------------------- แสดงเฉพาะภาพ ---------------------
function showOnlyImage(){
 container.innerHTML=`
   <img src="audio/pic.png" alt="ฉากในเกม Squid game">
   <p>Squid game : audio only</p>
 `;
}

// --------------------- เริ่มเกม ---------------------
function startMainGame(){
 deaths=0; distance=0;
 renderGameScreen();
 setTimeout(playNextRound,500);
}

function renderGameScreen(){
 if(isLocked)return;
 container.innerHTML=`
   <h1 tabindex="0">Squid Game - for blind</h1>
   <img src="audio/pic.png" alt="ฉากในเกม Squid game">
   <p id="status">ระยะทาง: ${distance.toFixed(1)} เมตร | ชีวิต: ${2-deaths}</p>
   <button id="goBtn" disabled>ไป</button>
 `;
 const goBtn=document.getElementById('goBtn');
 goBtn.focus();
 goBtn.onclick=()=>{
   if(!inGoRound||isLocked)return;
   toggleGoStop(goBtn);
 };
}

// --------------------- ปุ่ม ไป / หยุด ---------------------
function toggleGoStop(goBtn){
 if(isLocked)return;
 isGoing=!isGoing;
 goBtn.textContent=isGoing?'หยุด':'ไป';
 if(isGoing){
   startTime=Date.now();
   playerStoppedDuringGo=false;
 }else{
   if(inGoRound){
     playerStoppedDuringGo=true;
     const elapsed=(Date.now()-startTime)/1000;
     distance+=elapsed;
     if(distance>=20)return gameWin();
   }
 }
 updateStatus();
}

function updateStatus(){
 const st=document.getElementById('status');
 if(st)st.textContent='ระยะทาง: '+distance.toFixed(1)+' เมตร | ชีวิต: '+(2-deaths);
}

// --------------------- เล่นรอบใหม่ ---------------------
function playNextRound(){
 if(deaths>=2)return gameOver();
 if(distance>=20)return gameWin();
 if(isLocked)return;

 renderGameScreen();
 const goFiles=['go1.mp3','go2.mp3','go3.mp3','go4.mp3'];
 const randomFile=goFiles[Math.floor(Math.random()*goFiles.length)];
 const audio=audios[randomFile];

 inGoRound=true; isGoing=false; playerStoppedDuringGo=false;
 const goBtn=document.getElementById('goBtn');
 goBtn.disabled=false; goBtn.textContent='ไป'; goBtn.focus();

 audio.currentTime=0;
 audio.play();
 audio.onended=()=>{
   inGoRound=false;
   goBtn.disabled=true;
   const delay=100;
   setTimeout(()=>{
     if(playerStoppedDuringGo){
       playAudio('pass.mp3',()=>setTimeout(()=>{renderGameScreen();playNextRound();},1000));
     }else{
       deaths++;
       let dieSound=lastDieSound==='pass-die1.mp3'?'pass-die2.mp3':'pass-die1.mp3';
       lastDieSound=dieSound;
       playAudio(dieSound,()=>{
         if(deaths>=2)return gameOver();
         setTimeout(()=>{renderGameScreen();playNextRound();},1000);
       });
     }
     updateStatus();
   },delay);
 };
}

// --------------------- เล่นเสียง ---------------------
function playAudio(name,callback){
 const a=audios[name];
 if(!a)return callback&&callback();
 a.currentTime=0;
 a.play().then(()=>{
   a.onended=()=>callback&&callback();
 }).catch(()=>{
   console.warn('Safari ยังไม่อนุญาตให้เล่นเสียงนี้จนกว่าจะมีการแตะ');
   callback&&callback();
 });
}

// --------------------- จบเกม ---------------------
function gameOver(){
 if(isGameEnded)return;
 isGameEnded=true; isLocked=true;
 showOnlyImage(); stopAllAudio();
 setTimeout(()=>{
   playAudio('over.mp3',()=>{ deactivateFocusMode(); resetGame(); });
 },500);
}

function gameWin(){
 if(isGameEnded)return;
 isGameEnded=true; isLocked=true;
 showOnlyImage(); stopAllAudio();
 setTimeout(()=>{
   playAudio('end.mp3',()=>{ deactivateFocusMode(); resetGame(); });
 },500);
}

function resetGame(){
 deaths=0; distance=0; isGameEnded=false; isLocked=false;
 startGameMenu();
}

// --------------------- Shortcut Key ---------------------
document.addEventListener('keydown',e=>{
 if(isLocked)return;
 if(e.key==='ArrowUp'){
   const goBtn=document.getElementById('goBtn');
   if(goBtn && !goBtn.disabled && !isGoing)toggleGoStop(goBtn);
 }
});
document.addEventListener('keyup',e=>{
 if(isLocked)return;
 if(e.key==='ArrowUp'){
   const goBtn=document.getElementById('goBtn');
   if(goBtn && !goBtn.disabled && isGoing)toggleGoStop(goBtn);
 }
});

startGameMenu();
</script>
</body>
</html>
