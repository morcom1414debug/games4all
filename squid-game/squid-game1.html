<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Squid Game - for blind</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
/* ตั้งค่าพื้นฐาน */
body {
  font-family: 'Inter', sans-serif;
  text-align: center;
  background-color: #000;
  color: #fff;
  margin: 0;
  padding: 0;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}
h1 {
  font-weight: 700;
}
img {
  max-width: 300px;
  display: block;
  margin: 20px auto 10px auto;
  border-radius: 12px;
}
/* สไตล์ปุ่มทั่วไป */
button {
  font-size: 1.2em;
  padding: 10px 20px;
  margin-top: 20px;
  border-radius: 12px;
  border: none;
  background-color: #e50914; /* แดงเข้มแบบ Netflix */
  color: #fff;
  cursor: pointer;
  transition: background-color 0.3s, transform 0.1s;
  box-shadow: 0 4px 0 #9a070e;
}
button:hover { background-color: #ff3b30; }
button:active:not(:disabled) {
  transform: translateY(4px);
  box-shadow: 0 0 0 #9a070e;
}
button:disabled { background-color: #555; cursor: not-allowed; box-shadow: none; }

#gameContainer {
  margin: 50px auto;
  width: 90%;
  max-width: 600px;
  position: relative; /* ต้องมีเพื่อให้ปุ่มด้านบนซ้ายทำงานได้ */
}
.status-text { 
  font-size: 1.4em; 
  margin-top: 10px; 
  font-weight: 300;
}

/* 2. สไตล์ปุ่ม กลับเมนูหลัก */
#backToMainBtn {
  /* จัดตำแหน่งให้อยู่ด้านบนซ้ายของ gameContainer โดยเลื่อนขึ้นไปเล็กน้อย */
  position: absolute;
  top: -40px; 
  left: 0;
  background-color: #444;
  color: #fff;
  font-size: 1em;
  padding: 8px 15px;
  border-radius: 8px;
  z-index: 10;
  transition: background-color 0.3s;
  /* ลบเงาและเอฟเฟกต์กระโดดของปุ่มทั่วไปออก */
  box-shadow: none; 
  transform: none;
  text-decoration: none; /* สำหรับแท็ก a */
}
#backToMainBtn:hover {
  background-color: #666;
}
#backToMainBtn:active:not(:disabled) {
  transform: none;
  box-shadow: none;
}

/* 1. สไตล์ปุ่ม "ไป/หยุด" ขนาดใหญ่ */
#goBtn {
  font-size: 3.5em; /* ใหญ่ขึ้น */
  padding: 35px 70px; /* Padding ใหญ่ขึ้น */
  margin: 50px auto;
  width: 90%; /* กว้างขึ้นบนมือถือ */
  max-width: 450px; /* กว้างสุดบน desktop */
  display: block;
  border-radius: 20px;
  background-color: #00a86b; /* สีเขียว */
  box-shadow: 0 10px 0 #007049, 0 5px 15px rgba(0, 0, 0, 0.5);
  font-weight: 700;
}
#goBtn:hover { background-color: #00cc80; }
#goBtn:active:not(:disabled) {
  transform: translateY(10px);
  box-shadow: 0 0 0 #007049;
}
#goBtn:disabled { background-color: #555; }
</style>
</head>
<body>
<div id="gameContainer" role="main" aria-live="assertive"></div>

<script>
// ตรวจสอบตัวแปรส่วนกลางสำหรับ Firebase (ไม่ใช้สำหรับเกมนี้ แต่เป็นแนวทางปฏิบัติที่ดี)
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// ---------------- ตัวแปรเกม ----------------
const audioFiles = [
  'start.mp3', 'go1.mp3', 'go2.mp3', 'go3.mp3', 'go4.mp3',
  'pass.mp3', 'pass-die1.mp3', 'pass-die2.mp3', 'over.mp3', 'end.mp3', 'pic.png'
];

let audios = {}, deaths = 0, distance = 0, startTime = 0;
let isGoing = false, inGoRound = false, playerStoppedDuringGo = false, playerMovedThisRound = false;
let lastDieSound = '', isGameEnded = false, isLocked = false, isAudioLoaded = false;
let tempAudio = null;
let audioContext = null, safariBuffers = {};
let isIPhoneSafari = false;

const container = document.getElementById('gameContainer');

// ---------------- ฟังก์ชันช่วยในการสร้างปุ่มกลับเมนูหลัก ----------------
function getBackButtonHTML() {
  // ใช้ <a href> เพื่อให้สามารถกลับไปยัง ../index.html ได้ง่าย
  return `
    <a id="backToMainBtn" href="../index.html" role="button">
      กลับเมนูหลัก
    </a>
  `;
}

// ---------------- ตรวจจับ Safari บน iPhone ----------------
function detectIPhoneSafari() {
  const ua = navigator.userAgent;
  // ตรวจจับ iPhone/iPad/iPod และ Safari (ไม่ใช่ Chrome/Firefox บน iOS)
  return /iPhone|iPad|iPod/i.test(ua) && /Safari/i.test(ua) && !/CriOS|FxiOS|OPiOS/i.test(ua);
}

// ---------------- Focus Mode สำหรับผู้พิการทางสายตา ----------------
function activateFocusMode() {
  container.setAttribute('role', 'application');
  container.setAttribute('tabindex', '0');
  try { container.focus(); } catch (e) { }
}
function deactivateFocusMode() {
  container.removeAttribute('role');
  container.removeAttribute('tabindex');
}

// ---------------- โหลดไฟล์เสียง ----------------
async function loadAssets() {
  // หน้าโหลด/พร้อมเล่น: แสดงปุ่มกลับเมนูหลัก
  container.innerHTML = getBackButtonHTML() + `
    <img src="audio/pic.png" alt="-">
    <p id="loadText" class="status-text">กำลังโหลดไฟล์เสียง กรุณารอสักครู่...</p>
    <button id="startGameBtn" class="bg-red-600 hover:bg-red-700 disabled:bg-gray-500" disabled>เริ่มเกม</button>
  `;
  const startBtn = document.getElementById('startGameBtn');
  const loadText = document.getElementById('loadText');

  let loaded = 0, total = audioFiles.length;
  function checkDone() {
    if (loaded === total) {
      isAudioLoaded = true;
      startBtn.disabled = false;
      // 1. เปลี่ยนข้อความเมื่อโหลดเสร็จสิ้น
      loadText.textContent = 'วิธีการเล่น : กดปุ่มไปเพื่อเดิน กดปุ่มหยุดเพื่อให้ทันก่อนน้องหันมา หรือกดลูกศรขึ้นค้างไว้เพื่อเดิน ปล่อยปุ่มเพื่อหยุด!';
    }
  }

  // เตรียม AudioContext สำหรับ Safari/iOS เพื่อให้เล่นเสียงได้
  if (isIPhoneSafari) {
    if (!audioContext) {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
  }

  const bufferPreload = [
    'go1.mp3', 'go2.mp3', 'go3.mp3', 'go4.mp3',
    'pass.mp3', 'pass-die1.mp3', 'pass-die2.mp3',
    'over.mp3', 'end.mp3', 'start.mp3'
  ];

  for (const f of audioFiles) {
    if (isIPhoneSafari && bufferPreload.includes(f)) {
      try {
        const res = await fetch('audio/' + f);
        const arrBuf = await res.arrayBuffer();
        // รอการ decode ใน AudioContext
        const buf = await audioContext.decodeAudioData(arrBuf);
        safariBuffers[f] = buf;
      } catch (e) { console.warn('โหลด buffer ไม่สำเร็จ', f); }
      loaded++; checkDone();
    } else if (f.endsWith('.mp3')) {
      const a = new Audio('audio/' + f);
      a.addEventListener('canplaythrough', () => { loaded++; checkDone(); }, { once: true });
      a.load();
      audios[f] = a;
    } else {
      const img = new Image();
      img.src = 'audio/' + f;
      // Alt text ถูกกำหนดไว้ใน HTML แล้ว
      img.onload = () => { loaded++; checkDone(); };
    }
  }

  startBtn.onclick = () => {
    // *** การปรับปรุง: ซ่อนปุ่ม "เริ่มเกม" ทันทีที่กดเพื่อป้องกันการกดซ้ำ ***
    startBtn.style.display = 'none'; 
    startBtn.disabled = true; // ป้องกันการกดซ้ำซ้อน
    
    // 2. เปลี่ยนข้อความเมื่อกด "เริ่มเกม"
    if (loadText) {
      loadText.textContent = 'เดินและหยุดให้ทัน เอาชีวิตรอดกันให้ได้?';
    }

    if (tempAudio) { try { tempAudio.pause(); tempAudio.currentTime = 0; } catch (e) { } }
    // เล่นเสียง "start.mp3" ทันทีที่กดปุ่ม
    if (isIPhoneSafari) {
       playSoundSmart('start.mp3', ()=>{
          setTimeout(() => {
            startMainGame();
            activateFocusMode();
          }, 500);
       });
    } else {
      playAudio('start.mp3', ()=>{
          setTimeout(() => {
            startMainGame();
            activateFocusMode();
          }, 500);
      });
    }
  };
}

// ---------------- หยุดเสียงทั้งหมด ----------------
function stopAllAudio() {
  for (let key in audios) {
    try { audios[key].pause(); audios[key].currentTime = 0; } catch (e) { }
  }
}

// ---------------- หน้าหลัก ----------------
function startGameMenu() {
  deactivateFocusMode();
  isLocked = false;
  isIPhoneSafari = detectIPhoneSafari();
  // หน้าเริ่มต้น: แสดงปุ่มกลับเมนูหลัก
  container.innerHTML = getBackButtonHTML() + `
    <h1 tabindex="0">Squid Game - for blind</h1>
    <img src="audio/pic.png" alt="-">
    <p class="status-text">คุณมี 2 ชีวิต และต้องเดินให้ครบ 20 เมตร!<br>กด "เตรียมตัว" เพื่อเริ่มโหลดเสียง</p>
    <button id="prepareBtn">เตรียมตัว</button>
  `;
  document.querySelector('h1').focus();

  document.getElementById('prepareBtn').onclick = () => {
    loadAssets();
  };
}

// ---------------- เริ่มเกม ----------------
function startMainGame() {
  deaths = 0; distance = 0;
  // renderGameScreen() จะแสดงผลตามเดิม (ระยะทาง/ชีวิต)
  renderGameScreen(); 
  setTimeout(playNextRound, 500);
}

function renderGameScreen() {
  if (isLocked) return;
  // หน้ากำลังเล่น: ซ่อนปุ่มกลับเมนูหลัก
  container.innerHTML = `
    <h1 tabindex="0">Squid Game - for blind</h1>
    <img src="audio/pic.png" alt="-">
    <p id="status" class="status-text">ระยะทาง: ${distance.toFixed(1)} เมตร | ชีวิต: ${2 - deaths}</p>
    <button id="goBtn" disabled>ไป</button>
  `;
  const goBtn = document.getElementById('goBtn');
  goBtn.focus();
  // ใช้ 'touchstart' สำหรับ iOS/Safari เพื่อความแม่นยำในการตอบสนอง
  if (isIPhoneSafari) {
    goBtn.addEventListener('touchstart', (e) => {
      e.preventDefault(); // ป้องกันการดีเลย์ 300ms
      if (!inGoRound || isLocked) return;
      toggleGoStop(goBtn);
    });
    goBtn.addEventListener('click', (e) => {
      e.preventDefault();
      if (!inGoRound || isLocked) return;
      // ปล่อยให้ touchstart จัดการ
    });
  } else {
    goBtn.onclick = () => {
      if (!inGoRound || isLocked) return;
      toggleGoStop(goBtn);
    };
  }
}

// ---------------- ปุ่ม ไป / หยุด ----------------
function toggleGoStop(goBtn) {
  if (isLocked) return;
  if (!inGoRound) return;

  // ตรวจสอบสถานะก่อนเปลี่ยน
  const wasGoing = isGoing;
  isGoing = !isGoing;
  
  if (isGoing) {
    // เปลี่ยนจาก 'หยุด' เป็น 'ไป'
    goBtn.textContent = 'หยุด';
    goBtn.style.backgroundColor = '#e50914'; // เปลี่ยนเป็นสีแดงเมื่อ "หยุด"
    goBtn.style.boxShadow = '0 10px 0 #9a070e, 0 5px 15px rgba(0, 0, 0, 0.5)';
    
    startTime = Date.now();
    playerStoppedDuringGo = false;
    playerMovedThisRound = true; // มีการเคลื่อนไหวจริง
  } else {
    // เปลี่ยนจาก 'ไป' เป็น 'หยุด'
    goBtn.textContent = 'ไป';
    goBtn.style.backgroundColor = '#00a86b'; // เปลี่ยนเป็นสีเขียวเมื่อ "ไป"
    goBtn.style.boxShadow = '0 10px 0 #007049, 0 5px 15px rgba(0, 0, 0, 0.5)';
    
    playerStoppedDuringGo = true;
    const elapsed = (Date.now() - startTime) / 1000;
    distance += elapsed;
    updateStatus();
    if (distance >= 20) return gameWin();
  }
  updateStatus();
}

// ---------------- สถานะ ----------------
function updateStatus() {
  const st = document.getElementById('status');
  if (st) st.textContent = `ระยะทาง: ${distance.toFixed(1)} เมตร | ชีวิต: ${2 - deaths}`;
}

// ---------------- เล่นเสียง (รองรับ Safari Buffer) ----------------
async function playSoundSmart(name, callback) {
  if (isIPhoneSafari && safariBuffers[name] && audioContext) {
    try {
      await audioContext.resume();
      const src = audioContext.createBufferSource();
      src.buffer = safariBuffers[name];
      src.connect(audioContext.destination);
      src.start(0);
      src.onended = () => callback && callback();
    } catch (e) {
      console.warn('เล่น buffer ไม่ได้', name, e);
      callback && callback();
    }
  } else {
    playAudio(name, callback);
  }
}

// ---------------- เล่นรอบใหม่ ----------------
function playNextRound() {
  if (deaths >= 2) return gameOver();
  if (distance >= 20) return gameWin();
  if (isLocked) return;

  renderGameScreen();

  const goFiles = ['go1.mp3', 'go2.mp3', 'go3.mp3', 'go4.mp3'];
  const randomFile = goFiles[Math.floor(Math.random() * goFiles.length)];

  inGoRound = true;
  isGoing = false; // สถานะเริ่มต้นของรอบคือ "ยังไม่ไป"
  playerStoppedDuringGo = false;
  playerMovedThisRound = false;

  const goBtn = document.getElementById('goBtn');
  goBtn.disabled = false;
  goBtn.textContent = 'ไป'; // ข้อความเริ่มต้นคือ "ไป"
  goBtn.style.backgroundColor = '#00a86b'; // สีเขียวเริ่มต้น
  goBtn.focus();

  playSoundSmart(randomFile, () => {
    inGoRound = false;
    goBtn.disabled = true;
    goBtn.style.backgroundColor = '#555'; // ปุ่มถูกปิดใช้งาน

    // ตรวจสอบผลรอบนี้หลังเสียง go จบ
    setTimeout(() => {
      if (!playerMovedThisRound) {
        // 1. ไม่เคย “ไป” เลย (ถูกกติกา แต่ไม่เดิน)
        deaths++;
        let dieSound = lastDieSound === 'pass-die1.mp3' ? 'pass-die2.mp3' : 'pass-die1.mp3';
        lastDieSound = dieSound;
        playSoundSmart(dieSound, () => {
          if (deaths >= 2) return gameOver();
          setTimeout(() => { renderGameScreen(); playNextRound(); }, 1000);
        });
      } else if (playerStoppedDuringGo) {
        // 2. เดินแล้วหยุดถูกต้อง
        playSoundSmart('pass.mp3', () => setTimeout(() => { renderGameScreen(); playNextRound(); }, 1000));
      } else {
        // 3. เดินแต่ไม่หยุดทัน (ยังอยู่ในสถานะ isGoing)
        deaths++;
        let dieSound = lastDieSound === 'pass-die1.mp3' ? 'pass-die2.mp3' : 'pass-die1.mp3';
        lastDieSound = dieSound;
        playSoundSmart(dieSound, () => {
          if (deaths >= 2) return gameOver();
          setTimeout(() => { renderGameScreen(); playNextRound(); }, 1000);
        });
      }
      updateStatus();
    }, 100);
  });
}

// ---------------- เล่นเสียงปกติ ----------------
function playAudio(name, callback) {
  const a = audios[name];
  if (!a) return callback && callback();
  a.currentTime = 0;
  a.play().then(() => { a.onended = () => callback && callback(); }).catch(() => { callback && callback(); });
}

// ---------------- จบเกม ----------------
function gameOver() {
  if (isGameEnded) return;
  isGameEnded = true; isLocked = true;
  showOnlyImage(); stopAllAudio();
  setTimeout(async () => {
    if (isIPhoneSafari && audioContext) await audioContext.resume();
    stopAllAudio();
    playSoundSmart('over.mp3', () => {
      deactivateFocusMode();
      resetToStartScreen();
    });
  }, 500);
}

function gameWin() {
  if (isGameEnded) return;
  isGameEnded = true; isLocked = true;
  showOnlyImage(); stopAllAudio();
  setTimeout(async () => {
    if (isIPhoneSafari && audioContext) await audioContext.resume();
    stopAllAudio();
    playSoundSmart('end.mp3', () => {
      deactivateFocusMode();
      resetToStartScreen();
    });
  }, 500);
}

function showOnlyImage() {
  // หน้าจบเกม: ซ่อนปุ่มกลับเมนูหลัก
  container.innerHTML = `
    <img src="audio/pic.png" alt="-">
    <p class="status-text">Squid game : audio only</p>
  `;
}

// ---------------- กลับไปหน้าเริ่มเกม ----------------
function resetToStartScreen() {
  deaths = 0; distance = 0; isGameEnded = false; isLocked = false;
  loadAssets();
}

// ---------------- Shortcut Key (เฉพาะ PC) ----------------
document.addEventListener('keydown', e => {
  if (isLocked) return;
  if (e.key === 'ArrowUp' || e.key === ' ') { // เพิ่ม Spacebar
    e.preventDefault(); // ป้องกันการเลื่อนหน้าจอ
    const goBtn = document.getElementById('goBtn');
    if (goBtn && !goBtn.disabled && !isGoing) {
      toggleGoStop(goBtn);
    }
  }
});
document.addEventListener('keyup', e => {
  if (isLocked) return;
  if (e.key === 'ArrowUp' || e.key === ' ') { // เพิ่ม Spacebar
    e.preventDefault();
    const goBtn = document.getElementById('goBtn');
    if (goBtn && !goBtn.disabled && isGoing) {
      toggleGoStop(goBtn);
    }
  }
});

startGameMenu();
</script>
</body>
</html>
