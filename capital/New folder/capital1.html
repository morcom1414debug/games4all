<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ทายสิ๊ คำตอบคือ</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body { font-family: 'Tahoma', sans-serif; text-align: center; background: #fffaf3; color: #333; }
    .container { max-width: 420px; margin: 50px auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    input, button { width: 90%; padding: 10px; margin: 10px 0; border-radius: 8px; border: 1px solid #aaa; font-size: 16px; }
    button { background: #ffb347; border: none; color: white; font-weight: bold; cursor: pointer; }
    button:hover { background: #ffa502; }
    .question { font-size: 18px; margin: 20px 0; }
    .option { display: block; margin: 8px 0; padding: 10px; border-radius: 8px; border: 1px solid #aaa; cursor: pointer; background: #fafafa; }
    .option:hover { background: #ffeaa7; }
  </style>
</head>
<body>
  <div class="container" id="main"></div>

  <script>
  const firebaseConfig = {
    apiKey: "AIzaSyBIPeN4YUIrwM4MmFtDvT2DJ-v4toxc7tY",
    authDomain: "xo-game-134ec.firebaseapp.com",
    projectId: "xo-game-134ec",
    storageBucket: "xo-game-134ec.firebasestorage.app",
    messagingSenderId: "318375224157",
    appId: "1:318375224157:web:3ae89d6c20452f1bb77eb4",
    databaseURL: "https://xo-game-134ec-default-rtdb.asia-southeast1.firebasedatabase.app/"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ตั้งค่า
  const ROOMS_PATH = 'quizRooms'; // แยกจาก XO

  let playerName = localStorage.getItem('playerName') || '';
  let roomName = '';
  let currentQuestionIndex = 0;
  let score = 0;
  let timer;
  let isHost = false;

  const main = document.getElementById('main');

  const questions = [
    {q: 'เมืองหลวงของไทยคืออะไร', c: ['กรุงเทพมหานคร','เชียงใหม่','สงขลา'], a: 'กรุงเทพมหานคร'},
    {q: 'เมืองหลวงของญี่ปุ่นคืออะไร', c: ['โตเกียว','โอซาก้า','นาโกย่า'], a: 'โตเกียว'},
    {q: 'เมืองหลวงของฝรั่งเศสคืออะไร', c: ['ปารีส','ลีล','ลียง'], a: 'ปารีส'},
    {q: 'เมืองหลวงของอังกฤษคืออะไร', c: ['ลอนดอน','แมนเชสเตอร์','ลิเวอร์พูล'], a: 'ลอนดอน'},
    {q: 'เมืองหลวงของจีนคืออะไร', c: ['ปักกิ่ง','เซี่ยงไฮ้','ฮ่องกง'], a: 'ปักกิ่ง'},
    {q: 'เมืองหลวงของเกาหลีใต้คืออะไร', c: ['โซล','ปูซาน','แดกู'], a: 'โซล'},
    {q: 'เมืองหลวงของออสเตรเลียคืออะไร', c: ['แคนเบอร์รา','ซิดนีย์','เมลเบิร์น'], a: 'แคนเบอร์รา'},
  ];

  // หน้าแรก
  function showNameInput(){
    main.innerHTML = `<h2>ทายสิ๊ คำตอบคือ</h2><p>มาแข่งกันนะ ว่าคุณๆจะรู้ใจฉันไหม</p>
      <input id='nameInput' placeholder='ใส่ชื่อผู้เล่น' value='${playerName}'>
      <button onclick='confirmName()'>ยืนยัน</button>`;
  }

  function confirmName(){
    const name = document.getElementById('nameInput').value.trim();
    if(!name) return alert('กรุณาใส่ชื่อ');
    playerName = name;
    localStorage.setItem('playerName',name);
    showLobby();
  }

  // ล็อบบี้
  function showLobby(){
    db.ref(ROOMS_PATH).on('value',snap=>{
      const rooms = snap.val()||{};
      let list = '';
      for(const r in rooms){
        const room = rooms[r];
        if(room.started) continue;
        const count = room.players ? Object.keys(room.players).length : 0;
        if(count>0) list += `<button onclick="joinRoom('${r}')">เข้าร่วมห้อง ${r} (${count}/8)</button>`;
      }
      main.innerHTML = `<h3>ยินดีต้อนรับ ${playerName}</h3>
      <button onclick='createRoom()'>สร้างห้องใหม่</button>
      <h4>ห้องที่เปิดอยู่</h4>${list||'<p>ยังไม่มีห้อง</p>'}`;
    });
  }

  // สร้างห้อง
  function createRoom(){
    const r = prompt('ตั้งชื่อห้อง');
    if(!r) return;
    roomName = r;
    isHost = true;
    db.ref(`${ROOMS_PATH}/${roomName}`).set({started:false, host:playerName, currentQuestion:0, lastActive:Date.now()});
    joinRoom(roomName);
  }

  // เข้าห้อง
  function joinRoom(r){
    roomName = r;
    db.ref(`${ROOMS_PATH}/${roomName}/players/${playerName}`).set({score:0, joinAt:Date.now()});
    db.ref(`${ROOMS_PATH}/${roomName}/players/${playerName}`).onDisconnect().remove();

    db.ref(`${ROOMS_PATH}/${roomName}`).on('value',snap=>{
      const room = snap.val();
      if(!room){ showLobby(); return; }
      // ถ้า host หาย ให้โอนสิทธิ์
      if(!room.host || !room.players[room.host]){
        const newHost = Object.keys(room.players)[0];
        db.ref(`${ROOMS_PATH}/${roomName}/host`).set(newHost);
      }
      if(!room.started) showRoom(room);
      else startGame(room);
    });
  }

  // ห้องก่อนเริ่ม
  function showRoom(room){
    const players = room.players ? Object.keys(room.players) : [];
    const host = room.host;
    let html = `<h3>ห้อง: ${roomName}</h3><p>ผู้เล่นในห้อง (${players.length}/8)</p>`;
    players.forEach(p=> html += `<div>${p}${p===host?' (หัวหน้าห้อง)':''}</div>`);
    if(playerName===host && !room.started && players.length>=2)
      html += `<button onclick='startRoom()'>เริ่มเกม</button>`;
    html += `<button onclick='leaveRoom()'>ออกจากห้อง</button>`;
    main.innerHTML = html;
  }

  // ออกจากห้อง
  function leaveRoom(){
    db.ref(`${ROOMS_PATH}/${roomName}/players/${playerName}`).remove();
    roomName=''; showLobby();
  }

  // เริ่มเกม
  function startRoom(){
    db.ref(`${ROOMS_PATH}/${roomName}`).update({started:true, currentQuestion:0});
  }

  // เล่นเกม
  function startGame(room){
    const qIndex = room.currentQuestion || 0;
    if(qIndex >= questions.length){ showResult(room); return; }
    const q = questions[qIndex];
    showQuestion(q, room);
  }

  // แสดงคำถาม
  function showQuestion(q, room){
    let html = `<div class='question'>${q.q}</div>`;
    q.c.sort(()=>Math.random()-0.5).forEach(opt=>{
      html += `<div class='option' onclick="answer('${opt}')">${opt}</div>`;
    });
    main.innerHTML = html;
    let timeLeft = 30;
    clearInterval(timer);
    timer = setInterval(()=>{
      timeLeft--;
      if(timeLeft<=0){ clearInterval(timer); nextQuestion(); }
    },1000);
  }

  // ตอบคำถาม
  function answer(opt){
    clearInterval(timer);
    const q = questions[currentQuestionIndex];
    if(opt===q.a) score++;
    nextQuestion();
  }

  // ข้อต่อไป
  function nextQuestion(){
    currentQuestionIndex++;
    db.ref(`${ROOMS_PATH}/${roomName}/players/${playerName}/score`).set(score);
    db.ref(`${ROOMS_PATH}/${roomName}`).once('value',snap=>{
      const room = snap.val();
      if(currentQuestionIndex>=questions.length){
        db.ref(`${ROOMS_PATH}/${roomName}/finished/${playerName}`).set(true);
        const finished = room.finished ? Object.keys(room.finished).length : 0;
        const total = room.players ? Object.keys(room.players).length : 0;
        if(finished+1>=total) showResult(room);
        else main.innerHTML = '<p>รอผู้เล่นคนอื่น...</p>';
      } else {
        db.ref(`${ROOMS_PATH}/${roomName}`).update({currentQuestion:currentQuestionIndex});
        startGame({currentQuestion:currentQuestionIndex});
      }
    });
  }

  // สรุปผลคะแนน
  function showResult(room){
    let best=0; let text='';
    for(const p in room.players){
      const s = room.players[p].score||0;
      if(s>best) best=s;
    }
    for(const p in room.players){
      const s = room.players[p].score||0;
      text += `<div>${p}: ${s}</div>`;
    }
    const winners = Object.keys(room.players).filter(p=>room.players[p].score===best);
    main.innerHTML = `<h3>ผลคะแนน</h3>${text}<p>ผู้ชนะ: ${winners.join(', ')}</p><button onclick='showLobby()'>กลับหน้าแรก</button>`;
    db.ref(`${ROOMS_PATH}/${roomName}`).remove();
  }

  // เคลียร์ห้องเก่าเฉพาะ quizRooms
  setInterval(()=>{
    db.ref(ROOMS_PATH).once('value',snap=>{
      const now = Date.now();
      const rooms = snap.val()||{};
      for(const r in rooms){
        const room = rooms[r];
        const players = room.players ? Object.keys(room.players).length : 0;
        if(players===0 || (room.lastActive && now-room.lastActive>7200000))
          db.ref(`${ROOMS_PATH}/${r}`).remove();
      }
    });
  },300000);

  showNameInput();
  </script>
</body>
</html>
