<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>ทายสิ๊ คำตอบคือ</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {
  font-family: "Segoe UI", sans-serif;
  background: #fafafa;
  text-align: center;
  padding: 20px;
}
#game, #lobby, #room, #quiz, #result { display: none; }
button {
  background: #4CAF50; color: white; border: none;
  padding: 10px 20px; margin: 5px; border-radius: 6px; cursor: pointer;
}
button:hover { background: #45a049; }
input { padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
h2, h3, h1 { color: #333; }
ul { list-style: none; padding: 0; }
li { margin: 5px 0; }
</style>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
</head>
<body>
<h1 id="mainTitle" tabindex="0">ทายสิ๊ คำตอบคือ</h1>

<div id="game">
  <div id="nameInput">
    <p>ใส่ชื่อผู้เล่นก่อนนะ</p>
    <input id="playerName" placeholder="ชื่อของคุณ"><br>
    <button onclick="confirmName()">ยืนยัน</button>
  </div>

  <div id="lobby">
    <h2 id="lobbyTitle" tabindex="0">ล็อบบี้</h2>
    <button onclick="showCreateRoom()">สร้างห้องใหม่</button>
    <h3>ห้องที่เปิดอยู่</h3>
    <ul id="roomList"></ul>
  </div>

  <div id="room">
    <h2 id="roomName" tabindex="0"></h2>
    <p>ผู้เล่นในห้อง:</p>
    <ul id="playerList"></ul>
    <button id="startBtn" onclick="startGame()">เริ่มเกม</button>
  </div>

  <div id="quiz">
    <h2 id="questionText" tabindex="0"></h2>
    <div id="options"></div>
    <p id="timer"></p>
  </div>

  <div id="result">
    <h2 id="resultHeading" tabindex="0">สรุปผล</h2>
    <ul id="scoreList"></ul>
    <button onclick="requestBackToLobby()">กลับไปเลือกห้องใหม่</button>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBIPeN4YUIrwM4MmFtDvT2DJ-v4toxc7tY",
  authDomain: "xo-game-134ec.firebaseapp.com",
  projectId: "xo-game-134ec",
  storageBucket: "xo-game-134ec.firebasestorage.app",
  messagingSenderId: "318375224157",
  appId: "1:318375224157:web:3ae89d6c20452f1bb77eb4",
  databaseURL: "https://xo-game-134ec-default-rtdb.asia-southeast1.firebasedatabase.app/"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let playerName="", roomId="", playerId="", isHost=false;
let questionIndex=0, timerInterval, timeLeft=20, localAnswered=false;
let currentRoomListener=null;
let waitAudio = null;
let currentAudio = null;

const questions = [
  { q:"เมืองหลวงของไทยคืออะไร?", options:["กรุงเทพมหานคร","มาเล","คูเวตซิตี"], answer:0 },
  { q:"เมืองหลวงของกัมพูชาคืออะไร?", options:["ซาเกร็บ","โฮนีอารา","พนมเปญ"], answer:2 },
  { q:"เมืองหลวงของกาตาร์คืออะไร?", options:["อิสลามาบาด","โคนาครี","โดฮา"], answer:2 },
  { q:"เมืองหลวงของเกาหลีใต้คืออะไร?", options:["เยรูซาเลม","ปาลีกีร์","โซล"], answer:2 },
  { q:"เมืองหลวงของเกาหลีเหนือคืออะไร?", options:["ไปรยา","ฟูนาฟูตี","เปียงยาง"], answer:2 },
  { q:"เมืองหลวงของคาซัคสถานคืออะไร?", options:["พนมเปญ","โซเฟีย","อัสตานา"], answer:2 },
  { q:"เมืองหลวงของคีร์กีซสถานคืออะไร?", options:["ลักเซมเบิร์ก","โซเฟีย","บิชเคก"], answer:2 },
  { q:"เมืองหลวงของคูเวตคืออะไร?", options:["ทิมพู","บูคาเรสต์","คูเวตซิตี"], answer:2 },
  { q:"เมืองหลวงของจอร์เจียคืออะไร?", options:["ทบิลีซี","มาดริด","เนปยีดอ"], answer:0 },
  { q:"เมืองหลวงของจอร์แดนคืออะไร?", options:["ดามัสกัส","อัมมาน","ฮาราเร"], answer:1 },
  { q:"เมืองหลวงของจีนคืออะไร?", options:["ปักกิ่ง","ลอนดอน","ธากา"], answer:0 },
  { q:"เมืองหลวงของซาอุดีอาระเบียคืออะไร?", options:["บราติสลาวา","รียาด","นูกูอาโลฟา"], answer:1 },
  { q:"เมืองหลวงของซีเรียคืออะไร?", options:["มาจูโร","ดามัสกัส","รียาด"], answer:1 },
  { q:"เมืองหลวงของไซปรัสคืออะไร?", options:["นิโคเซีย","มะนิลา","แคนเบอร์รา"], answer:0 },
  { q:"เมืองหลวงของญี่ปุ่นคืออะไร?", options:["ลูบลิยานา","อึนจาเมนา","โตเกียว"], answer:2 },
  { q:"เมืองหลวงของติมอร์-เลสเตคืออะไร?", options:["ดิลี","วาดุซ","เงรุลมุด"], answer:0 },
  { q:"เมืองหลวงของตุรกีคืออะไร?", options:["กาฐมาณฑุ","อังการา","เยรูซาเลม"], answer:1 },
  { q:"เมืองหลวงของเติร์กเมนิสถานคืออะไร?", options:["อาชกาบัต","คาร์ทูม","จาการ์ตา"], answer:0 },
  { q:"เมืองหลวงของทาจิกิสถานคืออะไร?", options:["พอร์ตวิลา","เคียฟ","ดูชานเบ"], answer:2 },
  { q:"เมืองหลวงของเนปาลคืออะไร?", options:["กาฐมาณฑุ","วัลเลตตา","ทบิลีซี"], answer:0 },
  { q:"เมืองหลวงของบรูไนคืออะไร?", options:["บันดาร์เซอรีเบอกาวัน","อังการา","ซูวา"], answer:0 },
  { q:"เมืองหลวงของบังกลาเทศคืออะไร?", options:["ธากา","โลเม","ซูวา"], answer:0 },
  { q:"เมืองหลวงของบาห์เรนคืออะไร?", options:["สิงคโปร์","วาติกัน","มานามา"], answer:2 },
  { q:"เมืองหลวงของปากีสถานคืออะไร?", options:["อิสลามาบาด","นูอากช็อต","วาติกัน"], answer:0 },
  { q:"เมืองหลวงของปาเลสไตน์คืออะไร?", options:["เรคยาวิก","บราติสลาวา","เยรูซาเลม"], answer:2 },
  { q:"เมืองหลวงของพม่าคืออะไร?", options:["อาบูจา","ตูนิส","เนปยีดอ"], answer:2 },
  { q:"เมืองหลวงของฟิลิปปินส์คืออะไร?", options:["มาเล","มะนิลา","เยเรวาน"], answer:1 },
  { q:"เมืองหลวงของภูฏานคืออะไร?", options:["ทิมพู","อังการา","โคนาครี"], answer:0 },
  { q:"เมืองหลวงของมองโกเลียคืออะไร?", options:["ปอร์โต-โนโว","อูลานบาตาร์","จูบา"], answer:1 },
  { q:"เมืองหลวงของมัลดีฟส์คืออะไร?", options:["มาเล","นูอากช็อต","กัวลาลัมเปอร์"], answer:0 },
  { q:"เมืองหลวงของมาเลเซียคืออะไร?", options:["วอร์ซอ","กัวลาลัมเปอร์","อูลานบาตาร์"], answer:1 },
  { q:"เมืองหลวงของเยเมนคืออะไร?", options:["ซานา","อึนจาเมนา","กรุงเทพมหานคร"], answer:0 },
  { q:"เมืองหลวงของลาวคืออะไร?", options:["โดโดมา","เวียงจันทน์","ทาชเคนต์"], answer:1 },
  { q:"เมืองหลวงของเลบานอนคืออะไร?", options:["ปารีส","เบรุต","วินด์ฮุก"], answer:1 },
  { q:"เมืองหลวงของเวียดนามคืออะไร?", options:["เยเรวาน","สต็อกโฮล์ม","ฮานอย"], answer:2 },
  { q:"เมืองหลวงของศรีลังกาคืออะไร?", options:["โมนาโก","โมกาดิชู","ศรีชยวรรธนปุระโกฏเฏ"], answer:2 },
  { q:"เมืองหลวงของสหรัฐอาหรับเอมิเรตส์คืออะไร?", options:["บราติสลาวา","พอดกอรีตซา","อาบูดาบี"], answer:2 },
  { q:"เมืองหลวงของสิงคโปร์คืออะไร?", options:["บันดาร์เซอรีเบอกาวัน","พริสตีนา","สิงคโปร์"], answer:2 },
  { q:"เมืองหลวงของอัฟกานิสถานคืออะไร?", options:["อาชกาบัต","พอร์ตลูอิส","คาบูล"], answer:2 },
  { q:"เมืองหลวงของอาเซอร์ไบจานคืออะไร?", options:["บากู","แบกแดด","ดาการ์"], answer:0 },
  { q:"เมืองหลวงของอาร์มีเนียคืออะไร?", options:["ซูวา","เยเรวาน","อันตานานารีโว"], answer:1 },
  { q:"เมืองหลวงของอินเดียคืออะไร?", options:["นิวเดลี","คีชีเนา","เรคยาวิก"], answer:0 },
  { q:"เมืองหลวงของอินโดนีเซียคืออะไร?", options:["กาโบโรเน","จาการ์ตา","โมโรนี"], answer:1 },
  { q:"เมืองหลวงของอิรักคืออะไร?", options:["โฮนีอารา","ปราก","แบกแดด"], answer:2 },
  { q:"เมืองหลวงของอิสราเอลคืออะไร?", options:["อัสตานา","เยรูซาเลม","มาจูโร"], answer:1 },
  { q:"เมืองหลวงของอิหร่านคืออะไร?", options:["พนมเปญ","เตหะราน","ดูชานเบ"], answer:1 },
  { q:"เมืองหลวงของอุซเบกิสถานคืออะไร?", options:["อาชกาบัต","มาจูโร","ทาชเคนต์"], answer:2 },
  { q:"เมืองหลวงของโอมานคืออะไร?", options:["นีอาเม","ดูชานเบ","มัสกัต"], answer:2 },
  { q:"เมืองหลวงของคิริบาสคืออะไร?", options:["ลูซากา","ตาราวา","ซูวา"], answer:1 },
  { q:"เมืองหลวงของซามัวคืออะไร?", options:["อาปีอา","ซาเกร็บ","ดาการ์"], answer:0 },
  { q:"เมืองหลวงของตองงาคืออะไร?", options:["เยรูซาเลม","ตาราวา","นูกูอาโลฟา"], answer:2 },
  { q:"เมืองหลวงของตูวาลูคืออะไร?", options:["ฟูนาฟูตี","โคนาครี","วาดุซ"], answer:0 },
  { q:"เมืองหลวงของนิวซีแลนด์คืออะไร?", options:["เนปยีดอ","นิโคเซีย","เวลลิงตัน"], answer:2 },
  { q:"เมืองหลวงของปาปัวนิวกินีคืออะไร?", options:["บูคาเรสต์","ทิมพู","พอร์ตมอร์สบี"], answer:2 },
  { q:"เมืองหลวงของปาเลาคืออะไร?", options:["นูอากช็อต","เงรุลมุด","ตาราวา"], answer:1 },
  { q:"เมืองหลวงของฟีจีคืออะไร?", options:["ซูวา","ทาชเคนต์","โคนาครี"], answer:0 },
  { q:"เมืองหลวงของไมโครนีเชียคืออะไร?", options:["กาฐมาณฑุ","ปาลีกีร์","ปราก"], answer:1 },
  { q:"เมืองหลวงของวานูวาตูคืออะไร?", options:["ดามัสกัส","อันตานานารีโว","พอร์ตวิลา"], answer:2 },
  { q:"เมืองหลวงของหมู่เกาะโซโลมอนคืออะไร?", options:["โฮนีอารา","จาการ์ตา","เอเธนส์"], answer:0 },
  { q:"เมืองหลวงของหมู่เกาะมาร์แชลล์คืออะไร?", options:["เงรุลมุด","มาจูโร","ฟรีทาวน์"], answer:1 },
  { q:"เมืองหลวงของออสเตรเลียคืออะไร?", options:["เวียนนา","จาการ์ตา","แคนเบอร์รา"], answer:2 },
  { q:"เมืองหลวงของกรีซคืออะไร?", options:["เอเธนส์","อึนจาเมนา","วาติกัน"], answer:0 },
  { q:"เมืองหลวงของคอซอวอคืออะไร?", options:["บากู","ลูซากา","พริสตีนา"], answer:2 },
  { q:"เมืองหลวงของโครเอเชียคืออะไร?", options:["ซูวา","ซาเกร็บ","โตเกียว"], answer:1 },
  { q:"เมืองหลวงของเช็กเกียคืออะไร?", options:["โตเกียว","วัลเลตตา","ปราก"], answer:2 },
  { q:"เมืองหลวงของซานมารีโนคืออะไร?", options:["โดโดมา","ปอร์โต-โนโว","ซานมารีโน"], answer:2 },
  { q:"เมืองหลวงของเซอร์เบียคืออะไร?", options:["อาบูจา","บันดาร์เซอรีเบอกาวัน","เบลเกรด"], answer:2 },
  { q:"เมืองหลวงของเดนมาร์กคืออะไร?", options:["แคนเบอร์รา","โคเปนเฮเกน","อาชกาบัต"], answer:1 },
  { q:"เมืองหลวงของนครรัฐวาติกันคืออะไร?", options:["ซาเกร็บ","วาติกัน","ปักกิ่ง"], answer:1 },
  { q:"เมืองหลวงของนอร์เวย์คืออะไร?", options:["ออสโล","กีเตกา","ไปรยา"], answer:0 },
  { q:"เมืองหลวงของเนเธอร์แลนด์คืออะไร?", options:["วัลเลตตา","เวลลิงตัน","อัมสเตอร์ดัม"], answer:2 },
  { q:"เมืองหลวงของบอสเนียและเฮอร์เซโกวีนาคืออะไร?", options:["ซาราเยโว","ติรานา","เบรุต"], answer:0 },
  { q:"เมืองหลวงของบัลแกเรียคืออะไร?", options:["ฮาราเร","วัลเลตตา","โซเฟีย"], answer:2 },
  { q:"เมืองหลวงของเบลเยียมคืออะไร?", options:["ฮาราเร","เนปยีดอ","บรัสเซลส์"], answer:2 },
  { q:"เมืองหลวงของเบลารุสคืออะไร?", options:["โคเปนเฮเกน","วินด์ฮุก","มินสค์"], answer:2 },
  { q:"เมืองหลวงของโปรตุเกสคืออะไร?", options:["ลิสบอน","พริสตีนา","อาชกาบัต"], answer:0 },
  { q:"เมืองหลวงของโปแลนด์คืออะไร?", options:["วอร์ซอ","เยเรวาน","โมโรนี"], answer:0 },
  { q:"เมืองหลวงของฝรั่งเศสคืออะไร?", options:["ปารีส","ปอร์โต-โนโว","โดฮา"], answer:0 },
  { q:"เมืองหลวงของฟินแลนด์คืออะไร?", options:["ฮานอย","เฮลซิงกิ","มะนิลา"], answer:1 },
  { q:"เมืองหลวงของมอนเตเนโกรคืออะไร?", options:["พอดกอรีตซา","บากู","ทิมพู"], answer:0 },
  { q:"เมืองหลวงของมอลโดวาคืออะไร?", options:["ลักเซมเบิร์ก","พอร์ตมอร์สบี","คีชีเนา"], answer:2 },
  { q:"เมืองหลวงของมอลตาคืออะไร?", options:["โมกาดิชู","วัลเลตตา","วินด์ฮุก"], answer:1 },
  { q:"เมืองหลวงของมาซิโดเนียเหนือคืออะไร?", options:["โคนาครี","สกอเปีย","อิสลามาบาด"], answer:1 },
  { q:"เมืองหลวงของโมนาโกคืออะไร?", options:["มอสโก","กรุงเทพมหานคร","โมนาโก"], answer:2 },
  { q:"เมืองหลวงของยูเครนคืออะไร?", options:["เคียฟ","นิวเดลี","ไนโรบี"], answer:0 },
  { q:"เมืองหลวงของเยอรมนีคืออะไร?", options:["โดฮา","อูลานบาตาร์","เบอร์ลิน"], answer:2 },
  { q:"เมืองหลวงของรัสเซียคืออะไร?", options:["อัมมาน","มอสโก","แบร์น"], answer:1 },
  { q:"เมืองหลวงของโรมาเนียคืออะไร?", options:["เวียงจันทน์","บันจูล","บูคาเรสต์"], answer:2 },
  { q:"เมืองหลวงของลักเซมเบิร์กคืออะไร?", options:["ปักกิ่ง","ลักเซมเบิร์ก","ลูบลิยานา"], answer:1 },
  { q:"เมืองหลวงของลัตเวียคืออะไร?", options:["รีกา","มะนิลา","ซาเกร็บ"], answer:0 },
  { q:"เมืองหลวงของลิทัวเนียคืออะไร?", options:["บากู","แคนเบอร์รา","วิลนีอัส"], answer:2 },
  { q:"เมืองหลวงของลีชเทินชไตน์คืออะไร?", options:["บิชเคก","อักกรา","วาดุซ"], answer:2 },
  { q:"เมืองหลวงของสเปนคืออะไร?", options:["ซาเกร็บ","มาดริด","อักกรา"], answer:1 },
  { q:"เมืองหลวงของสโลวาเกียคืออะไร?", options:["เวียนนา","ทิมพู","บราติสลาวา"], answer:2 },
  { q:"เมืองหลวงของสโลวีเนียคืออะไร?", options:["ลูบลิยานา","ฟูนาฟูตี","ปาลีกีร์"], answer:0 },
  { q:"เมืองหลวงของสวิตเซอร์แลนด์คืออะไร?", options:["เฮลซิงกิ","โฮนีอารา","แบร์น"], answer:2 },
  { q:"เมืองหลวงของสวีเดนคืออะไร?", options:["สต็อกโฮล์ม","เรคยาวิก","อาปีอา"], answer:0 },
  { q:"เมืองหลวงของสหราชอาณาจักรคืออะไร?", options:["ลอนดอน","ซาราเยโว","อาชกาบัต"], answer:0 },
  { q:"เมืองหลวงของออสเตรียคืออะไร?", options:["นูอากช็อต","เคียฟ","เวียนนา"], answer:2 },
  { q:"เมืองหลวงของอันดอร์ราคืออะไร?", options:["อันดอร์ราลาเวยา","เบลเกรด","เตหะราน"], answer:0 },
  { q:"เมืองหลวงของอิตาลีคืออะไร?", options:["โรม","อัมมาน","ทิมพู"], answer:0 },
  { q:"เมืองหลวงของเอสโตเนียคืออะไร?", options:["คีชีเนา","ทาลลินน์","ลักเซมเบิร์ก"], answer:1 },
  { q:"เมืองหลวงของแอลเบเนียคืออะไร?", options:["ตาราวา","ติรานา","เวียนนา"], answer:1 },
  { q:"เมืองหลวงของไอซ์แลนด์คืออะไร?", options:["ยามูซูโกร","เรคยาวิก","กรุงเทพมหานคร"], answer:1 },
  { q:"เมืองหลวงของไอร์แลนด์คืออะไร?", options:["บันจูล","บราติสลาวา","ดับลิน"], answer:2 },
  { q:"เมืองหลวงของฮังการีคืออะไร?", options:["บูดาเปสต์","คีชีเนา","ซานา"], answer:0 },
  { q:"เมืองหลวงของกานาคืออะไร?", options:["อักกรา","วินด์ฮุก","พอดกอรีตซา"], answer:0 },
  { q:"เมืองหลวงของกาบองคืออะไร?", options:["ลีเบรอวีล","โมนาโก","เรคยาวิก"], answer:0 },
  { q:"เมืองหลวงของกาบูเวร์ดีคืออะไร?", options:["ไปรยา","อาปีอา","เวียงจันทน์"], answer:0 },
  { q:"เมืองหลวงของกินีคืออะไร?", options:["ปารีส","โคนาครี","เยรูซาเลม"], answer:1 },
  { q:"เมืองหลวงของกินี-บิสเซาคืออะไร?", options:["บรัสเซลส์","ปารีส","บิสเซา"], answer:2 },
  { q:"เมืองหลวงของแกมเบียคืออะไร?", options:["บันจูล","จูบา","สกอเปีย"], answer:0 },
  { q:"เมืองหลวงของโกตดิวัวร์คืออะไร?", options:["อาบูจา","ยามูซูโกร","เงรุลมุด"], answer:1 },
  { q:"เมืองหลวงของคอโมโรสคืออะไร?", options:["โมโรนี","ธากา","โซเฟีย"], answer:0 },
  { q:"เมืองหลวงของเคนยาคืออะไร?", options:["ไนโรบี","อิสลามาบาด","แคนเบอร์รา"], answer:0 },
  { q:"เมืองหลวงของแคเมอรูนคืออะไร?", options:["พอร์ตวิลา","นูกูอาโลฟา","ยาอุนเด"], answer:2 },
  { q:"เมืองหลวงของจิบูตีคืออะไร?", options:["พริสตีนา","จิบูตี","รียาด"], answer:1 },
  { q:"เมืองหลวงของชาดคืออะไร?", options:["จิบูตี","อึนจาเมนา","อักกรา"], answer:1 },
  { q:"เมืองหลวงของซิมบับเวคืออะไร?", options:["ตูนิส","ฮาราเร","เวียนนา"], answer:1 },
  { q:"เมืองหลวงของซูดานคืออะไร?", options:["พนมเปญ","สิงคโปร์","คาร์ทูม"], answer:2 },
  { q:"เมืองหลวงของซูดานใต้คืออะไร?", options:["จูบา","ปาลีกีร์","เตหะราน"], answer:0 },
  { q:"เมืองหลวงของเซเชลส์คืออะไร?", options:["ซาเกร็บ","ดามัสกัส","วิกทอเรีย"], answer:2 },
  { q:"เมืองหลวงของเซเนกัลคืออะไร?", options:["ดาการ์","ฮานอย","ฮาราเร"], answer:0 },
  { q:"เมืองหลวงของเซาตูแมอีปริงซีปคืออะไร?", options:["เซาตูแม","วินด์ฮุก","โมโรนี"], answer:0 },
  { q:"เมืองหลวงของเซียร์ราลีโอนคืออะไร?", options:["ฟรีทาวน์","วิกทอเรีย","เยเรวาน"], answer:0 },
  { q:"เมืองหลวงของแซมเบียคืออะไร?", options:["ลูซากา","ซาเกร็บ","อัมสเตอร์ดัม"], answer:0 },
  { q:"เมืองหลวงของโซมาเลียคืออะไร?", options:["อัมสเตอร์ดัม","โมกาดิชู","เอเธนส์"], answer:1 },
  { q:"เมืองหลวงของตูนิเซียคืออะไร?", options:["ตูนิส","แคนเบอร์รา","บรัสเซลส์"], answer:0 },
  { q:"เมืองหลวงของโตโกคืออะไร?", options:["วัลเลตตา","อันตานานารีโว","โลเม"], answer:2 },
  { q:"เมืองหลวงของแทนซาเนียคืออะไร?", options:["มาจูโร","โดโดมา","คาบูล"], answer:1 },
  { q:"เมืองหลวงของนามิเบียคืออะไร?", options:["วินด์ฮุก","อังการา","เงรุลมุด"], answer:0 },
  { q:"เมืองหลวงของไนจีเรียคืออะไร?", options:["อาบูจา","อันตานานารีโว","เคียฟ"], answer:0 },
  { q:"เมืองหลวงของไนเจอร์คืออะไร?", options:["นีอาเม","เวลลิงตัน","ดิลี"], answer:0 },
  { q:"เมืองหลวงของบอตสวานาคืออะไร?", options:["ลอนดอน","กาโบโรเน","อัสตานา"], answer:1 },
  { q:"เมืองหลวงของบุรุนดีคืออะไร?", options:["กีเตกา","วอร์ซอ","วิลนีอัส"], answer:0 },
  { q:"เมืองหลวงของบูร์กินาฟาโซคืออะไร?", options:["ปาลีกีร์","วากาดูกู","นูอากช็อต"], answer:1 },
  { q:"เมืองหลวงของเบนินคืออะไร?", options:["บันจูล","ปอร์โต-โนโว","ออสโล"], answer:1 },
  { q:"เมืองหลวงของมอริเชียสคืออะไร?", options:["พอร์ตลูอิส","อันดอร์ราลาเวยา","มอสโก"], answer:0 },
  { q:"เมืองหลวงของมอริเตเนียคืออะไร?", options:["จาการ์ตา","คาร์ทูม","นูอากช็อต"], answer:2 },
  { q:"เมืองหลวงของมาดากัสการ์คืออะไร?", options:["บิชเคก","โรม","อันตานานารีโว"], answer:2 }
];

document.getElementById("game").style.display="block";

// ===== Audio utilities =====
function stopCurrentAudio(){
  try{
    if(currentAudio){
      currentAudio.pause();
      currentAudio.currentTime = 0;
      currentAudio = null;
    }
  }catch(e){}
}
function playSound(name){
  stopCurrentAudio();
  try{
    const a = new Audio(`audio/${name}.mp3`);
    a.play().catch(()=>{});
    currentAudio = a;
    return a;
  }catch(e){
    return null;
  }
}

// ลบ playWaitSound ออกทั้งหมด เพราะไม่ใช้แล้ว

// ===== UI / focus helpers =====
function focusHeading(id){
  setTimeout(()=>{
    const el = document.getElementById(id);
    if(el){
      el.setAttribute('tabindex', '-1');
      el.focus();
      setTimeout(() => el.focus(), 100);
    }
  }, 100);
}

// ===== flow ของเกม =====
function confirmName(){
  playerName=document.getElementById("playerName").value.trim();
  if(!playerName){ alert("กรุณาใส่ชื่อ"); return; }
  playerId=Math.random().toString(36).substr(2,9);
  document.getElementById("nameInput").style.display="none";
  document.getElementById("lobby").style.display="block";
  focusHeading("lobbyTitle");
  loadRooms();
}

function loadRooms(){
  const list=document.getElementById("roomList");
  db.ref("guessGameRooms").on("value", snap=>{
    list.innerHTML="";
    snap.forEach(r=>{
      const room = r.val();
      if(room.status==="waiting"){
        const li = document.createElement("li");
        li.textContent = `${room.name} (${room.players?Object.keys(room.players).length:0} คน)`;
        const btn = document.createElement("button");
        btn.textContent="เข้าร่วม";
        btn.onclick = ()=>joinRoom(r.key);
        li.appendChild(btn);
        list.appendChild(li);
      }
    });
  });
}

function showCreateRoom(){
  const name = prompt("ตั้งชื่อห้อง:");
  if(!name) return;
  const ref = db.ref("guessGameRooms").push();
  roomId = ref.key; isHost = true;
  ref.set({name, status:"waiting", host:playerId, created:Date.now(), players:{}});
  joinRoom(roomId);
}

function joinRoom(id){
  roomId = id;
  const ref = db.ref(`guessGameRooms/${roomId}/players/${playerId}`);
  ref.set({name:playerName, score:0, answered:false});
  ref.onDisconnect().remove();
  db.ref(`guessGameRooms/${roomId}/lastJoin`).set(Date.now());
  showRoom();
}

function showRoom(){
  document.getElementById("lobby").style.display="none";
  document.getElementById("room").style.display="block";
  focusHeading("roomName");

  if(currentRoomListener) currentRoomListener.off();
  currentRoomListener = db.ref(`guessGameRooms/${roomId}`);
  currentRoomListener.on("value", snap=>{
    const room = snap.val();
    if(!room){ alert("ห้องถูกลบแล้ว"); backToLobby(); return; }

    document.getElementById("roomName").textContent = `ห้อง: ${room.name}`;
    const list = document.getElementById("playerList"); list.innerHTML="";
    if(room.players){
      for(let id in room.players){
        const li = document.createElement("li");
        li.textContent = `${room.players[id].name} (${room.players[id].score} คะแนน)`;
        list.appendChild(li);
      }
    }

    document.getElementById("startBtn").style.display = room.host===playerId ? "inline" : "none";

    if(room.lastJoin && (!window._lastJoinTime || room.lastJoin !== window._lastJoinTime)){
      window._lastJoinTime = room.lastJoin;
      stopCurrentAudio();
      playSound("friend");
    }

    if(room.lastBackToLobby && (!window._lastBackTime || room.lastBackToLobby !== window._lastBackTime)){
      window._lastBackTime = room.lastBackToLobby;
      stopCurrentAudio();
      playSound("door");
    }

    if(room.status==="playing") startQuiz();
    else if(room.status==="finished") showResult(room);
  });
}

function startGame(){
  stopCurrentAudio();
  playSound("start");
  db.ref(`guessGameRooms/${roomId}`).update({
    status:"playing", current:0, questions:getRandomQuestions(7)
  });
}

function getRandomQuestions(n){
  const copy = [...questions];
  const res = [];
  for(let i=0;i<n;i++){
    const idx = Math.floor(Math.random()*copy.length);
    let q = copy.splice(idx,1)[0];
    const opts = [...q.options];
    const correctText = opts[q.answer];
    shuffleArray(opts);
    q.answer = opts.indexOf(correctText);
    q.options = opts;
    res.push(q);
  }
  return res;
}
function shuffleArray(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
}

function startQuiz(){
  document.getElementById("room").style.display="none";
  document.getElementById("quiz").style.display="block";
  document.getElementById("mainTitle").style.display="none";
  db.ref(`guessGameRooms/${roomId}`).once("value").then(snap=>{
    const data = snap.val();
    questionIndex = data.current || 0;
    showQuestion(data.questions[questionIndex]);
  });
}

function showQuestion(q){
  if(!q){ if(isHost) endGameHost(); return; }
  localAnswered=false;
  timeLeft = Math.floor(Math.random()*11)+15;
  document.getElementById("questionText").textContent = `ข้อที่ ${questionIndex+1}: ${q.q}`;
  
  focusHeading("questionText");
  
  const opts=document.getElementById("options");
  opts.innerHTML="";
  q.options.forEach((opt,i)=>{
    const b=document.createElement("button");
    b.textContent = opt;
    b.onclick = ()=>submitAnswer(i);
    opts.appendChild(b);
  });
  document.getElementById("timer").textContent = `เวลา: ${timeLeft}`;
  clearInterval(timerInterval);
  timerInterval = setInterval(()=>{
    timeLeft--;
    document.getElementById("timer").textContent = `เวลา: ${timeLeft}`;
    if(timeLeft<=0){ clearInterval(timerInterval); nextQuestion(); }
  },1000);
}

function submitAnswer(index){
  if(localAnswered) return;
  localAnswered = true;
  playSound("pop");

  db.ref(`guessGameRooms/${roomId}`).once("value").then(snap=>{
    const data=snap.val();
    const q=data.questions[data.current];
    const correct = (index===q.answer);
    if(correct){
      db.ref(`guessGameRooms/${roomId}/players/${playerId}/score`).transaction(v=>(v||0)+1);
    }
    db.ref(`guessGameRooms/${roomId}/players/${playerId}/answered`).set(true);
    checkAllAnswered();
  });
}

function checkAllAnswered(){
  db.ref(`guessGameRooms/${roomId}`).once("value").then(snap=>{
    const data = snap.val();
    const players = data.players || {};
    const allAnswered = Object.values(players).every(p=>p.answered);
    if(allAnswered){
      clearInterval(timerInterval);
      if(data.current < data.questions.length - 1){
        setTimeout(() => playSound("next"), 500);
      }
      nextQuestion();
    }
  });
}

function nextQuestion(){
  db.ref(`guessGameRooms/${roomId}`).once("value").then(snap=>{
    const data=snap.val();
    if(!data) return;
    const players = data.players || {};
    for(let id in players){
      db.ref(`guessGameRooms/${roomId}/players/${id}/answered`).set(false);
    }
    const next = data.current + 1;

    if(next < data.questions.length){
      db.ref(`guessGameRooms/${roomId}`).update({current: next});
      questionIndex = next;
      showQuestion(data.questions[next]);
    }else{
      // ทุกคนตอบครบข้อสุดท้าย → Host ส่งผลทันที!
      if(isHost) endGameHost(); // ส่งผลเลย ไม่รอเสียง
    }
  });
}

// ปรับให้ host ส่งผลทันที ไม่รออะไรเลย
function endGameHost(){
  clearInterval(timerInterval);
  db.ref(`guessGameRooms/${roomId}`).once("value").then(snap=>{
    const room = snap.val();
    if(!room || !room.players) return;
    const players = Object.values(room.players);
    players.sort((a,b)=>b.score-a.score);
    const max = players[0].score;
    const winners = players.filter(p=>p.score===max).map(p=>p.name);

    // ส่งผลทันที + เล่นเสียงชนะ
    db.ref(`guessGameRooms/${roomId}`).update({
      status:"finished",
      result:{winners, players}
    });
    playSound("new4"); // เสียงชนะทันที
  });
}

function showResult(roomData){
  clearInterval(timerInterval);
  document.getElementById("quiz").style.display="none";
  document.getElementById("result").style.display="block";
  document.getElementById("mainTitle").style.display="none";

  stopCurrentAudio();
  playSound("new4"); // ทุกคนได้ยินพร้อมกัน

  const list = document.getElementById("scoreList");
  list.innerHTML = "";
  const players = roomData.result?.players || [];
  const winners = roomData.result?.winners || [];
  document.getElementById("resultHeading").textContent =
    `สรุปผล ผู้ชนะคือ ${winners.join(", ")}`;

  players.forEach(p=>{
    const li = document.createElement("li");
    li.textContent = `${p.name}: ${p.score} คะแนน`;
    list.appendChild(li);
  });

  focusHeading("resultHeading");
}

function requestBackToLobby(){
  db.ref(`guessGameRooms/${roomId}/lastBackToLobby`).set(Date.now());
  backToLobby();
}

function backToLobby(){
  if(currentRoomListener){ currentRoomListener.off(); currentRoomListener = null; }
  db.ref(`guessGameRooms/${roomId}/players/${playerId}`).remove();
  roomId = "";
  questionIndex = 0;
  document.getElementById("result").style.display="none";
  document.getElementById("room").style.display="none";
  document.getElementById("quiz").style.display="none";
  document.getElementById("mainTitle").style.display="block";
  document.getElementById("lobby").style.display="block";
  focusHeading("lobbyTitle");
  loadRooms();
}

setInterval(()=>{
  db.ref("guessGameRooms").once("value").then(snap=>{
    snap.forEach(r=>{
      const data = r.val();
      if(!data.players || Object.keys(data.players).length===0){
        db.ref(`guessGameRooms/${r.key}`).remove();
      }
    });
  });
},300000);
</script>
</body>
</html>