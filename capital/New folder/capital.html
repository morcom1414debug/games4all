<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>ทายสิ๊ คำตอบคือ</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {
  font-family: "Segoe UI", sans-serif;
  background: #fafafa;
  text-align: center;
  padding: 20px;
}
#game, #lobby, #room, #quiz, #result { display: none; }
button {
  background: #4CAF50; color: white; border: none;
  padding: 10px 20px; margin: 5px; border-radius: 6px; cursor: pointer;
}
button:hover { background: #45a049; }
input { padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
h2, h3, h1 { color: #333; }
ul { list-style: none; padding: 0; }
li { margin: 5px 0; }
</style>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
</head>
<body>
<h1 id="mainTitle" tabindex="0">ทายสิ๊ คำตอบคือ</h1>

<div id="game">
  <div id="nameInput">
    <p>ใส่ชื่อผู้เล่นก่อนนะ</p>
    <input id="playerName" placeholder="ชื่อของคุณ"><br>
    <button onclick="confirmName()">ยืนยัน</button>
  </div>

  <div id="lobby">
    <h2 id="lobbyTitle" tabindex="0">ล็อบบี้</h2>
    <button onclick="showCreateRoom()">สร้างห้องใหม่</button>
    <h3>ห้องที่เปิดอยู่</h3>
    <ul id="roomList"></ul>
  </div>

  <div id="room">
    <h2 id="roomName" tabindex="0"></h2>
    <p>ผู้เล่นในห้อง:</p>
    <ul id="playerList"></ul>
    <button id="startBtn" onclick="startGame()">เริ่มเกม</button>
  </div>

  <div id="quiz">
    <h2 id="questionText" tabindex="0"></h2>
    <div id="options"></div>
    <p id="timer"></p>
  </div>

  <div id="result">
    <h2 id="resultHeading" tabindex="0">สรุปผล</h2>
    <ul id="scoreList"></ul>
    <button onclick="requestBackToLobby()">กลับไปเลือกห้องใหม่</button>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBIPeN4YUIrwM4MmFtDvT2DJ-v4toxc7tY",
  authDomain: "xo-game-134ec.firebaseapp.com",
  projectId: "xo-game-134ec",
  storageBucket: "xo-game-134ec.firebasestorage.app",
  messagingSenderId: "318375224157",
  appId: "1:318375224157:web:3ae89d6c20452f1bb77eb4",
  databaseURL: "https://xo-game-134ec-default-rtdb.asia-southeast1.firebasedatabase.app/"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let playerName="", roomId="", playerId="", isHost=false;
let questionIndex=0, timerInterval, timeLeft=20, localAnswered=false;
let currentRoomListener=null;
let waitAudio = null;
let currentAudio = null;

// === คำถามทั้งหมด 98 ข้อ (อาเซียนครบ 10 + เอเชียครบเกือบทุกประเทศ) ===
const questions = [
  { q:"เมืองหลวงของไทยคืออะไร?", options:["กรุงเทพมหานคร","โตเกียว","ปารีส"], answer:0 },
  { q:"เมืองหลวงของญี่ปุ่นคืออะไร?", options:["ปักกิ่ง","โตเกียว","โซล"], answer:1 },
  { q:"เมืองหลวงของจีนคืออะไร?", options:["ปักกิ่ง","เซี่ยงไฮ้","ฮ่องกง"], answer:0 },
  { q:"เมืองหลวงของฝรั่งเศสคืออะไร?", options:["ลอนดอน","ปารีส","เบอร์ลิน"], answer:1 },
  { q:"เมืองหลวงของอังกฤษคืออะไร?", options:["ลอนดอน","แมนเชสเตอร์","เอดินบะระ"], answer:0 },
  { q:"เมืองหลวงของเยอรมนีคืออะไร?", options:["มิวนิก","เบอร์ลิน","ฮัมบวร์ก"], answer:1 },
  { q:"เมืองหลวงของสหรัฐอเมริกาคืออะไร?", options:["นิวยอร์ก","วอชิงตัน ดี.ซี.","ลอสแอนเจลิส"], answer:1 },
  { q:"เมืองหลวงของรัสเซียคืออะไร?", options:["มอสโก","เซนต์ปีเตอร์สเบิร์ก","โนโวซีบีร์สค์"], answer:0 },
  { q:"เมืองหลวงของอินเดียคืออะไร?", options:["มุมไบ","นิวเดลี","บังกาลอร์"], answer:1 },
  { q:"เมืองหลวงของบราซิลคืออะไร?", options:["รีโอเดจาเนโร","เซาเปาโล","บราซิเลีย"], answer:2 },
  { q:"เมืองหลวงของออสเตรเลียคืออะไร?", options:["ซิดนีย์","เมลเบิร์น","แคนเบอร์รา"], answer:2 },
  { q:"เมืองหลวงของแคนาดาคืออะไร?", options:["โตรอนโต","ออตตาวา","แวนคูเวอร์"], answer:1 },
  { q:"เมืองหลวงของอิตาลีคืออะไร?", options:["มิลาน","โรม","เวนิส"], answer:1 },
  { q:"เมืองหลวงของสเปนคืออะไร?", options:["บาร์เซโลนา","มาดริด","วาเลนเซีย"], answer:1 },
  { q:"เมืองหลวงของเกาหลีใต้คืออะไร?", options:["ปูซาน","โซล","อินชอน"], answer:1 },
  { q:"เมืองหลวงของเม็กซิโกคืออะไร?", options:["กวาดาลาฮารา","เม็กซิโกซิตี","มอนเตร์เรย์"], answer:1 },
  { q:"เมืองหลวงของอาร์เจนตินาคืออะไร?", options:["บัวโนสไอเรส","คอร์โดบา","โรซาริโอ"], answer:0 },
  { q:"เมืองหลวงของอียิปต์คืออะไร?", options:["อเล็กซานเดรีย","ไคโร","ลักซอร์"], answer:1 },
  { q:"เมืองหลวงของตุรกีคืออะไร?", options:["อิสตันบูล","อังการา","อิซเมียร์"], answer:1 },
  { q:"เมืองหลวงของซาอุดีอาระเบียคืออะไร?", options:["เจดดาห์","รียาด","เมกกะ"], answer:1 },
  { q:"เมืองหลวงของอินโดนีเซียคืออะไร?", options:["บาหลี","จาการ์ตา","สุราบายา"], answer:1 },
  { q:"เมืองหลวงของเกาหลีเหนือคืออะไร?", options:["เปียงยาง","ฮัมฮึง","ชองจิน"], answer:0 },
  { q:"เมืองหลวงของเวียดนามคืออะไร?", options:["โฮจิมินห์","ฮานอย","ดานัง"], answer:1 },
  { q:"เมืองหลวงของมาเลเซียคืออะไร?", options:["ปีนัง","กัวลาลัมเปอร์","โจโฮร์บาห์รู"], answer:1 },
  { q:"เมืองหลวงของสิงคโปร์คืออะไร?", options:["สิงคโปร์","เซ็นโตซา","จูรง"], answer:0 },
  { q:"เมืองหลวงของฟิลิปปินส์คืออะไร?", options:["เซบู","มะนิลา","ดาเวา"], answer:1 },
  { q:"เมืองหลวงของนิวซีแลนด์คืออะไร?", options:["โอคแลนด์","เวลลิงตัน","ไครสต์เชิร์ช"], answer:1 },
  { q:"เมืองหลวงของสวีเดนคืออะไร?", options:["กอเทนเบิร์ก","สต็อกโฮล์ม","มัลโม"], answer:1 },
  { q:"เมืองหลวงของนอร์เวย์คืออะไร?", options:["เบอร์เกน","ออสโล","ทรอมเซอ"], answer:1 },
  { q:"เมืองหลวงของเดนมาร์กคืออะไร?", options:["ออร์ฮูส","โคเปนเฮเกน","โอเดนเซ"], answer:1 },
  { q:"เมืองหลวงของเนเธอร์แลนด์คืออะไร?", options:["ร็อตเตอร์ดัม","อัมสเตอร์ดัม","เฮก"], answer:1 },
  { q:"เมืองหลวงของเบลเยียมคืออะไร?", options:["แอนต์เวิร์ป","บรัสเซลส์","เกนต์"], answer:1 },
  { q:"เมืองหลวงของสวิตเซอร์แลนด์คืออะไร?", options:["ซูริก","เจนีวา","แบร์น"], answer:2 },
  { q:"เมืองหลวงของโปรตุเกสคืออะไร?", options:["ปอร์โต","ลิสบอน","ฟาโร"], answer:1 },
  { q:"เมืองหลวงของโปแลนด์คืออะไร?", options:["คราคูฟ","วอร์ซอ","กดัญสก์"], answer:1 },
  { q:"เมืองหลวงของยูเครนคืออะไร?", options:["คาร์คีฟ","เคียฟ","โอเดสซา"], answer:1 },
  { q:"เมืองหลวงของกรีซคืออะไร?", options:["เทสซาโลนิกี","เอเธนส์","พาทรัส"], answer:1 },
  { q:"เมืองหลวงของโรมาเนียคืออะไร?", options:["คลูช-นาโปกา","บูคาเรสต์","ทิมิชวารา"], answer:1 },
  { q:"เมืองหลวงของฮังการีคืออะไร?", options:["เดเบรเซน","บูดาเปสต์","มิชโคลซ์"], answer:1 },
  { q:"เมืองหลวงของเช็กเกียคืออะไร?", options:["บรัสลาฟ","ปราก","ออสตราวา"], answer:1 },
  { q:"เมืองหลวงของออสเตรียคืออะไร?", options:["ซาลซ์บวร์ก","เวียนนา","กราซ"], answer:1 },
  { q:"เมืองหลวงของไอร์แลนด์คืออะไร?", options:["คอร์ก","ดับลิน","กัลเวย์"], answer:1 },
  { q:"เมืองหลวงของฟินแลนด์คืออะไร?", options:["ตัมเปเร","เฮลซิงกิ","ตูร์กุ"], answer:1 },
  { q:"เมืองหลวงของชิลีคืออะไร?", options:["วัลปารัยโซ","ซานเตียโก","คอนเซปซิออน"], answer:1 },
  { q:"เมืองหลวงของเปรูคืออะไร?", options:["กุสโก","ลิมา","อาเรกิปา"], answer:1 },
  { q:"เมืองหลวงของโคลอมเบียคืออะไร?", options:["เมเดยิน","โบโกตา","กาลี"], answer:1 },
  { q:"เมืองหลวงของเวเนซุเอลาคืออะไร?", options:["มาราไกโบ","การากัส","วาเลนเซีย"], answer:1 },
  { q:"เมืองหลวงของแอฟริกาใต้คืออะไร?", options:["เคปทาวน์","โจฮันเนสเบิร์ก","พริทอเรีย"], answer:2 },
  { q:"เมืองหลวงของไนจีเรียคืออะไร?", options:["ลากอส","อาบูจา","คาโน"], answer:1 },
  { q:"เมืองหลวงของเคนยาคืออะไร?", options:["มอมบาซา","ไนโรบี","คิสumu"], answer:1 },
  { q:"เมืองหลวงของกานาคืออะไร?", options:["คูมาซี","อักกรา","ทามาเล"], answer:1 },
  { q:"เมืองหลวงของโมร็อกโกคืออะไร?", options:["กาซาบลองกา","ราบัต","มาร์ราเกช"], answer:1 },
  { q:"เมืองหลวงของแอลจีเรียคืออะไร?", options:["โอราน","แอลเจียร์","คอนสแตนติน"], answer:1 },
  { q:"เมืองหลวงของอิรักคืออะไร?", options:["โมซุล","แบกแดด","บัสรา"], answer:1 },
  { q:"เมืองหลวงของอิหร่านคืออะไร?", options:["อิสฟาฮาน","เตหะราน","ชีราซ"], answer:1 },
  { q:"เมืองหลวงของปากีสถานคืออะไร?", options:["ลาฮอร์","การาจี","อิสลามาบาด"], answer:2 },
  { q:"เมืองหลวงของบังกลาเทศคืออะไร?", options:["ชิตตะกอง","ธากา","คูลนา"], answer:1 },
  { q:"เมืองหลวงของศรีลังกาคืออะไร?", options:["โคลอมโบ","ศรีชยวรรธนปุระโกฏเฏ","แคนดี"], answer:1 },
  { q:"เมืองหลวงของเนปาลคืออะไร?", options:["โปขรา","กาฐมาณฑุ","ลลิตปุร์"], answer:1 },
  { q:"เมืองหลวงของภูฏานคืออะไร?", options:["พูนาคา","ทิมพู","พาโร"], answer:1 },
  { q:"เมืองหลวงของมัลดีฟส์คืออะไร?", options:["มาเล","อัดดู","ฟูวะห์มูละห์"], answer:0 },

  // ASEAN ครบ 10 ประเทศ
  { q:"เมืองหลวงของกัมพูชาคืออะไร?", options:["เสียมราฐ","พนมเปญ","พระตะบอง"], answer:1 },
  { q:"เมืองหลวงของลาวคืออะไร?", options:["หลวงพระบาง","เวียงจันทน์","ปากเซ"], answer:1 },
  { q:"เมืองหลวงของพม่าคืออะไร?", options:["ย่างกุ้ง","มัณฑะเลย์","เนปิดอว์"], answer:2 },
  { q:"เมืองหลวงของบรูไนคืออะไร?", options:["กัวลาลัมเปอร์","บันดาร์เสรีเบกาวัน","เจอร์รูดง"], answer:1 },

  // เอเชียเพิ่มเติมครบเกือบทุกประเทศ
  { q:"เมืองหลวงของมองโกเลียคืออะไร?", options:["เออร์เดเน็ต","อูลานบาตาร์","ดาร์ฮัน"], answer:1 },
  { q:"เมืองหลวงของคาซัคสถานคืออะไร?", options:["อัลมาตี","อัสตานา","ชิมเคนต์"], answer:1 },
  { q:"เมืองหลวงของอุซเบกิสถานคืออะไร?", options:["ซามาร์กานด์","ทาชเคนต์","บูคารา"], answer:1 },
  { q:"เมืองหลวงของเติร์กเมนิสถานคืออะไร?", options:["มารี","อาชกาบัต","เติร์กเมนาบัต"], answer:1 },
  { q:"เมืองหลวงของคีร์กีซสถานคืออะไร?", options:["โอช","บิชเคก","จาลาล-อาบาด"], answer:1 },
  { q:"เมืองหลวงของทาจิกิสถานคืออะไร?", options:["โคลับ","ดูชานเบ","คูจันด์"], answer:1 },
  { q:"เมืองหลวงของอัฟกานิสถานคืออะไร?", options:["กันดาฮาร์","คาบูล","เฮราต"], answer:1 },
  { q:"เมืองหลวงของซีเรียคืออะไร?", options:["อเลปโป","ดามัสกัส","โฮมส์"], answer:1 },
  { q:"เมืองหลวงของเลบานอนคืออะไร?", options:["ไซดา","เบรุต","ตรีโปลี"], answer:1 },
  { q:"เมืองหลวงของจอร์แดนคืออะไร?", options:["อัล-อากาบา","อัมมาน","อิรบิด"], answer:1 },
  { q:"เมืองหลวงของอิสราเอลคืออะไร?", options:["ไฮฟา","เยรูซาเล็ม","เทลอาวีฟ"], answer:1 },
  { q:"เมืองหลวงของปาเลสไตน์คืออะไร?", options:["กาซา","รามัลลาห์","เยรูซาเล็มตะวันออก"], answer:1 },
  { q:"เมืองหลวงของกาตาร์คืออะไร?", options:["อัล-วาคราห์","โดฮา","อัร-รายยาน"], answer:1 },
  { q:"เมืองหลวงของบาห์เรนคืออะไร?", options:["มุฮาร์รัค","มานามา","ริฟฟา"], answer:1 },
  { q:"เมืองหลวงของคูเวตคืออะไร?", options:["อัล-อาห์มาดี","คูเวตซิตี","ฮาวัลลี"], answer:1 },
  { q:"เมืองหลวงของโอมานคืออะไร?", options:["ซาลาลาห์","มัสกัต","โซฮาร์"], answer:1 },
  { q:"เมืองหลวงของเยเมนคืออะไร?", options:["เอเดน","ซานา","ตาอิซ"], answer:1 },
  { q:"เมืองหลวงของสหรัฐอาหรับเอมิเรตส์คืออะไร?", options:["ดูไบ","อาบูดาบี","ชาร์จาห์"], answer:1 },
  { q:"เมืองหลวงของอาร์เมเนียคืออะไร?", options:["กยุมรี","เยเรวาน","วานาดซอร์"], answer:1 },
  { q:"เมืองหลวงของอาเซอร์ไบจานคืออะไร?", options:["กานจา","บากู","ซุมกายิต"], answer:1 },
  { q:"เมืองหลวงของจอร์เจียคืออะไร?", options:["บาตูมี","ทบิลิซี","คูไตซี"], answer:1 },
  { q:"เมืองหลวงของมาเก๊าคืออะไร?", options:["มาเก๊า","โคโลอาน","ไทปา"], answer:0 },
  { q:"เมืองหลวงของฮ่องกงคืออะไร?", options:["ฮ่องกง","เกาลูน","วิกตอเรีย"], answer:0 },
  { q:"เมืองหลวงของไต้หวันคืออะไร?", options:["เกาสง","ไทเป","ไถจง"], answer:1 },
  { q:"เมืองหลวงของติมอร์-เลสเตคืออะไร?", options:["บาเกา","ดิลี","ซัวอิ"], answer:1 }
];

document.getElementById("game").style.display="block";

// ===== Audio utilities =====
function stopCurrentAudio(){
  try{
    if(currentAudio){
      currentAudio.pause();
      currentAudio.currentTime = 0;
      currentAudio = null;
    }
  }catch(e){}
}
function playSound(name){
  stopCurrentAudio();
  try{
    const a = new Audio(`audio/${name}.mp3`);
    a.play().catch(()=>{});
    currentAudio = a;
    return a;
  }catch(e){
    return null;
  }
}
function playWaitSound(){
  stopCurrentAudio();
  try{
    const a = new Audio(`audio/wait.mp3`);
    a.loop = false;
    a.play().catch(()=>{});
    waitAudio = a;
    return a;
  }catch(e){
    return null;
  }
}
function stopWaitSound(){
  try{
    if(waitAudio){
      waitAudio.pause();
      waitAudio.currentTime = 0;
      waitAudio = null;
    }
  }catch(e){}
}

// ===== UI / focus helpers =====
function focusHeading(id){
  setTimeout(()=>{
    const el = document.getElementById(id);
    if(el){
      el.setAttribute('tabindex', '-1');
      el.focus();
      setTimeout(() => el.focus(), 100);
    }
  }, 100);
}

// ===== flow ของเกม =====
function confirmName(){
  playerName=document.getElementById("playerName").value.trim();
  if(!playerName){ alert("กรุณาใส่ชื่อ"); return; }
  playerId=Math.random().toString(36).substr(2,9);
  document.getElementById("nameInput").style.display="none";
  document.getElementById("lobby").style.display="block";
  focusHeading("lobbyTitle");
  loadRooms();
}

function loadRooms(){
  const list=document.getElementById("roomList");
  db.ref("guessGameRooms").on("value", snap=>{
    list.innerHTML="";
    snap.forEach(r=>{
      const room = r.val();
      if(room.status==="waiting"){
        const li = document.createElement("li");
        li.textContent = `${room.name} (${room.players?Object.keys(room.players).length:0} คน)`;
        const btn = document.createElement("button");
        btn.textContent="เข้าร่วม";
        btn.onclick = ()=>joinRoom(r.key);
        li.appendChild(btn);
        list.appendChild(li);
      }
    });
  });
}

function showCreateRoom(){
  const name = prompt("ตั้งชื่อห้อง:");
  if(!name) return;
  const ref = db.ref("guessGameRooms").push();
  roomId = ref.key; isHost = true;
  ref.set({name, status:"waiting", host:playerId, created:Date.now(), players:{}});
  joinRoom(roomId);
}

function joinRoom(id){
  roomId = id;
  const ref = db.ref(`guessGameRooms/${roomId}/players/${playerId}`);
  ref.set({name:playerName, score:0, answered:false});
  ref.onDisconnect().remove();
  db.ref(`guessGameRooms/${roomId}/lastJoin`).set(Date.now());
  showRoom();
}

function showRoom(){
  document.getElementById("lobby").style.display="none";
  document.getElementById("room").style.display="block";
  focusHeading("roomName");

  if(currentRoomListener) currentRoomListener.off();
  currentRoomListener = db.ref(`guessGameRooms/${roomId}`);
  currentRoomListener.on("value", snap=>{
    const room = snap.val();
    if(!room){ alert("ห้องถูกลบแล้ว"); backToLobby(); return; }

    document.getElementById("roomName").textContent = `ห้อง: ${room.name}`;
    const list = document.getElementById("playerList"); list.innerHTML="";
    if(room.players){
      for(let id in room.players){
        const li = document.createElement("li");
        li.textContent = `${room.players[id].name} (${room.players[id].score} คะแนน)`;
        list.appendChild(li);
      }
    }

    document.getElementById("startBtn").style.display = room.host===playerId ? "inline" : "none";

    if(room.lastJoin && (!window._lastJoinTime || room.lastJoin !== window._lastJoinTime)){
      window._lastJoinTime = room.lastJoin;
      stopCurrentAudio();
      playSound("friend");
    }

    if(room.lastBackToLobby && (!window._lastBackTime || room.lastBackToLobby !== window._lastBackTime)){
      window._lastBackTime = room.lastBackToLobby;
      stopCurrentAudio();
      stopWaitSound();
      playSound("door");
    }

    if(room.status==="playing") startQuiz();
    else if(room.status==="finished") showResult(room);
  });
}

function startGame(){
  stopCurrentAudio();
  stopWaitSound();
  playSound("start");
  db.ref(`guessGameRooms/${roomId}`).update({
    status:"playing", current:0, questions:getRandomQuestions(7)
  });
}

function getRandomQuestions(n){
  const copy = [...questions];
  const res = [];
  for(let i=0;i<n;i++){
    const idx = Math.floor(Math.random()*copy.length);
    let q = copy.splice(idx,1)[0];
    const opts = [...q.options];
    const correctText = opts[q.answer];
    shuffleArray(opts);
    q.answer = opts.indexOf(correctText);
    q.options = opts;
    res.push(q);
  }
  return res;
}
function shuffleArray(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
}

function startQuiz(){
  document.getElementById("room").style.display="none";
  document.getElementById("quiz").style.display="block";
  document.getElementById("mainTitle").style.display="none";
  db.ref(`guessGameRooms/${roomId}`).once("value").then(snap=>{
    const data = snap.val();
    questionIndex = data.current || 0;
    showQuestion(data.questions[questionIndex]);
  });
}

function showQuestion(q){
  if(!q){ if(isHost) endGameHost(); return; }
  localAnswered=false;
  timeLeft = Math.floor(Math.random()*11)+15;
  document.getElementById("questionText").textContent = `ข้อที่ ${questionIndex+1}: ${q.q}`;
  
  focusHeading("questionText");
  
  const opts=document.getElementById("options");
  opts.innerHTML="";
  q.options.forEach((opt,i)=>{
    const b=document.createElement("button");
    b.textContent = opt;
    b.onclick = ()=>submitAnswer(i);
    opts.appendChild(b);
  });
  document.getElementById("timer").textContent = `เวลา: ${timeLeft}`;
  clearInterval(timerInterval);
  timerInterval = setInterval(()=>{
    timeLeft--;
    document.getElementById("timer").textContent = `เวลา: ${timeLeft}`;
    if(timeLeft<=0){ clearInterval(timerInterval); nextQuestion(); }
  },1000);
}

function submitAnswer(index){
  if(localAnswered) return;
  localAnswered = true;
  playSound("pop");

  db.ref(`guessGameRooms/${roomId}`).once("value").then(snap=>{
    const data=snap.val();
    const q=data.questions[data.current];
    const correct = (index===q.answer);
    if(correct){
      db.ref(`guessGameRooms/${roomId}/players/${playerId}/score`).transaction(v=>(v||0)+1);
    }
    db.ref(`guessGameRooms/${roomId}/players/${playerId}/answered`).set(true);
    checkAllAnswered();
  });
}

function checkAllAnswered(){
  db.ref(`guessGameRooms/${roomId}`).once("value").then(snap=>{
    const data = snap.val();
    const players = data.players || {};
    const allAnswered = Object.values(players).every(p=>p.answered);
    if(allAnswered){
      clearInterval(timerInterval);
      if(data.current < data.questions.length - 1){
        setTimeout(() => playSound("next"), 500);
      }
      nextQuestion();
    }
  });
}

function nextQuestion(){
  db.ref(`guessGameRooms/${roomId}`).once("value").then(snap=>{
    const data=snap.val();
    if(!data) return;
    const players = data.players || {};
    for(let id in players){
      db.ref(`guessGameRooms/${roomId}/players/${id}/answered`).set(false);
    }
    const next = data.current + 1;

    if(next < data.questions.length){
      db.ref(`guessGameRooms/${roomId}`).update({current: next});
      questionIndex = next;
      showQuestion(data.questions[next]);
    }else{
      stopCurrentAudio();
      playWaitSound();
      if(isHost) setTimeout(endGameHost, 800);
    }
  });
}

function endGameHost(){
  clearInterval(timerInterval);
  db.ref(`guessGameRooms/${roomId}`).once("value").then(snap=>{
    const room = snap.val();
    if(!room || !room.players) return;
    const players = Object.values(room.players);
    players.sort((a,b)=>b.score-a.score);
    const max = players[0].score;
    const winners = players.filter(p=>p.score===max).map(p=>p.name);

    db.ref(`guessGameRooms/${roomId}`).update({
      status:"finished",
      result:{winners, players}
    });
  });
}

function showResult(roomData){
  clearInterval(timerInterval);
  document.getElementById("quiz").style.display="none";
  document.getElementById("result").style.display="block";
  document.getElementById("mainTitle").style.display="none";

  stopWaitSound();
  stopCurrentAudio();
  playSound("new4");

  const list = document.getElementById("scoreList");
  list.innerHTML = "";
  const players = roomData.result?.players || [];
  const winners = roomData.result?.winners || [];
  document.getElementById("resultHeading").textContent =
    `สรุปผล ผู้ชนะคือ ${winners.join(", ")}`;

  players.forEach(p=>{
    const li = document.createElement("li");
    li.textContent = `${p.name}: ${p.score} คะแนน`;
    list.appendChild(li);
  });

  focusHeading("resultHeading");
}

function requestBackToLobby(){
  db.ref(`guessGameRooms/${roomId}/lastBackToLobby`).set(Date.now());
  backToLobby();
}

function backToLobby(){
  if(currentRoomListener){ currentRoomListener.off(); currentRoomListener = null; }
  db.ref(`guessGameRooms/${roomId}/players/${playerId}`).remove();
  roomId = "";
  questionIndex = 0;
  document.getElementById("result").style.display="none";
  document.getElementById("room").style.display="none";
  document.getElementById("quiz").style.display="none";
  document.getElementById("mainTitle").style.display="block";
  document.getElementById("lobby").style.display="block";
  focusHeading("lobbyTitle");
  loadRooms();
}

setInterval(()=>{
  db.ref("guessGameRooms").once("value").then(snap=>{
    snap.forEach(r=>{
      const data = r.val();
      if(!data.players || Object.keys(data.players).length===0){
        db.ref(`guessGameRooms/${r.key}`).remove();
      }
    });
  });
},300000);
</script>
</body>
</html>