<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>เกมยิงจุดโทษ 2005/2006</title>
<style>
body { 
  font-family: Tahoma; 
  background:#111; 
  color:white; 
  text-align:center; 
  margin:0;
  padding:20px;
  height:100vh;
  overflow:hidden;
  position:relative;
}

.shot-btn { 
  position:fixed;
  background:rgba(255,255,255,0.9); 
  border-radius:15px;
  padding:28px 32px;
  font-weight:bold;
  cursor:pointer;
  border:3px solid #fff;
  font-size:23px;
  z-index:1000;
  box-shadow:0 8px 20px rgba(0,0,0,0.5);
  transition:all 0.2s;
}

/* ปรับตำแหน่งปุ่มให้กดง่ายขึ้น (เหมือน o.html) */
#tl { top:18%; left:12%; }
#tr { top:18%; right:12%; }
#center { top:50%; left:50%; transform:translate(-50%, -50%); }
#bl { bottom:18%; left:12%; }
#br { bottom:18%; right:12%; }

.shot-btn:active {
  transform:scale(0.95);
  box-shadow:0 4px 10px rgba(0,0,0,0.5);
}

#scoreBoard { 
  font-size:28px;
  position:fixed;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  z-index:1001;
  background:rgba(0,0,0,0.7);
  padding:15px 30px;
  border-radius:15px;
  border:2px solid #fff;
}

#teamSelect {
  display:flex;
  flex-direction:column;
  gap:20px;
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
}

#teamSelect button {
  background:rgba(255,255,255,0.9);
  border-radius:15px;
  padding:25px 40px;
  font-weight:bold;
  cursor:pointer;
  border:3px solid #fff;
  transition:all 0.2s;
  font-size:24px;
}

#teamSelect button:active { transform:scale(0.95); }
#teamSelect button:focus { outline:4px solid yellow; }

#gameScreen { width:100vw; height:100vh; }

/* หน้าแรก */
#homeScreen {
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  height:100vh;
  gap:40px;
}

#homeScreen h1 {
  font-size:48px;
  margin:0;
  text-shadow:2px 2px 4px rgba(0,0,0,0.8);
}

.mode-btn {
  background:rgba(255,255,255,0.95);
  border-radius:20px;
  padding:30px 50px;
  font-weight:bold;
  cursor:pointer;
  border:4px solid #fff;
  font-size:28px;
  transition:all 0.3s;
  box-shadow:0 10px 25px rgba(0,0,0,0.5);
  color:#333;
}

.mode-btn:hover {
  background:#fff;
  transform:translateY(-5px);
  box-shadow:0 15px 35px rgba(0,0,0,0.7);
}

#backToMainMenu {
  position:fixed;
  top:20px;
  left:20px;
  background:rgba(255,255,255,0.95);
  color:#333;
  border:3px solid #fff;
  border-radius:12px;
  padding:12px 20px;
  font-size:18px;
  font-weight:bold;
  cursor:pointer;
  z-index:1002;
  box-shadow:0 6px 15px rgba(0,0,0,0.4);
}

#ttsDisplay {
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(0,0,0,0.7);
  color:white;
  padding:12px 24px;
  border-radius:12px;
  font-size:20px;
  max-width:90%;
  z-index:1002;
  opacity:0;
  transition:opacity 0.3s;
  pointer-events:none;
}
#ttsDisplay.show { opacity:1; }

/* เพิ่ม aria-live สำหรับประกาศผลผู้ชนะ */
#gameResult {
  position: absolute;
  left: -9999px;
}
</style>
</head>
<body>

<button id="backToMainMenu" onclick="window.location.href='../index.html'">กลับเมนูหลัก</button>

<h1 id="gameTitle" tabindex="-1" style="margin-bottom:40px;">เกมยิงจุดโทษ 2005/2006</h1>

<div id="homeScreen">
  <div id="modeSelect">
    <button class="mode-btn" onclick="selectMode('bot')">เล่นกับบอท</button>
    <button class="mode-btn" onclick="selectMode('online')">เล่นออนไลน์</button>
    <p>คำอธิบายเบื้องต้น เกมจำลองการยิงจุดโทษแบบเสียง เพื่อความสนุกสนานสำหรับคนชอบฟุตบอล<br>มีตำแหน่งให้คุณเลือกยิงและเลือกเซฟทั้งหมด 5 จุด<br>มุมซ้ายบน มุมขวาบน ตรงกลาง มุมซ้ายล่าง และมุมขวาล่าง<br>ผลัดกันยิงและผลัดกันเป็นผู้รักษาประตู พร้อมแล้วก็ไปเลือกทีมกันเลย</p>
  </div>
</div>

<div id="teamSelect" style="display:none;">
  <p style="font-size:28px;">เลือกทีมของคุณ</p>
  <button id="teamManU" onclick="selectTeam('Manchester United')">แมนเชสเตอร์ ยูไนเต็ด</button>
  <button onclick="selectTeam('Liverpool')">ลิเวอร์พูล</button>
  <button onclick="selectTeam('Arsenal')">อาร์เซนอล</button>
  <button onclick="selectTeam('Chelsea')">เชลซี</button>
</div>

<div id="gameScreen" style="display:none;">
  <div id="scoreBoard">Score ตอนนี้คือ 0 - 0</div>
  <button id="tl" class="shot-btn" onclick="debounceClick('TL')">มุมซ้ายบน</button>
  <button id="tr" class="shot-btn" onclick="debounceClick('TR')">มุมขวาบน</button>
  <button id="center" class="shot-btn" onclick="debounceClick('C')">ตรงกลาง</button>
  <button id="bl" class="shot-btn" onclick="debounceClick('BL')">มุมซ้ายล่าง</button>
  <button id="br" class="shot-btn" onclick="debounceClick('BR')">มุมขวาล่าง</button>
</div>

<div id="ttsDisplay"></div>
<div id="tts" aria-live="assertive" style="position:absolute;left:-9999px;"></div>
<div id="gameResult" aria-live="assertive"></div>

<audio id="bgm" loop src="audio/b.mp3"></audio>
<audio id="end" src="audio/end.mp3"></audio>

<audio id="goal0" src="audio/t.mp3"></audio>
<audio id="goal1" src="audio/t1.mp3"></audio>
<audio id="goal2" src="audio/t2.mp3"></audio>
<audio id="goal3" src="audio/t3.mp3"></audio>
<audio id="goal4" src="audio/t4.mp3"></audio>

<audio id="miss0" src="audio/f.mp3"></audio>
<audio id="miss1" src="audio/f1.mp3"></audio>
<audio id="miss2" src="audio/f2.mp3"></audio>
<audio id="miss3" src="audio/f3.mp3"></audio>
<audio id="miss4" src="audio/f4.mp3"></audio>

<script>
// === TTS System ===
let ttsQueue = [], isSpeaking = false;
const ttsDisplay = document.getElementById("ttsDisplay");

function speak(text){
  ttsQueue.push(text);
  processTTS();
}
function processTTS(){
  if(isSpeaking || ttsQueue.length === 0) return;
  isSpeaking = true;
  const msg = ttsQueue.shift();
  ttsDisplay.textContent = msg;
  ttsDisplay.classList.add('show');
  setTimeout(()=>{
    document.getElementById("tts").innerText = msg;
    setTimeout(()=>{
      isSpeaking = false;
      document.getElementById("tts").innerText = "";
      ttsDisplay.classList.remove('show');
      processTTS();
    }, Math.max(600, msg.length * 40));
  }, 50);
}

// === เสียง ===
const bgm = document.getElementById("bgm");
const endSnd = document.getElementById("end");
const goalSounds = [0,1,2,3,4].map(i=>document.getElementById("goal"+i));
const missSounds = [0,1,2,3,4].map(i=>document.getElementById("miss"+i));
let lastGoal = -1, lastMiss = -1;

function playSound(el){ el.currentTime = 0; el.play().catch(()=>{}); }
function waitForSound(el){ return new Promise(r=>{ el.onended=()=>r(); el.play().catch(()=>r()); }); }
function stopBGM(){ bgm.pause(); bgm.currentTime = 0; }

async function playRandomGoal(){
  let idx;
  do { idx = Math.floor(Math.random()*5); } while(5>1 && idx===lastGoal);
  lastGoal = idx;
  await waitForSound(goalSounds[idx]);
}
async function playRandomMiss(){
  let idx;
  do { idx = Math.floor(Math.random()*5); } while(5>1 && idx===lastMiss);
  lastMiss = idx;
  await waitForSound(missSounds[idx]);
}

// === ข้อมูลทีม ===
const squads = {
  "Manchester United": { players:["แกรี่ เนวิลล์","ริโอ เฟอร์ดินานด์","เวส บราวน์","ปาทริซ เอฟร่า","คริสเตียโน่ โรนัลโด้","พอล สโคลส์","จอห์น โอเช","ไรอัน กิ๊กส์","เวย์น รูนี่ย์","รุด ฟาน นิสเทลรอย"], keeper:"เอ็ดวิน ฟาน เดอร์ ซาร์" },
  "Liverpool": { players:["สตีฟ ฟินแนน","เจมี่ คาร์ราเกอร์","ซามี่ ฮูเปีย","จอห์น อาร์เน่ รีเซ่","ซาบี อลอนโซ่","โมฮาเหม็ด ซิสโซโก้","สตีเว่น เจอร์ราร์ด","หลุยส์ การ์เซีย","ปีเตอร์ เคร้าช์","ฌิบริล ซิสเซ่"], keeper:"เปเป้ เรน่า" },
  "Arsenal": { players:["เอ็มมานูเอล เอบูเอ้","โคโล ตูเร่","โซล แคมเบล","แอชลีย์ โคล","อเล็กซานเดอร์ เคล็บ","ฌิลแบร์โต้ ซีลวา","เชส ฟาเบรกัส","โรแบร์ ปิแรส","เฟรดริก ลุงเบิร์ก","เธียร์รี่ อองรี"], keeper:"เยนส์ เลห์มันน์" },
  "Chelsea": { players:["เปาโล เฟร์เรร่า","ริคาร์โด้ คาร์วัลโญ่","จอห์น เทอร์รี่","วิลเลียม กัลลาส","โคล้ด มาเกเลเล่","มิคาเอล เอสเซียง","แฟรงก์ แลมพาร์ด","โจ โคล","อาร์เยน ร็อบเบน","เฮอร์นัน เครสโป"], keeper:"ปีเตอร์ เช็ก" }
};

// === ตัวแปรเกม ===
let userTeam, cpuTeam, scoreP1 = 0, scoreP2 = 0, turn = 0, isSudden = false;
let shotIndexP1 = 0, shotIndexP2 = 0, userShotsOrder = [], cpuShotsOrder = [];
let isButtonLocked = false;
let firstShooterIsUser = true; // สุ่มตอนเริ่มเกม

// === Utility ===
function debounceClick(dir){ if(isButtonLocked) return; isButtonLocked=true; chooseDirection(dir); setTimeout(()=>{isButtonLocked=false;},100); }
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function createShotsOrder(t){ let b=squads[t].players.slice(); shuffle(b); b.push(squads[t].keeper); return b; }
function getShooterName(t,i){ return (t===userTeam?userShotsOrder:cpuShotsOrder)[i%10]; }

// === เลือกทีม & เริ่มเกม ===
function selectMode(m){ 
  if(m==='bot'){ 
    document.getElementById("homeScreen").style.display="none"; 
    document.getElementById("teamSelect").style.display="flex";
    setTimeout(() => document.getElementById("teamManU").focus(), 100);
  } else window.location.href="o.html"; 
}

function selectTeam(t){
  userTeam=t;
  let rem=Object.keys(squads).filter(x=>x!==t);
  cpuTeam=rem[Math.floor(Math.random()*rem.length)];
  document.getElementById("teamSelect").style.display="none";
  document.getElementById("gameScreen").style.display="block";
  document.getElementById("backToMainMenu").style.display="none";
  document.querySelector('h1').style.display='none';

  userShotsOrder=createShotsOrder(userTeam);
  cpuShotsOrder=createShotsOrder(cpuTeam);
  
  // รีเซ็ตค่า
  scoreP1 = scoreP2 = turn = shotIndexP1 = shotIndexP2 = 0;
  isSudden = false;
  firstShooterIsUser = Math.random() < 0.5;
  
  updateScoreboard();
  playSound(bgm);

  setTimeout(() => document.getElementById("tl").focus(), 300);

  setTimeout(startTurn, 800);
}

function startTurn(){
  const isUserTurn = (turn % 2 === 0) ? firstShooterIsUser : !firstShooterIsUser;
  const shooterTeam = isUserTurn ? userTeam : cpuTeam;
  const shooterIdx = isUserTurn ? shotIndexP1 : shotIndexP2;
  const keeperName = isUserTurn ? squads[cpuTeam].keeper : squads[userTeam].keeper;

  if (isUserTurn) {
    speak(`ลูกที่ ${shooterIdx+1} ${shooterTeam}: ${getShooterName(shooterTeam, shooterIdx)} เตรียมยิง`);
  } else {
    speak(`ลูกที่ ${shooterIdx+1} ${shooterTeam}: ${getShooterName(shooterTeam, shooterIdx)} เตรียมยิง ${keeperName} ของคุณพร้อมเซฟ`);
  }
}

async function chooseDirection(dir){
  const keeperDir = ["TL","TR","C","BL","BR"][Math.floor(Math.random()*5)];
  const isGoal = dir !== keeperDir;

  const isUserTurn = (turn % 2 === 0) ? firstShooterIsUser : !firstShooterIsUser;
  if (isUserTurn) {
    scoreP1 += isGoal ? 1 : 0;
    shotIndexP1++;
  } else {
    scoreP2 += isGoal ? 1 : 0;
    shotIndexP2++;
  }
  updateScoreboard();

  const shooter = getShooterName(isUserTurn ? userTeam : cpuTeam, isUserTurn ? shotIndexP1-1 : shotIndexP2-1);
  const msg = `${shooter} ${isUserTurn ? userTeam : cpuTeam} ยิง${isGoal?"เข้า":"ไม่เข้า"}! Score ${scoreP1} - ${scoreP2}`;

  if(isGoal) await playRandomGoal(); else await playRandomMiss();
  speak(msg);

  setTimeout(() => checkGameEndOrNext(), 1200);
}

// === แก้ไขเฉพาะส่วนนี้เท่านั้น (กติกาซัดเด้นเดธที่ถูกต้อง) ===
function checkGameEndOrNext(){
  const totalShotsP1 = shotIndexP1;
  const totalShotsP2 = shotIndexP2;

  // ยังอยู่ในช่วง 5 ลูกแรก
  if (!isSudden) {
    const shotsDoneP1 = Math.min(totalShotsP1, 5);
    const shotsDoneP2 = Math.min(totalShotsP2, 5);
    const remainingP1 = 5 - shotsDoneP1;
    const remainingP2 = 5 - shotsDoneP2;

    // ตัดสินก่อนครบ 5 ลูก (ถ้าทีมใดทีมหนึ่งตามไม่ทันแน่นอน)
    if (totalShotsP1 < 5 || totalShotsP2 < 5) {
      if (scoreP1 + remainingP1 < scoreP2 || scoreP2 + remainingP2 < scoreP1) {
        endGame(scoreP1 > scoreP2);
        return;
      }
    }

    // ครบ 5 ลูกทั้งคู่แล้ว
    if (totalShotsP1 >= 5 && totalShotsP2 >= 5) {
      if (scoreP1 !== scoreP2) {
        endGame(scoreP1 > scoreP2);
        return;
      } else {
        isSudden = true;
        speak("เข้าสู่ซัดเดนเดธ!");
        turn++;
        setTimeout(startTurn, 1000);
        return;
      }
    }
  }
  // === ซัดเด้นเดธ (กติกาที่ถูกต้องตามฟุตบอลสากล) ===
  else {
    const suddenShotsP1 = totalShotsP1 - 5;  // จำนวนลูกในซัดเด้นเดธของผู้เล่น
    const suddenShotsP2 = totalShotsP2 - 5;  // ของบอท

    // ต้องรอให้ทั้งสองทีมยิงครบ "คู่" ก่อนถึงจะตัดสินได้
    if (suddenShotsP1 === suddenShotsP2 && suddenShotsP1 > 0) {
      if (scoreP1 !== scoreP2) {
        endGame(scoreP1 > scoreP2);
        return;
      }
    }
  }

  // ยังไม่จบ → ดำเนินการต่อ
  turn++;
  setTimeout(startTurn, 800);
}

function endGame(userWins){
  stopBGM();
  playSound(endSnd);
  const winner = userWins ? userTeam : cpuTeam;
  const msg = `${winner} ชนะ!`;
  speak(msg);

  document.getElementById("gameResult").textContent = msg;

  setTimeout(()=>{
    alert(msg);
    window.location.href = '../index.html';  // <--- แก้ไขตรงนี้เท่านั้น กลับเมนูหลักทันทีหลังกดตกลง/Esc/ปิด
  }, 800);

  // ไม่เรียก resetGame() อีกต่อไป
}

function updateScoreboard(){
  document.getElementById("scoreBoard").innerText = `Score ตอนนี้คือ ${scoreP1} - ${scoreP2}`;
}

function resetGame(){
  stopBGM();
  document.getElementById("gameScreen").style.display="none";
  document.getElementById("teamSelect").style.display="flex";
  document.getElementById("backToMainMenu").style.display="block";
  document.querySelector('h1').style.display='block';

  document.getElementById("gameResult").textContent = "";

  setTimeout(() => document.getElementById("teamManU").focus(), 300);
}

document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("backToMainMenu").style.display = "block";
  document.getElementById("gameTitle").focus();
});
</script>
</body>
</html>