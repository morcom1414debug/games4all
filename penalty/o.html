<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>เกมยิงจุดโทษ 2005/2006 - ออนไลน์</title>
<style>
  body { 
    font-family: Tahoma; 
    background:#111; 
    color:white; 
    text-align:center; 
    margin:0;
    padding:20px;
    height:100vh;
    overflow:hidden;
    position:relative;
  }

  .shot-btn { 
    position:fixed;
    background:rgba(255,255,255,0.9); 
    border-radius:15px;
    padding:25px 30px;
    font-weight:bold;
    cursor:pointer;
    border:3px solid #fff;
    font-size:22px;
    z-index:1000;
    box-shadow:0 8px 20px rgba(0,0,0,0.5);
    transition:all 0.2s;
    opacity:1;
  }
  .shot-btn:active { transform:scale(0.95); box-shadow:0 4px 10px rgba(0,0,0,0.5); }
  .shot-btn:disabled { opacity:0.5; cursor:not-allowed; }
  .shot-btn.locked { opacity:0.3; cursor:not-allowed; }
  #tl { top:10%; left:10%; }
  #tr { top:10%; right:10%; }
  #center { top:50%; left:50%; transform:translate(-50%, -50%); }
  #bl { bottom:10%; left:10%; }
  #br { bottom:10%; right:10%; }

  #scoreBoard { 
    margin-top:20px; 
    font-size:28px;
    position:fixed;
    top:10px;
    left:50%;
    transform:translateX(-50%);
    z-index:1001;
    background:rgba(0,0,0,0.7);
    padding:15px 30px;
    border-radius:15px;
    border:2px solid #fff;
  }

  /* หน้าแรก: ตั้งชื่อ */
  #nameInput {
    display:flex;
    flex-direction:column;
    gap:20px;
    position:fixed;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    background:rgba(0,0,0,0.8);
    padding:30px;
    border-radius:20px;
    width:320px;
  }
  #nameInput input {
    padding:12px;
    font-size:20px;
    border-radius:8px;
    border:none;
    text-align:center;
  }
  #nameInput button {
    background:rgba(255,255,255,0.9);
    border:none;
    border-radius:15px;
    padding:15px;
    font-weight:bold;
    font-size:20px;
    cursor:pointer;
  }

  /* ล็อบบี้ */
  #lobby, #room { display:none; }
  ul { list-style:none; padding:0; margin:0; }
  li { margin:8px 0; background:rgba(255,255,255,0.1); padding:12px; border-radius:10px; }

  /* เลือกทีม */
  #teamSelectInRoom {
    display:none;
    flex-direction:column;
    gap:15px;
    margin-top:20px;
  }
  #teamSelectInRoom button {
    background:rgba(255,255,255,0.9);
    border-radius:15px;
    padding:15px 30px;
    font-weight:bold;
    cursor:pointer;
    border:3px solid #fff;
    font-size:20px;
    transition:all 0.2s;
  }
  #teamSelectInRoom button:disabled,
  #teamSelectInRoom button.unavailable {
    background:#555;
    cursor:not-allowed;
    opacity:0.6;
    border-color:#777;
  }

  #waitingMessage {
    display:none;
    margin-top:20px;
    padding:20px;
    background:rgba(255,255,255,0.1);
    border-radius:15px;
    font-size:18px;
  }

  #startBtn {
    display:none;
    margin-top:20px;
    background:#4CAF50;
    color:white;
    border:none;
    border-radius:15px;
    padding:15px 30px;
    font-weight:bold;
    font-size:20px;
    cursor:pointer;
  }

  /* TTS */
  #ttsDisplay {
    position:fixed;
    bottom:20px;
    left:50%;
    transform:translateX(-50%);
    background:rgba(0,0,0,0.7);
    color:white;
    padding:12px 24px;
    border-radius:12px;
    font-size:20px;
    max-width:90%;
    z-index:1002;
    opacity:0;
    transition:opacity 0.3s;
    pointer-events:none;
  }
  #ttsDisplay.show { opacity:1; }

  #backBtn {
    position:fixed;
    top:15px;
    left:15px;
    z-index:9999;
  }
  #backBtn button {
    background:#f44336;
    color:white;
    border:none;
    border-radius:50px;
    padding:12px 26px;
    font-weight:bold;
    box-shadow:0 4px 12px rgba(244,67,54,0.4);
    transition:all 0.3s;
  }

  #resultScreen {
    position:fixed;
    top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.95);
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    z-index:10000;
    display:none;
  }
  #resultScreen h1 { font-size:48px; margin:20px; }
  #resultScreen p { font-size:28px; }
  #resultScreen button {
    margin-top:30px;
    background:#4CAF50;
    color:white;
    border:none;
    border-radius:15px;
    padding:15px 40px;
    font-size:22px;
    cursor:pointer;
  }

  #currentTurn {
    position:fixed;
    top:70px;
    left:50%;
    transform:translateX(-50%);
    background:rgba(255,255,255,0.9);
    color:#333;
    padding:10px 20px;
    border-radius:10px;
    font-size:18px;
    font-weight:bold;
    z-index:1001;
    display:none;
  }
</style>
</head>
<body>

<div id="backBtn" style="display:none;">
  <button onclick="backToLobby()">กลับล็อบบี้</button>
</div>

<!-- หน้าแรก: ตั้งชื่อ -->
<div id="nameInput">
  <p style="font-size:24px;">กรอกชื่อของคุณ</p>
  <input id="playerName" placeholder="ชื่อของคุณ" autofocus>
  <button id="confirmNameBtn">ยืนยัน</button>
</div>

<!-- ล็อบบี้ -->
<div id="lobby">
  <h2>ล็อบบี้</h2>
  <button id="createRoomBtn" style="background:#fff;color:#333;padding:15px 30px;border-radius:15px;font-weight:bold;">สร้างห้องใหม่</button>
  <h3>ห้องที่เปิดอยู่</h3>
  <ul id="roomList"></ul>
</div>

<!-- ห้อง -->
<div id="room">
  <h2 id="roomName"></h2>
  <p>ผู้เล่นในห้อง:</p>
  <ul id="playerList"></ul>
  
  <div id="teamSelectInRoom">
    <p>เลือกทีมของคุณ:</p>
    <button class="team-btn" data-team="Manchester United">แมนเชสเตอร์ ยูไนเต็ด</button>
    <button class="team-btn" data-team="Liverpool">ลิเวอร์พูล</button>
    <button class="team-btn" data-team="Arsenal">อาร์เซนอล</button>
    <button class="team-btn" data-team="Chelsea">เชลซี</button>
  </div>
  
  <div id="waitingMessage"></div>
  
  <button id="startBtn" onclick="startGame()">เริ่มเกม</button>
</div>

<!-- หน้าจอเกม -->
<div id="gameScreen" style="display:none;">
  <div id="scoreBoard">Score ตอนนี้คือ 0 - 0</div>
  <div id="currentTurn"></div>
  <button id="tl" class="shot-btn" onclick="debounceClick('TL')">มุมซ้ายบน</button>
  <button id="tr" class="shot-btn" onclick="debounceClick('TR')">มุมขวาบน</button>
  <button id="center" class="shot-btn" onclick="debounceClick('C')">ตรงกลาง</button>
  <button id="bl" class="shot-btn" onclick="debounceClick('BL')">มุมซ้ายล่าง</button>
  <button id="br" class="shot-btn" onclick="debounceClick('BR')">มุมขวาล่าง</button>
</div>

<!-- ผลลัพธ์ -->
<div id="resultScreen">
  <h1 id="resultTitle">ชนะ!</h1>
  <p id="resultScore">5 - 3</p>
  <button onclick="backToLobby()">กลับล็อบบี้</button>
</div>

<!-- TTS -->
<div id="ttsDisplay"></div>
<div id="tts" aria-live="assertive" style="position:absolute;left:-9999px;"></div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script>
// === เริ่มต้น Firebase ===
const firebaseConfig = {
  apiKey: "AIzaSyBIPeN4YUIrwM4MmFtDvT2DJ-v4toxc7tY",
  authDomain: "xo-game-134ec.firebaseapp.com",
  databaseURL: "https://xo-game-134ec-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "xo-game-134ec",
  storageBucket: "xo-game-134ec.appspot.com",
  messagingSenderId: "318375224157",
  appId: "1:318375224157:web:348a410dfd625359b77eb4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// === ตัวแปรหลัก ===
let playerName = "", roomId = "", playerId = "", isHost = false;
let currentRoomListener = null, soundListener = null, lobbyRoomsListener = null;
let preloadedAudios = {};
let isButtonLocked = false;
let gameStarted = false;
let isMyTurn = false;
let spokenTurns = new Set();

// === ข้อมูลทีม ===
const squads = {
  "Manchester United": {
    keeper: "ฟาน เดอร์ ซาร์",
    players: ["รูนี่ย์", "ฟาน นิสเตลรอย", "กิกส์", "สโคลส์", "เฟอร์ดินานด์"]
  },
  "Liverpool": {
    keeper: "เรน่า",
    players: ["เจอร์ราร์ด", "ซิสโก้", "อัลonso", "การ์เซีย", "คราวช์"]
  },
  "Arsenal": {
    keeper: "เลห์มันน์",
    players: ["เฮนรี่", "ปิแรส", "ลุงเบิร์ก", "ฟาเบรกาส", "วิเอร่า"]
  },
  "Chelsea": {
    keeper: "เช็ก",
    players: ["แลมพาร์ด", "ดร็อกบา", "ร็อบเบน", "โจ โคล", "มาเคเลเล่"]
  }
};

function shuffle(a) {
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function createShotsOrder(team) {
  const players = [...squads[team].players];
  shuffle(players);
  return players;
}

// === โหลดเสียงทั้งหมดล่วงหน้า ===
function preloadAllSounds() {
  const files = ["b.mp3", "t.mp3", "f.mp3", "end.mp3", "friend.mp3"];
  files.forEach(name => {
    const audio = new Audio(`audio/${name}`);
    audio.preload = "auto";
    audio.load();
    preloadedAudios[name] = audio;
  });
}

// === เริ่ม/หยุด BGM ===
function startBGM() {
  const bgm = preloadedAudios["b.mp3"];
  if (bgm) {
    bgm.currentTime = 0;
    bgm.volume = 0.3;
    bgm.loop = true;
    bgm.play().catch(() => {});
  }
}
function stopBGM() {
  const bgm = preloadedAudios["b.mp3"];
  if (bgm) { bgm.pause(); bgm.currentTime = 0; }
}

// === ฟังก์ชันเล่นเสียงจาก server (ทุกฝ่าย) ===
let lastSoundId = null;
function startSoundListener() {
  if (soundListener) soundListener.off();
  if (!roomId) return;

  soundListener = db.ref(`penaltyRooms/${roomId}/soundTrigger`);
  soundListener.on("value", snap => {
    const data = snap.val();
    if (!data || !data.name || !data.id) return;
    if (lastSoundId === data.id) return;
    lastSoundId = data.id;

    const audio = preloadedAudios[data.name];
    if (audio) {
      audio.currentTime = 0;
      audio.volume = data.name === "b.mp3" ? 0.3 : 1.0;
      audio.play().catch(() => {});
    }

    let msg = "";
    if (data.name === "t.mp3") msg = "ยิงเข้า!";
    else if (data.name === "f.mp3") msg = "ยิงไม่เข้า!";
    else if (data.name === "end.mp3") msg = "จบเกม!";
    else if (data.name === "friend.mp3") msg = `${data.playerName || ''} เลือกทีมแล้ว`;
    if (msg) speak(msg);
  });
}

// === ส่งคำสั่งเล่นเสียง ===
function triggerSound(soundName, extra = {}) {
  if (!roomId) return;
  const id = Date.now() + "_" + Math.random().toString(36).substr(2, 9);
  db.ref(`penaltyRooms/${roomId}/soundTrigger`).set({
    name: soundName,
    id: id,
    playerName: playerName,
    ...extra
  });
}

// === TTS ===
let ttsQueue = [];
  let isSpeaking = false;
  const ttsDisplay = document.getElementById("ttsDisplay");

  function speak(text) {
    ttsQueue.push(text);
    processTTS();
  }
  function processTTS() {
    if (isSpeaking || ttsQueue.length === 0) return;
    isSpeaking = true;
    const msg = ttsQueue.shift();
    ttsDisplay.textContent = msg;
    ttsDisplay.classList.add('show');
    setTimeout(() => {
      document.getElementById("tts").innerText = msg;
      setTimeout(() => {
        isSpeaking = false;
        document.getElementById("tts").innerText = "";
        ttsDisplay.classList.remove('show');
        processTTS();
      }, Math.max(800, msg.length * 50));
    }, 50);
  }

// === Debounce ===
function debounceClick(dir){
  if(isButtonLocked || !isMyTurn) return;
  isButtonLocked = true;
  chooseDirection(dir);
  setTimeout(()=>{ isButtonLocked = false; }, 100);
}

// === เริ่มต้นแอป ===
document.addEventListener("DOMContentLoaded", () => {
  const playerNameInput = document.getElementById("playerName");
  const confirmBtn = document.getElementById("confirmNameBtn");

  playerNameInput.focus();
  confirmBtn.addEventListener("click", confirmName);
  playerNameInput.addEventListener("keydown", e => { if (e.key === "Enter") confirmName(); });

  document.getElementById("createRoomBtn").onclick = showCreateRoom;
  document.querySelectorAll(".team-btn").forEach(btn => {
    btn.onclick = () => chooseTeam(btn.getAttribute("data-team"));
  });
});

// === ยืนยันชื่อ ===
function confirmName() {
  const input = document.getElementById("playerName");
  playerName = input.value.trim();
  if (!playerName) { alert("กรุณาใส่ชื่อ"); return; }
  playerId = Math.random().toString(36).substr(2,9);
  document.getElementById("nameInput").style.display = "none";
  document.getElementById("lobby").style.display = "block";
  preloadAllSounds();
  loadRooms();
}

// === สร้างห้องใหม่ ===
async function showCreateRoom() {
  const name = prompt("ตั้งชื่อห้อง:");
  if (!name || name.trim() === "") return;

  const roomRef = db.ref("penaltyRooms").push();
  const newRoomId = roomRef.key;

  try {
    await roomRef.set({
      name: name.trim(),
      status: "waiting",
      host: playerId,
      created: Date.now(),
      players: { [playerId]: { name: playerName, team: null } }
    });

    const playerRef = db.ref(`penaltyRooms/${newRoomId}/players/${playerId}`);
    playerRef.onDisconnect().remove();

    roomId = newRoomId;
    isHost = true;
    showRoom();
  } catch (err) {
    console.error("สร้างห้องล้มเหลว:", err);
    alert("สร้างห้องล้มเหลว กรุณาลองใหม่");
  }
}

// === เข้าร่วมห้อง ===
async function joinRoom(id) {
  const roomRef = db.ref(`penaltyRooms/${id}`);
  const snap = await roomRef.once("value");
  const room = snap.val();
  if (!room || room.status !== "waiting" || Object.keys(room.players || {}).length >= 2) {
    alert("ไม่สามารถเข้าร่วมห้องนี้ได้");
    return;
  }

  await db.ref(`penaltyRooms/${id}/players/${playerId}`).set({ name: playerName, team: null });
  const playerRef = db.ref(`penaltyRooms/${id}/players/${playerId}`);
  playerRef.onDisconnect().remove();

  roomId = id;
  isHost = (room.host === playerId);
  showRoom();
}

// === โหลดห้องในล็อบบี้ ===
function loadRooms() {
  if (lobbyRoomsListener) lobbyRoomsListener.off();
  const roomsRef = db.ref("penaltyRooms").orderByChild("created").limitToLast(20);
  lobbyRoomsListener = roomsRef.on("value", snap => {
    const rooms = snap.val() || {};
    const list = document.getElementById("roomList");
    list.innerHTML = "";
    Object.keys(rooms).reverse().forEach(id => {
      const r = rooms[id];
      if (r.status !== "waiting") return;
      const li = document.createElement("li");
      li.innerHTML = `<strong>${r.name}</strong> (${Object.keys(r.players || {}).length}/2)`;
      const btn = document.createElement("button");
      btn.textContent = "เข้าร่วม";
      btn.onclick = () => joinRoom(id);
      btn.style.marginLeft = "10px";
      btn.style.padding = "5px 15px";
      btn.style.background = "#4CAF50";
      btn.style.color = "white";
      btn.style.border = "none";
      btn.style.borderRadius = "8px";
      btn.style.cursor = "pointer";
      li.appendChild(btn);
      list.appendChild(li);
    });
  });
}

// === แสดงห้อง ===
function showRoom() {
  document.getElementById("lobby").style.display = "none";
  document.getElementById("room").style.display = "block";
  document.getElementById("backBtn").style.display = "block";
  document.getElementById("roomName").textContent = "ห้อง: " + (promptRoomName || "ไม่ระบุ");

  if (currentRoomListener) currentRoomListener.off();
  currentRoomListener = db.ref(`penaltyRooms/${roomId}`).on("value", snap => {
    const room = snap.val();
    if (!room) return backToLobby();

    document.getElementById("roomName").textContent = room.name;

    const playerList = document.getElementById("playerList");
    playerList.innerHTML = "";
    const players = room.players || {};
    Object.values(players).forEach(p => {
      const li = document.createElement("li");
      li.textContent = p.name + (p.team ? ` (${p.team})` : "");
      playerList.appendChild(li);
    });

    updateTeamButtons(room);
    startSoundListener();

    if (room.status === "playing") {
      startGameplay(room, players);
    } else {
      document.getElementById("gameScreen").style.display = "none";
      document.getElementById("resultScreen").style.display = "none";
      const startBtn = document.getElementById("startBtn");
      if (isHost && Object.keys(players).length === 2 && 
          Object.values(players).every(p => p.team)) {
        startBtn.style.display = "block";
      } else {
        startBtn.style.display = "none";
      }
    }

    if (room.winner) showResult(room);
  });
}

let promptRoomName = "";
function updateTeamButtons(room) {
  const selectDiv = document.getElementById("teamSelectInRoom");
  const waiting = document.getElementById("waitingMessage");
  const players = room.players || {};
  const takenTeams = Object.values(players).map(p => p.team).filter(t => t);

  if (room.players[playerId].team) {
    selectDiv.style.display = "none";
    waiting.style.display = "block";
    waiting.textContent = "รออีกฝ่ายเลือกทีม...";
    return;
  }

  selectDiv.style.display = "flex";
  waiting.style.display = "none";

  document.querySelectorAll(".team-btn").forEach(btn => {
    const team = btn.getAttribute("data-team");
    if (takenTeams.includes(team)) {
      btn.classList.add("unavailable");
      btn.disabled = true;
    } else {
      btn.classList.remove("unavailable");
      btn.disabled = false;
    }
  });
}

function chooseTeam(team) {
  db.ref(`penaltyRooms/${roomId}/players/${playerId}/team`).set(team);
  triggerSound("friend.mp3");
  speak(`${playerName} เลือกทีม ${team}`);
}

// === เริ่มเกม ===
function startGame() {
  if (gameStarted) return;
  gameStarted = true;
  document.getElementById("startBtn").disabled = true;
  speak("เริ่มเกม!");

  db.ref(`penaltyRooms/${roomId}/players`).once("value").then(snap => {
    const players = snap.val();
    const keys = Object.keys(players);
    const p1Id = keys[0], p2Id = keys[1];
    const p1Team = players[p1Id].team;
    const p2Team = players[p2Id].team;
    
    const orderP1 = createShotsOrder(p1Team);
    const orderP2 = createShotsOrder(p2Team);
    
    const firstShooter = Math.random() < 0.5 ? p1Id : p2Id;
    
    speak(`ทีม ${p1Team} ปะทะ ${p2Team}`);
    speak(`${players[firstShooter].name} จากทีม ${players[firstShooter].team} จะยิงลูกแรก`);
    
    db.ref(`penaltyRooms/${roomId}`).update({
      status: "playing", 
      firstShooter: firstShooter,
      turn: 0,
      scoreP1: 0, scoreP2: 0, 
      shotIndexP1: 0, shotIndexP2: 0,
      isSudden: false, 
      shooterDir: null, keeperDir: null,
      processed: false,
      shotOrderP1: orderP1,
      shotOrderP2: orderP2,
      p1Id: p1Id,
      p2Id: p2Id
    });
  });
}

// === เกมเพลย์ ===
let shotOrderP1 = [], shotOrderP2 = [];
let lastProcessedTurn = -1;

function startGameplay(room, players) {
  document.getElementById("room").style.display = "none";
  document.getElementById("gameScreen").style.display = "block";
  document.getElementById("currentTurn").style.display = "block";
  startBGM();

  shotOrderP1 = room.shotOrderP1 || [];
  shotOrderP2 = room.shotOrderP2 || [];

  const gameRef = db.ref(`penaltyRooms/${roomId}`);
  
  document.querySelectorAll('.shot-btn').forEach(btn => {
    btn.classList.remove('locked');
    btn.disabled = false;
  });

  let lastTurn = -1;
  let lastIsSudden = false;

  gameRef.on("value", snap => {
    const data = snap.val();
    if (!data || data.status !== "playing") {
      document.querySelectorAll('.shot-btn').forEach(btn => { btn.style.display = 'none'; });
      document.getElementById("currentTurn").style.display = "none";
      return;
    }

    const scoreP1 = data.scoreP1 || 0;
    const scoreP2 = data.scoreP2 || 0;
    document.getElementById("scoreBoard").innerText = `Score: ${scoreP1} - ${scoreP2}`;

    const p1Id = data.p1Id;
    const p2Id = data.p2Id;
    const currentShooterId = data.turn % 2 === 0 ? data.firstShooter : (data.firstShooter === p1Id ? p2Id : p1Id);
    const currentKeeperId = currentShooterId === p1Id ? p2Id : p1Id;
    isMyTurn = (playerId === currentShooterId || playerId === currentKeeperId);

    document.querySelectorAll('.shot-btn').forEach(btn => {
      if (isMyTurn) {
        btn.classList.remove('locked');
        btn.disabled = false;
        btn.style.display = 'block';
      } else {
        btn.classList.add('locked');
        btn.disabled = true;
      }
    });

    const currentTurnEl = document.getElementById("currentTurn");
    const action = playerId === currentShooterId ? "ยิง!" : "เซฟ!";
    currentTurnEl.textContent = `ถึงตาคุณ${action}`;
    currentTurnEl.style.background = playerId === currentShooterId ? "rgba(76,175,80,0.9)" : "rgba(255,152,0,0.9)";
    currentTurnEl.style.color = "white";

    if (data.turn !== lastTurn) {
      lastTurn = data.turn;
      const shooterOrder = currentShooterId === p1Id ? shotOrderP1 : shotOrderP2;
      const shooterIndex = currentShooterId === p1Id ? data.shotIndexP1 : data.shotIndexP2;
      const shooterName = shooterOrder[shooterIndex];
      const keeperTeam = players[currentKeeperId].team;
      const keeperName = squads[keeperTeam].keeper;
      const shooterTeam = players[currentShooterId].team;

      if (!spokenTurns.has(`turn_${data.turn}_shooter`)) {
        spokenTurns.add(`turn_${data.turn}_shooter`);
        speak(`ลูกที่ ${shooterIndex + 1} ${shooterTeam}: ${shooterName} เตรียมยิง`);
      }

      if (!spokenTurns.has(`turn_${data.turn}_keeper`)) {
        spokenTurns.add(`turn_${data.turn}_keeper`);
        speak(`${shooterTeam} กำลังยิง ${keeperName} ของคุณเตรียมเซฟ`);
      }
    }

    if (data.isSudden && !lastIsSudden) {
      if (!spokenTurns.has("sudden")) {
        spokenTurns.add("sudden");
        speak("เข้าสู่ซัดเดนเดธ!");
      }
    }
    lastIsSudden = data.isSudden;

    if (data.shooterDir && data.keeperDir && !data.processed && data.turn > lastProcessedTurn) {
      lastProcessedTurn = data.turn;
      processShot(data, players, gameRef);
    }
  });
}

async function processShot(data, players, gameRef) {
  const processedRef = gameRef.child('processed');
  const transactionResult = await processedRef.transaction(current => current ? undefined : true);
  if (!transactionResult.committed) return;

  const p1Id = data.p1Id;
  const p2Id = data.p2Id;
  const currentShooterId = data.turn % 2 === 0 ? data.firstShooter : (data.firstShooter === p1Id ? p2Id : p1Id);
  const currentKeeperId = currentShooterId === p1Id ? p2Id : p1Id;
  
  const shooterOrder = currentShooterId === p1Id ? shotOrderP1 : shotOrderP2;
  const shooterIndex = currentShooterId === p1Id ? data.shotIndexP1 : data.shotIndexP2;
  const shooterName = shooterOrder[shooterIndex];
  const keeperTeam = players[currentKeeperId].team;
  const keeperName = squads[keeperTeam].keeper;
  const shooterTeam = players[currentShooterId].team;

  const isGoal = data.shooterDir !== data.keeperDir;

  triggerSound(isGoal ? "t.mp3" : "f.mp3");

  let scoreP1 = data.scoreP1 || 0;
  let scoreP2 = data.scoreP2 || 0;
  if (isGoal) currentShooterId === p1Id ? scoreP1++ : scoreP2++;

  const resultMsg = `${shooterName} จากทีม ${shooterTeam} ยิง${isGoal ? "เข้า" : "ไม่เข้า"}! คะแนน ${scoreP1} - ${scoreP2}`;
  speak(resultMsg);

  const updates = {
    turn: data.turn + 1,
    shooterDir: null, keeperDir: null, processed: false,
    scoreP1, scoreP2
  };

  if (currentShooterId === p1Id) updates.shotIndexP1 = data.shotIndexP1 + 1;
  else updates.shotIndexP2 = data.shotIndexP2 + 1;

  setTimeout(() => {
    gameRef.update(updates);
    setTimeout(() => checkGameEndOrNext(data, players, gameRef, scoreP1, scoreP2, 
      updates.shotIndexP1 || data.shotIndexP1, updates.shotIndexP2 || data.shotIndexP2), 1000);
  }, 1000);
}

function checkGameEndOrNext(data, players, gameRef, scoreP1, scoreP2, idxP1, idxP2) {
  const maxShots = 5;
  const shotsDone = idxP1 + idxP2;
  const isSudden = data.isSudden;

  if (!isSudden && shotsDone >= maxShots * 2) {
    if (scoreP1 !== scoreP2) {
      endGame(gameRef, scoreP1 > scoreP2 ? data.p1Id : data.p2Id, scoreP1, scoreP2);
      return;
    } else {
      gameRef.update({ isSudden: true });
      return;
    }
  }

  if (isSudden && Math.abs(scoreP1 - scoreP2) > 0 && (idxP1 > maxShots || idxP2 > maxShots)) {
    endGame(gameRef, scoreP1 > scoreP2 ? data.p1Id : data.p2Id, scoreP1, scoreP2);
    return;
  }

  // ยังไม่จบ
}

function endGame(gameRef, winnerId, finalP1, finalP2) {
  gameRef.update({
    status: "finished",
    winner: winnerId,
    finalScoreP1: finalP1,
    finalScoreP2: finalP2
  });
}

async function chooseDirection(dir) {
  const snap = await db.ref(`penaltyRooms/${roomId}`).once("value");
  const data = snap.val();
  if (data.status !== "playing") return;
  
  const currentShooterId = data.turn % 2 === 0 ? data.firstShooter : (data.firstShooter === data.p1Id ? data.p2Id : data.p1Id);
  const currentKeeperId = currentShooterId === data.p1Id ? data.p2Id : data.p1Id;

  if (playerId === currentShooterId && !data.shooterDir) {
    await db.ref(`penaltyRooms/${roomId}/shooterDir`).set(dir);
  } else if (playerId === currentKeeperId && !data.keeperDir) {
    await db.ref(`penaltyRooms/${roomId}/keeperDir`).set(dir);
  }
}

function showResult(room) {
  stopBGM();
  triggerSound("end.mp3");
  document.getElementById("gameScreen").style.display = "none";
  document.getElementById("currentTurn").style.display = "none";
  document.querySelectorAll('.shot-btn').forEach(btn => { btn.style.display = 'none'; });

  const p1Team = room.players[room.p1Id].team;
  const p2Team = room.players[room.p2Id].team;
  const winnerTeam = room.winner === room.p1Id ? p1Team : p2Team;

  document.getElementById("resultTitle").textContent = `${winnerTeam} ชนะ!`;
  document.getElementById("resultScore").textContent = `${room.finalScoreP1} - ${room.finalScoreP2}`;
  document.getElementById("resultScreen").style.display = "flex";

  const finalMsg = `${winnerTeam} ชนะด้วยคะแนน ${room.finalScoreP1} ต่อ ${room.finalScoreP2}`;
  speak(finalMsg);
}

function backToLobby() {
  gameStarted = false; 
  isButtonLocked = false; 
  isMyTurn = false;
  stopBGM();
  spokenTurns.clear();
  shotOrderP1 = []; shotOrderP2 = [];
  lastProcessedTurn = -1;
  lastSoundId = null;
  
  if (currentRoomListener) { currentRoomListener.off(); currentRoomListener = null; }
  if (soundListener) { soundListener.off(); soundListener = null; }
  if (lobbyRoomsListener) { lobbyRoomsListener.off(); lobbyRoomsListener = null; }
  if (roomId && playerId) db.ref(`penaltyRooms/${roomId}/players/${playerId}`).remove();
  
  roomId = ""; playerId = "";
  document.getElementById("room").style.display = "none";
  document.getElementById("gameScreen").style.display = "none";
  document.getElementById("resultScreen").style.display = "none";
  document.getElementById("backBtn").style.display = "none";
  document.getElementById("currentTurn").style.display = "none";
  document.querySelectorAll('.shot-btn').forEach(btn => { btn.style.display = 'block'; });
  document.getElementById("lobby").style.display = "block";
  loadRooms();
}
</script>
</body>
</html>