<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>เกมยิงจุดโทษ 2005/2006 - ออนไลน์</title>
<style>
  body { 
    font-family: Tahoma; 
    background:#111; 
    color:white; 
    text-align:center; 
    margin:0;
    padding:20px;
    height:100vh;
    overflow:hidden;
    position:relative;
  }

  .shot-btn { 
    position:fixed;
    background:rgba(255,255,255,0.9); 
    border-radius:12px;
    padding:12px 18px;
    font-weight:bold;
    cursor:pointer;
    border:2px solid #fff;
    font-size:16px;
    z-index:1000;
    box-shadow:0 6px 16px rgba(0,0,0,0.5);
    transition:all 0.2s;
    opacity:1;
    min-width:80px;
    white-space:nowrap;
  }
  .shot-btn:active { transform:scale(0.95); box-shadow:0 3px 8px rgba(0,0,0,0.5); }
  .shot-btn:disabled { opacity:0.5; cursor:not-allowed; }
  .shot-btn.locked { opacity:0.3; cursor:not-allowed; }

  #tl { top:8%; left:8%; }
  #tr { top:8%; right:8%; }
  #center { top:50%; left:50%; transform:translate(-50%, -50%); }
  #bl { bottom:8%; left:8%; }
  #br { bottom:8%; right:8%; }

  #scoreBoard { 
    margin-top:20px; 
    font-size:24px;
    position:fixed;
    top:10px;
    left:50%;
    transform:translateX(-50%);
    z-index:1001;
    background:rgba(0,0,0,0.7);
    padding:12px 24px;
    border-radius:12px;
    border:2px solid #fff;
  }

  #nameInput {
    display:flex;
    flex-direction:column;
    gap:20px;
    position:fixed;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    background:rgba(0,0,0,0.8);
    padding:30px;
    border-radius:20px;
    width:320px;
    max-width:90%;
  }
  #nameInput input {
    padding:12px;
    font-size:20px;
    border-radius:8px;
    border:none;
    text-align:center;
  }
  #nameInput button {
    background:rgba(255,255,255,0.9);
    border:none;
    border-radius:15px;
    padding:15px;
    font-weight:bold;
    font-size:20px;
    cursor:pointer;
  }

  #lobby, #room { display:none; }
  ul { list-style:none; padding:0; margin:0; }
  li { margin:8px 0; background:rgba(255,255,255,0.1); padding:12px; border-radius:10px; }

  #teamSelectInRoom {
    display:none;
    flex-direction:column;
    gap:15px;
    margin-top:20px;
  }
  #teamSelectInRoom button {
    background:rgba(255,255,255,0.9);
    border-radius:15px;
    padding:15px 30px;
    font-weight:bold;
    cursor:pointer;
    border:3px solid #fff;
    font-size:20px;
    transition:all 0.2s;
  }
  #teamSelectInRoom button:disabled,
  #teamSelectInRoom button.unavailable {
    background:#555;
    cursor:not-allowed;
    opacity:0.6;
    border-color:#777;
  }

  #waitingMessage {
    display:none;
    margin-top:20px;
    padding:20px;
    background:rgba(255,255,255,0.1);
    border-radius:15px;
    font-size:18px;
  }

  #startBtn {
    display:none;
    margin-top:20px;
    background:#4CAF50;
    color:white;
    border:none;
    border-radius:15px;
    padding:15px 30px;
    font-weight:bold;
    font-size:20px;
    cursor:pointer;
  }

  /* ปุ่มกลับเมนูหลัก */
  #backToMainBtn {
    position:fixed;
    top:15px;
    left:15px;
    z-index:9999;
    display:none;
    background:#f44336;
    color:white;
    border:none;
    border-radius:50px;
    padding:12px 26px;
    font-weight:bold;
    font-size:18px;
    box-shadow:0 4px 12px rgba(244,67,54,0.4);
    cursor:pointer;
    transition:all 0.3s;
  }
  #backToMainBtn:hover { box-shadow:0 6px 16px rgba(244,67,54,0.6); }
  #backToMainBtn:active { transform:scale(0.95); }

  #ttsDisplay {
    position:fixed;
    bottom:20px;
    left:50%;
    transform:translateX(-50%);
    background:rgba(0,0,0,0.7);
    color:white;
    padding:12px 24px;
    border-radius:12px;
    font-size:18px;
    max-width:90%;
    z-index:1002;
    opacity:0;
    transition:opacity 0.3s;
    pointer-events:none;
  }
  #ttsDisplay.show { opacity:1; }

  #currentTurn {
    position:fixed;
    top:70px;
    left:50%;
    transform:translateX(-50%);
    background:rgba(255,255,255,0.9);
    color:#333;
    padding:10px 20px;
    border-radius:10px;
    font-size:18px;
    font-weight:bold;
    z-index:1001;
    display:none;
  }

  #gameEndMessage {
    position:fixed;
    top:50%;
    left:50%;
    transform:translate(-50%, -50%);
    background:rgba(0,0,0,0.95);
    color:#4CAF50;
    padding:40px;
    border-radius:25px;
    font-size:32px;
    font-weight:bold;
    z-index:10000;
    display:none;
    border:4px solid #4CAF50;
    max-width:90%;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
  }

  @media (max-width: 480px) {
    .shot-btn { font-size:14px; padding:10px 14px; border-radius:10px; }
    #tl { top:6%; left:6%; }
    #tr { top:6%; right:6%; }
    #bl { bottom:6%; left:6%; }
    #br { bottom:6%; right:6%; }
    #center { font-size:14px; }
    #gameEndMessage { font-size:24px; padding:25px; }
  }
</style>
</head>
<body>

<!-- ปุ่มกลับเมนูหลัก -->
<button id="backToMainBtn" onclick="window.location.href='../index.html'">กลับเมนูหลัก</button>

<!-- หน้าแรก: ตั้งชื่อ -->
<div id="nameInput">
  <p style="font-size:24px;">กรอกชื่อของคุณ</p>
  <input id="playerName" placeholder="ชื่อของคุณ" autofocus>
  <button id="confirmNameBtn">ยืนยัน</button>
</div>

<!-- ล็อบบี้ -->
<div id="lobby">
  <h2>ล็อบบี้</h2>
  <button id="createRoomBtn" style="background:#fff;color:#333;padding:15px 30px;border-radius:15px;font-weight:bold;">สร้างห้องใหม่</button>
  <h3>ห้องที่เปิดอยู่</h3>
  <ul id="roomList"></ul>
</div>

<!-- ห้อง -->
<div id="room">
  <h2 id="roomName"></h2>
  <p>ผู้เล่นในห้อง:</p>
  <ul id="playerList"></ul>
  
  <div id="teamSelectInRoom">
    <p>เลือกทีมของคุณ:</p>
    <button class="team-btn" data-team="Manchester United">แมนเชสเตอร์ ยูไนเต็ด</button>
    <button class="team-btn" data-team="Liverpool">ลิเวอร์พูล</button>
    <button class="team-btn" data-team="Arsenal">อาร์เซนอล</button>
    <button class="team-btn" data-team="Chelsea">เชลซี</button>
  </div>
  
  <div id="waitingMessage"></div>
  
  <button id="startBtn" onclick="startGame()">เริ่มเกม</button>
</div>

<!-- หน้าจอเกม -->
<div id="gameScreen" style="display:none;">
  <div id="scoreBoard">Score ตอนนี้คือ 0 - 0</div>
  <div id="currentTurn"></div>
  <button id="tl" class="shot-btn" onclick="debounceClick('TL')">มุมซ้ายบน</button>
  <button id="tr" class="shot-btn" onclick="debounceClick('TR')">มุมขวาบน</button>
  <button id="center" class="shot-btn" onclick="debounceClick('C')">ตรงกลาง</button>
  <button id="bl" class="shot-btn" onclick="debounceClick('BL')">มุมซ้ายล่าง</button>
  <button id="br" class="shot-btn" onclick="debounceClick('BR')">มุมขวาล่าง</button>
</div>

<!-- ข้อความจบเกม -->
<div id="gameEndMessage"></div>

<!-- TTS -->
<div id="ttsDisplay"></div>
<div id="tts" aria-live="assertive" style="position:absolute;left:-9999px;"></div>

<!-- เสียง -->
<audio id="bgm" loop src="audio/b.mp3"></audio>
<audio id="goal" src="audio/t.mp3"></audio>
<audio id="miss" src="audio/f.mp3"></audio>
<audio id="end" src="audio/end.mp3"></audio>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script>
// === Firebase ===
const firebaseConfig = {
  apiKey: "AIzaSyBIPeN4YUIrwM4MmFtDvT2DJ-v4toxc7tY",
  authDomain: "xo-game-134ec.firebaseapp.com",
  databaseURL: "https://xo-game-134ec-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "xo-game-134ec",
  storageBucket: "xo-game-134ec.appspot.com",
  messagingSenderId: "318375224157",
  appId: "1:318375224157:web:348a410dfd625359b77eb4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// === ตัวแปร ===
let playerName = "", roomId = "", playerId = "", isHost = false;
let currentRoomListener = null, soundListener = null, lobbyRoomsListener = null, gameListener = null;
let preloadedAudios = {};
let isButtonLocked = false;
let bgmAudio = null;
let gameStarted = false;
let isMyTurn = false;
let gameEnded = false;

// === TTS ===
let ttsQueue = [];
let isSpeaking = false;
const ttsDisplay = document.getElementById("ttsDisplay");

function speak(text){
  ttsQueue.push(text);
  processTTS();
}

function processTTS(){
  if(isSpeaking || ttsQueue.length === 0) return;
  isSpeaking = true;
  const msg = ttsQueue.shift();
  ttsDisplay.textContent = msg;
  ttsDisplay.classList.add('show');
  setTimeout(()=>{
    document.getElementById("tts").innerText = msg;
    setTimeout(()=>{
      isSpeaking = false;
      document.getElementById("tts").innerText = "";
      ttsDisplay.classList.remove('show');
      processTTS();
    }, Math.max(600, msg.length * 40));
  }, 50);
}

function waitForSound(audioEl){
  return new Promise(resolve => {
    audioEl.onended = ()=>resolve();
    audioEl.play().catch(()=> resolve());
  });
}

// === ทีม ===
const squads = {
  "Manchester United": { players: ["แกรี่ เนวิลล์","ริโอ เฟอร์ดินานด์","เวส บราวน์","ปาทริซ เอฟร่า","คริสเตียโน่ โรนัลโด้","พอล สโคลส์","จอห์น โอเช","ไรอัน กิ๊กส์","เวย์น รูนี่ย์","รุด ฟาน นิสเทลรอย"], keeper: "เอ็ดวิน ฟาน เดอร์ ซาร์" },
  "Liverpool": { players: ["สตีฟ ฟินแนน","เจมี่ คาร์ราเกอร์","ซามี่ ฮูเปีย","จอห์น อาร์เน่ รีเซ่","ซาบี อลอนโซ่","โมฮาเหม็ด ซิสโซโก้","สตีเว่น เจอร์ราร์ด","หลุยส์ การ์เซีย","ปีเตอร์ เคร้าช์","ฌิบริล ซิสเซ่"], keeper: "เปเป้ เรน่า" },
  "Arsenal": { players: ["เอ็มมานูเอล เอบูเอ้","โคโล ตูเร่","โซล แคมเบล","แอชลีย์ โคล","อเล็กซานเดอร์ เคล็บ","ฌิลแบร์โต้ ซิลวา","เชส ฟาเบรกัส","โรแบร์ ปิแรส","เฟรดริก ลุงเบิร์ก","เธียร์รี่ อองรี"], keeper: "เยนส์ เลห์มันน์" },
  "Chelsea": { players: ["เปาโล เฟร์เรร่า","ริคาร์โด้ คาร์วัลโญ่","จอห์น เทอร์รี่","วิลเลียม กัลลาส","โคล้ด มาเกเลเล่","มิคาเอล เอสเซียง","แฟรงก์ แลมพาร์ด","โจ โคล","อาร์เยน ร็อบเบน","เฮอร์นัน เครสโป"], keeper: "ปีเตอร์ เช็ก" }
};

let shotOrderP1 = [], shotOrderP2 = [];
let spokenTurns = new Set();
let lastProcessedTurn = -1;
let currentTurnFromShot = -1;

// === เสียง ===
function preloadAllSounds() {
  const files = ["friend.mp3", "b.mp3", "t.mp3", "f.mp3", "end.mp3"];
  files.forEach(name => {
    const audio = new Audio(`audio/${name}`);
    audio.preload = "auto";
    preloadedAudios[name] = audio;
  });
  bgmAudio = preloadedAudios["b.mp3"];
}

function startBGM() {
  if (bgmAudio) {
    bgmAudio.currentTime = 0;
    bgmAudio.volume = 0.3;
    bgmAudio.loop = true;
    bgmAudio.play().catch(() => {});
  }
}
function stopBGM() {
  if (bgmAudio) {
    bgmAudio.pause();
    bgmAudio.currentTime = 0;
  }
}

function playSound(name) {
  if (name === "b.mp3") return;
  if ((name === "t.mp3" || name === "f.mp3") && lastProcessedTurn === currentTurnFromShot) return;
  const audio = preloadedAudios[name];
  if (audio) {
    audio.currentTime = 0;
    audio.volume = 1;
    audio.play().catch(() => {});
  }
}

function triggerSound(name) {
  if (!roomId) return;
  db.ref(`penaltyRooms/${roomId}/soundTrigger`).set({
    name: name, time: Date.now(), playerId: playerId
  });
}

function startSoundListener() {
  if (soundListener) soundListener.off();
  if (!roomId) return;
  soundListener = db.ref(`penaltyRooms/${roomId}/soundTrigger`);
  soundListener.on("value", s => {
    const data = s.val();
    if (data && data.time && Date.now() - data.time < 1000) {
      playSound(data.name);
    }
  });
}

function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

function createShotsOrder(team){
  let players = squads[team].players.slice();
  shuffle(players);
  players.push(squads[team].keeper);
  return players;
}

// === Debounce ===
function debounceClick(dir){
  if(isButtonLocked || !isMyTurn || gameEnded) return;
  isButtonLocked = true;
  chooseDirection(dir);
  setTimeout(()=>{ isButtonLocked = false; }, 100);
}

const goalSnd = document.getElementById("goal");
const missSnd = document.getElementById("miss");
const endSnd = document.getElementById("end");

/* === เริ่มต้นแอป === */
document.addEventListener("DOMContentLoaded", () => {
  const playerNameInput = document.getElementById("playerName");
  const confirmBtn = document.getElementById("confirmNameBtn");

  playerNameInput.focus();

  confirmBtn.addEventListener("click", confirmName);
  playerNameInput.addEventListener("keydown", e => {
    if (e.key === "Enter") confirmName();
  });

  document.getElementById("createRoomBtn").onclick = showCreateRoom;
  document.querySelectorAll(".team-btn").forEach(btn => {
    btn.onclick = () => chooseTeam(btn.getAttribute("data-team"));
  });

  // แสดงปุ่มกลับเมนูหลักในหน้าแรก
  document.getElementById("backToMainBtn").style.display = "block";
});

/* === ยืนยันชื่อ === */
function confirmName() {
  const input = document.getElementById("playerName");
  playerName = input.value.trim();
  if (!playerName) {
    alert("กรุณาใส่ชื่อ");
    return;
  }
  playerId = Math.random().toString(36).substr(2,9);
  document.getElementById("nameInput").style.display = "none";
  document.getElementById("lobby").style.display = "block";
  preloadAllSounds();
  loadRooms();

  // ซ่อนปุ่มกลับเมนูหลักเมื่อเข้าล็อบบี้
  document.getElementById("backToMainBtn").style.display = "none";
}

/* === สร้างห้องใหม่ === */
async function showCreateRoom() {
  const name = prompt("ตั้งชื่อห้อง:");
  if (!name) return;
  const roomIdNew = db.ref("penaltyRooms").push().key;
  await db.ref(`penaltyRooms/${roomIdNew}`).set({
    name: name,
    created: Date.now(),
    host: playerId,
    status: "waiting",
    players: {
      [playerId]: { name: playerName }
    }
  });
  roomId = roomIdNew;
  isHost = true;
  showRoom();
}

/* === เข้าห้อง === */
async function joinRoom(id) {
  const snap = await db.ref(`penaltyRooms/${id}`).once("value");
  const room = snap.val();
  if (!room || Object.keys(room.players || {}).length >= 2) {
    alert("ห้องเต็มหรือไม่พบห้อง");
    return;
  }
  roomId = id;
  isHost = false;
  await db.ref(`penaltyRooms/${roomId}/players/${playerId}`).set({ name: playerName });
  showRoom();
}

/* === โหลดห้องในล็อบบี้ === */
function loadRooms() {
  if (lobbyRoomsListener) lobbyRoomsListener.off();
  const list = document.getElementById("roomList");
  list.innerHTML = "";
  lobbyRoomsListener = db.ref("penaltyRooms").on("value", snap => {
    const rooms = snap.val() || {};
    list.innerHTML = "";
    Object.entries(rooms).forEach(([key, r]) => {
      if (r.status === "waiting" && Object.keys(r.players || {}).length < 2) {
        const li = document.createElement("li");
        li.innerHTML = `${r.name} (${Object.keys(r.players || {}).length}/2)`;
        const btn = document.createElement("button");
        btn.textContent = "เข้าร่วม";
        btn.style.cssText = "margin-left:10px;padding:5px 15px;background:#4CAF50;color:white;border:none;border-radius:5px;cursor:pointer;";
        btn.onclick = () => joinRoom(key);
        li.appendChild(btn);
        list.appendChild(li);
      }
    });
  });
}

/* === แสดงห้อง === */
function showRoom() {
  document.getElementById("lobby").style.display = "none";
  document.getElementById("room").style.display = "block";
  startSoundListener();

  if (currentRoomListener) currentRoomListener.off();
  currentRoomListener = db.ref(`penaltyRooms/${roomId}`);
  currentRoomListener.on("value", snap => {
    const room = snap.val();
    if (!room) { alert("ห้องถูกลบ"); backToLobby(); return; }
    document.getElementById("roomName").textContent = `ห้อง: ${room.name}`;
    
    const players = room.players || {};
    const list = document.getElementById("playerList");
    list.innerHTML = "";
    for (let id in players) {
      const p = players[id];
      if (p && p.name) {
        list.innerHTML += `<li>${p.name}${p.team ? ` - ${p.team}` : ""}</li>`;
      }
    }
    updateTeamButtons(room);

    const takenTeams = Object.values(players).filter(p => p && p.team).map(p => p.team);
    const teamDiv = document.getElementById("teamSelectInRoom");
    const waitMsg = document.getElementById("waitingMessage");
    const startBtn = document.getElementById("startBtn");

    if (players[playerId]?.team) {
      teamDiv.style.display = "none";
      waitMsg.style.display = "block";
      waitMsg.innerHTML = takenTeams.length === 1 ? "เลือกทีมแล้ว รอผู้เล่นที่เหลือ..." : "เลือกทีมแล้ว รอเจ้าของห้องกดเริ่มเกม…";
    } else {
      teamDiv.style.display = "flex";
      waitMsg.style.display = "none";
    }

    if (room.host === playerId && takenTeams.length === 2) {
      startBtn.style.display = "inline-block";
      startBtn.disabled = false;
    } else {
      startBtn.style.display = "none";
    }

    if (room.status === "playing") setupGameListener(room, players);
    if (room.status === "finished" && room.resultMessage) {
      showGameEnd(room);
    }
  });
}

function updateTeamButtons(room) {
  const taken = Object.values(room.players || {}).filter(p => p && p.team).map(p => p.team);
  document.querySelectorAll(".team-btn").forEach(btn => {
    const team = btn.getAttribute("data-team");
    if (taken.includes(team)) {
      btn.classList.add("unavailable");
      btn.disabled = true;
    } else {
      btn.classList.remove("unavailable");
      btn.disabled = false;
    }
  });
}

function chooseTeam(team) {
  db.ref(`penaltyRooms/${roomId}/players/${playerId}/team`).set(team);
  triggerSound("friend.mp3");
  speak(`${playerName} เลือกทีม ${team}`);
}

/* === เริ่มเกม === */
function startGame() {
  if (gameStarted) return;
  gameStarted = true;
  document.getElementById("startBtn").disabled = true;
  speak("เริ่มเกม!");

  db.ref(`penaltyRooms/${roomId}/players`).once("value").then(snap => {
    const players = snap.val();
    const keys = Object.keys(players);
    const p1Id = keys[0], p2Id = keys[1];
    const p1Team = players[p1Id].team;
    const p2Team = players[p2Id].team;
    
    const orderP1 = createShotsOrder(p1Team);
    const orderP2 = createShotsOrder(p2Team);
    
    const firstShooter = Math.random() < 0.5 ? p1Id : p2Id;
    
    speak(`ทีม ${p1Team} ปะทะ ${p2Team}`);
    speak(`${players[firstShooter].name} จากทีม ${players[firstShooter].team} จะยิงลูกแรก`);
    
    db.ref(`penaltyRooms/${roomId}`).update({
      status: "playing", 
      firstShooter: firstShooter,
      turn: 0,
      scoreP1: 0, 
      scoreP2: 0, 
      shotIndexP1: 0, 
      shotIndexP2: 0,
      isSudden: false, 
      shooterDir: null, 
      keeperDir: null,
      processed: false,
      shotOrderP1: orderP1,
      shotOrderP2: orderP2,
      p1Id: p1Id,
      p2Id: p2Id
    });
  });
}

/* === ตั้งค่า Game Listener === */
function setupGameListener(room, players) {
  if (gameListener) gameListener.off();

  document.getElementById("room").style.display = "none";
  document.getElementById("gameScreen").style.display = "block";
  document.getElementById("currentTurn").style.display = "block";
  startBGM();
  gameEnded = false;

  shotOrderP1 = room.shotOrderP1 || [];
  shotOrderP2 = room.shotOrderP2 || [];

  const gameRef = db.ref(`penaltyRooms/${roomId}`);
  gameListener = gameRef;

  let lastTurn = -1;
  let lastIsSudden = false;

  gameRef.on("value", snap => {
    const data = snap.val();
    if (!data) return;

    // ถ้าจบเกมแล้ว → ซ่อนปุ่ม + แสดงผลทันที
    if (data.status === "finished" && data.resultMessage) {
      if (!gameEnded) {
        gameEnded = true;
        hideGameButtons();
        showGameEnd(data);
      }
      return;
    }

    if (data.status !== "playing") return;

    const scoreP1 = data.scoreP1 || 0;
    const scoreP2 = data.scoreP2 || 0;
    document.getElementById("scoreBoard").innerText = `Score ตอนนี้คือ ${scoreP1} - ${scoreP2}`;

    const p1Id = data.p1Id;
    const p2Id = data.p2Id;
    const currentShooterId = data.turn % 2 === 0 ? data.firstShooter : (data.firstShooter === p1Id ? p2Id : p1Id);
    const currentKeeperId = currentShooterId === p1Id ? p2Id : p1Id;
    isMyTurn = (playerId === currentShooterId || playerId === currentKeeperId) && !data.processed;

    document.querySelectorAll('.shot-btn').forEach(btn => {
      if (isMyTurn) {
        btn.classList.remove('locked');
        btn.disabled = false;
        btn.style.display = 'block';
      } else {
        btn.classList.add('locked');
        btn.disabled = true;
        btn.style.display = data.processed ? 'none' : 'block';
      }
    });

    const currentTurnEl = document.getElementById("currentTurn");
    const action = playerId === currentShooterId ? "ยิง!" : "เซฟ!";
    currentTurnEl.textContent = `ถึงตาคุณ${action}`;
    currentTurnEl.style.background = playerId === currentShooterId ? "rgba(76,175,80,0.9)" : "rgba(255,152,0,0.9)";
    currentTurnEl.style.color = "white";
    currentTurnEl.style.display = "block";

    if (data.turn !== lastTurn && !data.processed) {
      lastTurn = data.turn;
      const shooterOrder = currentShooterId === p1Id ? shotOrderP1 : shotOrderP2;
      const shooterIndex = currentShooterId === p1Id ? data.shotIndexP1 : data.shotIndexP2;
      const shooterName = shooterOrder[shooterIndex];
      const keeper = squads[players[currentKeeperId].team].keeper;
      const shooterTeam = players[currentShooterId].team;

      if (playerId === currentShooterId && !spokenTurns.has(`turn_${data.turn}_shooter`)) {
        spokenTurns.add(`turn_${data.turn}_shooter`);
        speak(`ลูกที่ ${shooterIndex+1} ${shooterTeam}: ${shooterName} เตรียมยิง`);
      }

      if (playerId === currentKeeperId && !spokenTurns.has(`turn_${data.turn}_keeper`)) {
        spokenTurns.add(`turn_${data.turn}_keeper`);
        speak(`ลูกที่ ${shooterIndex+1} ${shooterTeam}: ${shooterName} เตรียมยิง ${keeper} ของคุณพร้อมเซฟ`);
      }
    }

    if (data.isSudden && !lastIsSudden) {
      if (!spokenTurns.has("sudden")) {
        spokenTurns.add("sudden");
        speak("เข้าสู่ซัดเดนเดธ!");
      }
    }
    lastIsSudden = data.isSudden;

    if (data.shooterDir && data.keeperDir && !data.processed) {
      processShot(data, players, gameRef);
    }
  });
}

// === ซ่อนปุ่มยิงทันที ===
function hideGameButtons() {
  document.querySelectorAll('.shot-btn').forEach(btn => {
    btn.style.display = 'none';
  });
  document.getElementById("currentTurn").style.display = "none";
  gameEnded = true;
}

/* === processShot === */
async function processShot(data, players, gameRef) {
  const processedRef = gameRef.child('processed');
  const transactionResult = await processedRef.transaction(current => {
    if (current) return;
    return true;
  });

  if (!transactionResult.committed) return;

  const p1Id = data.p1Id;
  const p2Id = data.p2Id;
  const currentShooterId = data.turn % 2 === 0 ? data.firstShooter : (data.firstShooter === p1Id ? p2Id : p1Id);
  const currentKeeperId = currentShooterId === p1Id ? p2Id : p1Id;
  
  const shooterOrder = currentShooterId === p1Id ? shotOrderP1 : shotOrderP2;
  const shooterIndex = currentShooterId === p1Id ? data.shotIndexP1 : data.shotIndexP2;
  const shooterName = shooterOrder[shooterIndex];
  const shooterTeam = players[currentShooterId].team;

  const isGoal = data.shooterDir !== data.keeperDir;

  if (isGoal) await waitForSound(goalSnd);
  else await waitForSound(missSnd);

  let scoreP1 = data.scoreP1 || 0;
  let scoreP2 = data.scoreP2 || 0;
  if (isGoal) {
    currentShooterId === p1Id ? scoreP1++ : scoreP2++;
  }

  if (!spokenTurns.has(`result_${data.turn}`)) {
    spokenTurns.add(`result_${data.turn}`);
    const finalMsg = `${shooterName} ${shooterTeam} ยิง${isGoal?"เข้า":"ไม่เข้า"}! Score ${scoreP1} - ${scoreP2}`;
    speak(finalMsg);
  }

  if (playerId === currentShooterId) {
    const soundName = isGoal ? "t.mp3" : "f.mp3";
    triggerSound(soundName);
    currentTurnFromShot = data.turn;
    lastProcessedTurn = data.turn;
  }

  const updates = {
    turn: data.turn + 1,
    shooterDir: null, 
    keeperDir: null, 
    processed: false,
    scoreP1, scoreP2
  };

  if (currentShooterId === p1Id) {
    updates.shotIndexP1 = data.shotIndexP1 + 1;
  } else {
    updates.shotIndexP2 = data.shotIndexP2 + 1;
  }

  setTimeout(() => {
    gameRef.update(updates);
    setTimeout(() => checkGameEndOrNext(data, players, gameRef, scoreP1, scoreP2, updates.shotIndexP1 || data.shotIndexP1, updates.shotIndexP2 || data.shotIndexP2), 1000);
  }, 1000);
}

/* === ตรวจจบเกม === */
function checkGameEndOrNext(data, players, gameRef, scoreP1, scoreP2, sp1, sp2) {
  const p1Id = data.p1Id;
  const p2Id = data.p2Id;

  const shotsP1 = sp1;
  const shotsP2 = sp2;
  const remainingP1 = 5 - shotsP1;
  const remainingP2 = 5 - shotsP2;

  let end = false;

  if (!data.isSudden){
    if(shotsP1 > shotsP2 && scoreP1 - scoreP2 > remainingP2) end = true;
    else if(shotsP2 >= shotsP1 && scoreP2 - scoreP1 > remainingP1) end = true;
    else if(shotsP1 >= 5 && shotsP2 >= 5 && scoreP1 !== scoreP2) end = true;
    else if(shotsP1 >= 5 && shotsP2 >= 5) {
      gameRef.update({ isSudden: true });
      return;
    }
  } else {
    if(shotsP1 > shotsP2 || (shotsP2 >= shotsP1 && scoreP1 !== scoreP2)) end = true;
  }

  if(end){
    triggerSound("end.mp3");
    stopBGM();

    const p1Team = players[p1Id].team;
    const p2Team = players[p2Id].team;
    
    let resultMessage = scoreP1 > scoreP2 ? `${p1Team} ชนะ!` : scoreP1 < scoreP2 ? `${p2Team} ชนะ!` : "เสมอ!";

    setTimeout(() => {
      gameRef.update({
        status: "finished",
        finalScoreP1: scoreP1,
        finalScoreP2: scoreP2,
        resultMessage: resultMessage
      });
    }, 800);
  }
}

async function chooseDirection(dir) {
  const snap = await db.ref(`penaltyRooms/${roomId}`).once("value");
  const data = snap.val();
  if (data.status !== "playing" || data.processed || gameEnded) return;

  const currentShooterId = data.turn % 2 === 0 ? data.firstShooter : (data.firstShooter === data.p1Id ? data.p2Id : data.p1Id);
  const currentKeeperId = currentShooterId === data.p1Id ? data.p2Id : data.p1Id;

  if (playerId === currentShooterId && !data.shooterDir) {
    await db.ref(`penaltyRooms/${roomId}/shooterDir`).set(dir);
  } else if (playerId === currentKeeperId && !data.keeperDir) {
    await db.ref(`penaltyRooms/${roomId}/keeperDir`).set(dir);
  }
}

/* === แสดงหน้าจอจบเกม === */
function showGameEnd(room) {
  stopBGM();
  hideGameButtons();
  
  const messageEl = document.getElementById("gameEndMessage");
  messageEl.textContent = `ผู้ชนะคือ ${room.resultMessage}`;
  messageEl.style.display = "block";
  
  // แสดงปุ่มกลับเมนูหลักเมื่อจบเกม
  document.getElementById("backToMainBtn").style.display = "block";
  
  // TTS ประกาศผู้ชนะ
  speak(`ผู้ชนะคือ ${room.resultMessage}`);
}

/* === ออกจากห้อง → กลับไปล็อบบี้โดยใช้ชื่อเดิมทันที === */
function backToLobby() {
  gameStarted = false; 
  gameEnded = false;
  isButtonLocked = false; 
  isMyTurn = false;
  stopBGM();
  spokenTurns.clear();
  shotOrderP1 = []; shotOrderP2 = [];
  lastProcessedTurn = -1;
  currentTurnFromShot = -1;
  
  document.getElementById("gameEndMessage").style.display = "none";
  
  // ลบผู้เล่นออกจากห้องเดิม (ถ้ามี)
  if (roomId && playerId) {
    db.ref(`penaltyRooms/${roomId}/players/${playerId}`).remove();
  }
  
  // รีเซ็ตตัวแปร
  roomId = ""; 
  isHost = false;

  // ปิด listeners
  if (currentRoomListener) { currentRoomListener.off(); currentRoomListener = null; }
  if (soundListener) { soundListener.off(); soundListener = null; }
  if (lobbyRoomsListener) { lobbyRoomsListener.off(); lobbyRoomsListener = null; }
  if (gameListener) { gameListener.off(); gameListener = null; }

  // ซ่อนหน้าจอทั้งหมด
  document.getElementById("room").style.display = "none";
  document.getElementById("gameScreen").style.display = "none";
  document.querySelectorAll('.shot-btn').forEach(btn => {
    btn.style.display = 'block';
  });

  // แสดงล็อบบี้ + โหลดห้องใหม่ทันที (ใช้ playerName, playerId เดิม)
  document.getElementById("lobby").style.display = "block";
  loadRooms();

  // ซ่อนปุ่มกลับเมนูหลักเมื่อกลับไปล็อบบี้
  document.getElementById("backToMainBtn").style.display = "none";
}
</script>
</body>
</html>