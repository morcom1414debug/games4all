<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>เกมยิงจุดโทษ 2005/2006 - ออนไลน์</title>
<style>
  /* ---------- CSS เดิมทั้งหมด (ไม่เปลี่ยน) ---------- */
  body {font-family:Tahoma;background:#111;color:white;text-align:center;margin:0;padding:20px;height:100vh;overflow:hidden;position:relative;}
  .shot-btn{position:fixed;background:rgba(255,255,255,0.9);border-radius:12px;padding:12px 18px;font-weight:bold;cursor:pointer;border:2px solid #fff;font-size:16px;z-index:1000;box-shadow:0 6px 16px rgba(0,0,0,0.5);transition:all .2s;opacity:1;min-width:80px;white-space:nowrap;}
  .shot-btn:active{transform:scale(.95);box-shadow:0 3px 8px rgba(0,0,0,0.5);}
  .shot-btn:disabled{opacity:.5;cursor:not-allowed;}
  .shot-btn.locked{opacity:.3;cursor:not-allowed;}
  #tl{top:8%;left:8%;}#tr{top:8%;right:8%;}#center{top:50%;left:50%;transform:translate(-50%,-50%);}
  #bl{bottom:8%;left:8%;}#br{bottom:8%;right:8%;}
  #scoreBoard{margin-top:20px;font-size:24px;position:fixed;top:10px;left:50%;transform:translateX(-50%);z-index:1001;background:rgba(0,0,0,0.7);padding:12px 24px;border-radius:12px;border:2px solid #fff;}
  #nameInput{display:flex;flex-direction:column;gap:20px;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);padding:30px;border-radius:20px;width:320px;max-width:90%;}
  #nameInput input{padding:12px;font-size:20px;border-radius:8px;border:none;text-align:center;}
  #nameInput button{background:rgba(255,255,255,0.9);border:none;border-radius:15px;padding:15px;font-weight:bold;font-size:20px;cursor:pointer;}
  #lobby,#room{display:none;}
  ul{list-style:none;padding:0;margin:0;}
  li{margin:8px 0;background:rgba(255,255,255,0.1);padding:12px;border-radius:10px;}
  #teamSelectInRoom{display:none;flex-direction:column;gap:15px;margin-top:20px;}
  #teamSelectInRoom button{background:rgba(255,255,255,0.9);border-radius:15px;padding:15px 30px;font-weight:bold;cursor:pointer;border:3px solid #fff;font-size:20px;transition:all .2s;}
  #teamSelectInRoom button:disabled,#teamSelectInRoom button.unavailable{background:#555;cursor:not-allowed;opacity:.6;border-color:#777;}
  #waitingMessage{display:none;margin-top:20px;padding:20px;background:rgba(255,255,255,0.1);border-radius:15px;font-size:18px;}
  #startBtn{display:none;margin-top:20px;background:#4CAF50;color:white;border:none;border-radius:15px;padding:15px 30px;font-weight:bold;font-size:20px;cursor:pointer;}
  #backToMainBtn{position:fixed;top:15px;left:15px;z-index:9999;display:none;background:#f44336;color:white;border:none;border-radius:50px;padding:12px 26px;font-weight:bold;font-size:18px;box-shadow:0 4px 12px rgba(244,67,54,0.4);cursor:pointer;transition:all .3s;}
  #backToMainBtn:hover{box-shadow:0 6px 16px rgba(244,67,54,0.6);}
  #backToMainBtn:active{transform:scale(.95);}
  #ttsDisplay{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.7);color:white;padding:12px 24px;border-radius:12px;font-size:18px;max-width:90%;z-index:1002;opacity:0;transition:opacity .3s;pointer-events:none;}
  #ttsDisplay.show{opacity:1;}
  #currentTurn{position:fixed;top:70px;left:50%;transform:translateX(-50%);background:rgba(255,255,255,0.9);color:#333;padding:10px 20px;border-radius:10px;font-size:18px;font-weight:bold;z-index:1001;display:none;}
  #gameEndMessage{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.95);color:#4CAF50;padding:40px;border-radius:25px;font-size:32px;font-weight:bold;z-index:10000;display:none;border:4px solid #4CAF50;max-width:90%;text-shadow:2px 2px 4px rgba(0,0,0,0.8);}
  @media(max-width:480px){
    .shot-btn{font-size:14px;padding:10px 14px;border-radius:10px;}
    #tl{top:6%;left:6%;}#tr{top:6%;right:6%;}#bl{bottom:6%;left:6%;}#br{bottom:6%;right:6%;}
    #center{font-size:14px;}
    #gameEndMessage{font-size:24px;padding:25px;}
  }
</style>
</head>
<body>

<button id="backToMainBtn" onclick="window.location.href='../index.html'">กลับเมนูหลัก</button>

<div id="nameInput">
  <p style="font-size:24px;">กรอกชื่อของคุณ</p>
  <input id="playerName" placeholder="ชื่อของคุณ" autofocus>
  <button id="confirmNameBtn">ยืนยัน</button>
</div>

<div id="lobby">
  <h2>ล็อบบี้</h2>
  <button id="createRoomBtn" style="background:#fff;color:#333;padding:15px 30px;border-radius:15px;font-weight:bold;">สร้างห้องใหม่</button>
  <h3>ห้องที่เปิดอยู่</h3>
  <ul id="roomList"></ul>
</div>

<div id="room">
  <h2 id="roomName"></h2>
  <p>ผู้เล่นในห้อง:</p>
  <ul id="playerList"></ul>
  <div id="teamSelectInRoom">
    <p>เลือกทีมของคุณ:</p>
    <button class="team-btn" data-team="Manchester United">แมนเชสเตอร์ ยูไนเต็ด</button>
    <button class="team-btn" data-team="Liverpool">ลิเวอร์พูล</button>
    <button class="team-btn" data-team="Arsenal">อาร์เซนอล</button>
    <button class="team-btn" data-team="Chelsea">เชลซี</button>
  </div>
  <div id="waitingMessage"></div>
  <button id="startBtn" onclick="startGame()">เริ่มเกม</button>
</div>

<div id="gameScreen" style="display:none;">
  <div id="scoreBoard">Score ตอนนี้คือ 0 - 0</div>
  <div id="currentTurn"></div>
  <button id="tl" class="shot-btn" onclick="debounceClick('TL')">มุมซ้ายบน</button>
  <button id="tr" class="shot-btn" onclick="debounceClick('TR')">มุมขวาบน</button>
  <button id="center" class="shot-btn" onclick="debounceClick('C')">ตรงกลาง</button>
  <button id="bl" class="shot-btn" onclick="debounceClick('BL')">มุมซ้ายล่าง</button>
  <button id="br" class="shot-btn" onclick="debounceClick('BR')">มุมขวาล่าง</button>
</div>

<div id="gameEndMessage"></div>

<div id="ttsDisplay"></div>
<div id="tts" aria-live="assertive" style="position:absolute;left:-9999px;"></div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script>
/* ====================== 1. Firebase ====================== */
const firebaseConfig = {
  apiKey: "AIzaSyBIPeN4YUIrwM4MmFtDvT2DJ-v4toxc7tY",
  authDomain: "xo-game-134ec.firebaseapp.com",
  databaseURL: "https://xo-game-134ec-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "xo-game-134ec",
  storageBucket: "xo-game-134ec.appspot.com",
  messagingSenderId: "318375224157",
  appId: "1:318375224157:web:348a410dfd625359b77eb4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ====================== 2. Preload + Cache ====================== */
const preloadedAudios = {};
const soundFiles = {
  friend: "friend.mp3",
  goal:   "t.mp3",
  miss:   "f.mp3",
  end:    "end.mp3",
  bgm:    "b.mp3"
};
function preloadAllSounds() {
  Object.entries(soundFiles).forEach(([key, file]) => {
    const a = new Audio(`audio/${file}`);
    a.preload = "auto";
    a.load();
    preloadedAudios[key] = a;
  });
}

/* ====================== 3. BGM ====================== */
function startBGM() {
  const bgm = preloadedAudios.bgm;
  if (bgm) {
    bgm.currentTime = 0;
    bgm.volume = 0.3;
    bgm.loop = true;
    bgm.play().catch(() => {});
  }
}
function stopBGM() {
  const bgm = preloadedAudios.bgm;
  if (bgm) { bgm.pause(); bgm.currentTime = 0; }
}

/* ====================== 4. Trigger Sound (ผ่าน Firebase) ====================== */
function triggerSound(name) {
  if (!roomId) return;
  db.ref(`penaltyRooms/${roomId}/soundTrigger`).set({
    name,
    time: Date.now(),
    playerId
  });
}

/* ====================== 5. Sound Listener ====================== */
let soundListener = null;
function startSoundListener() {
  if (soundListener) soundListener.off();
  if (!roomId) return;
  soundListener = db.ref(`penaltyRooms/${roomId}/soundTrigger`);
  soundListener.on("value", s => {
    const data = s.val();
    if (!data || Date.now() - data.time > 1000) return;

    const audio = preloadedAudios[data.name];
    if (audio) {
      audio.currentTime = 0;
      audio.volume = 1;
      audio.play().catch(() => {});
    }

    let msg = "";
    if (data.name === "t.mp3") msg = "ยิงเข้า!";
    else if (data.name === "f.mp3") msg = "ยิงไม่เข้า!";
    else if (data.name === "end.mp3") msg = "จบเกม!";
    else if (data.name === "friend.mp3") msg = `${playerName} เลือกทีมแล้ว`;

    if (msg) {
      speak(msg);
      const live = document.getElementById("tts");
      live.textContent = msg;
      setTimeout(() => live.textContent = "", 3000);
    }
  });
}

/* ====================== 6. TTS ====================== */
let ttsQueue = [], isSpeaking = false;
const ttsDisplay = document.getElementById("ttsDisplay");
function speak(text){
  ttsQueue.push(text);
  processTTS();
}
function processTTS(){
  if(isSpeaking || ttsQueue.length===0) return;
  isSpeaking = true;
  const msg = ttsQueue.shift();
  ttsDisplay.textContent = msg;
  ttsDisplay.classList.add('show');
  setTimeout(()=>{
    document.getElementById("tts").innerText = msg;
    setTimeout(()=>{
      isSpeaking=false;
      document.getElementById("tts").innerText="";
      ttsDisplay.classList.remove('show');
      processTTS();
    }, Math.max(800, msg.length*50));
  },50);
}

/* ====================== 7. ตัวแปรหลัก ====================== */
let playerName = "", roomId = "", playerId = "", isHost = false;
let currentRoomListener = null, lobbyRoomsListener = null, gameListener = null;
let isButtonLocked = false, gameStarted = false, isMyTurn = false, gameEnded = false;
let shotOrderP1 = [], shotOrderP2 = [];
let spokenTurns = new Set();
let lastProcessedTurn = -1;

/* ====================== 8. ทีม ====================== */
const squads = {
  "Manchester United": {players:["แกรี่ เนวิลล์","ริโอ เฟอร์ดินานด์","เวส บราวน์","ปาทริซ เอฟร่า","คริสเตียโน่ โรนัลโด้","พอล สโคลส์","จอห์น โอเช","ไรอัน กิ๊กส์","เวย์น รูนี่ย์","รุด ฟาน นิสเทลรอย"],keeper:"เอ็ดวิน ฟาน เดอร์ ซาร์"},
  "Liverpool": {players:["สตีฟ ฟินแนน","เจมี่ คาร์ราเกอร์","ซามี่ ฮูเปีย","จอห์น อาร์เน่ รีเซ่","ซาบี อลอนโซ่","โมฮาเหม็ด ซิสโซโก้","สตีเว่น เจอร์ราร์ด","หลุยส์ การ์เซีย","ปีเตอร์ เคร้าช์","ฌิบริล ซิสเซ่"],keeper:"เปเป้ เรน่า"},
  "Arsenal": {players:["เอ็มมานูเอล เอบูเอ้","โคโล ตูเร่","โซล แคมเบล","แอชลีย์ โคล","อเล็กซานเดอร์ เคล็บ","ฌิลแบร์โต้ ซิลวา","เชส ฟาเบรกัส","โรแบร์ ปิแรส","เฟรดริก ลุงเบิร์ก","เธียร์รี่ อองรี"],keeper:"เยนส์ เลห์มันน์"},
  "Chelsea": {players:["เปาโล เฟร์เรร่า","ริคาร์โด้ คาร์วัลโญ่","จอห์น เทอร์รี่","วิลเลียม กัลลาส","โคล้ด มาเกเลเล่","มิคาเอล เอสเซียง","แฟรงก์ แลมพาร์ด","โจ โคล","อาร์เยน ร็อบเบน","เฮอร์นัน เครสโป"],keeper:"ปีเตอร์ เช็ก"}
};

function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function createShotsOrder(team){
  let p = squads[team].players.slice();
  shuffle(p);
  p.push(squads[team].keeper);
  return p;
}

/* ====================== 9. Debounce ====================== */
function debounceClick(dir){
  if(isButtonLocked || !isMyTurn || gameEnded) return;
  isButtonLocked = true;
  chooseDirection(dir);
  setTimeout(()=>{isButtonLocked=false;},100);
}

/* ====================== 10. เริ่มแอป ====================== */
document.addEventListener("DOMContentLoaded", () => {
  const input = document.getElementById("playerName");
  const btn = document.getElementById("confirmNameBtn");
  input.focus();
  btn.onclick = confirmName;
  input.onkeydown = e=> {if(e.key==="Enter") confirmName();};
  document.getElementById("createRoomBtn").onclick = showCreateRoom;
  document.querySelectorAll(".team-btn").forEach(b=>b.onclick=()=>chooseTeam(b.dataset.team));
  document.getElementById("backToMainBtn").style.display = "block";
});

/* ====================== 11. ยืนยันชื่อ ====================== */
function confirmName(){
  const n = document.getElementById("playerName").value.trim();
  if(!n){alert("กรุณาใส่ชื่อ");return;}
  playerName = n; playerId = Math.random().toString(36).substr(2,9);
  document.getElementById("nameInput").style.display="none";
  document.getElementById("lobby").style.display="block";
  preloadAllSounds();
  loadRooms();
  document.getElementById("backToMainBtn").style.display="none";
}

/* ====================== 12. สร้าง/เข้าร่วมห้อง ====================== */
async function showCreateRoom(){
  const name = prompt("ตั้งชื่อห้อง:");
  if(!name) return;
  const newId = db.ref("penaltyRooms").push().key;
  await db.ref(`penaltyRooms/${newId}`).set({name,created:Date.now(),host:playerId,status:"waiting",players:{[playerId]:{name:playerName}}});
  roomId = newId; isHost = true; showRoom();
}
async function joinRoom(id){
  const snap = await db.ref(`penaltyRooms/${id}`).once("value");
  const r = snap.val();
  if(!r || Object.keys(r.players||{}).length>=2){alert("ห้องเต็มหรือไม่พบ");return;}
  roomId = id; isHost = false;
  await db.ref(`penaltyRooms/${roomId}/players/${playerId}`).set({name:playerName});
  showRoom();
}

/* ====================== 13. Lobby ====================== */
function loadRooms(){
  if(lobbyRoomsListener) lobbyRoomsListener.off();
  const ul = document.getElementById("roomList"); ul.innerHTML="";
  lobbyRoomsListener = db.ref("penaltyRooms").on("value", s=>{
    const rooms = s.val()||{};
    ul.innerHTML="";
    Object.entries(rooms).forEach(([k,r])=>{
      if(r.status==="waiting" && Object.keys(r.players||{}).length<2){
        const li=document.createElement("li");
        li.innerHTML=`${r.name} (${Object.keys(r.players||{}).length}/2)`;
        const b=document.createElement("button");
        b.textContent="เข้าร่วม"; b.style.cssText="margin-left:10px;padding:5px 15px;background:#4CAF50;color:white;border:none;border-radius:5px;cursor:pointer;";
        b.onclick=()=>joinRoom(k);
        li.appendChild(b); ul.appendChild(li);
      }
    });
  });
}

/* ====================== 14. แสดงห้อง ====================== */
function showRoom(){
  document.getElementById("lobby").style.display="none";
  document.getElementById("room").style.display="block";
  startSoundListener();

  if(currentRoomListener) currentRoomListener.off();
  currentRoomListener = db.ref(`penaltyRooms/${roomId}`);
  currentRoomListener.on("value", snap=>{
    const r = snap.val(); if(!r){alert("ห้องถูกลบ");backToLobby();return;}
    document.getElementById("roomName").textContent=`ห้อง: ${r.name}`;
    const pl = r.players||{}; const ul=document.getElementById("playerList"); ul.innerHTML="";
    for(let id in pl){ const p=pl[id]; if(p&&p.name) ul.innerHTML+=`<li>${p.name}${p.team?` - ${p.team}`:""}</li>`;}
    updateTeamButtons(r);
    const taken = Object.values(pl).filter(p=>p&&p.team).map(p=>p.team);
    const teamDiv=document.getElementById("teamSelectInRoom");
    const wait=document.getElementById("waitingMessage");
    const start=document.getElementById("startBtn");
    if(pl[playerId]?.team){teamDiv.style.display="none"; wait.style.display="block";
      wait.innerHTML = taken.length===1 ? "เลือกทีมแล้ว รอผู้เล่นที่เหลือ..." : "เลือกทีมแล้ว รอเจ้าของห้องกดเริ่มเกม…";
    }else{teamDiv.style.display="flex"; wait.style.display="none";}
    if(r.host===playerId && taken.length===2){start.style.display="inline-block"; start.disabled=false;}
    else start.style.display="none";
    if(r.status==="playing") setupGameListener(r,pl);
    if(r.status==="finished" && r.resultMessage) showGameEnd(r);
  });
}
function updateTeamButtons(r){
  const taken = Object.values(r.players||{}).filter(p=>p&&p.team).map(p=>p.team);
  document.querySelectorAll(".team-btn").forEach(b=>{
    const t=b.dataset.team;
    if(taken.includes(t)){b.classList.add("unavailable");b.disabled=true;}
    else{b.classList.remove("unavailable");b.disabled=false;}
  });
}
function chooseTeam(team){
  db.ref(`penaltyRooms/${roomId}/players/${playerId}/team`).set(team);
  triggerSound("friend");
  speak(`${playerName} เลือกทีม ${team}`);
}

/* ====================== 15. เริ่มเกม ====================== */
function startGame(){
  if(gameStarted) return;
  gameStarted = true;
  document.getElementById("startBtn").disabled = true;
  speak("เริ่มเกม!");
  db.ref(`penaltyRooms/${roomId}/players`).once("value").then(s=>{
    const pl=s.val(); const keys=Object.keys(pl);
    const p1Id=keys[0], p2Id=keys[1];
    const p1Team=pl[p1Id].team, p2Team=pl[p2Id].team;
    const orderP1=createShotsOrder(p1Team);
    const orderP2=createShotsOrder(p2Team);
    const first=Math.random()<0.5?p1Id:p2Id;
    speak(`ทีม ${p1Team} ปะทะ ${p2Team}`);
    speak(`${pl[first].name} จากทีม ${pl[first].team} จะยิงลูกแรก`);
    db.ref(`penaltyRooms/${roomId}`).update({
      status:"playing", firstShooter:first, turn:0, scoreP1:0, scoreP2:0,
      shotIndexP1:0, shotIndexP2:0, isSudden:false,
      shooterDir:null, keeperDir:null, processed:false,
      shotOrderP1:orderP1, shotOrderP2:orderP2,
      p1Id, p2Id
    });
  });
}

/* ====================== 16. Game Listener ====================== */
function setupGameListener(room,players){
  if(gameListener) gameListener.off();
  document.getElementById("room").style.display="none";
  document.getElementById("gameScreen").style.display="block";
  document.getElementById("currentTurn").style.display="block";
  startBGM(); gameEnded=false;
  shotOrderP1 = room.shotOrderP1||[]; shotOrderP2 = room.shotOrderP2||[];
  const ref = db.ref(`penaltyRooms/${roomId}`);
  gameListener = ref;
  let lastTurn=-1, lastSudden=false;
  ref.on("value", snap=>{
    const d = snap.val(); if(!d) return;
    if(d.status==="finished" && d.resultMessage){ if(!gameEnded){gameEnded=true; hideGameButtons(); showGameEnd(d);} return;}
    if(d.status!=="playing") return;
    const s1=d.scoreP1||0, s2=d.scoreP2||0;
    document.getElementById("scoreBoard").innerText=`Score ตอนนี้คือ ${s1} - ${s2}`;
    const p1=d.p1Id, p2=d.p2Id;
    const shooter = d.turn%2===0 ? d.firstShooter : (d.firstShooter===p1?p2:p1);
    const keeper = shooter===p1?p2:p1;
    isMyTurn = (playerId===shooter || playerId===keeper) && !d.processed;
    document.querySelectorAll('.shot-btn').forEach(b=>{
      if(isMyTurn){b.classList.remove('locked');b.disabled=false;b.style.display='block';}
      else{b.classList.add('locked');b.disabled=true;b.style.display=d.processed?'none':'block';}
    });
    const turnEl=document.getElementById("currentTurn");
    const act = playerId===shooter?"ยิง!":"เซฟ!";
    turnEl.textContent=`ถึงตาคุณ${act}`;
    turnEl.style.background = playerId===shooter?"rgba(76,175,80,0.9)":"rgba(255,152,0,0.9)";
    turnEl.style.color="white"; turnEl.style.display="block";

    if(d.turn!==lastTurn && !d.processed){
      lastTurn = d.turn;
      const order = shooter===p1?shotOrderP1:shotOrderP2;
      const idx = shooter===p1?d.shotIndexP1:d.shotIndexP2;
      const name = order[Math.min(idx,order.length-1)];
      const team = players[shooter].team;
      if(playerId===shooter && !spokenTurns.has(`t${d.turn}s`)){
        spokenTurns.add(`t${d.turn}s`);
        speak(`ลูกที่ ${idx+1} ${team}: ${name} เตรียมยิง`);
      }
      if(playerId===keeper && !spokenTurns.has(`t${d.turn}k`)){
        spokenTurns.add(`t${d.turn}k`);
        speak(`ลูกที่ ${idx+1} ${team}: ${name} เตรียมยิง ${squads[players[keeper].team].keeper} ของคุณพร้อมเซฟ`);
      }
    }
    if(d.isSudden && !lastSudden){
      if(!spokenTurns.has("sudden")){spokenTurns.add("sudden");speak("เข้าสู่ซัดเดนเดธ!");}
    }
    lastSudden = d.isSudden;

    if(d.shooterDir && d.keeperDir && !d.processed && d.turn > lastProcessedTurn) {
      lastProcessedTurn = d.turn;
      processShot(d,players,ref);
    }
  });
}
function hideGameButtons(){
  document.querySelectorAll('.shot-btn').forEach(b=>b.style.display='none');
  document.getElementById("currentTurn").style.display='none';
  gameEnded=true;
}

/* ====================== 17. Process Shot ====================== */
async function processShot(data,players,ref){
  const proc = ref.child('processed');
  const tx = await proc.transaction(c=>c?undefined:true);
  if(!tx.committed) return;
  const p1=data.p1Id, p2=data.p2Id;
  const shooter = data.turn%2===0?data.firstShooter:(data.firstShooter===p1?p2:p1);
  const keeper = shooter===p1?p2:p1;
  const order = shooter===p1?shotOrderP1:shotOrderP2;
  const idx = shooter===p1?data.shotIndexP1:data.shotIndexP2;
  const name = order[idx];
  const team = players[shooter].team;
  const goal = data.shooterDir!==data.keeperDir;

  triggerSound(goal?"goal":"miss");

  let s1=data.scoreP1||0, s2=data.scoreP2||0;
  if(goal) shooter===p1?s1++:s2++;
  const resultMsg = `${name} ${team} ยิง${goal?"เข้า":"ไม่เข้า"}! Score ${s1} - ${s2}`;
  if(!spokenTurns.has(`r${data.turn}`)){
    spokenTurns.add(`r${data.turn}`);
    speak(resultMsg);
  }

  const upd = {turn:data.turn+1, shooterDir:null, keeperDir:null, processed:false, scoreP1:s1, scoreP2:s2};
  if(shooter===p1) upd.shotIndexP1 = data.shotIndexP1+1;
  else upd.shotIndexP2 = data.shotIndexP2+1;
  setTimeout(()=>ref.update(upd),800);
  setTimeout(()=>checkGameEndOrNext(data,players,ref,s1,s2,
    shooter===p1?data.shotIndexP1+1:data.shotIndexP1,
    shooter===p2?data.shotIndexP2+1:data.shotIndexP2),1800);
}

/* ====================== 18. ตรวจจบเกม ====================== */
function checkGameEndOrNext(data,players,ref,s1,s2,sp1,sp2){
  const p1=data.p1Id, p2=data.p2Id;
  const rem1=5-sp1, rem2=5-sp2;
  let end=false;
  if(!data.isSudden){
    if(sp1>sp2 && s1-s2>rem2) end=true;
    else if(sp2>=sp1 && s2-s1>rem1) end=true;
    else if(sp1>=5 && sp2>=5 && s1!==s2) end=true;
    else if(sp1>=5 && sp2>=5) {ref.update({isSudden:true});return;}
  }else{
    if(sp1>sp2 || (sp2>=sp1 && s1!==s2)) end=true;
  }
  if(end){
    triggerSound("end"); stopBGM();
    const msg = s1>s2?`${players[p1].team} ชนะ!` : s1<s2?`${players[p2].team} ชนะ!` : "เสมอ!";
    setTimeout(()=>ref.update({status:"finished",finalScoreP1:s1,finalScoreP2:s2,resultMessage:msg}),800);
  }
}

/* ====================== 19. เลือกทิศ ====================== */
async function chooseDirection(dir){
  const snap = await db.ref(`penaltyRooms/${roomId}`).once("value");
  const d = snap.val();
  if(d.status!=="playing" || d.processed || gameEnded) return;
  const shooter = d.turn%2===0?d.firstShooter:(d.firstShooter===d.p1Id?d.p2Id:d.p1Id);
  const keeper = shooter===d.p1Id?d.p2Id:d.p1Id;
  if(playerId===shooter && !d.shooterDir) await db.ref(`penaltyRooms/${roomId}/shooterDir`).set(dir);
  else if(playerId===keeper && !d.keeperDir) await db.ref(`penaltyRooms/${roomId}/keeperDir`).set(dir);
}

/* ====================== 20. จบเกม ====================== */
function showGameEnd(room){
  stopBGM(); hideGameButtons();
  const el=document.getElementById("gameEndMessage");
  el.textContent=`ผู้ชนะคือ ${room.resultMessage}`;
  el.style.display="block";
  document.getElementById("backToMainBtn").style.display="block";
  speak(`ผู้ชนะคือ ${room.resultMessage}`);
}

/* ====================== 21. กลับล็อบบี้ ====================== */
function backToLobby(){
  gameStarted=false; gameEnded=false; isButtonLocked=false; isMyTurn=false;
  stopBGM(); spokenTurns.clear(); shotOrderP1=[]; shotOrderP2=[];
  lastProcessedTurn = -1;
  document.getElementById("gameEndMessage").style.display="none";
  if(roomId && playerId) db.ref(`penaltyRooms/${roomId}/players/${playerId}`).remove();
  roomId=""; isHost=false;
  [currentRoomListener, soundListener, lobbyRoomsListener, gameListener].forEach(l=>l&&l.off());
  currentRoomListener=soundListener=lobbyRoomsListener=gameListener=null;
  document.getElementById("room").style.display="none";
  document.getElementById("gameScreen").style.display="none";
  document.querySelectorAll('.shot-btn').forEach(b=>b.style.display='block');
  document.getElementById("lobby").style.display="block";
  loadRooms();
  document.getElementById("backToMainBtn").style.display="none";
}
</script>
</body>
</html>