<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>เกมยิงจุดโทษ 2005/2006 - ออนไลน์</title>
<style>
  body { 
    font-family: Tahoma; 
    background:#111; 
    color:white; 
    text-align:center; 
    margin:0;
    padding:20px;
    height:100vh;
    overflow:hidden;
    position:relative;
  }

  .shot-btn { 
    position:fixed;
    background:rgba(255,255,255,0.9); 
    border-radius:15px;
    padding:28px 32px;
    font-weight:bold;
    cursor:pointer;
    border:3px solid #fff;
    font-size:23px;
    z-index:1000;
    box-shadow:0 8px 20px rgba(0,0,0,0.5);
    transition:all 0.2s;
    opacity:1;
  }
  .shot-btn:active { transform:scale(0.95); box-shadow:0 4px 10px rgba(0,0,0,0.5); }
  .shot-btn:disabled { opacity:0.5; cursor:not-allowed; }
  .shot-btn.locked { opacity:0.3; cursor:not-allowed; }

  #tl { top:18%; left:12%; }
  #tr { top:18%; right:12%; }
  #center { top:50%; left:50%; transform:translate(-50%, -50%); }
  #bl { bottom:18%; left:12%; }
  #br { bottom:18%; right:12%; }

  #scoreBoard { 
    position:fixed;
    top:10px;
    left:50%;
    transform:translateX(-50%);
    z-index:1001;
    background:rgba(0,0,0,0.7);
    padding:15px 30px;
    border-radius:15px;
    border:2px solid #fff;
    font-size:28px;
  }

  #nameInput {
    display:flex;
    flex-direction:column;
    gap:20px;
    position:fixed;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    background:rgba(0,0,0,0.8);
    padding:30px;
    border-radius:20px;
    width:320px;
    z-index:100;
  }
  #nameInput input {
    padding:12px;
    font-size:20px;
    border-radius:8px;
    border:none;
    text-align:center;
  }
  #nameInput button {
    background:rgba(255,255,255,0.9);
    border:none;
    border-radius:15px;
    padding:15px;
    font-weight:bold;
    font-size:20px;
    cursor:pointer;
  }

  #lobby, #room { display:none; }
  ul { list-style:none; padding:0; margin:0; }
  li { margin:8px 0; background:rgba(255,255,255,0.1); padding:12px; border-radius:10px; }

  #teamSelectInRoom {
    display:none;
    flex-direction:column;
    gap:15px;
    margin-top:20px;
  }
  #teamSelectInRoom button {
    background:rgba(255,255,255,0.9);
    border-radius:15px;
    padding:15px 30px;
    font-weight:bold;
    cursor:pointer;
    border:3px solid #fff;
    font-size:20px;
    transition:all 0.2s;
  }
  #teamSelectInRoom button:disabled,
  #teamSelectInRoom button.unavailable {
    background:#555;
    cursor:not-allowed;
    opacity:0.6;
    border-color:#777;
  }

  #waitingMessage {
    display:none;
    margin-top:20px;
    padding:20px;
    background:rgba(255,255,255,0.1);
    border-radius:15px;
    font-size:18px;
  }

  #startBtn {
    display:none;
    margin-top:20px;
    background:#4CAF50;
    color:white;
    border:none;
    border-radius:15px;
    padding:15px 30px;
    font-weight:bold;
    font-size:20px;
    cursor:pointer;
  }

  #ttsDisplay {
    position:fixed;
    bottom:20px;
    left:50%;
    transform:translateX(-50%);
    background:rgba(0,0,0,0.7);
    color:white;
    padding:12px 24px;
    border-radius:12px;
    font-size:20px;
    max-width:90%;
    z-index:1002;
    opacity:0;
    transition:opacity 0.3s;
    pointer-events:none;
  }
  #ttsDisplay.show { opacity:1; }

  #resultScreen {
    position:fixed;
    top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.95);
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    z-index:10000;
    display:none;
  }
  #resultScreen h1 { font-size:48px; margin:20px; }
  #resultScreen p { font-size:28px; }

  #currentTurn {
    position:fixed;
    top:70px;
    left:50%;
    transform:translateX(-50%);
    background:rgba(255,255,255,0.9);
    color:#333;
    padding:10px 20px;
    border-radius:10px;
    font-size:18px;
    font-weight:bold;
    z-index:1001;
    display:none;
  }

  #mainMenuBtn {
    position:fixed;
    top:15px;
    left:15px;
    z-index:9999;
    background:#f44336;
    color:white;
    border:none;
    border-radius:50px;
    padding:12px 26px;
    font-weight:bold;
    box-shadow:0 4px 12px rgba(244,67,54,0.4);
    transition:all 0.3s;
    cursor:pointer;
    display:none;
  }
</style>
</head>
<body>

<button id="mainMenuBtn" onclick="location.href='../index.html'">กลับเมนูหลัก</button>

<div id="nameInput">
  <p style="font-size:24px;">กรอกชื่อของคุณ</p>
  <input id="playerName" placeholder="ชื่อของคุณ" autofocus>
  <button id="confirmNameBtn">ยืนยัน</button>
</div>

<div id="lobby">
  <h2>ล็อบบี้</h2>
  <button id="createRoomBtn" style="background:#fff;color:#333;padding:15px 30px;border-radius:15px;font-weight:bold;">สร้างห้องใหม่</button>
  <h3>ห้องที่เปิดอยู่</h3>
  <ul id="roomList"></ul>
</div>

<div id="room">
  <h2 id="roomName"></h2>
  <p>ผู้เล่นในห้อง:</p>
  <ul id="playerList"></ul>
  
  <div id="teamSelectInRoom">
    <p>เลือกทีมของคุณ:</p>
    <button class="team-btn" data-team="Manchester United">แมนเชสเตอร์ ยูไนเต็ด</button>
    <button class="team-btn" data-team="Liverpool">ลิเวอร์พูล</button>
    <button class="team-btn" data-team="Arsenal">อาร์เซนอล</button>
    <button class="team-btn" data-team="Chelsea">เชลซี</button>
  </div>
  
  <div id="waitingMessage"></div>
  
  <button id="startBtn" onclick="startGame()">เริ่มเกม</button>
</div>

<div id="gameScreen" style="display:none;">
  <div id="scoreBoard">Score: 0 - 0</div>
  <div id="currentTurn"></div>
  <button id="tl" class="shot-btn" onclick="debounceClick('TL')">มุมซ้ายบน</button>
  <button id="tr" class="shot-btn" onclick="debounceClick('TR')">มุมขวาบน</button>
  <button id="center" class="shot-btn" onclick="debounceClick('C')">ตรงกลาง</button>
  <button id="bl" class="shot-btn" onclick="debounceClick('BL')">มุมซ้ายล่าง</button>
  <button id="br" class="shot-btn" onclick="debounceClick('BR')">มุมขวาล่าง</button>
</div>

<div id="resultScreen">
  <h1 id="resultTitle">ทีมชนะ</h1>
  <p id="resultMessage">ยินดีด้วย!</p>
</div>

<div id="ttsDisplay"></div>
<div id="tts" aria-live="assertive" style="position:absolute; left:-9999px;"></div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script>
// ==================== Firebase ====================
const firebaseConfig = {
  apiKey: "AIzaSyBIPeN4YUIrwM4MmFtDvT2DJ-v4toxc7tY",
  authDomain: "xo-game-134ec.firebaseapp.com",
  databaseURL: "https://xo-game-134ec-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "xo-game-134ec",
  storageBucket: "xo-game-134ec.appspot.com",
  messagingSenderId: "318375224157",
  appId: "1:318375224157:web:348a410dfd625359b77eb4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ==================== ตัวแปรหลัก ====================
let playerName = "", roomId = "", playerId = "", isHost = false;
let currentRoomListener = null, soundListener = null, lobbyRoomsListener = null;
let preloadedAudios = {};
let isButtonLocked = false;
let gameStarted = false;
let isMyTurn = false;
let spokenTurns = new Set();
let shotOrderP1 = [], shotOrderP2 = [];
let lastProcessedTurn = -1;   
let finalResultSpoken = false;

// ==================== ระบบคิวสุ่มเสียง ====================
let goalQueue = [], missQueue = [];
const goalSounds = ["t.mp3", "t1.mp3", "t2.mp3", "t3.mp3", "t4.mp3"];
const missSounds = ["f.mp3", "f1.mp3", "f2.mp3", "f3.mp3", "f4.mp3"];

function refillQueue(array, queue) {
  const copy = [...array];
  for (let i = copy.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [copy[i], copy[j]] = [copy[j], copy[i]];
  }
  queue.push(...copy);
}
function getNextGoalSound() {
  if (goalQueue.length === 0) refillQueue(goalSounds, goalQueue);
  return goalQueue.shift();
}
function getNextMissSound() {
  if (missQueue.length === 0) refillQueue(missSounds, missQueue);
  return missQueue.shift();
}

// ==================== Preload เสียง ====================
function preloadAllSounds() {
  const files = ["friend.mp3", "b.mp3", "end.mp3", ...goalSounds, ...missSounds];
  files.forEach(name => {
    const audio = new Audio(`audio/${name}`);
    audio.preload = "auto";
    preloadedAudios[name] = audio;
  });
  refillQueue(goalSounds, goalQueue);
  refillQueue(missSounds, missQueue);
}

function startBGM() {
  const bgm = preloadedAudios["b.mp3"];
  if (bgm) { bgm.currentTime = 0; bgm.volume = 0.3; bgm.loop = true; bgm.play().catch(() => {}); }
}
function stopBGM() {
  const bgm = preloadedAudios["b.mp3"];
  if (bgm) { bgm.pause(); bgm.currentTime = 0; }
}

// ==================== ระบบเสียงผ่าน Firebase (เหมือน d.html) ====================
function triggerSound(name) {
  if (!roomId) return;
  db.ref(`penaltyRooms/${roomId}/soundTrigger`).set({ name, time: Date.now(), playerId });
}

function startSoundListener() {
  if (soundListener) soundListener.off();
  if (!roomId) return;
  soundListener = db.ref(`penaltyRooms/${roomId}/soundTrigger`);
  soundListener.on("value", s => {
    const data = s.val();
    if (!data || Date.now() - data.time > 1000) return;
    const audio = preloadedAudios[data.name];
    if (audio) { audio.currentTime = 0; audio.volume = 1; audio.play().catch(() => {}); }

    let msg = "";
    if (goalSounds.includes(data.name)) msg = "ยิงเข้า!";
    else if (missSounds.includes(data.name)) msg = "ยิงไม่เข้า!";
    else if (data.name === "end.mp3") msg = "จบเกม!";
    else if (data.name === "friend.mp3") msg = `${playerName} เลือกทีมแล้ว`;

    if (msg) {
      speak(msg);
      document.getElementById("tts").textContent = msg;
      setTimeout(() => document.getElementById("tts").textContent = "", 3000);
    }
  });
}

// ==================== TTS ====================
let ttsQueue = [], isSpeaking = false;
const ttsDisplay = document.getElementById("ttsDisplay");
function speak(text){ ttsQueue.push(text); processTTS(); }
function processTTS(){
  if(isSpeaking || ttsQueue.length === 0) return;
  isSpeaking = true;
  const msg = ttsQueue.shift();
  ttsDisplay.textContent = msg;
  ttsDisplay.classList.add('show');
  setTimeout(()=>{
    document.getElementById("tts").innerText = msg;
    setTimeout(()=>{
      isSpeaking = false;
      document.getElementById("tts").innerText = "";
      ttsDisplay.classList.remove('show');
      processTTS();
    }, Math.max(800, msg.length * 50));
  }, 50);
}

// ==================== ข้อมูลทีม ====================
const squads = {
  "Manchester United": { players: ["แกรี่ เนวิลล์","ริโอ เฟอร์ดินานด์","เวส บราวน์","ปาทริซ เอฟร่า","คริสเตียโน่ โรนัลโด้","พอล สโคลส์","จอห์น โอเช","ไรอัน กิ๊กส์","เวย์น รูนี่ย์","รุด ฟาน นิสเทลรอย"], keeper: "เอ็ดวิน ฟาน เดอร์ ซาร์" },
  "Liverpool": { players: ["สตีฟ ฟินแนน","เจมี่ คาร์ราเกอร์","ซามี่ ฮูเปีย","จอห์น อาร์เน่ รีเซ่","ซาบี อลอนโซ่","โมฮาเหม็ด ซิสโซโก้","สตีเว่น เจอร์ราร์ด","หลุยส์ การ์เซีย","ปีเตอร์ เคร้าช์","ฌิบริล ซิสเซ่"], keeper: "เปเป้ เรน่า" },
  "Arsenal": { players: ["เอ็มมานูเอล เอบูเอ้","โคโล ตูเร่","โซล แคมเบล","แอชลีย์ โคล","อเล็กซานเดอร์ เคล็บ","ฌิลแบร์โต้ ซิลวา","เชส ฟาเบรกัส","โรแบร์ ปิแรส","เฟรดริก ลุงเบิร์ก","เธียร์รี่ อองรี"], keeper: "เยนส์ เลห์มันน์" },
  "Chelsea": { players: ["เปาโล เฟร์เรร่า","ริคาร์โด้ คาร์วัลโญ่","จอห์น เทอร์รี่","วิลเลียม กัลลาส","โคล้ด มาเกเลเล่","มิคาเอล เอสเซียง","แฟรงก์ แลมพาร์ด","โจ โคล","อาร์เยน ร็อบเบน","เฮอร์นัน เครสโป"], keeper: "ปีเตอร์ เช็ก" }
};

function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function createShotsOrder(t){ let p=squads[t].players.slice(); shuffle(p); p.push(squads[t].keeper); return p; }
function getShooterName(o,i){ return o[i % o.length] || "นักเตะ"; }

function debounceClick(dir){ if(isButtonLocked || !isMyTurn) return; isButtonLocked=true; chooseDirection(dir); setTimeout(()=>{isButtonLocked=false;},100); }

// ==================== เริ่มต้นแอป ====================
document.addEventListener("DOMContentLoaded", () => {
  preloadAllSounds(); // สำคัญมาก ต้อง preload ก่อน

  document.getElementById("confirmNameBtn").onclick = confirmName;
  document.getElementById("playerName").addEventListener("keydown", e => { if(e.key==="Enter") confirmName(); });
  document.getElementById("createRoomBtn").onclick = showCreateRoom;
  document.querySelectorAll(".team-btn").forEach(b => b.onclick = () => chooseTeam(b.dataset.team));

  document.getElementById("mainMenuBtn").style.display = "block";
  document.getElementById("playerName").focus();
});

// ==================== ฟังก์ชันทั้งหมด (ครบทุกบรรทัด) ====================
function confirmName() {
  playerName = document.getElementById("playerName").value.trim();
  if (!playerName) { alert("กรุณาใส่ชื่อ"); return; }
  playerId = Math.random().toString(36).substr(2,9);
  document.getElementById("nameInput").style.display = "none";
  document.getElementById("lobby").style.display = "block";
  document.getElementById("mainMenuBtn").style.display = "none";
  loadRooms();
}

async function showCreateRoom() {
  const name = prompt("ตั้งชื่อห้อง:");
  if (!name || name.trim() === "") return;
  const roomRef = db.ref("penaltyRooms").push();
  const newRoomId = roomRef.key;
  await roomRef.set({ name: name.trim(), status: "waiting", host: playerId, created: Date.now(), players: { [playerId]: { name: playerName, team: null } } });
  db.ref(`penaltyRooms/${newRoomId}/players/${playerId}`).onDisconnect().remove();
  roomId = newRoomId; isHost = true; showRoom();
}

async function joinRoom(id) {
  if (lobbyRoomsListener) lobbyRoomsListener.off();
  const snap = await db.ref(`penaltyRooms/${id}`).once("value");
  const room = snap.val();
  if (!room || room.status !== "waiting" || Object.values(room.players || {}).filter(p => p && p.name).length >= 2) {
    alert("ไม่สามารถเข้าร่วมห้องนี้ได้"); loadRooms(); return;
  }
  roomId = id;
  const playerRef = db.ref(`penaltyRooms/${roomId}/players/${playerId}`);
  await playerRef.set({ name: playerName, team: null });
  playerRef.onDisconnect().remove();
  showRoom();
}

function loadRooms() {
  const list = document.getElementById("roomList");
  if (lobbyRoomsListener) lobbyRoomsListener.off();
  lobbyRoomsListener = db.ref("penaltyRooms").orderByChild("status").equalTo("waiting");
  lobbyRoomsListener.on("value", snap => {
    list.innerHTML = "";
    snap.forEach(r => {
      const room = r.val(); const key = r.key;
      if (!room) return;
      const count = Object.values(room.players || {}).filter(p => p && p.name).length;
      if (count > 0 && count < 2) {
        const li = document.createElement("li");
        li.innerHTML = `<strong>${room.name}</strong> (${count}/2)`;
        const btn = document.createElement("button");
        btn.textContent = "เข้าร่วม";
        btn.style.cssText = "margin-left:10px;padding:5px 15px;background:#4CAF50;color:white;border:none;border-radius:5px;cursor:pointer;";
        btn.onclick = () => joinRoom(key);
        li.appendChild(btn);
        list.appendChild(li);
      }
    });
  });
}

function showRoom() {
  document.getElementById("lobby").style.display = "none";
  document.getElementById("room").style.display = "block";
  startSoundListener();

  if (currentRoomListener) currentRoomListener.off();
  currentRoomListener = db.ref(`penaltyRooms/${roomId}`);
  currentRoomListener.on("value", snap => {
    const room = snap.val();
    if (!room) { alert("ห้องถูกลบ"); backToLobby(); return; }
    document.getElementById("roomName").textContent = `ห้อง: ${room.name}`;
    const players = room.players || {};
    const list = document.getElementById("playerList"); list.innerHTML = "";
    for (let id in players) if (players[id]?.name) list.innerHTML += `<li>${players[id].name}${players[id].team ? ` - ${players[id].team}` : ""}</li>`;

    updateTeamButtons(room);

    const takenTeams = Object.values(players).filter(p => p?.team).map(p => p.team);
    const teamDiv = document.getElementById("teamSelectInRoom");
    const waitMsg = document.getElementById("waitingMessage");
    const startBtn = document.getElementById("startBtn");

    if (players[playerId]?.team) {
      teamDiv.style.display = "none";
      waitMsg.style.display = "block";
      waitMsg.innerHTML = takenTeams.length === 1 ? "เลือกทีมแล้ว รอผู้เล่นที่เหลือ..." : "เลือกทีมแล้ว รอเจ้าของห้องกดเริ่มเกม…";
    } else {
      teamDiv.style.display = "flex";
      waitMsg.style.display = "none";
    }

    if (room.host === playerId && takenTeams.length === 2) {
      startBtn.style.display = "inline-block";
      startBtn.disabled = false;
    } else startBtn.style.display = "none";

    if (room.status === "playing") startGameplay(room, players);
    if (room.status === "finished") showResult(room);
  });
}

function updateTeamButtons(room) {
  const taken = Object.values(room.players || {}).filter(p => p?.team).map(p => p.team);
  document.querySelectorAll(".team-btn").forEach(btn => {
    if (taken.includes(btn.dataset.team)) { btn.classList.add("unavailable"); btn.disabled = true; }
    else { btn.classList.remove("unavailable"); btn.disabled = false; }
  });
}

function chooseTeam(team) {
  db.ref(`penaltyRooms/${roomId}/players/${playerId}/team`).set(team);
  triggerSound("friend.mp3");
  speak(`${playerName} เลือกทีม ${team}`);
}

function startGame() {
  if (gameStarted) return;
  gameStarted = true;
  document.getElementById("startBtn").disabled = true;
  speak("เริ่มเกม!");

  db.ref(`penaltyRooms/${roomId}/players`).once("value").then(snap => {
    const players = snap.val();
    const keys = Object.keys(players);
    const p1Id = keys[0], p2Id = keys[1];
    const p1Team = players[p1Id].team;
    const p2Team = players[p2Id].team;
    const orderP1 = createShotsOrder(p1Team);
    const orderP2 = createShotsOrder(p2Team);
    const firstShooter = Math.random() < 0.5 ? p1Id : p2Id;

    speak(`ทีม ${p1Team} ปะทะ ${p2Team}`);
    speak(`${players[firstShooter].name} จากทีม ${players[firstShooter].team} จะยิงลูกแรก`);

    db.ref(`penaltyRooms/${roomId}`).update({
      status: "playing", firstShooter, turn: 0, scoreP1: 0, scoreP2: 0, shotIndexP1: 0, shotIndexP2: 0,
      isSudden: false, shooterDir: null, keeperDir: null, processed: false,
      shotOrderP1: orderP1, shotOrderP2: orderP2, p1Id, p2Id
    });
  });
}

function startGameplay(room, players) {
  document.getElementById("room").style.display = "none";
  document.getElementById("gameScreen").style.display = "block";
  document.getElementById("currentTurn").style.display = "block";
  startBGM();

  shotOrderP1 = room.shotOrderP1 || [];
  shotOrderP2 = room.shotOrderP2 || [];

  const gameRef = db.ref(`penaltyRooms/${roomId}`);
  document.querySelectorAll('.shot-btn').forEach(btn => { btn.classList.remove('locked'); btn.disabled = false; });

  let lastTurn = -1, lastIsSudden = false;

  gameRef.on("value", snap => {
    const data = snap.val();
    if (!data || data.status !== "playing") return;

    document.getElementById("scoreBoard").innerText = `Score: ${data.scoreP1||0} - ${data.scoreP2||0}`;

    const currentShooterId = data.turn % 2 === 0 ? data.firstShooter : (data.firstShooter === data.p1Id ? data.p2Id : data.p1Id);
    const currentKeeperId = currentShooterId === data.p1Id ? data.p2Id : data.p1Id;
    isMyTurn = (playerId === currentShooterId || playerId === currentKeeperId);

    document.querySelectorAll('.shot-btn').forEach(btn => {
      if (isMyTurn) { btn.classList.remove('locked'); btn.disabled = false; }
      else { btn.classList.add('locked'); btn.disabled = true; }
    });

    document.getElementById("currentTurn").textContent = `ถึงตาคุณ${playerId === currentShooterId ? "ยิง!" : "เซฟ!"}`;
    document.getElementById("currentTurn").style.background = playerId === currentShooterId ? "rgba(76,175,80,0.9)" : "rgba(255,152,0,0.9)";

    if (data.turn !== lastTurn) {
      lastTurn = data.turn;
      const shooterOrder = currentShooterId === data.p1Id ? shotOrderP1 : shotOrderP2;
      const shooterIndex = currentShooterId === data.p1Id ? data.shotIndexP1 : data.shotIndexP2;
      const shooterName = getShooterName(shooterOrder, shooterIndex);
      const shooterTeam = players[currentShooterId].team;
      const keeperName = squads[players[currentKeeperId].team].keeper;

      if (playerId === currentShooterId && !spokenTurns.has(`turn_${data.turn}_shooter`)) {
        spokenTurns.add(`turn_${data.turn}_shooter`);
        speak(`ลูกที่ ${shooterIndex + 1} ${shooterTeam}: ${shooterName} เตรียมยิง`);
      }
      if (playerId === currentKeeperId && !spokenTurns.has(`turn_${data.turn}_keeper`)) {
        spokenTurns.add(`turn_${data.turn}_keeper`);
        speak(`ลูกที่ ${shooterIndex + 1} ${shooterTeam}: ${shooterName} เตรียมยิง ${keeperName} ของคุณพร้อมเซฟ`);
      }
    }

    if (data.isSudden && !lastIsSudden && !spokenTurns.has("sudden")) {
      spokenTurns.add("sudden");
      speak("เข้าสู่ซัดเดนเดธ!");
    }
    lastIsSudden = data.isSudden;

    if (data.shooterDir && data.keeperDir && !data.processed && data.turn > lastProcessedTurn) {
      lastProcessedTurn = data.turn;
      processShot(data, players, gameRef);
    }
  });
}

async function processShot(data, players, gameRef) {
  const processedRef = gameRef.child('processed');
  const tx = await processedRef.transaction(c => c ? undefined : true);
  if (!tx.committed) return;

  const currentShooterId = data.turn % 2 === 0 ? data.firstShooter : (data.firstShooter === data.p1Id ? data.p2Id : data.p1Id);
  const currentKeeperId = currentShooterId === data.p1Id ? data.p2Id : data.p1Id;
  const shooterOrder = currentShooterId === data.p1Id ? shotOrderP1 : shotOrderP2;
  const shooterIndex = currentShooterId === data.p1Id ? data.shotIndexP1 : data.shotIndexP2;
  const shooterName = getShooterName(shooterOrder, shooterIndex);
  const shooterTeam = players[currentShooterId].team;
  const isGoal = data.shooterDir !== data.keeperDir;

  const soundName = isGoal ? getNextGoalSound() : getNextMissSound();
  triggerSound(soundName);

  let scoreP1 = data.scoreP1 || 0;
  let scoreP2 = data.scoreP2 || 0;
  if (isGoal) currentShooterId === data.p1Id ? scoreP1++ : scoreP2++;

  speak(`${shooterName} จากทีม ${shooterTeam} ยิง${isGoal ? "เข้า" : "ไม่เข้า"}! คะแนน ${scoreP1} - ${scoreP2}`);

  const updates = { turn: data.turn + 1, shooterDir: null, keeperDir: null, processed: false, scoreP1, scoreP2 };
  if (currentShooterId === data.p1Id) updates.shotIndexP1 = data.shotIndexP1 + 1;
  else updates.shotIndexP2 = data.shotIndexP2 + 1;

  setTimeout(() => gameRef.update(updates), 1000);
  setTimeout(() => checkGameEndOrNext(data, players, gameRef, scoreP1, scoreP2, updates.shotIndexP1 ?? data.shotIndexP1, updates.shotIndexP2 ?? data.shotIndexP2), 2000);
}

function checkGameEndOrNext(data, players, gameRef, scoreP1, scoreP2, shotIndexP1, shotIndexP2) {
  const isP1First = data.firstShooter === data.p1Id;
  let end = false, winnerId = null;

  if (!data.isSudden) {
    const shotsDoneP1 = Math.min(shotIndexP1, 5);
    const shotsDoneP2 = Math.min(shotIndexP2, 5);
    const remainingP1 = 5 - shotsDoneP1;
    const remainingP2 = 5 - shotsDoneP2;

    if (shotIndexP1 < 5 || shotIndexP2 < 5) {
      if (scoreP1 + remainingP1 < scoreP2 || scoreP2 + remainingP2 < scoreP1) {
        end = true;
        winnerId = (scoreP1 + remainingP1 < scoreP2) ? (isP1First ? data.p2Id : data.p1Id) : (isP1First ? data.p1Id : data.p2Id);
      }
    }

    if (shotIndexP1 >= 5 && shotIndexP2 >= 5) {
      if (scoreP1 !== scoreP2) {
        end = true;
        winnerId = scoreP1 > scoreP2 ? (isP1First ? data.p1Id : data.p2Id) : (isP1First ? data.p2Id : data.p1Id);
      } else {
        gameRef.update({ isSudden: true });
        return;
      }
    }
  } else {
    const suddenP1 = shotIndexP1 - 5;
    const suddenP2 = shotIndexP2 - 5;
    if (suddenP1 === suddenP2 && suddenP1 > 0 && scoreP1 !== scoreP2) {
      end = true;
      winnerId = scoreP1 > scoreP2 ? (isP1First ? data.p1Id : data.p2Id) : (isP1First ? data.p2Id : data.p1Id);
    }
  }

  if (end) {
    triggerSound("end.mp3");
    stopBGM();
    setTimeout(() => gameRef.update({ status: "finished", winner: winnerId, finalScoreP1: scoreP1, finalScoreP2: scoreP2 }), 800);
  }
}

async function chooseDirection(dir) {
  const snap = await db.ref(`penaltyRooms/${roomId}`).once("value");
  const data = snap.val();
  if (data.status !== "playing") return;
  const currentShooterId = data.turn % 2 === 0 ? data.firstShooter : (data.firstShooter === data.p1Id ? data.p2Id : data.p1Id);
  const currentKeeperId = currentShooterId === data.p1Id ? data.p2Id : data.p1Id;
  if (playerId === currentShooterId && !data.shooterDir) db.ref(`penaltyRooms/${roomId}/shooterDir`).set(dir);
  else if (playerId === currentKeeperId && !data.keeperDir) db.ref(`penaltyRooms/${roomId}/keeperDir`).set(dir);
}

function showResult(room) {
  stopBGM();
  document.getElementById("gameScreen").style.display = "none";
  document.getElementById("currentTurn").style.display = "none";
  document.querySelectorAll('.shot-btn').forEach(b => b.style.display = 'none');

  const winnerTeam = room.winner === room.p1Id ? room.players[room.p1Id].team : room.players[room.p2Id].team;
  document.getElementById("resultTitle").textContent = `${winnerTeam} เป็นฝ่ายชนะ`;
  document.getElementById("resultScreen").style.display = "flex";
  document.getElementById("mainMenuBtn").style.display = "block";

  if (!finalResultSpoken) {
    finalResultSpoken = true;
    speak(`${winnerTeam} เป็นฝ่ายชนะ ยินดีด้วย!`);
  }
}

function backToLobby() {
  if (currentRoomListener) currentRoomListener.off();
  if (soundListener) soundListener.off();
  if (lobbyRoomsListener) lobbyRoomsListener.off();
  roomId = "";
  document.getElementById("room").style.display = "none";
  document.getElementById("lobby").style.display = "block";
  loadRooms();
}
</script>
</body>
</html>