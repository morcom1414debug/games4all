<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>เกมยิงจุดโทษ 2005/2006 - ออนไลน์</title>
<style>
  body { 
    font-family: Tahoma; 
    background:#111; 
    color:white; 
    text-align:center; 
    margin:0;
    padding:20px;
    height:100vh;
    overflow:hidden;
    position:relative;
  }

  .shot-btn { 
    position:fixed;
    background:rgba(255,255,255,0.9); 
    border-radius:15px;
    padding:25px 30px;
    font-weight:bold;
    cursor:pointer;
    border:3px solid #fff;
    font-size:22px;
    z-index:1000;
    box-shadow:0 8px 20px rgba(0,0,0,0.5);
    transition:all 0.2s;
    opacity:1;
  }
  .shot-btn:active { transform:scale(0.95); box-shadow:0 4px 10px rgba(0,0,0,0.5); }
  .shot-btn:disabled { opacity:0.5; cursor:not-allowed; }
  .shot-btn.locked { opacity:0.3; cursor:not-allowed; }

  /* ปรับตำแหน่งปุ่มให้กดง่ายและสวยขึ้น */
  #tl { top:15%; left:10%; }
  #tr { top:15%; right:10%; }
  #center { top:50%; left:50%; transform:translate(-50%, -50%); }
  #bl { bottom:12%; left:10%; }
  #br { bottom:12%; right:10%; }

  #scoreBoard { 
    margin-top:20px; 
    font-size:28px;
    position:fixed;
    top:10px;
    left:50%;
    transform:translateX(-50%);
    z-index:1001;
    background:rgba(0,0,0,0.7);
    padding:15px 30px;
    border-radius:15px;
    border:2px solid #fff;
  }

  /* หน้าแรก: ตั้งชื่อ */
  #nameInput {
    display:flex;
    flex-direction:column;
    gap:20px;
    position:fixed;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    background:rgba(0,0,0,0.8);
    padding:30px;
    border-radius:20px;
    width:320px;
  }
  #nameInput input {
    padding:12px;
    font-size:20px;
    border-radius:8px;
    border:none;
    text-align:center;
  }
  #nameInput button {
    background:rgba(255,255,255,0.9);
    border:none;
    border-radius:15px;
    padding:15px;
    font-weight:bold;
    font-size:20px;
    cursor:pointer;
  }

  /* ล็อบบี้ */
  #lobby, #room { display:none; }
  ul { list-style:none; padding:0; margin:0; }
  li { margin:8px 0; background:rgba(255,255,255,0.1); padding:12px; border-radius:10px; }

  /* เลือกทีม */
  #teamSelectInRoom {
    display:none;
    flex-direction:column;
    gap:15px;
    margin-top:20px;
  }
  #teamSelectInRoom button {
    background:rgba(255,255,255,0.9);
    border-radius:15px;
    padding:15px 30px;
    font-weight:bold;
    cursor:pointer;
    border:3px solid #fff;
    font-size:20px;
    transition:all 0.2s;
  }
  #teamSelectInRoom button:disabled,
  #teamSelectInRoom button.unavailable {
    background:#555;
    cursor:not-allowed;
    opacity:0.6;
    border-color:#777;
  }

  #waitingMessage {
    display:none;
    margin-top:20px;
    padding:20px;
    background:rgba(255,255,255,0.1);
    border-radius:15px;
    font-size:18px;
  }

  #startBtn {
    display:none;
    margin-top:20px;
    background:#4CAF50;
    color:white;
    border:none;
    border-radius:15px;
    padding:15px 30px;
    font-weight:bold;
    font-size:20px;
    cursor:pointer;
  }

  /* TTS */
  #ttsDisplay {
    position:fixed;
    bottom:20px;
    left:50%;
    transform:translateX(-50%);
    background:rgba(0,0,0,0.7);
    color:white;
    padding:12px 24px;
    border-radius:12px;
    font-size:20px;
    max-width:90%;
    z-index:1002;
    opacity:0;
    transition:opacity 0.3s;
    pointer-events:none;
  }
  #ttsDisplay.show { opacity:1; }

  #backBtn {
    position:fixed;
    top:15px;
    left:15px;
    z-index:9999;
  }
  #backBtn button {
    background:#f44336;
    color:white;
    border:none;
    border-radius:50px;
    padding:12px 26px;
    font-weight:bold;
    box-shadow:0 4px 12px rgba(244,67,54,0.4);
    transition:all 0.3s;
  }

  #resultScreen {
    position:fixed;
    top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.95);
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
    z-index:10000;
    display:none;
  }
  #resultScreen h1 { font-size:48px; margin:20px; }
  #resultScreen p { font-size:28px; }
  #resultScreen button {
    margin-top:30px;
    background:#4CAF50;
    color:white;
    border:none;
    border-radius:15px;
    padding:15px 40px;
    font-size:22px;
    cursor:pointer;
  }

  #currentTurn {
    position:fixed;
    top:70px;
    left:50%;
    transform:translateX(-50%);
    background:rgba(255,255,255,0.9);
    color:#333;
    padding:10px 20px;
    border-radius:10px;
    font-size:18px;
    font-weight:bold;
    z-index:1001;
    display:none;
  }

  #mainMenuBtn {
    position:fixed;
    top:15px;
    left:15px;
    z-index:9999;
    background:#f44336;
    color:white;
    border:none;
    border-radius:50px;
    padding:12px 26px;
    font-weight:bold;
    box-shadow:0 4px 12px rgba(244,67,54,0.4);
    transition:all 0.3s;
    cursor:pointer;
    display:none;
  }
</style>
</head>
<body>

<button id="mainMenuBtn" onclick="location.href='../index.html'">กลับเมนูหลัก</button>

<div id="nameInput">
  <p style="font-size:24px;">กรอกชื่อของคุณ</p>
  <input id="playerName" placeholder="ชื่อของคุณ" autofocus>
  <button id="confirmNameBtn">ยืนยัน</button>
</div>

<div id="lobby">
  <h2>ล็อบบี้</h2>
  <button id="createRoomBtn" style="background:#fff;color:#333;padding:15px 30px;border-radius:15px;font-weight:bold;">สร้างห้องใหม่</button>
  <h3>ห้องที่เปิดอยู่</h3>
  <ul id="roomList"></ul>
</div>

<div id="room">
  <h2 id="roomName"></h2>
  <p>ผู้เล่นในห้อง:</p>
  <ul id="playerList"></ul>
  
  <div id="teamSelectInRoom">
    <p>เลือกทีมของคุณ:</p>
    <button class="team-btn" data-team="Manchester United">แมนเชสเตอร์ ยูไนเต็ด</button>
    <button class="team-btn" data-team="Liverpool">ลิเวอร์พูล</button>
    <button class="team-btn" data-team="Arsenal">อาร์เซนอล</button>
    <button class="team-btn" data-team="Chelsea">เชลซี</button>
  </div>
  
  <div id="waitingMessage"></div>
  
  <button id="startBtn" onclick="startGame()">เริ่มเกม</button>
</div>

<div id="gameScreen" style="display:none;">
  <div id="scoreBoard">Score ตอนนี้คือ 0 - 0</div>
  <div id="currentTurn"></div>
  <button id="tl" class="shot-btn" onclick="debounceClick('TL')">มุมซ้ายบน</button>
  <button id="tr" class="shot-btn" onclick="debounceClick('TR')">มุมขวาบน</button>
  <button id="center" class="shot-btn" onclick="debounceClick('C')">ตรงกลาง</button>
  <button id="bl" class="shot-btn" onclick="debounceClick('BL')">มุมซ้ายล่าง</button>
  <button id="br" class="shot-btn" onclick="debounceClick('BR')">มุมขวาล่าง</button>
</div>

<div id="resultScreen">
  <h1 id="resultTitle">ทีมชนะ</h1>
  <p id="resultMessage">ยินดีด้วย!</p>
</div>

<div id="ttsDisplay"></div>
<div id="tts" aria-live="assertive" style="position:absolute;left:-9999px;"></div>

<audio id="bgm" loop src="audio/b.mp3"></audio>
<audio id="goal" src="audio/t.mp3"></audio>
<audio id="miss" src="audio/f.mp3"></audio>
<audio id="end" src="audio/end.mp3"></audio>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script>
// === เริ่มต้น Firebase ===
const firebaseConfig = {
  apiKey: "AIzaSyBIPeN4YUIrwM4MmFtDvT2DJ-v4toxc7tY",
  authDomain: "xo-game-134ec.firebaseapp.com",
  databaseURL: "https://xo-game-134ec-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "xo-game-134ec",
  storageBucket: "xo-game-134ec.appspot.com",
  messagingSenderId: "318375224157",
  appId: "1:318375224157:web:348a410dfd625359b77eb4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// === ตัวแปรหลัก ===
let playerName = "", roomId = "", playerId = "", isHost = false;
let currentRoomListener = null, soundListener = null, lobbyRoomsListener = null;
let preloadedAudios = {};
let isButtonLocked = false;
let gameStarted = false;
let isMyTurn = false;

// === TTS & ARIA LIVE ===
let spokenTurns = new Set();
let shotOrderP1 = [], shotOrderP2 = [];
let lastProcessedTurn = -1;   
let finalResultSpoken = false;

// === โหลดเสียง (เพิ่มไฟล์ใหม่ทั้งหมด) ===
function preloadAllSounds() {
  const files = [
    "friend.mp3", "b.mp3", "end.mp3",
    // เสียงยิงเข้า
    "t.mp3", "t1.mp3", "t2.mp3", "t3.mp3", "t4.mp3",
    // เสียงยิงไม่เข้า
    "f.mp3", "f1.mp3", "f2.mp3", "f3.mp3", "f4.mp3"
  ];
  files.forEach(name => {
    const audio = new Audio(`audio/${name}`);
    audio.preload = "auto";
    preloadedAudios[name] = audio;
  });
}

function startBGM() {
  const bgm = preloadedAudios["b.mp3"];
  if (bgm) {
    bgm.currentTime = 0;
    bgm.volume = 0.3;
    bgm.loop = true;
    bgm.play().catch(() => {});
  }
}
function stopBGM() {
  const bgm = preloadedAudios["b.mp3"];
  if (bgm) { bgm.pause(); bgm.currentTime = 0; }
}

// สุ่มเสียงยิงเข้า / ไม่เข้า
function getRandomGoalSound() {
  const goals = ["t.mp3", "t1.mp3", "t2.mp3", "t3.mp3", "t4.mp3"];
  return goals[Math.floor(Math.random() * goals.length)];
}
function getRandomMissSound() {
  const misses = ["f.mp3", "f1.mp3", "f2.mp3", "f3.mp3", "f4.mp3"];
  return misses[Math.floor(Math.random() * misses.length)];
}

// ใช้ trigger จาก server เพื่อซิงค์ทั้ง 2 ฝ่าย
function triggerSound(name) {
  if (!roomId) return;
  db.ref(`penaltyRooms/${roomId}/soundTrigger`).set({
    name: name,
    time: Date.now(),
    playerId: playerId
  });
}

// ฟังจาก server แล้วเล่นเสียง + TTS + aria-live
function startSoundListener() {
  if (soundListener) soundListener.off();
  if (!roomId) return;
  soundListener = db.ref(`penaltyRooms/${roomId}/soundTrigger`);
  soundListener.on("value", s => {
    const data = s.val();
    if (!data || Date.now() - data.time > 1000) return;

    let name = data.name;
    // ถ้าเป็นเสียงยิงเข้า/ไม่เข้า ให้สุ่มจริง ๆ ที่นี่ด้วย (กันกรณีที่ trigger ด้วยชื่อเดิม)
    if (name === "goal") name = getRandomGoalSound();
    if (name === "miss") name = getRandomMissSound();

    const audio = preloadedAudios[name];
    if (audio) {
      audio.currentTime = 0;
      audio.volume = 1;
      audio.play().catch(() => {});
    }

    let msg = "";
    if (name.startsWith("t")) msg = "ยิงเข้า!";
    else if (name.startsWith("f")) msg = "ยิงไม่เข้า!";
    else if (name === "end.mp3") msg = "จบเกม!";
    else if (name === "friend.mp3") msg = `${playerName} เลือกทีมแล้ว`;

    if (msg) {
      speak(msg);
      const live = document.getElementById("tts");
      live.textContent = msg;
      setTimeout(() => live.textContent = "", 3000);
    }
  });
}

/* === TTS === */
let ttsQueue = [];
let isSpeaking = false;
const ttsDisplay = document.getElementById("ttsDisplay");

function speak(text){
  ttsQueue.push(text);
  processTTS();
}
function processTTS(){
  if(isSpeaking || ttsQueue.length === 0) return;
  isSpeaking = true;
  const msg = ttsQueue.shift();
  ttsDisplay.textContent = msg;
  ttsDisplay.classList.add('show');
  setTimeout(()=>{
    document.getElementById("tts").innerText = msg;
    setTimeout(()=>{
      isSpeaking = false;
      document.getElementById("tts").innerText = "";
      ttsDisplay.classList.remove('show');
      processTTS();
    }, Math.max(800, msg.length * 50));
  }, 50);
}

/* === ข้อมูลทีม === */
const squads = {
  "Manchester United": {
    "players": ["แกรี่ เนวิลล์","ริโอ เฟอร์ดินานด์","เวส บราวน์","ปาทริซ เอฟร่า",
                "คริสเตียโน่ โรนัลโด้","พอล สโคลส์","จอห์น โอเช","ไรอัน กิ๊กส์",
                "เวย์น รูนี่ย์","รุด ฟาน นิสเทลรอย"],
    "keeper": "เอ็ดวิน ฟาน เดอร์ ซาร์"
  },
  "Liverpool": {
    "players": ["สตีฟ ฟินแนน","เจมี่ คาร์ราเกอร์","ซามี่ ฮูเปีย","จอห์น อาร์เน่ รีเซ่",
                "ซาบี อลอนโซ่","โมฮาเหม็ด ซิสโซโก้","สตีเว่น เจอร์ราร์ด","หลุยส์ การ์เซีย",
                "ปีเตอร์ เคร้าช์","ฌิบริล ซิสเซ่"],
    "keeper": "เปเป้ เรน่า"
  },
  "Arsenal": {
    "players": ["เอ็มมานูเอล เอบูเอ้","โคโล ตูเร่","โซล แคมเบล","แอชลีย์ โคล",
                "อเล็กซานเดอร์ เคล็บ","ฌิลแบร์โต้ ซิลวา","เชส ฟาเบรกัส","โรแบร์ ปิแรส",
                "เฟรดริก ลุงเบิร์ก","เธียร์รี่ อองรี"],
    "keeper": "เยนส์ เลห์มันน์"
  },
  "Chelsea": {
    "players": ["เปาโล เฟร์เรร่า","ริคาร์โด้ คาร์วัลโญ่","จอห์น เทอร์รี่","วิลเลียม กัลลาส",
                "โคล้ด มาเกเลเล่","มิคาเอล เอสเซียง","แฟรงก์ แลมพาร์ด","โจ โคล",
                "อาร์เยน ร็อบเบน","เฮอร์นัน เครสโป"],
    "keeper": "ปีเตอร์ เช็ก"
  }
};

function shuffle(a){
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

function createShotsOrder(team){
  let players = squads[team].players.slice();
  shuffle(players);
  players.push(squads[team].keeper);
  return players;
}

function getShooterName(order, shotIndex) {
  const length = order.length;
  if (length === 0) return "นักเตะ";
  return order[shotIndex % length];
}

function debounceClick(dir){
  if(isButtonLocked || !isMyTurn) return;
  isButtonLocked = true;
  chooseDirection(dir);
  setTimeout(()=>{ isButtonLocked = false; }, 100);
}

/* === เริ่มต้นแอป === */
document.addEventListener("DOMContentLoaded", () => {
  const playerNameInput = document.getElementById("playerName");
  const confirmBtn = document.getElementById("confirmNameBtn");

  playerNameInput.focus();

  confirmBtn.addEventListener("click", confirmName);
  playerNameInput.addEventListener("keydown", e => {
    if (e.key === "Enter") confirmName();
  });

  document.getElementById("createRoomBtn").onclick = showCreateRoom;
  document.querySelectorAll(".team-btn").forEach(btn => {
    btn.onclick = () => chooseTeam(btn.getAttribute("data-team"));
  });

  document.getElementById("mainMenuBtn").style.display = "block";
});

/* === ยืนยันชื่อ === */
function confirmName() {
  const input = document.getElementById("playerName");
  playerName = input.value.trim();
  if (!playerName) {
    alert("กรุณาใส่ชื่อ");
    return;
  }
  playerId = Math.random().toString(36).substr(2,9);
  document.getElementById("nameInput").style.display = "none";
  document.getElementById("lobby").style.display = "block";
  document.getElementById("mainMenuBtn").style.display = "none";
  preloadAllSounds();
  loadRooms();
}

/* === สร้างห้องใหม่ === */
async function showCreateRoom() {
  const name = prompt("ตั้งชื่อห้อง:");
  if (!name || name.trim() === "") return;

  const roomRef = db.ref("penaltyRooms").push();
  const newRoomId = roomRef.key;

  try {
    await roomRef.set({
      name: name.trim(),
      status: "waiting",
      host: playerId,
      created: Date.now(),
      players: {
        [playerId]: { name: playerName, team: null }
      }
    });

    const playerRef = db.ref(`penaltyRooms/${newRoomId}/players/${playerId}`);
    playerRef.onDisconnect().remove();

    roomId = newRoomId;
    isHost = true;
    showRoom();
  } catch (err) {
    console.error("สร้างห้องล้มเหลว:", err);
    alert("สร้างห้องล้มเหลว กรุณาลองใหม่");
  }
}

/* === เข้าร่วมห้อง === */
async function joinRoom(id) {
  if (lobbyRoomsListener) lobbyRoomsListener.off();
  
  try {
    const snap = await db.ref(`penaltyRooms/${id}`).once("value");
    const room = snap.val();
    if (!room || room.status !== "waiting") {
      alert("ห้องนี้ไม่สามารถเข้าร่วมได้แล้ว");
      loadRooms(); 
      return;
    }

    const players = room.players || {};
    const activePlayers = Object.values(players).filter(p => p && p.name);
    if (activePlayers.length >= 2) {
      alert("ห้องเต็มแล้ว");
      loadRooms(); 
      return;
    }

    roomId = id;
    const playerRef = db.ref(`penaltyRooms/${roomId}/players/${playerId}`);
    await playerRef.set({ name: playerName, team: null });
    playerRef.onDisconnect().remove();

    showRoom();
  } catch (err) {
    console.error(err);
    alert("เข้าร่วมห้องล้มเหลว");
    loadRooms();
  }
}

/* === โหลดห้องในล็อบบี้ === */
function loadRooms() {
  const list = document.getElementById("roomList");
  if (lobbyRoomsListener) lobbyRoomsListener.off();
  
  lobbyRoomsListener = db.ref("penaltyRooms").orderByChild("status").equalTo("waiting");
  lobbyRoomsListener.on("value", snap => {
    list.innerHTML = "";
    const now = Date.now();

    snap.forEach(r => {
      const room = r.val();
      const key = r.key;
      if (!room) return;

      const players = room.players || {};
      const activePlayers = Object.values(players).filter(p => p && p.name);
      const count = activePlayers.length;

      if (count === 0 || (room.created && now - room.created > 300000)) {
        db.ref(`penaltyRooms/${key}`).remove();
        return;
      }

      if (count < 2) {
        const li = document.createElement("li");
        li.innerHTML = `<strong>${room.name}</strong> (${count}/2)`;
        const btn = document.createElement("button");
        btn.textContent = "เข้าร่วม";
        btn.style.cssText = "margin-left:10px;padding:5px 15px;background:#4CAF50;color:white;border:none;border-radius:5px;cursor:pointer;";
        btn.onclick = () => joinRoom(key);
        li.appendChild(btn);
        list.appendChild(li);
      }
    });
  });
}

/* === แสดงห้อง === */
function showRoom() {
  document.getElementById("lobby").style.display = "none";
  document.getElementById("room").style.display = "block";
  startSoundListener();

  if (currentRoomListener) currentRoomListener.off();
  currentRoomListener = db.ref(`penaltyRooms/${roomId}`);
  currentRoomListener.on("value", snap => {
    const room = snap.val();
    if (!room) { alert("ห้องถูกลบ"); backToLobby(); return; }
    document.getElementById("roomName").textContent = `ห้อง: ${room.name}`;
    
    const players = room.players || {};
    const list = document.getElementById("playerList");
    list.innerHTML = "";
    for (let id in players) {
      const p = players[id];
      if (p && p.name) {
        list.innerHTML += `<li>${p.name}${p.team ? ` - ${p.team}` : ""}</li>`;
      }
    }
    updateTeamButtons(room);

    const takenTeams = Object.values(players).filter(p => p && p.team).map(p => p.team);
    const teamDiv = document.getElementById("teamSelectInRoom");
    const waitMsg = document.getElementById("waitingMessage");
    const startBtn = document.getElementById("startBtn");

    if (players[playerId]?.team) {
      teamDiv.style.display = "none";
      waitMsg.style.display = "block";
      waitMsg.innerHTML = takenTeams.length === 1 ? "เลือกทีมแล้ว รอผู้เล่นที่เหลือ..." : "เลือกทีมแล้ว รอเจ้าของห้องกดเริ่มเกม…";
    } else {
      teamDiv.style.display = "flex";
      waitMsg.style.display = "none";
    }

    if (room.host === playerId && takenTeams.length === 2) {
      startBtn.style.display = "inline-block";
      startBtn.disabled = false;
    } else {
      startBtn.style.display = "none";
    }

    if (room.status === "playing") startGameplay(room, players);
    if (room.status === "finished") showResult(room);
  });
}

function updateTeamButtons(room) {
  const taken = Object.values(room.players || {}).filter(p => p && p.team).map(p => p.team);
  document.querySelectorAll(".team-btn").forEach(btn => {
    const team = btn.getAttribute("data-team");
    if (taken.includes(team)) {
      btn.classList.add("unavailable");
      btn.disabled = true;
    } else {
      btn.classList.remove("unavailable");
      btn.disabled = false;
    }
  });
}

function chooseTeam(team) {
  db.ref(`penaltyRooms/${roomId}/players/${playerId}/team`).set(team);
  triggerSound("friend.mp3");
  speak(`${playerName} เลือกทีม ${team}`);
}

/* === เริ่มเกม === */
function startGame() {
  if (gameStarted) return;
  gameStarted = true;
  document.getElementById("startBtn").disabled = true;
  speak("เริ่มเกม!");

  db.ref(`penaltyRooms/${roomId}/players`).once("value").then(snap => {
    const players = snap.val();
    const keys = Object.keys(players);
    const p1Id = keys[0], p2Id = keys[1];
    const p1Team = players[p1Id].team;
    const p2Team = players[p2Id].team;
    
    const orderP1 = createShotsOrder(p1Team);
    const orderP2 = createShotsOrder(p2Team);
    
    const firstShooter = Math.random() < 0.5 ? p1Id : p2Id;
    
    speak(`ทีม ${p1Team} ปะทะ ${p2Team}`);
    speak(`${players[firstShooter].name} จากทีม ${players[firstShooter].team} จะยิงลูกแรก`);
    
    db.ref(`penaltyRooms/${roomId}`).update({
      status: "playing", 
      firstShooter: firstShooter,
      turn: 0,
      scoreP1: 0, 
      scoreP2: 0, 
      shotIndexP1: 0, 
      shotIndexP2: 0,
      isSudden: false, 
      shooterDir: null, 
      keeperDir: null,
      processed: false,
      shotOrderP1: orderP1,
      shotOrderP2: orderP2,
      p1Id: p1Id,
      p2Id: p2Id
    });
  });
}

/* === เกมเพลย์ === */
function startGameplay(room, players) {
  document.getElementById("room").style.display = "none";
  document.getElementById("gameScreen").style.display = "block";
  document.getElementById("currentTurn").style.display = "block";
  startBGM();

  shotOrderP1 = room.shotOrderP1 || [];
  shotOrderP2 = room.shotOrderP2 || [];

  const gameRef = db.ref(`penaltyRooms/${roomId}`);
  
  document.querySelectorAll('.shot-btn').forEach(btn => {
    btn.classList.remove('locked');
    btn.disabled = false;
  });

  let lastTurn = -1;
  let lastIsSudden = false;

  gameRef.on("value", snap => {
    const data = snap.val();
    if (!data || data.status !== "playing") {
      document.querySelectorAll('.shot-btn').forEach(btn => {
        btn.style.display = 'none';
      });
      document.getElementById("currentTurn").style.display = "none";
      return;
    }

    const scoreP1 = data.scoreP1 || 0;
    const scoreP2 = data.scoreP2 || 0;
    document.getElementById("scoreBoard").innerText = 
      `Score: ${scoreP1} - ${scoreP2}`;

    const p1Id = data.p1Id;
    const p2Id = data.p2Id;
    
    const currentShooterId = data.turn % 2 === 0 ? data.firstShooter : (data.firstShooter === p1Id ? p2Id : p1Id);
    const currentKeeperId = currentShooterId === p1Id ? p2Id : p1Id;
    isMyTurn = (playerId === currentShooterId || playerId === currentKeeperId);

    document.querySelectorAll('.shot-btn').forEach(btn => {
      if (isMyTurn) {
        btn.classList.remove('locked');
        btn.disabled = false;
        btn.style.display = 'block';
      } else {
        btn.classList.add('locked');
        btn.disabled = true;
      }
    });

    const currentTurnEl = document.getElementById("currentTurn");
    const action = playerId === currentShooterId ? "ยิง!" : "เซฟ!";
    currentTurnEl.textContent = `ถึงตาคุณ${action}`;
    currentTurnEl.style.background = playerId === currentShooterId ? "rgba(76,175,80,0.9)" : "rgba(255,152,0,0.9)";
    currentTurnEl.style.color = "white";

    if (data.turn !== lastTurn) {
      lastTurn = data.turn;

      const shooterOrder = currentShooterId === p1Id ? shotOrderP1 : shotOrderP2;
      const shooterIndex = currentShooterId === p1Id ? data.shotIndexP1 : data.shotIndexP2;
      const shooterName = getShooterName(shooterOrder, shooterIndex);
      const keeperTeam = players[currentKeeperId].team;
      const keeperName = squads[keeperTeam].keeper;
      const shooterTeam = players[currentShooterId].team;

      if (playerId === currentShooterId && !spokenTurns.has(`turn_${data.turn}_shooter`)) {
        spokenTurns.add(`turn_${data.turn}_shooter`);
        speak(`ลูกที่ ${shooterIndex + 1} ${shooterTeam}: ${shooterName} เตรียมยิง`);
      }

      if (playerId === currentKeeperId && !spokenTurns.has(`turn_${data.turn}_keeper`)) {
        spokenTurns.add(`turn_${data.turn}_keeper`);
        speak(`ลูกที่ ${shooterIndex + 1} ${shooterTeam}: ${shooterName} เตรียมยิง ${keeperName} ของคุณพร้อมเซฟ`);
      }
    }

    if (data.isSudden && !lastIsSudden) {
      if (!spokenTurns.has("sudden")) {
        spokenTurns.add("sudden");
        speak("เข้าสู่ซัดเดนเดธ!");
      }
    }
    lastIsSudden = data.isSudden;

    if (data.shooterDir && data.keeperDir && !data.processed && data.turn > lastProcessedTurn) {
      lastProcessedTurn = data.turn;
      processShot(data, players, gameRef);
    }
  });
}

async function processShot(data, players, gameRef) {
  const processedRef = gameRef.child('processed');
  const transactionResult = await processedRef.transaction(current => {
    if (current) return;
    return true;
  });

  if (!transactionResult.committed) return;

  const p1Id = data.p1Id;
  const p2Id = data.p2Id;
  const currentShooterId = data.turn % 2 === 0 ? data.firstShooter : (data.firstShooter === p1Id ? p2Id : p1Id);
  const currentKeeperId = currentShooterId === p1Id ? p2Id : p1Id;
  
  const shooterOrder = currentShooterId === p1Id ? shotOrderP1 : shotOrderP2;
  const shooterIndex = currentShooterId === p1Id ? data.shotIndexP1 : data.shotIndexP2;
  const shooterName = getShooterName(shooterOrder, shooterIndex);
  const keeperTeam = players[currentKeeperId].team;
  const keeperName = squads[keeperTeam].keeper;
  const shooterTeam = players[currentShooterId].team;

  const isGoal = data.shooterDir !== data.keeperDir;

  // เปลี่ยนจาก trigger("t.mp3") / ("f.mp3") เป็น trigger แบบบอกประเภท แล้วสุ่มจริงที่ listener
  const soundType = isGoal ? "goal" : "miss";
  triggerSound(soundType);

  let scoreP1 = data.scoreP1 || 0;
  let scoreP2 = data.scoreP2 || 0;
  if (isGoal) {
    currentShooterId === p1Id ? scoreP1++ : scoreP2++;
  }

  const resultMsg = `${shooterName} จากทีม ${shooterTeam} ยิง${isGoal ? "เข้า" : "ไม่เข้า"}! คะแนน ${scoreP1} - ${scoreP2}`;
  speak(resultMsg);
  const live = document.getElementById("tts");
  live.textContent = resultMsg;
  setTimeout(() => live.textContent = "", 5000);

  const updates = {
    turn: data.turn + 1,
    shooterDir: null, 
    keeperDir: null, 
    processed: false,
    scoreP1, scoreP2
  };

  if (currentShooterId === p1Id) {
    updates.shotIndexP1 = data.shotIndexP1 + 1;
  } else {
    updates.shotIndexP2 = data.shotIndexP2 + 1;
  }

  setTimeout(() => {
    gameRef.update(updates);
    setTimeout(() => checkGameEndOrNext(data, players, gameRef, scoreP1, scoreP2, 
      updates.shotIndexP1 || data.shotIndexP1, updates.shotIndexP2 || data.shotIndexP2), 1000);
  }, 1000);
}

/* === ตรวจสอบจบเกมตามกฎ FIFA จริง === */
function checkGameEndOrNext(data, players, gameRef, scoreP1, scoreP2, shotIndexP1, shotIndexP2) {
  const p1Id = data.p1Id;
  const p2Id = data.p2Id;
  const isP1First = data.firstShooter === p1Id;

  const totalShotsP1 = shotIndexP1;
  const totalShotsP2 = shotIndexP2;

  let end = false;
  let winnerId = null;

  if (!data.isSudden) {
    const shotsDoneP1 = Math.min(totalShotsP1, 5);
    const shotsDoneP2 = Math.min(totalShotsP2, 5);
    const remainingP1 = 5 - shotsDoneP1;
    const remainingP2 = 5 - shotsDoneP2;

    if (totalShotsP1 < 5 || totalShotsP2 < 5) {
      const maxP1 = scoreP1 + remainingP1;
      const maxP2 = scoreP2 + remainingP2;
      if (maxP1 < scoreP2 || maxP2 < scoreP1) {
        end = true;
        winnerId = maxP1 < scoreP2 ? (isP1First ? p2Id : p1Id) : (isP1First ? p1Id : p2Id);
      }
    }

    if (totalShotsP1 >= 5 && totalShotsP2 >= 5) {
      if (scoreP1 !== scoreP2) {
        end = true;
        winnerId = scoreP1 > scoreP2 ? (isP1First ? p1Id : p2Id) : (isP1First ? p2Id : p1Id);
      } else {
        gameRef.update({ isSudden: true });
        return;
      }
    }
  }
  else {
    const suddenShotsP1 = totalShotsP1 - 5;
    const suddenShotsP2 = totalShotsP2 - 5;

    if (suddenShotsP1 === suddenShotsP2 && suddenShotsP1 > 0) {
      if (scoreP1 !== scoreP2) {
        end = true;
        winnerId = scoreP1 > scoreP2 ? (isP1First ? p1Id : p2Id) : (isP1First ? p2Id : p1Id);
      }
    }
  }

  if (end) {
    triggerSound("end.mp3");
    stopBGM();

    setTimeout(() => {
      gameRef.update({
        status: "finished",
        winner: winnerId,
        finalScoreP1: scoreP1,
        finalScoreP2: scoreP2
      });
    }, 800);
  }
}

async function chooseDirection(dir) {
  const snap = await db.ref(`penaltyRooms/${roomId}`).once("value");
  const data = snap.val();
  if (data.status !== "playing") return;
  
  const currentShooterId = data.turn % 2 === 0 ? data.firstShooter : (data.firstShooter === data.p1Id ? data.p2Id : data.p1Id);
  const currentKeeperId = currentShooterId === data.p1Id ? data.p2Id : data.p1Id;

  if (playerId === currentShooterId && !data.shooterDir) {
    await db.ref(`penaltyRooms/${roomId}/shooterDir`).set(dir);
  } else if (playerId === currentKeeperId && !data.keeperDir) {
    await db.ref(`penaltyRooms/${roomId}/keeperDir`).set(dir);
  }
}

function showResult(room) {
  stopBGM();
  document.getElementById("gameScreen").style.display = "none";
  document.getElementById("currentTurn").style.display = "none";
  document.querySelectorAll('.shot-btn').forEach(btn => {
    btn.style.display = 'none';
  });

  const p1Team = room.players[room.p1Id].team;
  const p2Team = room.players[room.p2Id].team;
  const winnerTeam = room.winner === room.p1Id ? p1Team : p2Team;

  document.getElementById("resultTitle").textContent = `${winnerTeam} เป็นฝ่ายชนะ`;
  document.getElementById("resultMessage").textContent = "ยินดีด้วย!";
  document.getElementById("resultScreen").style.display = "flex";
  document.getElementById("mainMenuBtn").style.display = "block";

  if (!finalResultSpoken) {
    finalResultSpoken = true;
    const finalMsg = `${winnerTeam} เป็นฝ่ายชนะ ยินดีด้วย!`;
    speak(finalMsg);
    const live = document.getElementById("tts");
    live.textContent = finalMsg;
    setTimeout(() => live.textContent = "", 8000);
  }
}

function backToLobby() {
  // ลบฟังก์ชันนี้ทั้งหมด ตามคำขอ
}
</script>
</body>
</html>