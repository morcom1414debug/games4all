<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Swipe Game</title>
<style>
  body {
    margin:0;
    padding:0;
    background:black;
    color:white;
    font-size:24px;
    text-align:center;
  }
  #startBtn {
    margin-top:40vh;
    padding:20px 40px;
    font-size:24px;
  }
</style>
</head>
<body>
  <button id="startBtn">เริ่มเกม</button>
<script>
let audioFiles = {
  start: "start.mp3",
  background: "background.mp3",
  left: "left.mp3",
  right: "right.mp3",
  up: "up.mp3",
  down: "down.mp3",
  touch: "touch.mp3",
  touch2: "touch2.mp3",
  win: "win.mp3",
  lost: "lost.mp3",
  endlost: "endlost.mp3",
  endhappy: "endhappy.mp3"
};

let backgroundAudio;
let gameStarted = false;
let currentRound = 1;
let failCount = 0;
let sequence = [];
let userInput = [];
let maxFails = 3;
let maxGestures = 10;

document.getElementById("startBtn").addEventListener("click", async () => {
  await playAudio("start");
  enableGameArea();
});

function enableGameArea() {
  document.body.addEventListener("touchstart", handleGestures, {passive:false});
  document.body.addEventListener("touchend", handleGestures, {passive:false});
}

async function startGame() {
  if (gameStarted) return;
  gameStarted = true;
  playBackground();
  currentRound = 1;
  failCount = 0;
  await delay(3000);
  nextRound();
}

function playBackground() {
  backgroundAudio = new Audio(audioFiles.background);
  backgroundAudio.loop = true;
  backgroundAudio.play().catch(()=>{});
}

function stopBackground() {
  if (backgroundAudio) {
    backgroundAudio.pause();
    backgroundAudio.currentTime = 0;
  }
}

async function nextRound() {
  if (currentRound > 999) return; // กัน loop เกิน
  let gestureCount = Math.min(1 + Math.floor((currentRound-1)/3), maxGestures);
  sequence = [];
  for (let i=0; i<gestureCount; i++) {
    sequence.push(randomGesture());
  }
  userInput = [];
  await playCoachSequence(sequence);
  // กำหนดเวลาในแต่ละรอบ
  let timeLimit = getTimeLimit(gestureCount);
  setTimeout(()=>{ checkAnswer(); }, timeLimit);
}

function getTimeLimit(gestureCount) {
  if (gestureCount<=3) return 2000;
  if (gestureCount<=6) return 2500;
  if (gestureCount<=9) return 3000;
  if (gestureCount<=12) return 3500;
  if (gestureCount<=15) return 4000;
  return 5000;
}

function randomGesture() {
  let keys = ["left","right","up","down","touch","touch2"];
  return keys[Math.floor(Math.random()*keys.length)];
}

async function playCoachSequence(seq) {
  for (let g of seq) {
    await playAudio(g);
    await delay(200); // กันเสียงทับ
  }
}

function playAudio(name) {
  return new Promise((resolve) => {
    let audio = new Audio(audioFiles[name]);
    audio.currentTime = 0;
    audio.onended = () => resolve();
    audio.onerror = () => resolve();
    audio.play().catch(()=>resolve());
  });
}

function delay(ms) {
  return new Promise(res => setTimeout(res, ms));
}

async function checkAnswer() {
  if (arraysEqual(userInput, sequence)) {
    await playAudio("win");
    currentRound++;
    if (sequence.length >= maxGestures) {
      stopBackground();
      await playAudio("endhappy");
      gameStarted = false;
      return;
    }
  } else {
    failCount++;
    await playAudio("lost");
    if (failCount >= maxFails) {
      stopBackground();
      await playAudio("endlost");
      gameStarted = false;
      return;
    }
  }
  await delay(1000);
  nextRound();
}

function arraysEqual(a,b) {
  if (a.length !== b.length) return false;
  for (let i=0;i<a.length;i++) if (a[i]!==b[i]) return false;
  return true;
}

// ------------------ Gesture Handling ------------------
let touchStartX=0, touchStartY=0, touchEndX=0, touchEndY=0, tapCount=0, lastTap=0;

function handleGestures(e) {
  if (!gameStarted) {
    // ตรวจสอบ gesture เริ่มเกม: 2 นิ้วปัดขึ้น
    if (e.touches && e.touches.length===2) {
      let t1 = e.touches[0];
      let t2 = e.touches[1];
      if (t1.clientY > t2.clientY-10 && t1.clientY < t2.clientY+10) {
        startGame();
      }
    }
    return;
  }

  if (e.type==="touchstart") {
    if (e.touches.length===1) {
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
    }
  } else if (e.type==="touchend") {
    touchEndX = e.changedTouches[0].clientX;
    touchEndY = e.changedTouches[0].clientY;
    let dx = touchEndX - touchStartX;
    let dy = touchEndY - touchStartY;

    if (Math.abs(dx) < 10 && Math.abs(dy) < 10) {
      // tap
      let now = Date.now();
      if (now - lastTap < 300) {
        userInput.push("touch2");
        lastTap=0;
      } else {
        userInput.push("touch");
        lastTap=now;
      }
    } else if (Math.abs(dx) > Math.abs(dy)) {
      userInput.push(dx>0 ? "right":"left");
    } else {
      userInput.push(dy>0 ? "down":"up");
    }
  }
}
</script>
</body>
</html>
