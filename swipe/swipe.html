<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Swipe Game</title>
<style>
  html,body{height:100%;margin:0}
  body{background:#111}
  #container{height:100vh;display:flex;align-items:center;justify-content:center}
  #startBtn{padding:18px 28px;border-radius:12px;background:#222;color:#fff;border:1px solid #444;font-size:18px}
  #gameArea{position:fixed;inset:0;background:#000;display:none;touch-action:none}
</style>
</head>
<body>
<div id="container">
  <button id="startBtn">เริ่ม</button>
</div>
<div id="gameArea"></div>

<audio id="audioStart" src="start.mp3"></audio>
<audio id="audioBackground" src="background.mp3" loop></audio>
<audio id="a_left" src="left.mp3"></audio>
<audio id="a_right" src="right.mp3"></audio>
<audio id="a_up" src="up.mp3"></audio>
<audio id="a_down" src="down.mp3"></audio>
<audio id="a_touch" src="touch.mp3"></audio>
<audio id="a_touch2" src="touch2.mp3"></audio>
<audio id="audioWin" src="win.mp3"></audio>
<audio id="audioLost" src="lost.mp3"></audio>
<audio id="audioEndLost" src="endlost.mp3"></audio>
<audio id="audioEndHappy" src="endhappy.mp3"></audio>

<script>
const startBtn = document.getElementById('startBtn');
const gameArea = document.getElementById('gameArea');
const audioStart = document.getElementById('audioStart');
const audioBackground = document.getElementById('audioBackground');
const audioWin = document.getElementById('audioWin');
const audioLost = document.getElementById('audioLost');
const audioEndLost = document.getElementById('audioEndLost');
const audioEndHappy = document.getElementById('audioEndHappy');
const AUDIO_MAP = {
  left: document.getElementById('a_left'),
  right: document.getElementById('a_right'),
  up: document.getElementById('a_up'),
  down: document.getElementById('a_down'),
  touch: document.getElementById('a_touch'),
  touch2: document.getElementById('a_touch2')
};

const GESTURES = Object.keys(AUDIO_MAP);
let playing = false;
let waitingForTwoFingerStart = false;
let sequence = [];
let currentRound = 0;
let playerIndex = 0;
let mistakes = 0;
const MAX_MISTAKES = 3;
let roundTimer;

function gesturesForRound(round){ return Math.ceil(round/3); }
function timeForRound(round){
  const g = gesturesForRound(round);
  if(g<=2) return 2000;
  return 2000 + 500*(g-2);
}
function generateSequence(n){
  let arr=[];for(let i=0;i<n;i++) arr.push(GESTURES[Math.floor(Math.random()*GESTURES.length)]);
  return arr;
}

function playCoachSequence(seq){
  return new Promise(resolve=>{
    let i=0;
    function playNext(){
      if(i>=seq.length){ resolve(); return; }
      let audio=AUDIO_MAP[seq[i]];
      audio.currentTime=0;
      audio.play().catch(()=>{});
      audio.onended=()=>{ i++; playNext(); };
    }
    playNext();
  });
}

function startBackground(){ audioBackground.currentTime=0; audioBackground.play().catch(()=>{}); }
function stopBackground(){ audioBackground.pause(); audioBackground.currentTime=0; }

async function startRound(){
  currentRound++;
  playerIndex=0;
  sequence=generateSequence(gesturesForRound(currentRound));
  if(currentRound===1) await new Promise(r=>setTimeout(r,3000));
  await playCoachSequence(sequence);
  roundTimer=setTimeout(()=>{handleRoundFailure();},timeForRound(currentRound));
}

async function handleRoundSuccess(){
  clearTimeout(roundTimer);
  await audioWin.play().catch(()=>{});
  if(sequence.length>=10){
    stopBackground();
    await audioEndHappy.play().catch(()=>{});
    playing=false;
  } else {
    setTimeout(startRound,1000);
  }
}

async function handleRoundFailure(){
  clearTimeout(roundTimer);
  mistakes++;
  await audioLost.play().catch(()=>{});
  if(mistakes>=MAX_MISTAKES){
    stopBackground();
    await audioEndLost.play().catch(()=>{});
    playing=false;
  } else {
    setTimeout(startRound,1000);
  }
}

function onDetectedGesture(g){
  if(!playing) return;
  if(g===sequence[playerIndex]){
    playerIndex++;
    if(playerIndex>=sequence.length) handleRoundSuccess();
  } else {
    handleRoundFailure();
  }
}

gameArea.addEventListener('touchstart',e=>{gameArea.startTouches=e.touches.length;gameArea.startY=e.touches[0].clientY;gameArea.startX=e.touches[0].clientX;});
gameArea.addEventListener('touchend',e=>{
  const endY=e.changedTouches[0].clientY;
  const endX=e.changedTouches[0].clientX;
  const dy=gameArea.startY-endY;
  const dx=endX-gameArea.startX;
  if(gameArea.startTouches>=2 && dy>50){
    if(waitingForTwoFingerStart){
      waitingForTwoFingerStart=false;playing=true;mistakes=0;currentRound=0;
      startBackground();startRound();
    } else if(!playing){
      playing=true;mistakes=0;currentRound=0;
      startBackground();startRound();
    }
    return;
  }
  if(Math.abs(dx)>Math.abs(dy) && Math.abs(dx)>40){
    onDetectedGesture(dx>0?'right':'left');
  } else if(Math.abs(dy)>40){
    onDetectedGesture(dy>0?'up':'down');
  } else {
    // tap or double tap
    if(e.timeStamp - (gameArea.lastTap||0) < 300){
      gameArea.lastTap=0;
      onDetectedGesture('touch2');
    } else {
      gameArea.lastTap=e.timeStamp;
      setTimeout(()=>{ if(gameArea.lastTap){gameArea.lastTap=0;onDetectedGesture('touch');}},310);
    }
  }
});

startBtn.onclick=()=>{
  audioStart.currentTime=0;
  audioStart.play().catch(()=>{});
  audioStart.onended=()=>{
    document.getElementById('container').style.display='none';
    gameArea.style.display='block';
    waitingForTwoFingerStart=true;
  };
};
</script>
</body>
</html>
