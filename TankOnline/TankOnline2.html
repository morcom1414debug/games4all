<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tank Assassin Online</title>
    <style>
        :root {
            --base-green: #4b5320;
            --player-zone: #2e3d2e;
            --enemy-zone: #600000;
            --gold: #ffd700;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: var(--player-zone);
            color: #fff;
            text-align: center;
            margin: 0;
            padding: 10px;
            overflow-x: hidden;
            transition: background-color 0.5s ease;
        }

        #game-container {
            max-width: 600px;
            width: 100%;
            margin: auto;
            position: relative;
            background-color: var(--base-green);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
            box-sizing: border-box;
            min-height: 560px;
        }

        .smoke-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.08), transparent);
            pointer-events: none;
            animation: drift 8s infinite alternate ease-in-out;
            z-index: 2;
        }
        @keyframes drift { from { transform: scale(1) translateX(-5%); } to { transform: scale(1.2) translateX(5%); } }

        @keyframes pulse-hit {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); filter: brightness(1.3); }
            100% { transform: scale(1); }
        }
        .hit-pulse { animation: pulse-hit 0.5s ease-out; }

        @keyframes shake {
            0% { transform: translate(1px, 1px); }
            50% { transform: translate(-3px, -2px); }
            100% { transform: translate(0, 0); }
        }
        .shake-effect { animation: shake 0.4s; }

        .tank-art { font-size: 80px; margin: 15px 0; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.5)); }

        .grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            max-width: 400px;
            margin: 15px auto;
            border: 3px solid var(--gold);
            padding: 10px;
            background-color: rgba(0,0,0,0.3);
            border-radius: 12px;
            position: relative;
            z-index: 3;
        }

        button {
            padding: 5px; font-size: 16px;
            background-color: #6b8e23; color: #fff;
            border: 2px solid var(--gold);
            cursor: pointer; border-radius: 8px;
            aspect-ratio: 1 / 1;
            display: flex; align-items: center; justify-content: center;
            transition: box-shadow 0.2s, background-color 0.2s;
        }

        button:focus:not(:disabled) {
            box-shadow: 0 0 15px #fff, inset 0 0 10px var(--gold);
            background-color: #8da33c;
            outline: 3px solid white;
        }

        .hit-bg { background-color: #ff4500 !important; border-color: #fff !important; }
        .miss-bg { background-color: #444 !important; border-color: #888 !important; }

        #room-list { list-style: none; padding: 0; margin-top: 20px; }
        .room-item {
            background: rgba(0,0,0,0.5); margin: 5px 0; padding: 10px;
            display: flex; justify-content: space-between; align-items: center;
            border-radius: 8px; border: 1px solid var(--gold);
        }
    </style>
</head>
<body>

<div id="game-container">
    <div class="smoke-overlay" aria-hidden="true"></div>

    <div id="menu">
        <div class="tank-art" aria-hidden="true">üöú</div>
        <h1 tabindex="-1">Tank Assassin Online</h1>
        <p>‡∏¢‡∏∏‡∏ó‡∏ò‡∏Å‡∏≤‡∏£‡∏£‡∏ñ‡∏ñ‡∏±‡∏á‡∏°‡∏´‡∏≤‡∏Å‡∏≤‡∏¨ (Online)<br>‡πÄ‡∏Å‡∏°‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏±‡∏ô‡∏¢‡∏¥‡∏á ‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏ô‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÅ‡∏ö‡∏ö Real-time</p>
        <button id="btn-create-room" style="aspect-ratio: auto; padding: 15px 30px; margin: 20px auto;">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>
        <h3>‡∏™‡∏°‡∏£‡∏†‡∏π‡∏°‡∏¥‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°:</h3>
        <div id="room-list"></div>
    </div>

    <div id="placement" style="display: none;">
        <h2 id="role-display" tabindex="-1">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏Å‡∏≤‡∏£</h2>
        <div id="placement-announce" aria-live="polite">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏¢‡∏∏‡∏ó‡∏ò‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå ‡∏ß‡∏≤‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏ô‡∏ß‡∏£‡∏ö‡∏£‡∏ñ‡∏ñ‡∏±‡∏á 3 ‡∏Ñ‡∏±‡∏ô</div>
        <div id="placement-grid" class="grid"></div>
    </div>

    <div id="game" style="display: none;">
        <div id="lives" style="display: flex; justify-content: space-around; background: rgba(0,0,0,0.4); padding: 10px; border-radius: 10px;">
            <span id="p1-label">Host: 3</span>
            <span id="p2-label">Guest: 3</span>
        </div>
        <div id="announcement" aria-live="polite" style="font-size: 19px; margin: 10px 0; color: var(--gold); font-weight: bold; min-height: 1.5em;"></div>
        
        <div id="enemy-grid-container" style="display: none;">
            <div id="enemy-grid" class="grid"></div>
        </div>

        <div id="my-grid-container" style="display: none;">
            <div id="my-grid" class="grid"></div>
        </div>
    </div>

    <div id="summary" style="display: none;">
        <div class="tank-art" id="summary-art" aria-hidden="true">üéñÔ∏è</div>
        <h2 tabindex="-1">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏ö</h2>
        <p id="result-message" style="font-size: 20px;"></p>
        <button onclick="location.reload()" style="aspect-ratio: auto; padding: 15px 30px; margin: 20px auto;">‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, onDisconnect, remove, get, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBIPeN4YUIrwM4MmFtDvT2DJ-v4toxc7tY",
        authDomain: "xo-game-134ec.firebaseapp.com",
        databaseURL: "https://xo-game-134ec-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "xo-game-134ec",
        storageBucket: "xo-game-134ec.firebasestorage.app",
        messagingSenderId: "318375224157",
        appId: "1:318375224157:web:ef720e113260d4b7b77eb4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const GAME_ID = "tank001";

    // --- Audio System ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let sounds = {};
    let bgm = null;

    const loadSounds = () => {
        ['back.mp3','select.mp3','shoot1.mp3','shoot2.mp3','t1.mp3','t2.mp3','t3.mp3','t4.mp3','f1.mp3','f2.mp3','f3.mp3','f4.mp3','a1.mp3','a2.mp3','a3.mp3','a4.mp3','s1.mp3','s2.mp3','s3.mp3','s4.mp3','win.mp3','lost.mp3','start.mp3']
        .forEach(f => {
            fetch('audio/' + f).then(r => r.arrayBuffer()).then(b => audioCtx.decodeAudioData(b)).then(d => sounds[f] = d);
        });
    };

    const playS = (f, loop = false) => {
        if (!sounds[f]) return null;
        const s = audioCtx.createBufferSource();
        s.buffer = sounds[f]; s.loop = loop;
        s.connect(audioCtx.destination); s.start();
        return s;
    };

    const playRnd = (side, isHit) => {
        // ‡∏ù‡πà‡∏≤‡∏¢ Host: Hit(t1-t4), Miss(f1-f4) | ‡∏ù‡πà‡∏≤‡∏¢ Guest: Hit(a1-a4), Miss(s1-s4)
        const map = { 
            'host': { 'hit': ['t1','t2','t3','t4'], 'miss': ['f1','f2','f3','f4'] },
            'guest': { 'hit': ['a1','a2','a3','a4'], 'miss': ['s1','s2','s3','s4'] }
        };
        const pool = isHit ? map[side].hit : map[side].miss;
        const file = pool[Math.floor(Math.random()*4)] + '.mp3';
        return playS(file);
    };

    // --- State ---
    let myRole = ""; 
    let myTanks = [];
    let roomRef = null;
    let currentTurn = "";

    // --- Room Logic ---
    onValue(ref(db, `games/${GAME_ID}/rooms`), (snapshot) => {
        const rooms = snapshot.val();
        const listDiv = document.getElementById('room-list');
        listDiv.innerHTML = "";
        const now = Date.now();
        for (let id in rooms) {
            if (now - rooms[id].lastActive > 600000) { remove(ref(db, `games/${GAME_ID}/rooms/${id}`)); continue; }
            if (!rooms[id].guest) {
                const item = document.createElement('div');
                item.className = "room-item";
                item.innerHTML = `<span>‡∏™‡∏°‡∏£‡∏†‡∏π‡∏°‡∏¥ ${id} (1/2)</span><button onclick="window.joinRoom('${id}')" style="aspect-ratio:auto; padding:5px 15px;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</button>`;
                listDiv.appendChild(item);
            }
        }
    });

    async function createRoom() {
        const snap = await get(ref(db, `games/${GAME_ID}/roomCounter`));
        let count = (snap.val() || 0) + 1;
        if (count > 99999) count = 1;
        await set(ref(db, `games/${GAME_ID}/roomCounter`), count);
        const roomId = "Tank" + String(count).padStart(5, '0');
        myRole = "host";
        roomRef = ref(db, `games/${GAME_ID}/rooms/${roomId}`);
        await set(roomRef, { host: "waiting", lastActive: serverTimestamp(), status: "waiting" });
        onDisconnect(roomRef).remove();
        bgm = playS('back.mp3', true);
        showPlacement();
    }

    window.joinRoom = async (id) => {
        myRole = "guest";
        roomRef = ref(db, `games/${GAME_ID}/rooms/${id}`);
        await update(roomRef, { guest: "waiting", lastActive: serverTimestamp() });
        onDisconnect(roomRef).remove();
        bgm = playS('back.mp3', true);
        showPlacement();
    };

    // --- UI Methods ---
    function showPlacement() {
        document.getElementById('menu').style.display = 'none';
        document.getElementById('placement').style.display = 'block';
        document.getElementById('role-display').textContent = myRole === "host" ? "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏Å‡∏≤‡∏£: Host" : "‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏à‡∏π‡πà‡πÇ‡∏à‡∏°: Guest";
        const grid = document.getElementById('placement-grid');
        grid.innerHTML = "";
        for (let i = 1; i <= 16; i++) {
            const btn = document.createElement('button');
            btn.textContent = i;
            btn.setAttribute('aria-label', i);
            btn.onclick = () => {
                if (myTanks.length < 3 && !btn.disabled) {
                    myTanks.push(i);
                    btn.disabled = true;
                    btn.innerHTML = `<span aria-hidden="true">üöú</span>`;
                    btn.setAttribute('aria-label', i + " ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß");
                    playS('select.mp3');
                    if (myTanks.length === 3) finishPlacement();
                }
            };
            grid.appendChild(btn);
        }
    }

    async function finishPlacement() {
        document.getElementById('placement-announce').textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢...";
        await update(roomRef, { [myRole]: myTanks, lastActive: serverTimestamp() });
        onValue(roomRef, (snapshot) => {
            const data = snapshot.val();
            if (!data) return;
            if (data.host !== "waiting" && data.guest && data.guest !== "waiting" && data.status === "waiting") {
                if (myRole === "host") {
                    update(roomRef, { 
                        status: "playing", 
                        turn: Math.random() > 0.5 ? "host" : "guest",
                        h_lives: 3, g_lives: 3,
                        lastActive: serverTimestamp()
                    });
                }
            } else if (data.status === "playing") {
                startBattle(data);
            } else if (data.status === "finished") {
                finishGame(data);
            }
            if (myRole === "host" && data.guest && data.guest !== "waiting" && !window.guestAlerted) {
                document.getElementById('placement-announce').textContent = "‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏™‡∏°‡∏£‡∏†‡∏π‡∏°‡∏¥‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏π‡πâ‡∏®‡∏∂‡∏Å!";
                window.guestAlerted = true;
            }
        });
    }

    function startBattle(data) {
        document.getElementById('placement').style.display = 'none';
        document.getElementById('game').style.display = 'block';
        if (!window.battleStarted) { playS('start.mp3'); window.battleStarted = true; initBattleGrids(); }
        syncGame(data);
    }

    function initBattleGrids() {
        const eGrid = document.getElementById('enemy-grid');
        const mGrid = document.getElementById('my-grid');
        eGrid.innerHTML = ""; mGrid.innerHTML = "";
        for (let i = 1; i <= 16; i++) {
            const eb = document.createElement('button');
            eb.textContent = i; eb.dataset.pos = i;
            eb.setAttribute('aria-label', `‡∏¢‡∏¥‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ${i}`);
            eb.onclick = () => myRole === currentTurn && handleAttack(i);
            eGrid.appendChild(eb);

            const mb = document.createElement('button');
            mb.textContent = i; mb.dataset.pos = i; mb.disabled = true;
            if (myTanks.includes(i)) mb.innerHTML = `<span aria-hidden="true">üöú</span>`;
            mGrid.appendChild(mb);
        }
    }

    async function handleAttack(pos) {
        await update(roomRef, { lastShot: { by: myRole, pos: pos }, lastActive: serverTimestamp() });
    }

    async function syncGame(data) {
        currentTurn = data.turn;
        const isMyTurn = currentTurn === myRole;
        
        // ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô (‡∏¢‡∏∂‡∏î‡∏´‡∏•‡∏±‡∏Å UI ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö)
        document.getElementById('enemy-grid-container').style.display = isMyTurn ? 'block' : 'none';
        document.getElementById('my-grid-container').style.display = isMyTurn ? 'none' : 'block';
        document.body.style.backgroundColor = isMyTurn ? 'var(--enemy-zone)' : 'var(--player-zone)';
        document.getElementById('announcement').textContent = isMyTurn ? "‡∏ï‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏¥‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ 1-16" : "‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î...";
        document.getElementById('p1-label').textContent = `Host: ${data.h_lives}`;
        document.getElementById('p2-label').textContent = `Guest: ${data.g_lives}`;

        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏° (Hit/Miss) ‡πÅ‡∏•‡∏∞ Aria-label
        const enemyRole = myRole === "host" ? "guest" : "host";
        const enemyTanks = data[enemyRole];

        if (data.shots) {
            Object.values(data.shots).forEach(s => {
                const isTargetMe = s.by !== myRole;
                const gridId = isTargetMe ? 'my-grid' : 'enemy-grid';
                const btn = document.querySelector(`#${gridId} button[data-pos="${s.pos}"]`);
                if (btn) {
                    const hit = (isTargetMe ? myTanks : enemyTanks).includes(s.pos);
                    btn.disabled = true;
                    btn.classList.add(hit ? 'hit-bg' : 'miss-bg');
                    btn.innerHTML = `<span aria-hidden="true">${hit ? 'üí•' : 'üï≥Ô∏è'}</span>`;
                    btn.setAttribute('aria-label', `‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ${s.pos} ${hit ? '‡∏£‡∏ñ‡∏ñ‡∏±‡∏á‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏†‡∏≤‡∏û' : '‡∏û‡∏•‡∏≤‡∏î'}`);
                }
            });
        }

        // ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏±‡πà‡∏ô‡∏à‡∏≠
        if (data.lastShot && data.lastShot.id !== window.lastId) {
            window.lastId = data.lastShot.id;
            const s = data.lastShot;
            const hit = (s.by === "host" ? data.guest : data.host).includes(s.pos);
            
            document.getElementById('game-container').classList.add('shake-effect');
            playS(hit ? 'shoot2.mp3' : 'shoot1.mp3');
            
            setTimeout(async () => {
                document.getElementById('game-container').classList.remove('shake-effect');
                playRnd(s.by, hit);
                
                if (myRole === "host") {
                    const victim = s.by === "host" ? "g_lives" : "h_lives";
                    const newLives = hit ? data[victim] - 1 : data[victim];
                    const nextTurn = s.by === "host" ? "guest" : "host";
                    const shotId = push(ref(db, `games/${GAME_ID}/rooms/${data.id}/shots`)).key;
                    
                    const updates = {
                        [`shots/${shotId}`]: { by: s.by, pos: s.pos },
                        turn: nextTurn,
                        lastShot: null, // clear for next
                        [victim]: newLives,
                        lastActive: serverTimestamp()
                    };
                    if (newLives <= 0) updates.status = "finished";
                    update(roomRef, updates);
                }
            }, 800);
        }

        if (isMyTurn) {
            const target = document.querySelector('#enemy-grid button:not(:disabled)');
            if (target) target.focus();
        }
    }

    function finishGame(data) {
        if (bgm) bgm.stop();
        const winner = data.h_lives > 0 ? "host" : "guest";
        const isWin = myRole === winner;
        document.getElementById('game').style.display = 'none';
        document.getElementById('summary').style.display = 'block';
        document.getElementById('result-message').textContent = isWin ? "‡∏ä‡∏±‡∏¢‡∏ä‡∏ô‡∏∞! ‡∏Å‡∏≠‡∏á‡∏ó‡∏±‡∏û‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡πà‡∏≤‡∏¢‡πÅ‡∏û‡πâ‡∏£‡∏≤‡∏ö‡∏Ñ‡∏≤‡∏ö" : "‡∏û‡πà‡∏≤‡∏¢‡πÅ‡∏û‡πâ... ‡∏ê‡∏≤‡∏ô‡∏ó‡∏±‡∏û‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡∏•‡πà‡∏°‡∏™‡∏•‡∏≤‡∏¢";
        document.getElementById('summary-art').textContent = isWin ? "üèÜ" : "üåë";
        playS(isWin ? 'win.mp3' : 'lost.mp3');
    }

    window.onload = loadSounds;
    document.getElementById('btn-create-room').onclick = createRoom;
</script>
</body>
</html>