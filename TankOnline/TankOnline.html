<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tank Assassin Online</title>
    <style>
        :root {
            --base-green: #4b5320;
            --player-zone: #2e3d2e;
            --enemy-zone: #600000;
            --gold: #ffd700;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: var(--player-zone);
            color: #fff;
            text-align: center;
            margin: 0;
            padding: 10px;
            overflow-x: hidden;
            transition: background-color 0.5s ease;
        }
        #game-container {
            max-width: 600px;
            width: 100%;
            margin: auto;
            position: relative;
            background-color: var(--base-green);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
            box-sizing: border-box;
            min-height: 560px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            max-width: 400px;
            margin: 15px auto;
            border: 3px solid var(--gold);
            padding: 10px;
            background-color: rgba(0,0,0,0.3);
            border-radius: 12px;
        }
        button {
            padding: 5px; font-size: 16px;
            background-color: #6b8e23; color: #fff;
            border: 2px solid var(--gold);
            cursor: pointer; border-radius: 8px;
            aspect-ratio: 1 / 1;
            display: flex; align-items: center; justify-content: center;
        }
        button:focus:not(:disabled) {
            box-shadow: 0 0 15px #fff;
            outline: 3px solid white;
        }
        .hit-bg { background-color: #ff4500 !important; }
        .miss-bg { background-color: #444 !important; }
        .shake-effect { animation: shake 0.4s; }
        @keyframes shake { 0% { transform: translate(1px, 1px); } 50% { transform: translate(-3px, -2px); } 100% { transform: translate(0, 0); } }
        
        #room-list { list-style: none; padding: 0; }
        .room-item {
            background: rgba(0,0,0,0.5); margin: 5px 0; padding: 10px;
            display: flex; justify-content: space-between; align-items: center;
            border: 1px solid var(--gold); border-radius: 8px;
        }
    </style>
</head>
<body>

<div id="game-container">
    <div id="menu">
        <h1>Tank Assassin Online</h1>
        <p>‡∏¢‡∏∏‡∏ó‡∏ò‡∏Å‡∏≤‡∏£‡∏£‡∏ñ‡∏ñ‡∏±‡∏á‡∏°‡∏´‡∏≤‡∏Å‡∏≤‡∏¨ (‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå)</p>
        <button id="btn-create-room" style="aspect-ratio:auto; padding:15px; margin-bottom:20px;">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>
        <div id="room-list"></div>
    </div>

    <div id="placement" style="display:none;">
        <h2 id="role-display">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏Å‡∏≤‡∏£</h2>
        <div id="placement-announce" aria-live="polite">‡∏ß‡∏≤‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏£‡∏ñ‡∏ñ‡∏±‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì 3 ‡∏Ñ‡∏±‡∏ô</div>
        <div id="placement-grid" class="grid"></div>
    </div>

    <div id="game" style="display:none;">
        <div id="lives-stats" style="margin-bottom:10px;"></div>
        <div id="announcement" aria-live="polite" style="font-weight:bold; color:var(--gold); margin:10px;"></div>
        
        <div id="enemy-view">
            <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÇ‡∏à‡∏°‡∏ï‡∏µ‡∏®‡∏±‡∏ï‡∏£‡∏π</p>
            <div id="enemy-grid" class="grid"></div>
        </div>
        
        <div id="my-view" style="display:none;">
            <p>‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏à‡∏°‡∏ï‡∏µ! ‡πÅ‡∏ô‡∏ß‡∏£‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:</p>
            <div id="my-grid" class="grid"></div>
        </div>
    </div>

    <div id="summary" style="display:none;">
        <h2 id="result-title">‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏ö</h2>
        <p id="result-message"></p>
        <button onclick="location.reload()" style="aspect-ratio:auto; padding:10px 20px;">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, update, onDisconnect, remove, get, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBIPeN4YUIrwM4MmFtDvT2DJ-v4toxc7tY",
        authDomain: "xo-game-134ec.firebaseapp.com",
        databaseURL: "https://xo-game-134ec-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "xo-game-134ec",
        storageBucket: "xo-game-134ec.firebasestorage.app",
        messagingSenderId: "318375224157",
        appId: "1:318375224157:web:ef720e113260d4b7b77eb4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const GAME_ID = "tank001";

    let myRole = ""; 
    let myTanks = [];
    let roomRef = null;
    let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let sounds = {};
    let bgm = null;

    // Load Sounds
    const files = ['back.mp3','select.mp3','shoot1.mp3','shoot2.mp3','t1.mp3','t2.mp3','t3.mp3','t4.mp3','f1.mp3','f2.mp3','f3.mp3','f4.mp3','a1.mp3','a2.mp3','a3.mp3','a4.mp3','s1.mp3','s2.mp3','s3.mp3','s4.mp3','win.mp3','lost.mp3','start.mp3'];
    files.forEach(f => fetch('audio/' + f).then(r => r.arrayBuffer()).then(b => audioCtx.decodeAudioData(b)).then(d => sounds[f] = d));

    function playS(f, loop = false) {
        if (!sounds[f]) return;
        const s = audioCtx.createBufferSource();
        s.buffer = sounds[f]; s.loop = loop;
        s.connect(audioCtx.destination); s.start();
        return s;
    }

    function playRndVoice(side, isHit) {
        const set = (side === 'host') ? (isHit ? ['t1','t2','t3','t4'] : ['f1','f2','f3','f4']) 
                                     : (isHit ? ['a1','a2','a3','a4'] : ['s1','s2','s3','s4']);
        playS(set[Math.floor(Math.random()*4)] + '.mp3');
    }

    // Lobby
    onValue(ref(db, `games/${GAME_ID}/rooms`), (snap) => {
        const list = document.getElementById('room-list');
        list.innerHTML = "";
        const rooms = snap.val();
        for (let id in rooms) {
            if (!rooms[id].guest && rooms[id].status === "waiting") {
                const div = document.createElement('div');
                div.className = "room-item";
                div.innerHTML = `<span>‡∏´‡πâ‡∏≠‡∏á: ${id}</span><button onclick="window.joinRoom('${id}')" style="aspect-ratio:auto; padding:5px 15px;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</button>`;
                list.appendChild(div);
            }
        }
    });

    window.createRoom = async () => {
        const countSnap = await get(ref(db, `games/${GAME_ID}/counter`));
        let num = (countSnap.val() || 0) + 1;
        if(num > 99999) num = 1;
        await set(ref(db, `games/${GAME_ID}/counter`), num);
        const roomId = "Tank" + String(num).padStart(5, '0');
        myRole = "host";
        roomRef = ref(db, `games/${GAME_ID}/rooms/${roomId}`);
        await set(roomRef, { status: "waiting", hostReady: false, guestReady: false, lastActive: serverTimestamp() });
        onDisconnect(roomRef).remove();
        initPlacement();
    };

    window.joinRoom = async (id) => {
        myRole = "guest";
        roomRef = ref(db, `games/${GAME_ID}/rooms/${id}`);
        await update(roomRef, { guest: "joined", guestReady: false, lastActive: serverTimestamp() });
        onDisconnect(roomRef).remove();
        initPlacement();
    };

    function initPlacement() {
        if (!bgm) bgm = playS('back.mp3', true);
        document.getElementById('menu').style.display = 'none';
        document.getElementById('placement').style.display = 'block';
        document.getElementById('role-display').textContent = "‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠: " + (myRole === 'host' ? "Host" : "Guest");
        
        const grid = document.getElementById('placement-grid');
        grid.innerHTML = "";
        for (let i = 1; i <= 16; i++) {
            const btn = document.createElement('button');
            btn.textContent = i;
            btn.setAttribute('aria-label', i);
            btn.onclick = () => {
                if (myTanks.length < 3 && !myTanks.includes(i)) {
                    myTanks.push(i);
                    btn.disabled = true;
                    btn.innerHTML = "üöú";
                    btn.setAttribute('aria-label', i + " ‡∏ß‡∏≤‡∏á‡∏£‡∏ñ‡∏ñ‡∏±‡∏á‡πÅ‡∏•‡πâ‡∏ß");
                    playS('select.mp3');
                    if (myTanks.length === 3) submitPlacement();
                }
            };
            grid.appendChild(btn);
        }
    }

    async function submitPlacement() {
        document.getElementById('placement-announce').textContent = "‡∏ß‡∏≤‡∏á‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡∏ù‡πà‡∏≤‡∏¢‡∏ï‡∏£‡∏á‡∏Ç‡πâ‡∏≤‡∏°...";
        const updateData = {};
        updateData[`${myRole}Tanks`] = myTanks;
        updateData[`${myRole}Ready`] = true;
        await update(roomRef, updateData);
        listenForStart();
    }

    function listenForStart() {
        onValue(roomRef, (snap) => {
            const data = snap.val();
            if (!data) return;
            
            if (myRole === 'host' && data.guestReady && data.hostReady && data.status === "waiting") {
                update(roomRef, { 
                    status: "playing", 
                    turn: Math.random() > 0.5 ? "host" : "guest",
                    h_lives: 3, g_lives: 3
                });
            }

            if (data.status === "playing") {
                renderGame(data);
            } else if (data.status === "finished") {
                showResult(data);
            }
        });
    }

    function renderGame(data) {
        document.getElementById('placement').style.display = 'none';
        document.getElementById('game').style.display = 'block';
        
        const isMyTurn = data.turn === myRole;
        document.getElementById('announcement').textContent = isMyTurn ? "‡∏ï‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß! ‡∏¢‡∏¥‡∏á‡πÄ‡∏•‡∏¢" : "‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πá‡∏á‡πÄ‡∏õ‡πâ‡∏≤...";
        document.body.style.backgroundColor = isMyTurn ? "var(--enemy-zone)" : "var(--player-zone)";
        
        // ‡∏™‡∏•‡∏±‡∏ö View
        document.getElementById('enemy-view').style.display = isMyTurn ? 'block' : 'none';
        document.getElementById('my-view').style.display = isMyTurn ? 'none' : 'block';

        // ‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        drawEnemyGrid(data);
        drawMyGrid(data);

        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢‡∏á Action ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        if (data.lastShot && data.lastShot.id !== window.lastProcessedShot) {
            window.lastProcessedShot = data.lastShot.id;
            handleShotEffect(data.lastShot, data);
        }
    }

    function drawEnemyGrid(data) {
        const grid = document.getElementById('enemy-grid');
        grid.innerHTML = "";
        const shots = data.shots || {};
        const enemyTanks = (myRole === 'host') ? data.guestTanks : data.hostTanks;

        for (let i = 1; i <= 16; i++) {
            const btn = document.createElement('button');
            btn.textContent = i;
            btn.setAttribute('aria-label', "‡∏¢‡∏¥‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà " + i);
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏¢‡∏¥‡∏á‡πÑ‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
            const shotInfo = Object.values(shots).find(s => s.pos === i && s.by === myRole);
            if (shotInfo) {
                btn.disabled = true;
                const hit = enemyTanks.includes(i);
                btn.classList.add(hit ? 'hit-bg' : 'miss-bg');
                btn.innerHTML = hit ? "üí•" : "üï≥Ô∏è";
                btn.setAttribute('aria-label', "‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà " + i + (hit ? " ‡∏£‡∏ñ‡∏ñ‡∏±‡∏á‡∏û‡∏±‡∏á" : " ‡∏û‡∏•‡∏≤‡∏î"));
            } else {
                btn.onclick = () => { if(data.turn === myRole) performShot(i); };
            }
            grid.appendChild(btn);
        }
    }

    function drawMyGrid(data) {
        const grid = document.getElementById('my-grid');
        grid.innerHTML = "";
        const shots = data.shots || {};

        for (let i = 1; i <= 16; i++) {
            const btn = document.createElement('button');
            if (myTanks.includes(i)) btn.innerHTML = "üöú";
            const enemyShot = Object.values(shots).find(s => s.pos === i && s.by !== myRole);
            if (enemyShot) {
                const hit = myTanks.includes(i);
                btn.classList.add(hit ? 'hit-bg' : 'miss-bg');
                btn.innerHTML = hit ? "üí•" : "üï≥Ô∏è";
            }
            btn.disabled = true;
            grid.appendChild(btn);
        }
    }

    async function performShot(pos) {
        const shotId = Date.now();
        await update(roomRef, { 
            lastShot: { id: shotId, by: myRole, pos: pos },
            lastActive: serverTimestamp() 
        });
    }

    function handleShotEffect(shot, data) {
        const targetTanks = (shot.by === 'host') ? data.guestTanks : data.hostTanks;
        const isHit = targetTanks.includes(shot.pos);
        
        playS(isHit ? 'shoot2.mp3' : 'shoot1.mp3');
        document.getElementById('game-container').classList.add('shake-effect');
        
        setTimeout(() => {
            document.getElementById('game-container').classList.remove('shake-effect');
            playRndVoice(shot.by, isHit);
            
            if (myRole === 'host') {
                const newShotRef = push(ref(db, `games/${GAME_ID}/rooms/${data.id}/shots`));
                const updates = {
                    [`shots/${newShotRef.key}`]: { by: shot.by, pos: shot.pos },
                    turn: shot.by === 'host' ? 'guest' : 'host',
                    lastShot: null
                };
                if (isHit) {
                    const victimKey = shot.by === 'host' ? 'g_lives' : 'h_lives';
                    updates[victimKey] = data[victimKey] - 1;
                    if (updates[victimKey] <= 0) updates.status = "finished";
                }
                update(roomRef, updates);
            }
        }, 800);
    }

    function showResult(data) {
        if (bgm) bgm.stop();
        const hostWon = data.h_lives > 0;
        const iWon = (myRole === 'host' && hostWon) || (myRole === 'guest' && !hostWon);
        
        document.getElementById('game').style.display = 'none';
        document.getElementById('summary').style.display = 'block';
        document.getElementById('result-message').textContent = iWon ? "‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞‡πÉ‡∏ô‡∏™‡∏°‡∏£‡∏†‡∏π‡∏°‡∏¥‡∏ô‡∏µ‡πâ!" : "‡∏ê‡∏≤‡∏ô‡∏ó‡∏±‡∏û‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß...";
        playS(iWon ? 'win.mp3' : 'lost.mp3');
    }

    document.getElementById('btn-create-room').onclick = window.createRoom;

</script>
</body>
</html>