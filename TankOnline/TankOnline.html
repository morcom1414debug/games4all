<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tank Assassin Online</title>
    <style>
        :root {
            --base-green: #4b5320;
            --player-zone: #2e3d2e;
            --enemy-zone: #600000;
            --gold: #ffd700;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: var(--player-zone);
            color: #fff;
            text-align: center;
            margin: 0;
            padding: 10px;
            overflow-x: hidden;
            transition: background-color 0.5s ease;
        }

        #game-container {
            max-width: 600px;
            width: 100%;
            margin: auto;
            position: relative;
            background-color: var(--base-green);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
            box-sizing: border-box;
            min-height: 600px;
        }

        .smoke-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.08), transparent);
            pointer-events: none;
            animation: drift 8s infinite alternate ease-in-out;
            z-index: 2;
        }

        @keyframes drift { from { transform: scale(1) translateX(-5%); } to { transform: scale(1.2) translateX(5%); } }
        @keyframes shake { 0% { transform: translate(1px, 1px); } 50% { transform: translate(-3px, -2px); } 100% { transform: translate(0, 0); } }
        .shake-effect { animation: shake 0.4s; }

        .grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;
            max-width: 400px; margin: 15px auto; border: 3px solid var(--gold);
            padding: 10px; background-color: rgba(0,0,0,0.3); border-radius: 12px;
        }

        button {
            padding: 10px; font-size: 16px; background-color: #6b8e23; color: #fff;
            border: 2px solid var(--gold); cursor: pointer; border-radius: 8px;
            transition: all 0.2s;
        }

        .grid button { aspect-ratio: 1/1; font-weight: bold; }
        button:focus { outline: 3px solid white; box-shadow: 0 0 15px var(--gold); }
        button:disabled { opacity: 0.6; cursor: not-allowed; }

        .hit-bg { background-color: #ff4500 !important; }
        .miss-bg { background-color: #444 !important; }
        
        #room-list { margin-top: 20px; text-align: left; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; }
        .room-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #555; }
        
        #status-area { font-size: 1.2rem; color: var(--gold); margin: 10px 0; font-weight: bold; min-height: 1.5em; }
        .turn-indicator { padding: 5px 10px; border-radius: 5px; margin-bottom: 10px; display: inline-block; }
    </style>
</head>
<body>

<div id="game-container">
    <div class="smoke-overlay"></div>

    <div id="menu">
        <div style="font-size: 60px;">üöúüåê</div>
        <h1>Tank Assassin Online</h1>
        <p>‡∏¢‡∏∏‡∏ó‡∏ò‡∏Å‡∏≤‡∏£‡∏£‡∏ñ‡∏ñ‡∏±‡∏á‡∏°‡∏´‡∏≤‡∏Å‡∏≤‡∏¨ (‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå)<br>‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏±‡∏ô‡∏¢‡∏¥‡∏á ‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏ô‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÇ‡∏•‡∏Å</p>
        <button id="create-room" style="font-size: 1.2rem; padding: 15px 30px;">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>
        
        <div id="room-list-container">
            <h3>‡∏™‡∏°‡∏£‡∏†‡∏π‡∏°‡∏¥‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà</h3>
            <div id="room-list">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏°‡∏£‡∏†‡∏π‡∏°‡∏¥...</div>
        </div>
    </div>

    <div id="placement" style="display: none;">
        <h2>‡∏ß‡∏≤‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏£‡∏ñ‡∏ñ‡∏±‡∏á 3 ‡∏Ñ‡∏±‡∏ô (‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠: <span id="player-role-display"></span>)</h2>
        <div id="placement-announce" aria-live="polite">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∏‡∏î‡∏¢‡∏∏‡∏ó‡∏ò‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏Ñ‡∏±‡∏ô‡∏ó‡∏µ‡πà 1</div>
        <div id="placement-grid" class="grid"></div>
    </div>

    <div id="battle" style="display: none;">
        <div id="status-area" aria-live="assertive"></div>
        <div id="lives-display" style="display: flex; justify-content: space-around; background: rgba(0,0,0,0.4); padding: 10px;">
            <span>Host: <span id="hp-host">3</span></span>
            <span>Guest: <span id="hp-guest">3</span></span>
        </div>
        
        <div id="battle-grids">
            <h3 id="grid-label">‡∏ï‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏¥‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏®‡∏±‡∏ï‡∏£‡∏π</h3>
            <div id="enemy-view" class="grid"></div>
            <p>‡∏ê‡∏≤‡∏ô‡∏ó‡∏±‡∏û‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏ù‡∏±‡πà‡∏á‡∏ï‡∏£‡∏á‡∏Ç‡πâ‡∏≤‡∏°‡∏°‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô)</p>
            <div id="my-view" class="grid"></div>
        </div>
    </div>

    <div id="summary" style="display: none;">
        <h2 id="result-title">‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏ö</h2>
        <p id="result-desc"></p>
        <button onclick="location.reload()">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, push, update, onDisconnect, runTransaction, get, remove } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBIPeN4YUIrwM4MmFtDvT2DJ-v4toxc7tY",
        authDomain: "xo-game-134ec.firebaseapp.com",
        databaseURL: "https://xo-game-134ec-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "xo-game-134ec",
        storageBucket: "xo-game-134ec.firebasestorage.app",
        messagingSenderId: "318375224157",
        appId: "1:318375224157:web:ef720e113260d4b7b77eb4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const GAME_ID = "tank001";
    const roomsRef = ref(db, `games/${GAME_ID}/rooms`);

    // Audio Context & Assets
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const sounds = {};
    const loadSounds = () => {
        ['select.mp3','shoot1.mp3','shoot2.mp3','t1.mp3','t2.mp3','t3.mp3','t4.mp3','f1.mp3','f2.mp3','f3.mp3','f4.mp3','a1.mp3','a2.mp3','a3.mp3','a4.mp3','s1.mp3','s2.mp3','s3.mp3','s4.mp3','win.mp3','lost.mp3','start.mp3','back.mp3']
        .forEach(f => {
            fetch('audio/' + f).then(r => r.arrayBuffer()).then(b => audioCtx.decodeAudioData(b)).then(d => sounds[f] = d);
        });
    };

    const playS = (f, loop = false) => {
        if (!sounds[f]) return null;
        const s = audioCtx.createBufferSource();
        s.buffer = sounds[f]; s.loop = loop;
        s.connect(audioCtx.destination); s.start();
        return s;
    };

    const playVoice = (type) => {
        const map = { 
            'hit_atk': ['t1','t2','t3','t4'], 
            'miss_atk': ['f1','f2','f3','f4'],
            'hit_def': ['a1','a2','a3','a4'],
            'miss_def': ['s1','s2','s3','s4']
        };
        const rnd = map[type][Math.floor(Math.random()*4)] + '.mp3';
        playS(rnd);
    };

    // Game Variables
    let currentRoomId = null;
    let myRole = null; // 'Host' or 'Guest'
    let myTanks = [];
    let isGameOver = false;

    // UI Logic
    const showScreen = (id) => {
        ['menu','placement','battle','summary'].forEach(s => document.getElementById(s).style.display = (s===id?'block':'none'));
    };

    // 1. Room Management
    onValue(roomsRef, (snapshot) => {
        const rooms = snapshot.val();
        const listDiv = document.getElementById('room-list');
        listDiv.innerHTML = '';
        
        if (!rooms) {
            listDiv.innerHTML = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ';
            return;
        }

        Object.keys(rooms).forEach(id => {
            const room = rooms[id];
            const pCount = room.guest ? 2 : 1;
            const item = document.createElement('div');
            item.className = 'room-item';
            item.innerHTML = `
                <span>${room.name} (${pCount}/2)</span>
                ${pCount < 2 ? `<button onclick="window.joinRoom('${id}')">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</button>` : '<span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏ö...</span>'}
            `;
            listDiv.appendChild(item);
        });
    });

    document.getElementById('create-room').onclick = async () => {
        const snapshot = await get(roomsRef);
        const count = snapshot.exists() ? Object.keys(snapshot.val()).length : 0;
        const roomName = "Tank" + String((count % 99999) + 1).padStart(5, '0');
        
        const newRoomRef = push(roomsRef);
        currentRoomId = newRoomRef.key;
        myRole = 'Host';
        
        await set(newRoomRef, {
            name: roomName,
            host: { status: 'waiting' },
            currentTurn: '',
            lastAction: Date.now()
        });

        onDisconnect(newRoomRef).remove();
        initPlacement();
    };

    window.joinRoom = async (id) => {
        currentRoomId = id;
        myRole = 'Guest';
        const roomRef = ref(db, `games/${GAME_ID}/rooms/${id}`);
        
        await update(roomRef, {
            guest: { status: 'waiting' },
            lastAction: Date.now()
        });

        onDisconnect(roomRef).remove();
        initPlacement();
    };

    // 2. Placement
    function initPlacement() {
        showScreen('placement');
        document.getElementById('player-role-display').textContent = myRole;
        const grid = document.getElementById('placement-grid');
        grid.innerHTML = '';
        myTanks = [];

        for (let i = 1; i <= 16; i++) {
            const btn = document.createElement('button');
            btn.textContent = i;
            btn.onclick = () => {
                if (myTanks.length < 3 && !myTanks.includes(i)) {
                    myTanks.push(i);
                    btn.disabled = true;
                    btn.innerHTML = 'üöú';
                    playS('select.mp3');
                    const remain = 3 - myTanks.length;
                    document.getElementById('placement-announce').textContent = remain > 0 ? `‡∏ß‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡πà‡∏≠‡∏≠‡∏µ‡∏Å ${remain} ‡∏Ñ‡∏±‡∏ô` : "‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß! ‡∏£‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏¢‡∏∏‡∏ó‡∏ò‡∏Å‡∏≤‡∏£...";
                    
                    if (myTanks.length === 3) submitTanks();
                }
            };
            grid.appendChild(btn);
        }
    }

    async function submitTanks() {
        const roomRef = ref(db, `games/${GAME_ID}/rooms/${currentRoomId}`);
        const roleKey = myRole.toLowerCase();
        
        await update(ref(db, `games/${GAME_ID}/rooms/${currentRoomId}/${roleKey}`), {
            status: 'ready',
            tanks: myTanks,
            hp: 3
        });

        listenForGameStart();
    }

    // 3. Battle Logic
    function listenForGameStart() {
        const roomRef = ref(db, `games/${GAME_ID}/rooms/${currentRoomId}`);
        onValue(roomRef, (snapshot) => {
            const data = snapshot.val();
            if (!data) return;

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏à‡∏≤‡∏Å Idle (10 ‡∏ô‡∏≤‡∏ó‡∏µ)
            if (Date.now() - data.lastAction > 600000) {
                remove(roomRef);
                location.reload();
            }

            if (data.host?.status === 'ready' && data.guest?.status === 'ready') {
                if (!data.currentTurn) {
                    if (myRole === 'Host') {
                        update(roomRef, { 
                            currentTurn: Math.random() > 0.5 ? 'Host' : 'Guest',
                            lastAction: Date.now()
                        });
                    }
                } else {
                    startBattle(data);
                }
            } else if (myRole === 'Host' && data.guest) {
                document.getElementById('placement-announce').textContent = "‡∏®‡∏±‡∏ï‡∏£‡∏π‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏™‡∏°‡∏£‡∏†‡∏π‡∏°‡∏¥‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£...";
            }
        });
    }

    function startBattle(data) {
        showScreen('battle');
        const isMyTurn = data.currentTurn === myRole;
        const statusArea = document.getElementById('status-area');
        
        document.body.style.backgroundColor = isMyTurn ? 'var(--enemy-zone)' : 'var(--player-zone)';
        statusArea.textContent = isMyTurn ? "‡∏ï‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß! ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏¢‡∏¥‡∏á" : "‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î...";
        
        document.getElementById('hp-host').textContent = data.host.hp;
        document.getElementById('hp-guest').textContent = data.guest.hp;

        renderGrids(data);

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÉ‡∏Ñ‡∏£‡πÅ‡∏û‡πâ‡∏ä‡∏ô‡∏∞
        if (data.host.hp <= 0 || data.guest.hp <= 0) {
            endGame(data);
        }
    }

    function renderGrids(data) {
        const enemyView = document.getElementById('enemy-view');
        const myView = document.getElementById('my-view');
        const enemyRole = myRole === 'Host' ? 'guest' : 'host';
        const myData = myRole === 'Host' ? data.host : data.guest;
        const enemyData = data[enemyRole];

        enemyView.innerHTML = '';
        myView.innerHTML = '';

        for (let i = 1; i <= 16; i++) {
            // Grid ‡∏®‡∏±‡∏ï‡∏£‡∏π (‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏¢‡∏¥‡∏á)
            const eBtn = document.createElement('button');
            eBtn.textContent = i;
            eBtn.disabled = (data.currentTurn !== myRole);
            
            const shot = enemyData.shots?.[i];
            if (shot) {
                eBtn.disabled = true;
                eBtn.classList.add(shot === 'hit' ? 'hit-bg' : 'miss-bg');
                eBtn.innerHTML = shot === 'hit' ? 'üí•' : 'üï≥Ô∏è';
            }
            
            eBtn.onclick = () => handleShoot(i);
            enemyView.appendChild(eBtn);

            // Grid ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤ (‡∏ó‡∏µ‡πà‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏¢‡∏¥‡∏á‡∏°‡∏≤)
            const mBtn = document.createElement('button');
            if (myTanks.includes(i)) mBtn.innerHTML = 'üöú';
            const myShot = myData.shots?.[i];
            if (myShot) {
                mBtn.classList.add(myShot === 'hit' ? 'hit-bg' : 'miss-bg');
                mBtn.innerHTML = myShot === 'hit' ? 'üí•' : 'üï≥Ô∏è';
            }
            myView.appendChild(mBtn);
        }
    }

    async function handleShoot(pos) {
        const roomRef = ref(db, `games/${GAME_ID}/rooms/${currentRoomId}`);
        const enemyRole = myRole === 'Host' ? 'guest' : 'host';
        
        // Shake Effect
        document.getElementById('game-container').classList.add('shake-effect');
        setTimeout(() => document.getElementById('game-container').classList.remove('shake-effect'), 400);

        await runTransaction(roomRef, (currentData) => {
            if (currentData && currentData.currentTurn === myRole) {
                const isHit = currentData[enemyRole].tanks.includes(pos);
                
                if (!currentData[enemyRole].shots) currentData[enemyRole].shots = {};
                currentData[enemyRole].shots[pos] = isHit ? 'hit' : 'miss';
                
                if (isHit) currentData[enemyRole].hp -= 1;
                
                // ‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô
                currentData.currentTurn = enemyRole.charAt(0).toUpperCase() + enemyRole.slice(1);
                currentData.lastAction = Date.now();

                // Sound Logic (‡∏ù‡∏±‡πà‡∏á‡∏Ñ‡∏ô‡∏¢‡∏¥‡∏á)
                playS(isHit ? 'shoot2.mp3' : 'shoot1.mp3');
                setTimeout(() => playVoice(isHit ? 'hit_atk' : 'miss_atk'), 600);
            }
            return currentData;
        });
    }

    // 4. End Game
    function endGame(data) {
        if (isGameOver) return;
        isGameOver = true;
        showScreen('summary');
        
        const winner = data.host.hp > 0 ? 'Host' : 'Guest';
        const amIWinner = winner === myRole;
        
        document.getElementById('result-title').textContent = amIWinner ? "‡∏ä‡∏±‡∏¢‡∏ä‡∏ô‡∏∞!" : "‡∏û‡πà‡∏≤‡∏¢‡πÅ‡∏û‡πâ...";
        document.getElementById('result-desc').textContent = amIWinner ? 
            "‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡∏Å‡∏≠‡∏á‡∏ó‡∏±‡∏û‡∏®‡∏±‡∏ï‡∏£‡∏π‡πÑ‡∏î‡πâ‡∏£‡∏≤‡∏ö‡∏Ñ‡∏≤‡∏ö!" : "‡∏ê‡∏≤‡∏ô‡∏ó‡∏±‡∏û‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏•‡πà‡∏°‡∏™‡∏•‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß...";
        
        playS(amIWinner ? 'win.mp3' : 'lost.mp3');
        
        // ‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á‡∏à‡∏ö‡πÄ‡∏Å‡∏° 1 ‡∏ô‡∏≤‡∏ó‡∏µ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡πâ‡∏≤‡∏á
        setTimeout(() => {
            remove(ref(db, `games/${GAME_ID}/rooms/${currentRoomId}`));
        }, 60000);
    }

    window.onload = () => {
        loadSounds();
        // Trigger Audio Context on first click
        document.body.addEventListener('click', () => {
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }, { once: true });
    };

</script>
</body>
</html>