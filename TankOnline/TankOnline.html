<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tank Assassin Online</title>
    <style>
        :root {
            --base-green: #4b5320;
            --player-zone: #2e3d2e;
            --enemy-zone: #600000;
            --gold: #ffd700;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: var(--player-zone);
            color: #fff;
            text-align: center;
            margin: 0;
            padding: 10px;
            overflow-x: hidden;
            transition: background-color 0.5s ease;
        }

        #game-container {
            max-width: 600px;
            width: 100%;
            margin: auto;
            position: relative;
            background-color: var(--base-green);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
            box-sizing: border-box;
            min-height: 600px;
        }

        /* ‡∏Ñ‡∏ß‡∏±‡∏ô‡∏à‡∏≤‡∏á‡πÜ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏® */
        .smoke-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.05), transparent);
            pointer-events: none;
            z-index: 2;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            max-width: 400px;
            margin: 20px auto;
            border: 4px solid var(--gold);
            padding: 15px;
            background-color: rgba(0,0,0,0.4);
            border-radius: 12px;
            position: relative;
            z-index: 3;
        }

        button {
            padding: 12px; font-size: 18px;
            background-color: #6b8e23; color: #fff;
            border: 2px solid var(--gold);
            cursor: pointer; border-radius: 8px;
            transition: all 0.2s;
        }

        button:focus {
            box-shadow: 0 0 20px #fff;
            outline: 4px solid white;
        }

        button:disabled { opacity: 0.8; cursor: default; }

        .hit-bg { background-color: #ff4500 !important; animation: blink 0.5s infinite; }
        .miss-bg { background-color: #333 !important; }
        
        @keyframes blink { 50% { opacity: 0.7; } }
        @keyframes shake {
            0% { transform: translate(2px, 2px); }
            50% { transform: translate(-4px, -3px); }
            100% { transform: translate(0, 0); }
        }
        .shake-effect { animation: shake 0.3s; }

        #room-list { list-style: none; padding: 0; }
        .room-item {
            background: rgba(255,255,255,0.1); margin: 8px 0;
            padding: 12px; border-radius: 8px;
            display: flex; justify-content: space-between; align-items: center;
        }
    </style>
</head>
<body>

<div id="game-container">
    <div class="smoke-overlay"></div>

    <div id="menu-screen">
        <h1 tabindex="0">Tank Assassin ONLINE</h1>
        <p>‡∏™‡∏°‡∏£‡∏†‡∏π‡∏°‡∏¥‡∏£‡∏ñ‡∏ñ‡∏±‡∏á‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå)<br>‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏ö‡∏ö‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏±‡∏ô‡∏¢‡∏¥‡∏á‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏£‡∏¥‡∏á</p>
        <button id="btn-create-room" style="font-size: 24px; padding: 20px;">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</button>
        <hr style="margin:20px 0; border: 0; border-top: 1px dashed var(--gold);">
        <h3>‡∏´‡πâ‡∏≠‡∏á‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏π‡πà</h3>
        <ul id="room-list"></ul>
    </div>

    <div id="placement-screen" style="display: none;">
        <h2 id="placement-title">‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£‡∏£‡∏ö</h2>
        <div id="placement-announce" aria-live="assertive" style="font-size: 20px; color: var(--gold); margin: 10px;"></div>
        <div id="placement-grid" class="grid"></div>
    </div>

    <div id="battle-screen" style="display: none;">
        <div id="lives-info" style="display: flex; justify-content: space-around; font-weight: bold; font-size: 20px; background: rgba(0,0,0,0.5); padding: 10px;">
            <span id="label-host">Host: 3</span>
            <span id="label-guest">Guest: 3</span>
        </div>
        
        <div id="battle-announce" aria-live="assertive" style="font-size: 22px; margin: 15px; min-height: 1.5em; color: var(--gold);"></div>

        <div id="grid-wrapper">
            <div id="defend-view" style="display: none;">
                <p>‡∏ê‡∏≤‡∏ô‡∏ó‡∏±‡∏û‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏±‡∏ö)</p>
                <div id="my-grid" class="grid"></div>
            </div>
            <div id="attack-view" style="display: none;">
                <p>‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏®‡∏±‡∏ï‡∏£‡∏π (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏¥‡∏á)</p>
                <div id="target-grid" class="grid"></div>
            </div>
        </div>
    </div>

    <div id="summary-screen" style="display: none;">
        <h2 id="final-result">‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏ö</h2>
        <p id="final-msg" style="font-size: 24px;"></p>
        <button onclick="location.reload()" style="padding: 20px 40px;">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, onDisconnect, remove, runTransaction } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.app/https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyBIPeN4YUIrwM4MmFtDvT2DJ-v4toxc7tY",
        authDomain: "xo-game-134ec.firebaseapp.com",
        databaseURL: "https://xo-game-134ec-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "xo-game-134ec",
        storageBucket: "xo-game-134ec.firebasestorage.app",
        messagingSenderId: "318375224157",
        appId: "1:318375224157:web:ef720e113260d4b7b77eb4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const GAME_ID = "tank001";

    // --- ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á (Audio Logic) ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const soundBank = {};
    let bgm;

    async function loadAllSounds() {
        const files = ['back.mp3','back1.mp3','select.mp3','shoot1.mp3','shoot2.mp3','t1.mp3','t2.mp3','t3.mp3','t4.mp3','f1.mp3','f2.mp3','f3.mp3','f4.mp3','a1.mp3','a2.mp3','a3.mp3','a4.mp3','s1.mp3','s2.mp3','s3.mp3','s4.mp3','win.mp3','lost.mp3','start.mp3','start1.mp3'];
        for (let f of files) {
            try {
                const res = await fetch('audio/' + f);
                const arrayBuf = await res.arrayBuffer();
                soundBank[f] = await audioCtx.decodeAudioData(arrayBuf);
            } catch (e) { console.log("Sound error: " + f); }
        }
    }

    function playS(f, loop = false) {
        if (!soundBank[f]) return null;
        const src = audioCtx.createBufferSource();
        src.buffer = soundBank[f];
        src.loop = loop;
        src.connect(audioCtx.destination);
        src.start();
        return src;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡∏•‡∏∞‡∏ï‡∏±‡∏ß (Sequence)
    function playAsync(f) {
        return new Promise(resolve => {
            const s = playS(f);
            if (!s) resolve();
            else s.onended = resolve;
        });
    }

    // --- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Å‡∏° ---
    let myRole = ""; 
    let myRoom = "";
    let myTanks = [];
    let isBusy = false; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏£‡∏±‡∏ß

    // --- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á (Lobby) ---
    onValue(ref(db, `${GAME_ID}/rooms`), (snap) => {
        const list = document.getElementById('room-list');
        list.innerHTML = "";
        const rooms = snap.val();
        for (let id in rooms) {
            const r = rooms[id];
            if (!r.guestJoined) {
                const li = document.createElement('li');
                li.className = "room-item";
                li.innerHTML = `<span>‡∏´‡πâ‡∏≠‡∏á: ${id}</span><button onclick="window.joinRoom('${id}')">‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°</button>`;
                list.appendChild(li);
            }
        }
    });

    window.joinRoom = async (id) => {
        myRole = "guest";
        myRoom = id;
        await update(ref(db, `${GAME_ID}/rooms/${id}`), { guestJoined: true, lastAction: Date.now() });
        onDisconnect(ref(db, `${GAME_ID}/rooms/${id}`)).remove();
        startPlacement();
    };

    document.getElementById('btn-create-room').onclick = async () => {
        const counter = await runTransaction(ref(db, `${GAME_ID}/roomCounter`), (c) => (c || 0) + 1);
        const roomId = "Tank" + String(counter.snapshot.val()).padStart(5, '0');
        myRoom = roomId;
        myRole = "host";
        await set(ref(db, `${GAME_ID}/rooms/${roomId}`), {
            status: "waiting", hostLives: 3, guestLives: 3, lastAction: Date.now()
        });
        onDisconnect(ref(db, `${GAME_ID}/rooms/${roomId}`)).remove();
        startPlacement();
    };

    // --- ‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á‡∏£‡∏ñ‡∏ñ‡∏±‡∏á ---
    function startPlacement() {
        document.getElementById('menu-screen').style.display = 'none';
        document.getElementById('placement-screen').style.display = 'block';
        document.getElementById('placement-title').textContent = `‡∏™‡∏°‡∏£‡∏†‡∏π‡∏°‡∏¥‡∏Ç‡∏≠‡∏á‡∏ù‡πà‡∏≤‡∏¢ ${myRole.toUpperCase()}`;
        bgm = playS('back.mp3', true);
        
        const grid = document.getElementById('placement-grid');
        const ann = document.getElementById('placement-announce');
        ann.textContent = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏£‡∏ñ‡∏ñ‡∏±‡∏á‡∏Ñ‡∏±‡∏ô‡πÅ‡∏£‡∏Å";
        grid.innerHTML = "";
        
        for (let i = 1; i <= 16; i++) {
            const b = document.createElement('button');
            b.textContent = i;
            b.onclick = () => {
                if (myTanks.length < 3 && !b.disabled) {
                    myTanks.push(i);
                    b.disabled = true;
                    b.innerHTML = "üöú";
                    playS('select.mp3');
                    if (myTanks.length < 3) ann.textContent = `‡∏ß‡∏≤‡∏á‡∏Ñ‡∏±‡∏ô‡∏ó‡∏µ‡πà ${myTanks.length} ‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡πà‡∏≠‡∏≠‡∏µ‡∏Å ${3-myTanks.length} ‡∏Ñ‡∏±‡∏ô`;
                    else { ann.textContent = "‡∏ß‡∏≤‡∏á‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏Ñ‡∏π‡πà‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ..."; confirmPlacement(); }
                }
            };
            grid.appendChild(b);
        }
    }

    async function confirmPlacement() {
        const up = {};
        up[`${myRole}Tanks`] = myTanks;
        up[`${myRole}Ready`] = true;
        await update(ref(db, `${GAME_ID}/rooms/${myRoom}`), up);
        watchGameStatus();
    }

    // --- ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô (Gameplay Logic) ---
    function watchGameStatus() {
        onValue(ref(db, `${GAME_ID}/rooms/${myRoom}`), async (snap) => {
            const data = snap.val();
            if (!data) return;

            // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° (‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á Start ‡∏Å‡πà‡∏≠‡∏ô)
            if (data.hostReady && data.guestReady && data.status === "waiting") {
                if (myRole === "host") {
                    const startF = Math.random() > 0.5 ? 'start.mp3' : 'start1.mp3';
                    update(ref(db, `${GAME_ID}/rooms/${myRoom}`), { status: "playing", startSound: startF, turn: (Math.random() > 0.5 ? "host" : "guest") });
                }
            }

            if (data.status === "playing") {
                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô
                if (data.startSound) {
                    const sound = data.startSound;
                    await update(ref(db, `${GAME_ID}/rooms/${myRoom}`), { startSound: null }); // ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
                    await playAsync(sound);
                }
                
                // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏¥‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                if (data.lastShot && data.lastShot.processed !== true) {
                    await handleShotEffect(data.lastShot);
                    if (myRole === "host") update(ref(db, `${GAME_ID}/rooms/${myRoom}/lastShot`), { processed: true });
                }

                renderBattle(data);
            }
        });
    }

    async function handleShotEffect(shot) {
        isBusy = true;
        const ann = document.getElementById('battle-announce');
        const isMeAttacker = (shot.by === myRole);
        
        document.getElementById('game-container').classList.add('shake-effect');
        
        // ‡∏Å‡∏é‡∏Ç‡πâ‡∏≠ 1: ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏¢‡∏¥‡∏á‡πÉ‡∏´‡πâ‡∏à‡∏ö‡∏Å‡πà‡∏≠‡∏ô
        await playAsync(shot.isHit ? 'shoot2.mp3' : 'shoot1.mp3');
        document.getElementById('game-container').classList.remove('shake-effect');

        // ‡∏Å‡∏é‡∏Ç‡πâ‡∏≠ 4: ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® Aria Live ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏¢‡∏¥‡∏á
        if (isMeAttacker) {
            ann.textContent = `‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà ${shot.pos}: ${shot.isHit ? '‡∏¢‡∏¥‡∏á‡πÇ‡∏î‡∏ô! ‡∏£‡∏ñ‡∏ñ‡∏±‡∏á‡∏®‡∏±‡∏ï‡∏£‡∏π‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏´‡∏ô‡∏±‡∏Å' : '‡∏¢‡∏¥‡∏á‡∏û‡∏•‡∏≤‡∏î‡πÑ‡∏õ‡∏ô‡∏¥‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß'}`;
        } else {
            ann.textContent = `‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏¢‡∏¥‡∏á‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏Å‡∏±‡∏î ${shot.pos}: ${shot.isHit ? '‡∏ê‡∏≤‡∏ô‡∏ó‡∏±‡∏û‡πÄ‡∏£‡∏≤‡∏ñ‡∏π‡∏Å‡πÇ‡∏à‡∏°‡∏ï‡∏µ!' : '‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏¢‡∏¥‡∏á‡πÑ‡∏°‡πà‡πÇ‡∏î‡∏ô‡πÄ‡∏£‡∏≤'}`;
        }

        // ‡∏Å‡∏é‡∏Ç‡πâ‡∏≠ 2: ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ä‡∏∏‡∏î‡∏ï‡∏≠‡∏ö‡πÇ‡∏ï‡πâ (t/f ‡∏´‡∏£‡∏∑‡∏≠ a/s) ‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏¢‡∏¥‡∏á
        const rnd = Math.floor(Math.random()*4) + 1;
        let followSound = "";
        if (isMeAttacker) followSound = shot.isHit ? `t${rnd}.mp3` : `f${rnd}.mp3`;
        else followSound = shot.isHit ? `a${rnd}.mp3` : `s${rnd}.mp3`;
        
        await playAsync(followSound);
        isBusy = false;
    }

    function renderBattle(data) {
        const isMyTurn = (data.turn === myRole);
        const ann = document.getElementById('battle-announce');
        
        document.getElementById('placement-screen').style.display = 'none';
        document.getElementById('battle-screen').style.display = 'block';

        // ‡∏Å‡∏é‡∏Ç‡πâ‡∏≠ 2: ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡∏¢‡∏¥‡∏á-‡∏£‡∏±‡∏ö ‡∏ï‡∏≤‡∏°‡∏ï‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
        document.getElementById('attack-view').style.display = isMyTurn ? 'block' : 'none';
        document.getElementById('defend-view').style.display = isMyTurn ? 'none' : 'block';
        document.body.style.backgroundColor = isMyTurn ? 'var(--enemy-zone)' : 'var(--player-zone)';

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Aria Live ‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤
        if (!isBusy) {
            ann.textContent = isMyTurn ? "‡∏ï‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏¢‡∏¥‡∏á‡∏®‡∏±‡∏ï‡∏£‡∏π" : "‡∏ï‡∏≤‡∏Ç‡∏≠‡∏á‡∏®‡∏±‡∏ï‡∏£‡∏π... ‡πÇ‡∏õ‡∏£‡∏î‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏à‡∏°‡∏ï‡∏µ";
        }

        document.getElementById('label-host').textContent = `Host: ${data.hostLives}`;
        document.getElementById('label-guest').textContent = `Guest: ${data.guestLives}`;

        drawGrids(data);
        
        if (data.hostLives <= 0 || data.guestLives <= 0) showResult(data);
    }

    function drawGrids(data) {
        const myGrid = document.getElementById('my-grid');
        const targetGrid = document.getElementById('target-grid');
        myGrid.innerHTML = ""; targetGrid.innerHTML = "";
        
        const myTanksList = (myRole === "host" ? data.hostTanks : data.guestTanks);
        const allHits = data.hits || [];

        for (let i = 1; i <= 16; i++) {
            // ‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏£‡∏≤
            const bMe = document.createElement('button');
            bMe.textContent = i;
            if (myTanksList.includes(i)) bMe.innerHTML = "üöú";
            const hitOnMe = allHits.find(h => h.pos === i && h.by !== myRole);
            if (hitOnMe) {
                bMe.innerHTML = hitOnMe.isHit ? "üí•" : "üï≥Ô∏è";
                bMe.classList.add(hitOnMe.isHit ? 'hit-bg' : 'miss-bg');
            }
            myGrid.appendChild(bMe);

            // ‡∏ù‡∏±‡πà‡∏á‡∏®‡∏±‡∏ï‡∏£‡∏π (‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏¥‡∏á)
            const bT = document.createElement('button');
            bT.textContent = i;
            bT.setAttribute('aria-label', `‡∏¢‡∏¥‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ${i}`);
            const myShot = allHits.find(h => h.pos === i && h.by === myRole);
            if (myShot) {
                bT.disabled = true;
                bT.innerHTML = myShot.isHit ? "üí•" : "üï≥Ô∏è";
                bT.classList.add(myShot.isHit ? 'hit-bg' : 'miss-bg');
                bT.setAttribute('aria-label', `‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ${i} ${myShot.isHit ? '‡∏¢‡∏¥‡∏á‡πÇ‡∏î‡∏ô‡πÅ‡∏•‡πâ‡∏ß' : '‡∏û‡∏•‡∏≤‡∏î‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß'}`);
            } else {
                bT.onclick = () => (data.turn === myRole && !isBusy) && executeFire(i, data);
            }
            targetGrid.appendChild(bT);
        }
    }

    async function executeFire(pos, data) {
        const enemyRole = (myRole === "host" ? "guest" : "host");
        const enemyTanks = (enemyRole === "host" ? data.hostTanks : data.guestTanks);
        const isHit = enemyTanks.includes(pos);
        
        const shot = { pos, by: myRole, isHit, processed: false };
        const hits = data.hits || [];
        hits.push(shot);

        const up = {
            hits: hits,
            lastShot: shot,
            turn: enemyRole,
            lastAction: Date.now()
        };
        if (isHit) up[`${enemyRole}Lives`] = data[`${enemyRole}Lives`] - 1;

        await update(ref(db, `${GAME_ID}/rooms/${myRoom}`), up);
    }

    function showResult(data) {
        const iWon = (myRole === "host" && data.guestLives <= 0) || (myRole === "guest" && data.hostLives <= 0);
        document.getElementById('battle-screen').style.display = 'none';
        document.getElementById('summary-screen').style.display = 'block';
        if (bgm) bgm.stop();
        
        document.getElementById('final-msg').textContent = iWon ? "‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞‡πÉ‡∏ô‡∏™‡∏°‡∏£‡∏†‡∏π‡∏°‡∏¥‡∏ô‡∏µ‡πâ!" : "‡∏ê‡∏≤‡∏ô‡∏ó‡∏±‡∏û‡∏ñ‡∏π‡∏Å‡∏ó‡∏≥‡∏•‡∏≤‡∏¢ ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏û‡πâ‡πÅ‡∏•‡πâ‡∏ß";
        playS(iWon ? 'win.mp3' : 'lost.mp3');
    }

    window.onload = loadAllSounds;
</script>
</body>
</html>