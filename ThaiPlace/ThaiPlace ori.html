<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Thai place questions? online</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body {
    font-family: "Segoe UI", sans-serif;
    background: #fafafa;
    text-align: center;
    padding: 20px;
    margin: 0;
  }
  #game, #lobby, #room, #quiz, #result { display: none; }
  button {
    background: #4CAF50; color: white; border: none;
    padding: 10px 20px; margin: 5px; border-radius: 6px; cursor: pointer;
    font-size: 16px;
  }
  button:hover { background: #45a049; }
   
  /* เพิ่ม CSS สำหรับปุ่มที่ถูก disabled */
  button:disabled {
    background: #cccccc;
    color: #666666;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }
   
  input { padding: 8px; border-radius: 4px; border: 1px solid #ccc; width: 200px; }
  h1, h2, h3 { color: #333; }
  ul { list-style: none; padding: 0; }
  li { margin: 8px 0; background:#fff; padding:12px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }

  #backToMenuBtn {
    position: fixed;
    top: 15px;
    left: 15px;
    z-index: 9999;
  }
  #backToMenuBtn button {
    background: #f44336;
    padding: 12px 26px;
    font-weight: bold;
    border-radius: 50px;
    box-shadow: 0 4px 12px rgba(244,67,54,0.4);
    transition: all 0.3s;
  }
  #backToMenuBtn button:hover {
    background: #d32f2f;
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(244,67,54,0.5);
  }
</style>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
</head>
<body>
<h1 id="mainTitle" tabindex="0">Thai place questions? online : รู้รอบตัว - ชุดที่ 2</h1>

<div id="backToMenuBtn">
  <button onclick="window.location.href='../index.html'">กลับเมนูหลัก</button>
</div>

<div id="game">
  <div id="nameInput">
    <p>เกมที่เล่นร่วมกันได้แบบออนไลน์ มาแข่งกันทายว่าสถานที่สำคัญนี้อยู่ในจังหวัดอะไร เพียงตั้งชื่อแล้ว<br>จะสร้างห้องใหม่หรือเข้าร่วมห้องที่มีเพื่อนสร้างไว้ก็ดี แต่ละรอบจะมีทั้งหมด 7 ข้อ<br>สรุปผลคะแนนว่าใครจะชนะ หรือเล่นคนเดียวก็สร้างห้องและกดเริ่มเกมได้เลย</p>
    <input id="playerName" placeholder="ชื่อของคุณ" autofocus><br><br>
    <button onclick="confirmName()">ยืนยัน</button>
  </div>

  <div id="lobby">
    <h2 id="lobbyTitle" tabindex="0">ล็อบบี้</h2>
    <button onclick="showCreateRoom()">สร้างห้องใหม่</button>
    <h3>ห้องที่เปิดอยู่</h3>
    <ul id="roomList"></ul>
  </div>

  <div id="room">
    <h2 id="roomName" tabindex="0"></h2>
    <p>* คนที่สร้างห้อง กดเริ่มเกมได้คนเดียวเท่านั้น แต่ละข้อมีเวลา 20 วินาที<br>ถ้าตอบกันครบทุกคนก่อน 20 วินาที จะไปยังข้อถัดไปทันที แต่ถ้ายังมีผู้เล่นบางคนตอบไม่ครบ ต้องรอครบ 20 วินาทีก่อน? ถึงจะไปยังข้อถัดไป<br>โดยถ้าท่านใดตอบไม่ทันเวลาในข้อนั้น เสียไป 1 คะแนนนะ<br>ตอนนี้มีผู้เล่นในห้องดังนี้:</p>
    <ul id="playerList"></ul>
    <button id="startBtn" onclick="startGame()">เริ่มเกม</button>
  </div>

  <div id="quiz">
    <h2 id="questionText" tabindex="0"></h2>
    <div id="options"></div>
    <!-- ซ่อนตัวเลขเวลา แต่ยังคงทำงานตามปกติ -->
    <p id="timer" style="font-size:18px; font-weight:bold; margin-top:20px; visibility:hidden; height:0; overflow:hidden;"></p>
  </div>

  <div id="result">
    <h2 id="resultHeading" tabindex="0">สรุปผล</h2>
    <ul id="scoreList"></ul>
    <button onclick="requestBackToLobby()">กลับไปเลือกห้องใหม่</button>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBIPeN4YUIrwM4MmFtDvT2DJ-v4toxc7tY",
  authDomain: "xo-game-134ec.firebaseapp.com",
  databaseURL: "https://xo-game-134ec-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "xo-game-134ec",
  storageBucket: "xo-game-134ec.firebasestorage.app",
  messagingSenderId: "318375224157",
  appId: "1:318375224157:web:c879de661c334ee8b77eb4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let playerName="", roomId="", playerId="", isHost=false;
let questionIndex=0, timerInterval, timeLeft=20, localAnswered=false;
let currentRoomListener=null, soundListener=null, currentAudio=null, lastSoundTime=0;
let lastQuestionText = "";
let waitLoopAudio = null;
let isProcessingNext = false; 

// รายชื่อไฟล์เสียงทั้งหมดที่ใช้ในเกม
const soundFiles = [
  "pop.mp3",
  "start.mp3",
  "friend.mp3",
  "door.mp3",
  "next.mp3",
  "new4.mp3",
  "wait.mp3"
];

const preloadedAudios = {};

function preloadAllSounds() {
  soundFiles.forEach(name => {
    const audio = new Audio(`audio/${name}`);
    audio.preload = "auto";
    preloadedAudios[name] = audio;
  });

  if (preloadedAudios["friend.mp3"]) {
    preloadedAudios["friend.mp3"].volume = 0;
    preloadedAudios["friend.mp3"].play().then(() => {
      preloadedAudios["friend.mp3"].pause();
      preloadedAudios["friend.mp3"].currentTime = 0;
      preloadedAudios["friend.mp3"].volume = 1;
    }).catch(() => {});
  }
  console.log("Preloaded all sound files!");
}

// === รายการคำถาม ===
const questions = [
  { q:"วัดพระแก้ว อยู่ในจังหวัดใด", options:["กรุงเทพมหานคร","เชียงใหม่","พระนครศรีอยุธยา"], answer:0 },
  { q:"ดอยอินทนนท์ อยู่ในจังหวัดใด", options:["เชียงราย","เชียงใหม่","ลำปาง"], answer:1 },
  { q:"เกาะสมุย อยู่ในจังหวัดใด", options:["สุราษฎร์ธานี","กระบี่","พังงา"], answer:0 },
  { q:"สะพานข้ามแม่น้ำแคว อยู่ในจังหวัดใด", options:["กาญจนบุรี","ราชบุรี","สุพรรณบุรี"], answer:0 },
  { q:"ปราสาทหินพิมาย อยู่ในจังหวัดใด", options:["นครราชสีมา","บุรีรัมย์","สุรินทร์"], answer:0 },
  { q:"พระปฐมเจดีย์ อยู่ในจังหวัดใด", options:["นครปฐม","สุพรรณบุรี","ราชบุรี"], answer:0 },
  { q:"อุทยานแห่งชาติเขาศก อยู่ในจังหวัดใด", options:["สุราษฎร์ธานี","นครศรีธรรมราช","ชุมพร"], answer:0 },
  { q:"เกาะช้าง อยู่ในจังหวัดใด", options:["ตราด","จันทบุรี","ระยอง"], answer:0 },
  { q:"ปราสาทเมืองสิงห์ อยู่ในจังหวัดใด", options:["กาญจนบุรี","ราชบุรี","สุพรรณบุรี"], answer:0 },
  { q:"น้ำตกทีลอซู อยู่ในจังหวัดใด", options:["ตาก","แม่ฮ่องสอน","กำแพงเพชร"], answer:0 },
  { q:"ถ้ำหลวง อยู่ในจังหวัดใด", options:["เชียงราย","พะเยา","น่าน"], answer:0 },
  { q:"เกาะพีพี อยู่ในจังหวัดใด", options:["กระบี่","ภูเก็ต","พังงา"], answer:0 },
  { q:"วัดร่องขุ่น อยู่ในจังหวัดใด", options:["เชียงราย","เชียงใหม่","พะเยา"], answer:0 },
  { q:"พระพุทธชินราช อยู่ในจังหวัดใด", options:["พิษณุโลก","สุโขทัย","อุตรดิตถ์"], answer:0 },
  { q:"สวนนงนุช อยู่ในจังหวัดใด", options:["ชลบุรี","ระยอง","จันทบุรี"], answer:0 },
  { q:"เกาะลันตา อยู่ในจังหวัดใด", options:["กระบี่","ตรัง","สตูล"], answer:0 },
  { q:"เขื่อนรัชชประภา อยู่ในจังหวัดใด", options:["สุราษฎร์ธานี","นครศรีธรรมราช","ชุมพร"], answer:0 },
  { q:"วัดพระธาตุดอยกองมู อยู่ในจังหวัดใด", options:["แม่ฮ่องสอน","เชียงใหม่","ตาก"], answer:0 },
  { q:"หาดป่าตอง อยู่ในจังหวัดใด", options:["ภูเก็ต","กระบี่","พังงา"], answer:0 },
  { q:"อนุสาวรีย์ชัยสมรภูมิ อยู่ในจังหวัดใด", options:["กรุงเทพมหานคร","ปทุมธานี","นนทบุรี"], answer:0 },
  { q:"ปราสาทสัจธรรม อยู่ในจังหวัดใด", options:["ชลบุรี","ระยอง","จันทบุรี"], answer:0 },
  { q:"เกาะเต่า อยู่ในจังหวัดใด", options:["สุราษฎร์ธานี","ชุมพร","นครศรีธรรมราช"], answer:0 },
  { q:"วัดพระธาตุหริภุญชัย อยู่ในจังหวัดใด", options:["ลำพูน","ลำปาง","เชียงใหม่"], answer:0 },
  { q:"หาดเฉวง อยู่ในจังหวัดใด", options:["สุราษฎร์ธานี","กระบี่","ภูเก็ต"], answer:0 },
  { q:"พระพุทธรูปแกะสลักเขาคิชฌกูฏ อยู่ในจังหวัดใด", options:["จันทบุรี","ตราด","ระยอง"], answer:0 },
  { q:"น้ำตกเอราวัณ อยู่ในจังหวัดใด", options:["กาญจนบุรี","ราชบุรี","สุพรรณบุรี"], answer:0 },
  { q:"วัดโพธิ์ อยู่ในจังหวัดใด", options:["กรุงเทพมหานคร","สมุทรปราการ","นนทบุรี"], answer:0 },
  { q:"เกาะสิมิลัน อยู่ในจังหวัดใด", options:["พังงา","ภูเก็ต","กระบี่"], answer:0 },
  { q:"ดอยผาตั้ง อยู่ในจังหวัดใด", options:["เชียงราย","พะเยา","น่าน"], answer:0 },
  { q:"พระธาตุพนม อยู่ในจังหวัดใด", options:["นครพนม","มุกดาหาร","สกลนคร"], answer:0 },
  { q:"หาดในยาง อยู่ในจังหวัดใด", options:["ภูเก็ต","พังงา","กระบี่"], answer:0 },
  { q:"วัดพระธาตุแช่แห้ง อยู่ในจังหวัดใด", options:["น่าน","แพร่","พะเยา"], answer:0 },
  { q:"สามเหลี่ยมทองคำ อยู่ในจังหวัดใด", options:["เชียงราย","เชียงใหม่","พะเยา"], answer:0 },
  { q:"เกาะนางยวน อยู่ในจังหวัดใด", options:["สุราษฎร์ธานี","ชุมพร","กระบี่"], answer:0 },
  { q:"วัดพระสิงห์ อยู่ในจังหวัดใด", options:["เชียงใหม่","ลำพูน","ลำปาง"], answer:0 },
  { q:"อุทยานแห่งชาติแก่งกระจาน อยู่ในจังหวัดใด", options:["เพชรบุรี","ประจวบีรีขันธ์","ราชบุรี"], answer:0 },
  { q:"หาดกมลา อยู่ในจังหวัดใด", options:["ภูเก็ต","กระบี่","พังงา"], answer:0 },
  { q:"พระพุทธบาทสระบุรี อยู่ในจังหวัดใด", options:["สระบุรี","ลพบุรี","นครนายก"], answer:0 },
  { q:"เกาะหลีเป๊ะ อยู่ในจังหวัดใด", options:["สตูล","ตรัง","พัทลุง"], answer:0 },
  { q:"วัดจุฬามณี อยู่ในจังหวัดใด", options:["สมุทรสงคราม","ราชบุรี","เพชรบุรี"], answer:0 },
  { q:"วัดพระธาตุลำปางหลวง อยู่ในจังหวัดใด", options:["ลำปาง","ลำพูน","เชียงใหม่"], answer:0 },
  { q:"หาดราไวย์ อยู่ในจังหวัดใด", options:["ภูเก็ต","พังงา","กระบี่"], answer:0 },
  { q:"พระธาตุผาซ่อนแก้ว อยู่ในจังหวัดใด", options:["เพชรบูรณ์","พิษณุโลก","เลย"], answer:0 },
  { q:"เกาะพยาม อยู่ในจังหวัดใด", options:["ระนอง","พังงา","ชุมพร"], answer:0 },
  { q:"วัดเบญจมบพิตร อยู่ในจังหวัดใด", options:["กรุงเทพมหานคร","นนทบุรี","ปทุมธานี"], answer:0 },
  { q:"อุทยานแห่งชาติผาแต้ม อยู่ในจังหวัดใด", options:["อุบลราชธานี","อำนาจเจริญ","ยโสธร"], answer:0 },
  { q:"หาดสุรินทร์ อยู่ในจังหวัดใด", options:["ภูเก็ต","กระบี่","พังงา"], answer:0 },
  { q:"วัดพระธาตุโดนเต้า อยู่ในจังหวัดใด", options:["ลำปาง","แพร่","น่าน"], answer:0 },
  { q:"เกาะกระดาน อยู่ในจังหวัดใด", options:["ตรัง","กระบี่","สตูล"], answer:0 },
  { q:"พระตำหนักดอยตุง อยู่ในจังหวัดใด", options:["เชียงราย","เชียงใหม่","พะเยา"], answer:0 },
  { q:"ตลาดร่มหุบ อยู่ในจังหวัดใด", options:["สมุทรสงคราม","ราชบุรี","นครปฐม"], answer:0 },
  { q:"เขื่อนสิรินธร อยู่ในจังหวัดใด", options:["อุบลราชธานี","ศรีสะเกษ","สุรินทร์"], answer:0 },
  { q:"วัดพระมหาธาตุวรมหาวิหาร อยู่ในจังหวัดใด", options:["นครศรีธรรมราช","สุราษฎร์ธานี","สงขลา"], answer:0 },
  { q:"อุทยานแห่งชาติหมู่เกาะอ่างทอง อยู่ในจังหวัดใด", options:["สุราษฎร์ธานี","ชุมพร","นครศรีธรรมราช"], answer:0 },
  { q:"วัดพระธาตุศรีจอมทอง อยู่ในจังหวัดใด", options:["เชียงใหม่","ลำพูน","ลำปาง"], answer:0 },
  { q:"หาดกะตะ อยู่ในจังหวัดใด", options:["ภูเก็ต","กระบี่","พังงา"], answer:0 },
  { q:"สวนสัตว์เปิดเขาเขียว อยู่ในจังหวัดใด", options:["ชลบุรี","ระยอง","จันทบุรี"], answer:0 },
  { q:"เกาะมุก อยู่ในจังหวัดใด", options:["ตรัง","กระบี่","สตูล"], answer:0 },
  { q:"พระพุทธรูปหลวงพ่อโต อยู่ในจังหวัดใด", options:["อ่างทอง","สิงห์บุรี","ชัยนาท"], answer:0 },
  { q:"วัดพระพุทธบาท อยู่ในจังหวัดใด", options:["สระบุรี","ลพบุรี","นครนายก"], answer:0 },
  { q:"หาดบางแสน อยู่ในจังหวัดใด", options:["ชลบุรี","ระยอง","จันทบุรี"], answer:0 },
  { q:"เกาะราชา อยู่ในจังหวัดใด", options:["ภูเก็ต","กระบี่","พังงา"], answer:0 },
  { q:"วัดพระธาตุช่อแฮ อยู่ในจังหวัดใด", options:["แพร่","น่าน","ลำปาง"], answer:0 },
  { q:"อุทยานแห่งชาติดอยภูคา อยู่ในจังหวัดใด", options:["น่าน","แพร่","พะเยา"], answer:0 },
  { q:"หาดปราณบุรี อยู่ในจังหวัดใด", options:["ประจวบคีรีขันธ์","เพชรบุรี","ชุมพร"], answer:0 },
  { q:"วัดถ้ำเสือ อยู่ในจังหวัดใด", options:["กาญจนบุรี","ราชบุรี","สุพรรณบุรี"], answer:0 },
  { q:"เกาะหมาก อยู่ในจังหวัดใด", options:["ตราด","จันทบุรี","ระยอง"], answer:0 },
  { q:"พระพุทธรูปแกะสลักเขาชีจรรย์ อยู่ในจังหวัดใด", options:["ชลบุรี","ระยอง","จันทบุรี"], answer:0 },
  { q:"น้ำตกเจ็ดสาวน้อย อยู่ในจังหวัดใด", options:["สระบุรี","นครนายก","ปราจีนบุรี"], answer:0 },
  { q:"วัดพระธาตุผาเงา อยู่ในจังหวัดใด", options:["เชียงราย","พะเยา","น่าน"], answer:0 },
  { q:"หาดเจ้าหลาว อยู่ในจังหวัดใด", options:["จันทบุรี","ตราด","ระยอง"], answer:0 },
  { q:"อุทยานแห่งชาติทับลาน อยู่ในจังหวัดใด", options:["นครราชสีมา","ปราจีนบุรี","สระแก้ว"], answer:0 },
  { q:"เกาะไข่ อยู่ในจังหวัดใด", options:["พังงา","ภูเก็ต","กระบี่"], answer:0 },
  { q:"วัดพระธาตุแสงจันทร์ อยู่ในจังหวัดใด", options:["อุบลราชธานี","อำนาจเจริญ","ยโสธร"], answer:0 },
  { q:"น้ำตกสาริกา อยู่ในจังหวัดใด", options:["นครนายก","ปราจีนบุรี","สระแก้ว"], answer:0 },
  { q:"วัดป่าภูผาแดง อยู่ในจังหวัดใด", options:["เชียงใหม่","ลำปาง","ลำพูน"], answer:0 },
  { q:"เกาะตาชัย อยู่ในจังหวัดใด", options:["พังงา","ภูเก็ต","กระบี่"], answer:0 },
  { q:"พระพุทธรูปหลวงพ่อบ้านแหลม อยู่ในจังหวัดใด", options:["สมุทรสงคราม","สมุทรสาคร","ราชบุรี"], answer:0 },
  { q:"อุทยานแห่งชาติภูสอยดาว อยู่ในจังหวัดใด", options:["พิษณุโลก","เลย","อุตรดิตถ์"], answer:0 },
  { q:"หาดนพรัตน์ธารา อยู่ในจังหวัดใด", options:["กระบี่","ภูเก็ต","พังงา"], answer:0 },
  { q:"วัดพระธาตุจอมกิตติ อยู่ในจังหวัดใด", options:["เชียงราย","พะเยา","น่าน"], answer:0 },
  { q:"น้ำตกคลองพลู อยู่ในจังหวัดใด", options:["ตราด","จันทบุรี","ระยอง"], answer:0 },
  { q:"วัดพระพุทธฉาย อยู่ในจังหวัดใด", options:["สระบุรี","ลพบุรี","นครนายก"], answer:0 },
  { q:"หาดบางเบิด อยู่ในจังหวัดใด", options:["ประจวบคีรีขันธ์","ชุมพร","เพชรบุรี"], answer:0 },
  { q:"วัดถ้ำเขาน้อย อยู่ในจังหวัดใด", options:["กาญจนบุรี","ราชบุรี","สุพรรณบุรี"], answer:0 },
  { q:"อุทยานแห่งชาติภูเรือ อยู่ในจังหวัดใด", options:["เลย","หนองคาย","หนองบัวลำภู"], answer:0 },
  { q:"วัดพระธาตุศรีสองรัก อยู่ในจังหวัดใด", options:["เลย","หนองคาย","หนองบัวลำภู"], answer:0 },
  { q:"เกาะไม้ท่อน อยู่ในจังหวัดใด", options:["ภูเก็ต","พังงา","กระบี่"], answer:0 },
  { q:"น้ำตกวังตะไคร้ อยู่ในจังหวัดใด", options:["นครนายก","ปราจีนบุรี","สระแก้ว"], answer:0 },
  { q:"หาดหัวหิน อยู่ในจังหวัดใด", options:["ประจวบคีรีขันธ์","เพชรบุรี","ชุมพร"], answer:0 },
  { q:"เกาะกูด อยู่ในจังหวัดใด", options:["ตราด","จันทบุรี","ระยอง"], answer:0 },
  { q:"ปราสาทหินพนมรุ้ง อยู่ในจังหวัดใด", options:["บุรีรัมย์","สุรินทร์","นครราชสีมา"], answer:0 },
  { q:"วัดพระธาตุเชิงชุม อยู่ในจังหวัดใด", options:["สกลนคร","นครพนม","มุกดาหาร"], answer:0 },
  { q:"หาดคลองม่วง อยู่ในจังหวัดใด", options:["กระบี่","ภูเก็ต","พังงา"], answer:0 },
  { q:"เกาะจำ อยู่ในจังหวัดใด", options:["กระบี่","ภูเก็ต","พังงา"], answer:0 },
  { q:"พระพุทธรูปหลวงพ่อวัดบ้านไร่ อยู่ในจังหวัดใด", options:["นครราชสีมา","ชัยภูมิ","บุรีรัมย์"], answer:0 },
  { q:"น้ำตกชุมแสง อยู่ในจังหวัดใด", options:["นครศรีธรรมราช","สุราษฎร์ธานี","สงขลา"], answer:0 },
  { q:"วัดพระธาตุพนมวรมหาวิหาร อยู่ในจังหวัดใด", options:["นครพนม","มุกดาหาร","สกลนคร"], answer:0 },
  { q:"หาดอ่าวนาง อยู่ในจังหวัดใด", options:["กระบี่","ภูเก็ต","พังงา"], answer:0 },
  { q:"เกาะยาวน้อย อยู่ในจังหวัดใด", options:["พังงา","ภูเก็ต","กระบี่"], answer:0 },
  { q:"พระตำหนักภูพิงคราชนิเวศน์ อยู่ในจังหวัดใด", options:["เชียงใหม่","ลำปาง","ลำพูน"], answer:0 },
  { q:"น้ำตกบัวตอง อยู่ในจังหวัดใด", options:["เชียงใหม่","แม่ฮ่องสอน","ลำปาง"], answer:0 },
  { q:"วัดพระธาตุดอยสุเทพ อยู่ในจังหวัดใด", options:["เชียงใหม่","ลำพูน","ลำปาง"], answer:0 },
  { q:"หาดละไม อยู่ในจังหวัดใด", options:["สุราษฎร์ธานี","ชุมพร","นครศรีธรรมราช"], answer:0 },
  { q:"วัดพระศรีมหาธาตุบางเขน อยู่ในจังหวัดใด", options:["กรุงเทพมหานคร","นนทบุรี","ปทุมธานี"], answer:0 },
  { q:"น้ำตกสิริภูมิ อยู่ในจังหวัดใด", options:["เชียงใหม่","ลำปาง","ลำพูน"], answer:0 },
  { q:"หาดกะรน อยู่ในจังหวัดใด", options:["ภูเก็ต","กระบี่","พังงา"], answer:0 },
  { q:"เกาะห้อง อยู่ในจังหวัดใด", options:["กระบี่","ภูเก็ต","พังงา"], answer:0 },
  { q:"พระพุทธรูปหลวงพ่อโสธร อยู่ในจังหวัดใด", options:["ฉะเชิงเทรา","ปราจีนบุรี","สระแก้ว"], answer:0 },
  { q:"น้ำตกพลิ้ว อยู่ในจังหวัดใด", options:["จันทบุรี","ตราด","ระยอง"], answer:0 },
  { q:"หาดปากเมง อยู่ในจังหวัดใด", options:["ตรัง","กระบี่","สตูล"], answer:0 },
  { q:"เกาะกระ อยู่ในจังหวัดใด", options:["พังงา","ภูเก็ต","กระบี่"], answer:0 },
  { q:"วัดพระธาตุบังพวน อยู่ในจังหวัดใด", options:["หนองคาย","บึงกาฬ","เลย"], answer:0 },
  { q:"หาดชะอำ อยู่ในจังหวัดใด", options:["เพชรบุรี","ประจวบคีรีขันธ์","ราชบุรี"], answer:0 },
  { q:"วัดพระธาตุจอมแจ้ง อยู่ในจังหวัดใด", options:["แพร่","น่าน","ลำปาง"], answer:0 },
  { q:"เกาะหมากน้อย อยู่ในจังหวัดใด", options:["ตราด","จันทบุรี","ระยอง"], answer:0 },
  { q:"พระพุทธรูปหลวงพ่อวัดไร่ขิง อยู่ในจังหวัดใด", options:["นครปฐม","สมุทรสาคร","ราชบุรี"], answer:0 },
  { q:"น้ำตกเขาสอยดาว อยู่ในจังหวัดใด", options:["จันทบุรี","ตราด","ระยอง"], answer:0 },
  { q:"วัดพระธาตุเขาน้อย อยู่ในจังหวัดใด", options:["น่าน","แพร่","พะเยา"], answer:0 },
  { q:"หาดคุ้งวิมาน อยู่ในจังหวัดใด", options:["จันทบุรี","ตราด","ระยอง"], answer:0 },
  { q:"เกาะเสม็ด อยู่ในจังหวัดใด", options:["ระยอง","ชลบุรี","จันทบุรี"], answer:0 },
  { q:"น้ำตกโตนงาช้าง อยู่ในจังหวัดใด", options:["สงขลา","พัทลุง","นครศรีธรรมราช"], answer:0 },
  { q:"วัดเขียนบางแก้ว อยู่ในจังหวัดใด", options:["พัทลุง","สงขลา","นครศรีธรรมราช"], answer:0 },
  { q:"เกาะตะรุเตา อยู่ในจังหวัดใด", options:["สตูล","ตรัง","พัทลุง"], answer:0 },
  { q:"พระพุทธรูปหลวงพ่อโตวัดบางพลีใหญ่ใน อยู่ในจังหวัดใด", options:["สมุทรปราการ","กรุงเทพมหานคร","ฉะเชิงเทรา"], answer:0 },
  { q:"น้ำตกวังรี อยู่ในจังหวัดใด", options:["นครนายก","ปราจีนบุรี","สระแก้ว"], answer:0 },
  { q:"เกาะยาวใหญ่ อยู่ในจังหวัดใด", options:["พังงา","ภูเก็ต","กระบี่"], answer:0 },
  { q:"น้ำตกแม่ยะ อยู่ในจังหวัดใด", options:["เชียงใหม่","แม่ฮ่องสอน","ลำปาง"], answer:0 },
  { q:"วัดพระธาตุดอยคำ อยู่ในจังหวัดใด", options:["เชียงใหม่","ลำปาง","ลำพูน"], answer:0 },
  { q:"เกาะบอน อยู่ในจังหวัดใด", options:["ภูเก็ต","พังงา","กระบี่"], answer:0 },
  { q:"พระพุทธรูปหลวงพ่อวัดเขาตะเครา อยู่ในจังหวัดใด", options:["เพชรบุรี","ประจวบคีรีขันธ์","ราชบุรี"], answer:0 },
  { q:"น้ำตกเขาชะเมา อยู่ในจังหวัดใด", options:["ระยอง","จันทบุรี","ตราด"], answer:0 }
];

// เริ่มเกม
document.getElementById("game").style.display="block";
document.getElementById("backToMenuBtn").style.display="block";

// ============== AUDIO ==============
function triggerSound(name) {
  if (!roomId) return;
  const now = Date.now();
  if (now - lastSoundTime < 200) return;
  lastSoundTime = now;
  db.ref(`guessGameRooms/${roomId}/soundTrigger`).set({name, time: now});
  db.ref(`guessGameRooms/${roomId}/lastActivity`).set(now);
}

// ฟังก์ชันใหม่สำหรับเริ่มเล่น wait.mp3 แบบ loop
function startWaitLoop() {
  stopWaitLoop(); 
  const audio = preloadedAudios["wait.mp3"];
  if (!audio) return;
  audio.loop = true;
  audio.play().catch(() => {});
  waitLoopAudio = audio;
}

// ฟังก์ชันหยุด loop wait.mp3
function stopWaitLoop() {
  if (waitLoopAudio) {
    waitLoopAudio.pause();
    waitLoopAudio.currentTime = 0;
    waitLoopAudio.loop = false;
    waitLoopAudio = null;
  }
}

function stopCurrentAudio() {
  if (currentAudio) { currentAudio.pause(); currentAudio.currentTime = 0; currentAudio = null; }
}

function playSound(name) {
  stopCurrentAudio();
  const audio = preloadedAudios[`${name}.mp3`] || preloadedAudios[name] || new Audio(`audio/${name}.mp3`);
  audio.play().catch(() => {});
  currentAudio = audio;
}

function startSoundListener() {
  if (soundListener) soundListener.off();
  if (!roomId) return;
  soundListener = db.ref(`guessGameRooms/${roomId}/soundTrigger`);
  soundListener.on("value", s => { const d = s.val(); if (d?.name) playSound(d.name); });
}

// ============== FOCUS ==============
function focusHeading(id) {
  requestAnimationFrame(() => setTimeout(() => {
    const el = document.getElementById(id);
    if (el) { el.setAttribute('tabindex', '-1'); el.focus(); }
  }, 150));
}
function focusQuestionIfChanged(newText) {
  if (newText !== lastQuestionText) {
    lastQuestionText = newText;
    document.getElementById("questionText").textContent = newText;
    focusHeading("questionText");
  }
}

// ============== UTILS ==============
function shuffleArray(arr) {
  for (let i = arr.length-1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

// ============== GAME FLOW ==============
function confirmName() {
  playerName = document.getElementById("playerName").value.trim();
  if (!playerName) { alert("กรุณาใส่ชื่อ"); return; }
  playerId = Math.random().toString(36).substr(2,9);
  document.getElementById("nameInput").style.display = "none";
  document.getElementById("lobby").style.display = "block";
  focusHeading("lobbyTitle");
   
  preloadAllSounds();
   
  loadRooms();
}

function loadRooms() {
  const list = document.getElementById("roomList");
  db.ref("guessGameRooms").on("value", snap => {
    list.innerHTML = "";
    const now = Date.now();

    snap.forEach(r => {
      const room = r.val();
      const roomKey = r.key;
      const playerCount = room.players ? Object.keys(room.players).length : 0;

      const lastActivity = room.lastActivity || room.created || 0;
      if (now - lastActivity > 600000) { // 10 นาที
        db.ref(`guessGameRooms/${roomKey}`).remove();
        return;
      }

      if (playerCount === 0 && room.created && (now - room.created > 3000)) {
        db.ref(`guessGameRooms/${roomKey}`).remove();
        return;
      }

      if (room.status === "waiting" && playerCount > 0) {
        const li = document.createElement("li");
        li.innerHTML = `${room.name} (${playerCount} คน)`;
        const btn = document.createElement("button");
        btn.textContent = "เข้าร่วม";
        btn.onclick = () => joinRoom(roomKey);
        li.appendChild(btn);
        list.appendChild(li);
      }
    });
  });
}

function showCreateRoom() {
  const name = prompt("ตั้งชื่อห้อง:");
  if (!name) return;
  const ref = db.ref("guessGameRooms").push();
  roomId = ref.key; isHost = true;
  ref.set({
    name, 
    status:"waiting", 
    host:playerId, 
    created:Date.now(),
    lastActivity: Date.now(),
    players:{}
  });
  joinRoom(roomId);
}

function joinRoom(id) {
  db.ref(`guessGameRooms/${id}`).once("value").then(snap => {
    const room = snap.val();
    const playerCount = room.players ? Object.keys(room.players).length : 0;
    if (playerCount >= 20) {
      alert("ห้องนี้มีผู้เล่นครบ 20 คนแล้ว ไม่สามารถเข้าร่วมได้");
      return;
    }
    roomId = id;
    const ref = db.ref(`guessGameRooms/${roomId}/players/${playerId}`);
    ref.set({name:playerName, score:0, answered:false});
    ref.onDisconnect().remove();
    db.ref(`guessGameRooms/${roomId}/lastJoin`).set(Date.now());
    db.ref(`guessGameRooms/${roomId}/lastActivity`).set(Date.now());
    showRoom();
  });
}

function showRoom() {
  document.getElementById("lobby").style.display = "none";
  document.getElementById("room").style.display = "block";
  focusHeading("roomName");
  startSoundListener();

  if (currentRoomListener) currentRoomListener.off();
  currentRoomListener = db.ref(`guessGameRooms/${roomId}`);
  currentRoomListener.on("value", snap => {
    const room = snap.val();
    if (!room) { alert("ห้องถูกลบแล้ว"); backToLobby(); return; }

    document.getElementById("roomName").textContent = `ห้อง: ${room.name}`;
    const list = document.getElementById("playerList"); list.innerHTML = "";
    if (room.players) {
      for (let id in room.players) {
        const li = document.createElement("li");
        li.textContent = `${room.players[id].name} (${room.players[id].score||0} คะแนน)`;
        list.appendChild(li);
      }
    }
    document.getElementById("startBtn").style.display = (room.host === playerId) ? "inline" : "none";

    if (room.lastJoin && room.lastJoin !== window._lastJoinTime) {
      window._lastJoinTime = room.lastJoin;
      playSound("friend"); 
    }
    if (room.lastBackToLobby && room.lastBackToLobby !== window._lastBackTime) {
      window._lastBackTime = room.lastBackToLobby;
      triggerSound("door");
    }

    if (room.status === "playing") {
        const incomingIndex = room.current || 0;
        const isWaiting = document.getElementById("room").style.display !== "none";
        
        // ถ้าเลขข้อเปลี่ยน หรือเพิ่งเริ่มเกม ให้แสดงคำถามใหม่
        if (isWaiting || incomingIndex !== questionIndex) {
             questionIndex = incomingIndex;
             isProcessingNext = false; 

             if (room.questions && room.questions[questionIndex]) {
                 document.getElementById("lobby").style.display = "none";
                 document.getElementById("room").style.display = "none";
                 document.getElementById("quiz").style.display = "block";
                 document.getElementById("mainTitle").style.display = "none";
                 
                 showQuestion(room.questions[questionIndex]);
             }
        }
        
        // Logic บังคับ disable ปุ่ม
        if (room.players && room.players[playerId] && room.players[playerId].answered) {
             localAnswered = true;
             const allBtns = document.querySelectorAll("#options button");
             if (allBtns.length > 0) {
                 allBtns.forEach(btn => btn.disabled = true);
             }
        }

        // --- แก้ไข: ลบ Logic Distributed Auto-check ออกจากตรงนี้ ---
        // เหลือไว้แค่ logic สำหรับจับเวลา (timeout) ที่ยังต้องมีใครสักคนสั่ง
        // ส่วนการกดตอบครบ จะถูกจัดการใน submitAnswer ของคนสุดท้ายแล้ว
    }
    else if (room.status === "finished") {
      stopWaitLoop();
      showResult(room);
    }
  });
}

function startGame() {
  triggerSound("start");
  db.ref(`guessGameRooms/${roomId}`).update({
    status: "playing",
    current: 0,
    questions: getRandomQuestions(7),
    lastActivity: Date.now()
  });
}

function getRandomQuestions(n) {
  const copy = questions.map(q => ({...q, options: [...q.options]}));
  const res = [];
  for (let i = 0; i < n; i++) {
    const idx = Math.floor(Math.random() * copy.length);
    let q = copy.splice(idx, 1)[0];
    
    const opts = [...q.options];
    const correctText = opts[q.answer];
    shuffleArray(opts);
    q.answer = opts.indexOf(correctText);
    q.options = opts;
    
    res.push(q);
  }
  return res;
}

function showQuestion(q) {
  if (!q) return;

  localAnswered = false;
  timeLeft = Math.floor(Math.random() * 11) + 15; 

  const newText = `ข้อที่ ${questionIndex + 1}: ${q.q}`;
  focusQuestionIfChanged(newText);

  const container = document.getElementById("options");
  container.innerHTML = "";
  const shuffled = q.options;
  const correctText = q.options[q.answer];

  shuffled.forEach((opt, i) => {
    const btn = document.createElement("button");
    btn.textContent = opt;
    btn.onclick = () => submitAnswer(opt === correctText);
    container.appendChild(btn);
  });

  document.getElementById("timer").textContent = `เวลา: ${timeLeft} วินาที`; 
  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    timeLeft--;
    document.getElementById("timer").textContent = `เวลา: ${timeLeft} วินาที`; 
    
    // Fallback: ถ้าเวลาหมด ใครก็ได้ช่วยสั่งเปลี่ยน
    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      if (!isProcessingNext) {
          isProcessingNext = true;
          tryTriggerNextQuestion();
      }
    }
  }, 1000);
}

// === แก้ไขใหม่: ตรวจสอบสถานะทันทีใน Transaction ของการส่งคำตอบ ===
function submitAnswer(isCorrect) {
  if (localAnswered) return;
  localAnswered = true;

  const allBtns = document.querySelectorAll("#options button");
  allBtns.forEach(btn => btn.disabled = true);

  playSound("pop");

  const roomRef = db.ref(`guessGameRooms/${roomId}`);
  roomRef.transaction((room) => {
    if (!room || !room.players || !room.players[playerId]) return room;
    
    // 1. อัปเดตข้อมูลผู้เล่นตัวเอง
    const p = room.players[playerId];
    if (p.answered) return; // กันเหนียว
    
    if (isCorrect) {
      p.score = (p.score || 0) + 1;
    }
    p.answered = true;
    room.lastActivity = Date.now();
    
    return room;
  }, (error, committed, snapshot) => {
    if (error) return;
    if (committed && snapshot.val()) {
       const room = snapshot.val();
       
       // 2. เช็คทันทีว่า "ครบทุกคนหรือยัง" (หลังจากที่เราเพิ่งตอบไป)
       const allAnswered = Object.values(room.players || {}).every(p => p.answered);
       
       if (allAnswered) {
           // ถ้าเราเป็นจิ๊กซอว์ชิ้นสุดท้าย -> เรารับหน้าที่สั่งเปลี่ยนข้อ!
           console.log("I am the last one! Triggering next...");
           prepareNextQuestion(room);
       }
    }
  });
}

function prepareNextQuestion(room) {
    // ล็อค Local ตัวเองไม่ให้ timer มาแย่งสั่ง
    isProcessingNext = true;
    clearInterval(timerInterval);
    
    const isLastQuestion = (room.current || 0) >= (room.questions || []).length - 1;
    
    if (isLastQuestion) {
        startWaitLoop();
        triggerSound("new4");
        setTimeout(tryTriggerNextQuestion, 2500);
    } else {
        // setTimeout(() => triggerSound("next"), 500);
        setTimeout(tryTriggerNextQuestion, 1200);
    }
}

// === ฟังก์ชันเปลี่ยนข้อ (ยังคงใช้ Transaction เพื่อความปลอดภัยสูงสุด) ===
function tryTriggerNextQuestion() {
    const roomRef = db.ref(`guessGameRooms/${roomId}`);
    roomRef.transaction((room) => {
        if (!room) return room;

        if (room.current === questionIndex && room.status === 'playing') {
            const totalQ = (room.questions || []).length;
            
            if (room.current >= totalQ - 1) {
                room.status = 'finished';
                let playersArr = [];
                if (room.players) {
                    playersArr = Object.values(room.players);
                    playersArr.sort((a,b) => (b.score||0) - (a.score||0));
                }
                const max = playersArr.length > 0 ? (playersArr[0].score || 0) : 0;
                const winners = playersArr.filter(p => (p.score||0) === max).map(p => p.name);
                room.result = { winners, players: playersArr };
            } else {
                room.current++;
                if (room.players) {
                    Object.keys(room.players).forEach(k => {
                        room.players[k].answered = false;
                    });
                }
                // สั่งให้คนอื่นเล่นเสียง next (กรณี time out แล้วคนอื่นไม่ได้ยินเสียง pop ของเรา)
                room.soundTrigger = { name: "next", time: Date.now() };
            }
            
            room.lastActivity = Date.now();
            return room;
        }
        return; 
    }, (error, committed) => {
        if (error) isProcessingNext = false;
    });
}

function showResult(roomData) {
  clearInterval(timerInterval);
  stopWaitLoop(); 
  document.getElementById("quiz").style.display = "none";
  document.getElementById("result").style.display = "block";
  document.getElementById("mainTitle").style.display = "none";

  const list = document.getElementById("scoreList");
  list.innerHTML = "";
  const players = roomData.result?.players || [];
  const winners = roomData.result?.winners || [];
  document.getElementById("resultHeading").textContent = `สรุปผล ผู้ชนะคือ ${winners.join(", ")}`;

  players.forEach(p => {
    const li = document.createElement("li");
    li.textContent = `${p.name}: ${p.score} คะแนน`;
    list.appendChild(li);
  });
  focusHeading("resultHeading");
}

function requestBackToLobby() {
  triggerSound("door");
  db.ref(`guessGameRooms/${roomId}/lastBackToLobby`).set(Date.now());
  backToLobby();
}

function backToLobby() {
  if (currentRoomListener) { currentRoomListener.off(); currentRoomListener = null; }
  if (soundListener) { soundListener.off(); soundListener = null; }
  stopWaitLoop(); 
  db.ref(`guessGameRooms/${roomId}/players/${playerId}`).remove();
  roomId = ""; questionIndex = 0; lastQuestionText = "";
  document.getElementById("result").style.display = "none";
  document.getElementById("room").style.display = "none";
  document.getElementById("quiz").style.display = "none";
  document.getElementById("mainTitle").style.display = "block";
  document.getElementById("lobby").style.display = "block";
  focusHeading("lobbyTitle");
  loadRooms();
}
</script>
</body>
</html>