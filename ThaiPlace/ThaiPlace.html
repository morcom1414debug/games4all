<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>ทายสิ๊ Capital online</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body {
    font-family: "Segoe UI", sans-serif;
    background: #fafafa;
    text-align: center;
    padding: 20px;
    margin: 0;
  }
  #game, #lobby, #room, #quiz, #result { display: none; }
  button {
    background: #4CAF50; color: white; border: none;
    padding: 10px 20px; margin: 5px; border-radius: 6px; cursor: pointer;
    font-size: 16px;
  }
  button:hover { background: #45a049; }
  input { padding: 8px; border-radius: 4px; border: 1px solid #ccc; width: 200px; }
  h1, h2, h3 { color: #333; }
  ul { list-style: none; padding: 0; }
  li { margin: 8px 0; background:#fff; padding:12px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }

  #backToMenuBtn {
    position: fixed;
    top: 15px;
    left: 15px;
    z-index: 9999;
  }
  #backToMenuBtn button {
    background: #f44336;
    padding: 12px 26px;
    font-weight: bold;
    border-radius: 50px;
    box-shadow: 0 4px 12px rgba(244,67,54,0.4);
    transition: all 0.3s;
  }
  #backToMenuBtn button:hover {
    background: #d32f2f;
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(244,67,54,0.5);
  }
</style>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
</head>
<body>
<h1 id="mainTitle" tabindex="0">ทายสิ๊ Capital online</h1>

<div id="backToMenuBtn">
  <button onclick="window.location.href='../index.html'">กลับเมนูหลัก</button>
</div>

<div id="game">
  <div id="nameInput">
    <p>เกมที่เล่นร่วมกันได้แบบออนไลน์ มาแข่งกันทายว่าประเทศนี้ มีเมืองหลวงชื่อว่าอะไร เพียงตั้งชื่อ<br>แล้ว จะสร้างห้องใหม่หรือเข้าร่วมห้องที่มีเพื่อนสร้างไว้ก็ดี แต่ละรอบจะมีทั้งหมด 7 ข้อ สรุปผลคะแนนว่าใครจะชนะ<br>หรือเล่นคนเดียวก็สร้างห้องและกดเริ่มเกมได้เลย</p>
    <input id="playerName" placeholder="ชื่อของคุณ" autofocus><br><br>
    <button onclick="confirmName()">ยืนยัน</button>
  </div>

  <div id="lobby">
    <h2 id="lobbyTitle" tabindex="0">ล็อบบี้</h2>
    <button onclick="showCreateRoom()">สร้างห้องใหม่</button>
    <h3>ห้องที่เปิดอยู่</h3>
    <ul id="roomList"></ul>
  </div>

  <div id="room">
    <h2 id="roomName" tabindex="0"></h2>
    <p>ผู้เล่นในห้อง:</p>
    <ul id="playerList"></ul>
    <button id="startBtn" onclick="startGame()">เริ่มเกม</button>
  </div>

  <div id="quiz">
    <h2 id="questionText" tabindex="0"></h2>
    <div id="options"></div>
    <p id="timer" style="font-size:18px; font-weight:bold; margin-top:20px;"></p>
  </div>

  <div id="result">
    <h2 id="resultHeading" tabindex="0">สรุปผล</h2>
    <ul id="scoreList"></ul>
    <button onclick="requestBackToLobby()">กลับไปเลือกห้องใหม่</button>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBIPeN4YUIrwM4MmFtDvT2DJ-v4toxc7tY",
  authDomain: "xo-game-134ec.firebaseapp.com",
  databaseURL: "https://xo-game-134ec-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "xo-game-134ec",
  storageBucket: "xo-game-134ec.firebasestorage.app",
  messagingSenderId: "318375224157",
  appId: "1:318375224157:web:fdfe084db3984cdbb77eb4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let playerName="", roomId="", playerId="", isHost=false;
let questionIndex=0, timerInterval, timeLeft=20, localAnswered=false;
let currentRoomListener=null, soundListener=null, currentAudio=null, lastSoundTime=0;
let lastQuestionText = "";

// รายชื่อไฟล์เสียงทั้งหมดที่ใช้ในเกม
const soundFiles = [
  "pop.mp3",
  "start.mp3",
  "friend.mp3",
  "door.mp3",
  "next.mp3",
  "new4.mp3",
  "wait.mp3"
];

// ออบเจกต์เก็บ Audio ที่ preload แล้ว
const preloadedAudios = {};

// PRELOAD ALL SOUNDS เมื่อกดยืนยันชื่อ (แก้ไข)
function preloadAllSounds() {
  soundFiles.forEach(name => {
    const audio = new Audio(`audio/${name}`);
    audio.preload = "auto";
    preloadedAudios[name] = audio;
  });

  // ให้ user gesture authorize friend.mp3 สำหรับ iOS, ตอนนี้ mute แล้ว play สั้นๆ
  if (preloadedAudios["friend.mp3"]) {
    preloadedAudios["friend.mp3"].volume = 0;
    preloadedAudios["friend.mp3"].play().then(() => {
      preloadedAudios["friend.mp3"].pause();
      preloadedAudios["friend.mp3"].currentTime = 0;
      preloadedAudios["friend.mp3"].volume = 1;
      // หลังจากนี้จะสามารถ play friend.mp3 ใน event อื่นได้บน iOS
    }).catch(() => {});
  }

  console.log("Preloaded all sound files!");
}

// === 98 คำถามเมืองหลวง ===
const questions = [
  { q: "ลิโอเนล เมสซี เป็นสตาร์ของทีมชาติใด", options: ["บราซิล","อาร์เจนตินา","โปรตุเกส"], answer: 1 },
  { q: "คริสเตียโน โรนัลโด เป็นสตาร์ของทีมชาติใด", options: ["โปรตุเกส","สเปน","อิตาลี"], answer: 0 },
  { q: "เปเล่ เป็นสตาร์ของทีมชาติใด", options: ["บราซิล","อาร์เจนตินา","โคลอมเบีย"], answer: 0 },
  { q: "ดีเอโก มาราโดนา เป็นสตาร์ของทีมชาติใด", options: ["อาร์เจนตินา","อุรุกวัย","ชิลี"], answer: 0 },
  { q: "โยฮัน ครัฟฟ์ เป็นสตาร์ของทีมชาติใด", options: ["เนเธอร์แลนด์","เยอรมนี","เบลเยียม"], answer: 0 },
  { q: "ซีเนดีน ซีดาน เป็นสตาร์ของทีมชาติใด", options: ["ฝรั่งเศส","โมร็อกโก","เบลเยียม"], answer: 0 },
  { q: "โรนัลดินโญ เป็นสตาร์ของทีมชาติใด", options: ["บราซิล","โปรตุเกส","อาร์เจนตินา"], answer: 0 },
  { q: "เนย์มาร์ เป็นสตาร์ของทีมชาติใด", options: ["บราซิล","สเปน","ฝรั่งเศส"], answer: 0 },
  { q: "ฟรานซ์ เบ็คเคนเบาเออร์ เป็นสตาร์ของทีมชาติใด", options: ["เยอรมนี","ออสเตรีย","สวิตเซอร์แลนด์"], answer: 0 },
  { q: "เปาโล มัลดินี เป็นสตาร์ของทีมชาติใด", options: ["อิตาลี","สเปน","โปรตุเกส"], answer: 0 },
  { q: "มาร์โก ฟาน บัสเทิน เป็นสตาร์ของทีมชาติใด", options: ["เนเธอร์แลนด์","เบลเยียม","เดนมาร์ก"], answer: 0 },
  { q: "มิเชล พลาตินี เป็นสตาร์ของทีมชาติใด", options: ["ฝรั่งเศส","สวิตเซอร์แลนด์","อิตาลี"], answer: 0 },
  { q: "โรแบร์โต บักโจ เป็นสตาร์ของทีมชาติใด", options: ["อิตาลี","บราซิล","อาร์เจนตินา"], answer: 0 },
  { q: "เธียร์รี อองรี เป็นสตาร์ของทีมชาติใด", options: ["ฝรั่งเศส","ไอวอรีโคสต์","เบลเยียม"], answer: 0 },
  { q: "จอร์จ เบสต์ เป็นสตาร์ของทีมชาติใด", options: ["ไอร์แลนด์เหนือ","ไอร์แลนด์","สกอตแลนด์"], answer: 0 },
  { q: "บ็อบบี ชาร์ลตัน เป็นสตาร์ของทีมชาติใด", options: ["อังกฤษ","สกอตแลนด์","เวลส์"], answer: 0 },
  { q: "เปาโล รอสซี เป็นสตาร์ของทีมชาติใด", options: ["อิตาลี","อาร์เจนตินา","บราซิล"], answer: 0 },
  { q: "ซลาตัน อิบราฮิโมวิช เป็นสตาร์ของทีมชาติใด", options: ["สวีเดน","โครเอเชีย","นอร์เวย์"], answer: 0 },
  { q: "โรนัลโด นาซาริโอ เป็นสตาร์ของทีมชาติใด", options: ["บราซิล","อาร์เจนตินา","โปรตุเกส"], answer: 0 },
  { q: "โรแบร์โต คาร์ลอส เป็นสตาร์ของทีมชาติใด", options: ["บราซิล","โปรตุเกส","สเปน"], answer: 0 },
  { q: "อลัน เชียเรอร์ เป็นสตาร์ของทีมชาติใด", options: ["อังกฤษ","ไอร์แลนด์เหนือ","สกอตแลนด์"], answer: 0 },
  { q: "เซร์คิโอ รามอส เป็นสตาร์ของทีมชาติใด", options: ["สเปน","โปรตุเกส","ฝรั่งเศส"], answer: 0 },
  { q: "อันเดรส อิเนียสตา เป็นสตาร์ของทีมชาติใด", options: ["สเปน","อาร์เจนตินา","บราซิล"], answer: 0 },
  { q: "ลูกา โมดริช เป็นสตาร์ของทีมชาติใด", options: ["โครเอเชีย","โปแลนด์","สโลวีเนีย"], answer: 0 },
  { q: "เควิน เดอ บรอยน์ เป็นสตาร์ของทีมชาติใด", options: ["เบลเยียม","เนเธอร์แลนด์","สวิตเซอร์แลนด์"], answer: 0 },
  { q: "คิลิยัน เอ็มบัปเป้ เป็นสตาร์ของทีมชาติใด", options: ["ฝรั่งเศส","เบลเยียม","โปรตุเกส"], answer: 0 },
  { q: "เออร์ลิง ฮาแลนด์ เป็นสตาร์ของทีมชาติใด", options: ["นอร์เวย์","เดนมาร์ก","สวีเดน"], answer: 0 },
  { q: "เลวานดอฟสกี เป็นสตาร์ของทีมชาติใด", options: ["โปแลนด์","เยอรมนี","ออสเตรีย"], answer: 0 },
  { q: "ซาดิโอ มาเน่ เป็นสตาร์ของทีมชาติใด", options: ["เซเนกัล","ไอวอรีโคสต์","กานา"], answer: 0 },
  { q: "โมฮาเหม็ด ซาลาห์ เป็นสตาร์ของทีมชาติใด", options: ["อียิปต์","โมร็อกโก","ตูนิเซีย"], answer: 0 },
  { q: "จิอันลุยจิ บุฟฟอน เป็นสตาร์ของทีมชาติใด", options: ["อิตาลี","สเปน","ฝรั่งเศส"], answer: 0 },
  { q: "ชาบี เอร์นานเดซ เป็นสตาร์ของทีมชาติใด", options: ["สเปน","โปรตุเกส","อิตาลี"], answer: 0 },
  { q: "ชาบี อลอนโซ เป็นสตาร์ของทีมชาติใด", options: ["สเปน","ฝรั่งเศส","เยอรมนี"], answer: 0 },
  { q: "หลุยส์ ซัวเรซ เป็นสตาร์ของทีมชาติใด", options: ["อุรุกวัย","ชิลี","อาร์เจนตินา"], answer: 0 },
  { q: "เอดินสัน คาวานี เป็นสตาร์ของทีมชาติใด", options: ["อุรุกวัย","โคลอมเบีย","ปารากวัย"], answer: 0 },
  { q: "สตีเวน เจอร์ราร์ด เป็นสตาร์ของทีมชาติใด", options: ["อังกฤษ","เวลส์","สกอตแลนด์"], answer: 0 },
  { q: "แฟรงก์ แลมพาร์ด เป็นสตาร์ของทีมชาติใด", options: ["อังกฤษ","ไอร์แลนด์","สกอตแลนด์"], answer: 0 },
  { q: "เดวิด เบ็คแฮม เป็นสตาร์ของทีมชาติใด", options: ["อังกฤษ","เวลส์","ไอร์แลนด์เหนือ"], answer: 0 },
  { q: "เวนย์ รูนีย์ เป็นสตาร์ของทีมชาติใด", options: ["อังกฤษ","ไอร์แลนด์","สกอตแลนด์"], answer: 0 },
  { q: "กาก้า เป็นสตาร์ของทีมชาติใด", options: ["บราซิล","โปรตุเกส","อาร์เจนตินา"], answer: 0 },
  { q: "ดิดิเยร์ ดร็อกบา เป็นสตาร์ของทีมชาติใด", options: ["ไอวอรีโคสต์","ไนจีเรีย","กานา"], answer: 0 },
  { q: "ซามูเอล เอโต้ เป็นสตาร์ของทีมชาติใด", options: ["แคเมอรูน","กานา","มาลี"], answer: 0 },
  { q: "ฟาบิโอ คันนาวาโร เป็นสตาร์ของทีมชาติใด", options: ["อิตาลี","สเปน","ฝรั่งเศส"], answer: 0 },
  { q: "อีเคร์ กาซิยาส เป็นสตาร์ของทีมชาติใด", options: ["สเปน","โปรตุเกส","ฝรั่งเศส"], answer: 0 },
  { q: "มานูเอล นอยเออร์ เป็นสตาร์ของทีมชาติใด", options: ["เยอรมนี","ออสเตรีย","สวิตเซอร์แลนด์"], answer: 0 },
  { q: "โธมัส มุลเลอร์ เป็นสตาร์ของทีมชาติใด", options: ["เยอรมนี","ออสเตรีย","เบลเยียม"], answer: 0 },
  { q: "โทนี โครส เป็นสตาร์ของทีมชาติใด", options: ["เยอรมนี","สวิตเซอร์แลนด์","เนเธอร์แลนด์"], answer: 0 },
  { q: "ฟิล โฟเดน เป็นสตาร์ของทีมชาติใด", options: ["อังกฤษ","เวลส์","สกอตแลนด์"], answer: 0 },
  { q: "บูคาโย ซากา เป็นสตาร์ของทีมชาติใด", options: ["อังกฤษ","ไนจีเรีย","กานา"], answer: 0 },
  { q: "จู๊ด เบลลิงแฮม เป็นสตาร์ของทีมชาติใด", options: ["อังกฤษ","เวลส์","ไอร์แลนด์"], answer: 0 },
  { q: "วินิซิอุส จูเนียร์ เป็นสตาร์ของทีมชาติใด", options: ["บราซิล","อาร์เจนตินา","ชิลี"], answer: 0 },
  { q: "คาเซมิโร เป็นสตาร์ของทีมชาติใด", options: ["บราซิล","โปรตุเกส","อุรุกวัย"], answer: 0 },
  { q: "ริยาด มาห์เรซ เป็นสตาร์ของทีมชาติใด", options: ["แอลจีเรีย","โมร็อกโก","ตูนิเซีย"], answer: 0 },
  { q: "ฮาคิม ซีเยค เป็นสตาร์ของทีมชาติใด", options: ["โมร็อกโก","อียิปต์","ตูนิเซีย"], answer: 0 },
  { q: "แกเร็ธ เบล เป็นสตาร์ของทีมชาติใด", options: ["เวลส์","อังกฤษ","ไอร์แลนด์เหนือ"], answer: 0 },
  { q: "คริสเตียน อีริคเซน เป็นสตาร์ของทีมชาติใด", options: ["เดนมาร์ก","สวีเดน","นอร์เวย์"], answer: 0 },
  { q: "ลูกากู เป็นสตาร์ของทีมชาติใด", options: ["เบลเยียม","ฝรั่งเศส","เนเธอร์แลนด์"], answer: 0 },
  { q: "เอแด็น อาซาร์ เป็นสตาร์ของทีมชาติใด", options: ["เบลเยียม","ฝรั่งเศส","สวิตเซอร์แลนด์"], answer: 0 },
  { q: "มาร์คัส แรชฟอร์ด เป็นสตาร์ของทีมชาติใด", options: ["อังกฤษ","ไอร์แลนด์","เวลส์"], answer: 0 },
  { q: "แฮร์รี เคน เป็นสตาร์ของทีมชาติใด", options: ["อังกฤษ","สกอตแลนด์","เวลส์"], answer: 0 },
  { q: "เมซุต โอซิล เป็นสตาร์ของทีมชาติใด", options: ["เยอรมนี","ตุรกี","ออสเตรีย"], answer: 0 },
  { q: "บาสเตียน ชไวน์สไตเกอร์ เป็นสตาร์ของทีมชาติใด", options: ["เยอรมนี","ออสเตรีย","สวิตเซอร์แลนด์"], answer: 0 },
  { q: "จอห์น เทอร์รี เป็นสตาร์ของทีมชาติใด", options: ["อังกฤษ","สกอตแลนด์","เวลส์"], answer: 0 },
  { q: "ริโอ เฟอร์ดินานด์ เป็นสตาร์ของทีมชาติใด", options: ["อังกฤษ","ไอร์แลนด์","เวลส์"], answer: 0 },
  { q: "ปีเตอร์ เช็ก เป็นสตาร์ของทีมชาติใด", options: ["เช็ก","โปแลนด์","สโลวาเกีย"], answer: 0 },
  { q: "เคราร์ด ปิเก้ เป็นสตาร์ของทีมชาติใด", options: ["สเปน","อิตาลี","ฝรั่งเศส"], answer: 0 },
  { q: "อังเคล ดิ มาเรีย เป็นสตาร์ของทีมชาติใด", options: ["อาร์เจนตินา","ชิลี","อุรุกวัย"], answer: 0 },
  { q: "เอมิเลียโน มาร์ติเนซ เป็นสตาร์ของทีมชาติใด", options: ["อาร์เจนตินา","บราซิล","ชิลี"], answer: 0 },
  { q: "โรดรีโก เด ปอล เป็นสตาร์ของทีมชาติใด", options: ["อาร์เจนตินา","อุรุกวัย","ปารากวัย"], answer: 0 },
  { q: "คริสเตียน พูลิซิช เป็นสตาร์ของทีมชาติใด", options: ["สหรัฐอเมริกา","แคนาดา","เม็กซิโก"], answer: 0 },
  { q: "รอย คีน เป็นสตาร์ของทีมชาติใด", options: ["ไอร์แลนด์","อังกฤษ","สกอตแลนด์"], answer: 0 },
  { q: "เอริก คันโตนา เป็นสตาร์ของทีมชาติใด", options: ["ฝรั่งเศส","สวิตเซอร์แลนด์","เบลเยียม"], answer: 0 },
  { q: "พอล สโคลส์ เป็นสตาร์ของทีมชาติใด", options: ["อังกฤษ","ไอร์แลนด์เหนือ","เวลส์"], answer: 0 },
  { q: "ไรอัน กิ๊กส์ เป็นสตาร์ของทีมชาติใด", options: ["เวลส์","อังกฤษ","สกอตแลนด์"], answer: 0 },
  { q: "ปีเตอร์ ชไมเคิล เป็นสตาร์ของทีมชาติใด", options: ["เดนมาร์ก","สวีเดน","นอร์เวย์"], answer: 0 },
  { q: "เดนนิส เบิร์กแคมป์ เป็นสตาร์ของทีมชาติใด", options: ["เนเธอร์แลนด์","เบลเยียม","เยอรมนี"], answer: 0 },
  { q: "แพทริค วิเอรา เป็นสตาร์ของทีมชาติใด", options: ["ฝรั่งเศส","ไอวอรีโคสต์","เบลเยียม"], answer: 0 },
  { q: "โคล้ด มาเกเลเล เป็นสตาร์ของทีมชาติใด", options: ["ฝรั่งเศส","คองโก","เบลเยียม"], answer: 0 },
  { q: "อันเดรีย ปีร์โล เป็นสตาร์ของทีมชาติใด", options: ["อิตาลี","สเปน","ฝรั่งเศส"], answer: 0 },
  { q: "ฟรานเชสโก ต็อตติ เป็นสตาร์ของทีมชาติใด", options: ["อิตาลี","ฝรั่งเศส","เยอรมนี"], answer: 0 },
  { q: "อเลสซานโดร เดล ปีเอโร เป็นสตาร์ของทีมชาติใด", options: ["อิตาลี","โปรตุเกส","ฝรั่งเศส"], answer: 0 },
  { q: "กาเบรียล บาติสตูตา เป็นสตาร์ของทีมชาติใด", options: ["อาร์เจนตินา","ชิลี","อุรุกวัย"], answer: 0 },
  { q: "เออร์นาน เครสโป เป็นสตาร์ของทีมชาติใด", options: ["อาร์เจนตินา","อุรุกวัย","ปารากวัย"], answer: 0 },
  { q: "คาร์ลอส เตเบซ เป็นสตาร์ของทีมชาติใด", options: ["อาร์เจนตินา","บราซิล","อุรุกวัย"], answer: 0 },
  { q: "ฮาเวียร์ ซาเน็ตติ เป็นสตาร์ของทีมชาติใด", options: ["อาร์เจนตินา","ชิลี","อุรุกวัย"], answer: 0 },
  { q: "คาร์ลอส วัลเดอร์รามา เป็นสตาร์ของทีมชาติใด", options: ["โคลอมเบีย","เปรู","เวเนซุเอลา"], answer: 0 },
  { q: "เอ็นโกโล ก็องเต เป็นสตาร์ของทีมชาติใด", options: ["ฝรั่งเศส","มาลี","เซเนกัล"], answer: 0 },
  { q: "อองตวน กรีซมันน์ เป็นสตาร์ของทีมชาติใด", options: ["ฝรั่งเศส","สเปน","โปรตุเกส"], answer: 0 },
  { q: "เอ็นริเก เป็นสตาร์ของทีมชาติใด", options: ["สเปน","อิตาลี","ฝรั่งเศส"], answer: 0 },
  { q: "เชส ฟาเบรกาส เป็นสตาร์ของทีมชาติใด", options: ["สเปน","โปรตุเกส","ฝรั่งเศส"], answer: 0 },
  { q: "รุด ฟาน นิสเทลรอย เป็นสตาร์ของทีมชาติใด", options: ["เนเธอร์แลนด์","เบลเยียม","เยอรมนี"], answer: 0 },
  { q: "อาร์เยิน ร็อบเบิน เป็นสตาร์ของทีมชาติใด", options: ["เนเธอร์แลนด์","เดนมาร์ก","สวีเดน"], answer: 0 },
  { q: "เวสลีย์ ชไนเดอร์ เป็นสตาร์ของทีมชาติใด", options: ["เนเธอร์แลนด์","เบลเยียม","ออสเตรีย"], answer: 0 },
  { q: "เอ็ดการ์ ดาวิดส์ เป็นสตาร์ของทีมชาติใด", options: ["เนเธอร์แลนด์","ฝรั่งเศส","เบลเยียม"], answer: 0 },
  { q: "แพทริก ไคลเวิร์ต เป็นสตาร์ของทีมชาติใด", options: ["เนเธอร์แลนด์","เบลเยียม","เดนมาร์ก"], answer: 0 },
{ q: "ลามิน ยามาล เป็นสตาร์ของทีมชาติใด", options: ["สเปน","ฝรั่งเศส","โปรตุเกส"], answer: 0 },
{ q: "เดแคลน ไรซ์ เป็นสตาร์ของทีมชาติใด", options: ["อังกฤษ","ไอร์แลนด์","สกอตแลนด์"], answer: 0 },
{ q: "จามาล มูเซียลา เป็นสตาร์ของทีมชาติใด", options: ["เยอรมนี","ฝรั่งเศส","โปแลนด์"], answer: 0 },
{ q: "โยชโก กวาร์ดิโอล เป็นสตาร์ของทีมชาติใด", options: ["โครเอเชีย","เซอร์เบีย","สโลวีเนีย"], answer: 0 },
{ q: "ฮูเลียน อัลวาเรซ เป็นสตาร์ของทีมชาติใด", options: ["อาร์เจนตินา","บราซิล","อุรุกวัย"], answer: 0 },
{ q: "ชินจิ คากาวะ เป็นสตาร์ของทีมชาติใด", options: ["ญี่ปุ่น","ไทย","เวียดนาม"], answer: 0 },
{ q: "ซน ฮึง-มิน เป็นสตาร์ของทีมชาติใด", options: ["เกาหลีใต้","ญี่ปุ่น","ออสเตรเลีย"], answer: 0 },
{ q: "ชนาธิป สรงกระสินธ์ เป็นสตาร์ของทีมชาติใด", options: ["ไทย","ลาว","กัมพูชา"], answer: 0 },
{ q: "เกียติศักดิ์ เสนาเมือง เป็นสตาร์ของทีมชาติใด", options: ["ไทย","มาเลเซีย","สิงคโปร์"], answer: 0 },
{ q: "ปิยะพงษ์ ผิวอ่อน เป็นสตาร์ของทีมชาติใด", options: ["ไทย","ลาว","มาเลเซีย"], answer: 0 },
{ q: "ฮิเดโตชิ นากาตะ เป็นสตาร์ของทีมชาติใด", options: ["ญี่ปุ่น","เกาหลีใต้","จีน"], answer: 0 },
  { q: "โรดรีโก เป็นสตาร์ของทีมชาติใด", options: ["บราซิล","โปรตุเกส","สเปน"], answer: 0 }
];
// เริ่มเกม
document.getElementById("game").style.display="block";
document.getElementById("backToMenuBtn").style.display="block";

// ============== AUDIO ==============
function triggerSound(name) {
  if (!roomId) return;
  const now = Date.now();
  if (now - lastSoundTime < 200) return;
  lastSoundTime = now;
  db.ref(`guessGameRooms/${roomId}/soundTrigger`).set({name, time: now});
}
function triggerWaitSoundOnlyAtEnd() {
  if (!roomId) return;
  db.ref(`guessGameRooms/${roomId}/waitSoundEnd`).set({time: Date.now()});
}
function stopCurrentAudio() {
  if (currentAudio) { currentAudio.pause(); currentAudio.currentTime = 0; currentAudio = null; }
}

function playSound(name) {
  // ใช้ preloaded audio ที่ authorize แล้ว ถ้ามี
  stopCurrentAudio();
  const audio = preloadedAudios[`${name}.mp3`] || preloadedAudios[name] || new Audio(`audio/${name}.mp3`);
  audio.play().catch(() => {});
  currentAudio = audio;
}

function startSoundListener() {
  if (soundListener) soundListener.off();
  if (!roomId) return;
  soundListener = db.ref(`guessGameRooms/${roomId}/soundTrigger`);
  soundListener.on("value", s => { const d = s.val(); if (d?.name) playSound(d.name); });
  db.ref(`guessGameRooms/${roomId}/waitSoundEnd`).on("value", s => { if (s.val()?.time) playSound("wait"); });
}

// ============== FOCUS ==============
function focusHeading(id) {
  requestAnimationFrame(() => setTimeout(() => {
    const el = document.getElementById(id);
    if (el) { el.setAttribute('tabindex', '-1'); el.focus(); }
  }, 150));
}
function focusQuestionIfChanged(newText) {
  if (newText !== lastQuestionText) {
    lastQuestionText = newText;
    document.getElementById("questionText").textContent = newText;
    focusHeading("questionText");
  }
}

// ============== UTILS ==============
function shuffleArray(arr) {
  for (let i = arr.length-1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}


// ============== GAME FLOW ==============
function confirmName() {
  playerName = document.getElementById("playerName").value.trim();
  if (!playerName) { alert("กรุณาใส่ชื่อ"); return; }
  playerId = Math.random().toString(36).substr(2,9);
  document.getElementById("nameInput").style.display = "none";
  document.getElementById("lobby").style.display = "block";
  focusHeading("lobbyTitle");
  
  preloadAllSounds();
  
  loadRooms();
}

function loadRooms() {
  const list = document.getElementById("roomList");
  db.ref("guessGameRooms").on("value", snap => {
    list.innerHTML = "";
    const now = Date.now();

    snap.forEach(r => {
      const room = r.val();
      const roomKey = r.key;
      const playerCount = room.players ? Object.keys(room.players).length : 0;

      if (playerCount === 0 && room.created && (now - room.created > 3000)) {
        db.ref(`guessGameRooms/${roomKey}`).remove();
        return;
      }

      if (room.status === "waiting" && playerCount > 0) {
        const li = document.createElement("li");
        li.innerHTML = `${room.name} (${playerCount} คน)`;
        const btn = document.createElement("button");
        btn.textContent = "เข้าร่วม";
        btn.onclick = () => joinRoom(roomKey);
        li.appendChild(btn);
        list.appendChild(li);
      }
    });
  });
}

function showCreateRoom() {
  const name = prompt("ตั้งชื่อห้อง:");
  if (!name) return;
  const ref = db.ref("guessGameRooms").push();
  roomId = ref.key; isHost = true;
  ref.set({name, status:"waiting", host:playerId, created:Date.now(), players:{}});
  joinRoom(roomId);
}

/* function joinRoom(id) {
  roomId = id;
  const ref = db.ref(`guessGameRooms/${roomId}/players/${playerId}`);
  ref.set({name:playerName, score:0, answered:false});
  ref.onDisconnect().remove();
  db.ref(`guessGameRooms/${roomId}/lastJoin`).set(Date.now());
  showRoom();
} */

function joinRoom(id) {
  // ก่อน join ให้เช็คจำนวนคนในห้อง
  db.ref(`guessGameRooms/${id}`).once("value").then(snap => {
    const room = snap.val();
    const playerCount = room.players ? Object.keys(room.players).length : 0;
    if (playerCount >= 8) {
      alert("ห้องนี้มีผู้เล่นครบ 8 คนแล้ว ไม่สามารถเข้าร่วมได้");
      return;
    }
    roomId = id;
    const ref = db.ref(`guessGameRooms/${roomId}/players/${playerId}`);
    ref.set({name:playerName, score:0, answered:false});
    ref.onDisconnect().remove();
    db.ref(`guessGameRooms/${roomId}/lastJoin`).set(Date.now());
    showRoom();
  });
}

function showRoom() {
  document.getElementById("lobby").style.display = "none";
  document.getElementById("room").style.display = "block";
  focusHeading("roomName");
  startSoundListener();

  if (currentRoomListener) currentRoomListener.off();
  currentRoomListener = db.ref(`guessGameRooms/${roomId}`);
  currentRoomListener.on("value", snap => {
    const room = snap.val();
    if (!room) { alert("ห้องถูกลบแล้ว"); backToLobby(); return; }

    document.getElementById("roomName").textContent = `ห้อง: ${room.name}`;
    const list = document.getElementById("playerList"); list.innerHTML = "";
    if (room.players) {
      for (let id in room.players) {
        const li = document.createElement("li");
        li.textContent = `${room.players[id].name} (${room.players[id].score||0} คะแนน)`;
        list.appendChild(li);
      }
    }
    document.getElementById("startBtn").style.display = (room.host === playerId) ? "inline" : "none";

	if (room.lastJoin && room.lastJoin !== window._lastJoinTime) {
	  window._lastJoinTime = room.lastJoin;
	  // ทุกเครื่องที่อยู่ในห้อง เมื่อ lastJoin เปลี่ยน คือมีคนใหม่ join
	  playSound("friend"); 
	}
    if (room.lastBackToLobby && room.lastBackToLobby !== window._lastBackTime) {
      window._lastBackTime = room.lastBackToLobby;
      triggerSound("door");
    }

    if (room.status === "playing") startQuiz();
    else if (room.status === "finished") showResult(room);
  });
}

function startGame() {
  triggerSound("start");
  db.ref(`guessGameRooms/${roomId}`).update({
    status: "playing",
    current: 0,
    questions: getRandomQuestions(7)
  });
}

function getRandomQuestions(n) {
  const copy = [...questions];
  const res = [];
  for (let i = 0; i < n; i++) {
    const idx = Math.floor(Math.random() * copy.length);
    let q = copy.splice(idx, 1)[0];
    const opts = [...q.options];
    const correctText = opts[q.answer];
    shuffleArray(opts);
    q.answer = opts.indexOf(correctText);
    q.options = opts;
    res.push(q);
  }
  return res;
}

function startQuiz() {
  document.getElementById("room").style.display = "none";
  document.getElementById("quiz").style.display = "block";
  document.getElementById("mainTitle").style.display = "none";
  db.ref(`guessGameRooms/${roomId}`).once("value").then(snap => {
    const data = snap.val();
    questionIndex = data.current || 0;
    showQuestion(data.questions[questionIndex]);
  });
}

function showQuestion(q) {
  if (!q) { if (isHost) endGameHost(); return; }
  localAnswered = false;
  timeLeft = Math.floor(Math.random() * 11) + 15;

  const newText = `ข้อที่ ${questionIndex + 1}: ${q.q}`;
  focusQuestionIfChanged(newText);

  const container = document.getElementById("options");
  container.innerHTML = "";
  const shuffled = q.options; // <<--- ใช้ options จาก Firebase, ไม่ต้อง shuffle
  const correctText = q.options[q.answer];

  shuffled.forEach((opt, i) => {
    const btn = document.createElement("button");
    btn.textContent = opt;
    btn.onclick = () => submitAnswer(opt === correctText);
    container.appendChild(btn);
  });

  document.getElementById("timer").textContent = `เวลา: ${timeLeft} วินาที`;
  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    timeLeft--;
    document.getElementById("timer").textContent = `เวลา: ${timeLeft} วินาที`;
    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      triggerSound("next");
      setTimeout(nextQuestion, 1200);
    }
  }, 1000);
}


function submitAnswer(isCorrect) {
  if (localAnswered) return;
  localAnswered = true;
  playSound("pop");

  db.ref(`guessGameRooms/${roomId}`).once("value").then(snap => {
    const data = snap.val();
    if (isCorrect) {
      db.ref(`guessGameRooms/${roomId}/players/${playerId}/score`).transaction(v => (v || 0) + 1);
    }
    db.ref(`guessGameRooms/${roomId}/players/${playerId}/answered`).set(true);
    checkAllAnswered();
  });
}

function checkAllAnswered() {
  db.ref(`guessGameRooms/${roomId}`).once("value").then(snap => {
    const data = snap.val();
    const all = Object.values(data.players || {}).every(p => p.answered);
    if (all) {
      clearInterval(timerInterval);
      if (data.current === data.questions.length - 1) {
        triggerWaitSoundOnlyAtEnd();
        setTimeout(() => triggerSound("new4"), 600);
        setTimeout(nextQuestion, 2500);
      } else {
        setTimeout(() => triggerSound("next"), 500);
        setTimeout(nextQuestion, 1200);
      }
    }
  });
}

function nextQuestion() {
  db.ref(`guessGameRooms/${roomId}`).once("value").then(snap => {
    const data = snap.val();
    if (!data) return;
    const updates = {};
    for (let id in data.players) updates[`players/${id}/answered`] = false;
    updates.current = (data.current || 0) + 1;
    db.ref(`guessGameRooms/${roomId}`).update(updates);

    questionIndex = updates.current;
    if (questionIndex < data.questions.length) {
      showQuestion(data.questions[questionIndex]);
    } else if (isHost) {
      setTimeout(endGameHost, 800);
    }
  });
}

function endGameHost() {
  clearInterval(timerInterval);
  db.ref(`guessGameRooms/${roomId}`).once("value").then(snap => {
    const room = snap.val();
    if (!room?.players) return;
    const players = Object.values(room.players);
    players.sort((a,b) => b.score - a.score);
    const max = players[0].score;
    const winners = players.filter(p => p.score === max).map(p => p.name);

    db.ref(`guessGameRooms/${roomId}`).update({
      status: "finished",
      result: { winners, players }
    });
  });
}

function showResult(roomData) {
  clearInterval(timerInterval);
  document.getElementById("quiz").style.display = "none";
  document.getElementById("result").style.display = "block";
  document.getElementById("mainTitle").style.display = "none";

  const list = document.getElementById("scoreList");
  list.innerHTML = "";
  const players = roomData.result?.players || [];
  const winners = roomData.result?.winners || [];
  document.getElementById("resultHeading").textContent = `สรุปผล ผู้ชนะคือ ${winners.join(", ")}`;

  players.forEach(p => {
    const li = document.createElement("li");
    li.textContent = `${p.name}: ${p.score} คะแนน`;
    list.appendChild(li);
  });
  focusHeading("resultHeading");
}

function requestBackToLobby() {
  triggerSound("door");
  db.ref(`guessGameRooms/${roomId}/lastBackToLobby`).set(Date.now());
  backToLobby();
}

function backToLobby() {
  if (currentRoomListener) { currentRoomListener.off(); currentRoomListener = null; }
  if (soundListener) { soundListener.off(); soundListener = null; }
  db.ref(`guessGameRooms/${roomId}/players/${playerId}`).remove();
  roomId = ""; questionIndex = 0; lastQuestionText = "";
  document.getElementById("result").style.display = "none";
  document.getElementById("room").style.display = "none";
  document.getElementById("quiz").style.display = "none";
  document.getElementById("mainTitle").style.display = "block";
  document.getElementById("lobby").style.display = "block";
  focusHeading("lobbyTitle");
  loadRooms();
}
</script>
</body>
</html>